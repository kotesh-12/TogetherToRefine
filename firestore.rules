rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPERS ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return request.auth.uid == uid; }
    
    // SAFE Admin CHeck
    function isAdmin() { 
       return isSignedIn() && (
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
         (exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) && get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data.role == 'admin') ||
         (exists(/databases/$(database)/documents/institutions/$(request.auth.uid)) && get(/databases/$(database)/documents/institutions/$(request.auth.uid)).data.role == 'admin')
       );
    }

    // --- 1. USER PROFILES ---
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (isOwner(userId) || isAdmin());

      // SIMPLIFIED RULE: Direct Owner Check (No Admin function dependency)
      match /four_way_sessions/{sessionId} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
         
         match /messages/{msgId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
         }
      }
    }

    match /teachers/{teacherId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (isOwner(teacherId) || isAdmin());
    }
    match /institutions/{instId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (isOwner(instId) || isAdmin());
    }

    // --- 2. PUBLIC & APP ---
    match /admissions/{document=**} {
      allow create: if true; 
      allow read, update, delete: if isSignedIn();
    }

    match /groups/{groupId} {
      allow read, write: if isSignedIn();
      match /messages/{msgId} { allow read, write: if isSignedIn(); }
    }

    match /student_allotments/{id} { allow read, write: if isSignedIn(); }
    match /teacher_allotments/{id} { allow read, write: if isSignedIn(); }
    match /submissions/{id} { allow read, write: if isSignedIn(); }
    match /attendance/{id} { allow read, write: if isSignedIn(); }
    match /announcements/{id} { allow read, write: if isSignedIn(); }
    match /opportunities/{id} { allow read, write: if isSignedIn(); }
    match /general_feedback/{id} { allow read, write: if isSignedIn(); }
    match /emergency_reports/{id} { allow read, write: if isSignedIn(); }
    match /health_records/{id} { allow read, write: if isSignedIn(); }
    match /timetables/{id} { allow read, write: if isSignedIn(); }
    match /videos/{id} { allow read, write: if isSignedIn(); }

    // --- 4. AI CHATS ---
    // SIMPLIFIED RULE: Direct Owner Check Only
    match /ai_chats/{userId} {
       allow read, write: if request.auth != null && request.auth.uid == userId;
       
       match /sessions/{sessionId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
          
          match /messages/{msgId} {
             allow read, write: if request.auth != null && request.auth.uid == userId;
          }
       }
    }

    // Default Lock
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}
