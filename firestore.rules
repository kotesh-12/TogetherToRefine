rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- BASE HELPERS ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return request.auth.uid == uid; }
    
    // NEW: Multi-collection role check
    function hasRole(role) {
       return (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role.lower() == role) ||
              (exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) && get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data.role.lower() == role) ||
              (exists(/databases/$(database)/documents/institutions/$(request.auth.uid)) && get(/databases/$(database)/documents/institutions/$(request.auth.uid)).data.role.lower() == role);
    }

    // SECURE ADMIN CHECK: Case-insensitive & consolidated
    function isAdmin() { 
       return isSignedIn() && hasRole('admin');
    }

    // --- 1. USER PROFILES ---
    // Granular permissions to prevent Privilege Escalation (VULN-003)
    match /users/{userId} {
      allow read: if isSignedIn();
      
      // CREATE: Prevent creating 'admin' role
      allow create: if isSignedIn() && isOwner(userId) && 
         request.resource.data.role in ['student', 'teacher', 'institution'];
      
      // UPDATE: Prevent changing 'role' or 'approved' status
      allow update: if isSignedIn() && (
         isAdmin() || 
         (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'approved']))
      );
      
      // DELETE: Owner or Admin
      allow delete: if isSignedIn() && (isOwner(userId) || isAdmin());

      match /four_way_sessions/{sessionId} {
         allow read, write: if isOwner(userId);
         match /messages/{msgId} { allow read, write: if isOwner(userId); }
      }
    }

    match /teachers/{teacherId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(teacherId) && 
         request.resource.data.role == 'teacher';
      allow update: if isSignedIn() && (
         isAdmin() || 
         (isOwner(teacherId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'approved']))
      );
      allow delete: if isSignedIn() && (isOwner(teacherId) || isAdmin());
    }

    match /institutions/{instId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(instId) && 
         request.resource.data.role == 'institution';
      allow update: if isSignedIn() && (
         isAdmin() || 
         (isOwner(instId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'approved']))
      );
      allow delete: if isSignedIn() && (isOwner(instId) || isAdmin());
    }

    // --- 2. FEE MANAGEMENT (SECURED) ---
    // Original rule was: allow read, write: if isSignedIn(); (CRITICAL VULN)
    match /fees/{feeId} {
       // Students read own fees; Institutions read their students' fees; Admins read all
       allow read: if isSignedIn() && (
          (request.auth.uid == resource.data.studentId) || 
          (request.auth.uid == resource.data.institutionId) ||
          isAdmin()
       );
       // Only Institution/Admin can write fees
       allow write: if isSignedIn() && (hasRole('institution') || hasRole('admin'));
    }

    // --- 3. ANNOUNCEMENTS (SECURED) ---
    match /announcements/{id} {
        allow read: if isSignedIn();
        // Only valid authors or admins can create
        allow create: if isSignedIn() && (
            isAdmin() || 
            (request.auth.uid == request.resource.data.authorId) ||
            (request.auth.uid == request.resource.data.institutionId)
        );
        // Only author or admin can delete/update
        allow update, delete: if isSignedIn() && (
            isAdmin() || 
            (resource.data.authorId == request.auth.uid) ||
            (resource.data.institutionId == request.auth.uid)
        );
    }

    // --- 4. GROUPS (SECURED) ---
    match /groups/{groupId} {
        allow read, write: if isSignedIn() && (
            request.auth.uid in resource.data.members ||
            resource.data.teacherId == request.auth.uid ||
            resource.data.institutionId == request.auth.uid || 
            resource.data.createdBy == request.auth.uid ||
            isAdmin()
        );
        match /messages/{msgId} {
             allow read, write: if isSignedIn() && (
                request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members ||
                get(/databases/$(database)/documents/groups/$(groupId)).data.institutionId == request.auth.uid ||
                get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid ||
                isAdmin()
            );
        }
    }

    // --- 5. OTHER COLLECTIONS (Basic Ownership/Role Security Needed) ---
    match /admissions/{id} {
      allow create: if true; 
      allow read, update, delete: if isSignedIn() && (
          resource.data.institutionId == request.auth.uid || isAdmin()
      );
    }

    match /timetables/{id} { 
        allow read: if isSignedIn();
        allow write: if isSignedIn() && (hasRole('teacher') || hasRole('institution') || hasRole('admin'));
    }

    // Generic fallback for less critical collections (Locked to signed in for now, specific rules recommended later)
    match /student_allotments/{id} { allow read, write: if isSignedIn(); }
    match /teacher_allotments/{id} { allow read, write: if isSignedIn(); }
    match /submissions/{id} { allow read, write: if isSignedIn(); }
    match /attendance/{id} { allow read, write: if isSignedIn(); }
    match /opportunities/{id} { allow read, write: if isSignedIn(); }
    match /general_feedback/{id} { allow read, write: if isSignedIn(); }
    match /emergency_reports/{id} { allow read, write: if isSignedIn(); }
    match /health_records/{id} { allow read, write: if isSignedIn(); }
    match /videos/{id} { allow read, write: if isSignedIn(); }
    
    // --- NEW MODULES ---
    match /marks/{id} { allow read, write: if isSignedIn(); }
    match /library_books/{id} { allow read, write: if isSignedIn(); }
    match /library_issued_books/{id} { allow read, write: if isSignedIn(); }
    match /library_reservations/{id} { allow read, write: if isSignedIn(); }
    match /homework/{id} { allow read, write: if isSignedIn(); }
    match /homework_submissions/{id} { allow read, write: if isSignedIn(); }
    match /exam_seating_plans/{id} { allow read, write: if isSignedIn() && (hasRole('institution') || hasRole('admin')); }
    match /exam_seating/{id} { allow read, write: if isSignedIn() && (hasRole('institution') || hasRole('admin')); }

    // --- 6. AI CHATS ---
    match /ai_chats/{userId} {
       allow read, write: if isOwner(userId);
       match /sessions/{sessionId} {
          allow read, write: if isOwner(userId);
          match /messages/{msgId} { allow read, write: if isOwner(userId); }
       }
    }

    // --- 7. FALLBACK ---
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}
