rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── HELPERS ────────────────────────────────────────────────────────────
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return request.auth.uid == uid; }

    // Check role by verifying existence in specific collections
    function isStudent()     { return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function isTeacher()     { return isSignedIn() && exists(/databases/$(database)/documents/teachers/$(request.auth.uid)); }
    function isInstitution() { return isSignedIn() && exists(/databases/$(database)/documents/institutions/$(request.auth.uid)); }
    function isAdmin()       { return isStudent()  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'; }

    // Resolve the institution UID for any logged-in user:
    function myInstitutionId() {
      return isInstitution()
        ? request.auth.uid
        : (isTeacher()
          ? get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data.institutionId
          : (isStudent()
            ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.institutionId
            : null));
    }

    // Does the document belong to my institution?
    function myDoc() {
      return resource.data.institutionId == myInstitutionId()
          || resource.data.createdBy     == myInstitutionId();
    }

    // Does a write request carry my institution id?
    function writingToMyInst() {
      return request.resource.data.institutionId == myInstitutionId()
          || request.resource.data.createdBy     == myInstitutionId();
    }

    // ─── 1. USER PROFILES ───────────────────────────────────────────────────
    match /users/{userId} {
      // Any signed-in user can read profiles (needed for name lookups, etc.)
      allow read: if isSignedIn();

      // Create: only yourself, no admin/role escalation
      allow create: if isSignedIn() && isOwner(userId)
                    && request.resource.data.role in ['student', 'teacher', 'institution'];

      // Update: admin anything; owner cannot change role/approved
      allow update: if isSignedIn() && (
        isAdmin() ||
        (isOwner(userId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role','approved']))
      );

      allow delete: if isSignedIn() && (isOwner(userId) || isAdmin());

      match /four_way_sessions/{sessionId} {
        allow read, write: if isOwner(userId);
        match /messages/{msgId} { allow read, write: if isOwner(userId); }
      }
    }

    match /teachers/{teacherId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(teacherId)
                    && request.resource.data.role == 'teacher';
      allow update: if isSignedIn() && (
        isAdmin() ||
        (isOwner(teacherId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role','approved']))
      );
      allow delete: if isSignedIn() && (isOwner(teacherId) || isAdmin());
    }

    match /institutions/{instId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(instId)
                    && request.resource.data.role == 'institution';
      allow update: if isSignedIn() && (
        isAdmin() ||
        (isOwner(instId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role','approved']))
      );
      allow delete: if isSignedIn() && (isOwner(instId) || isAdmin());
    }

    // ─── 2. FEES ────────────────────────────────────────────────────────────
    match /fees/{feeId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        request.auth.uid == resource.data.institutionId ||
        isAdmin()
      );
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    // ─── 3. ANNOUNCEMENTS ───────────────────────────────────────────────────
    // Filtered at query level in app; only institution can write
    match /announcements/{id} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    // ─── 4. GROUPS ──────────────────────────────────────────────────────────
    // Groups are tied to an institution; members are from the same institution
    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (isInstitution() || isTeacher() || isAdmin());
      match /messages/{msgId} {
        allow read, write: if isSignedIn();
      }
    }

    // ─── 5. ADMISSIONS ──────────────────────────────────────────────────────
    match /admissions/{id} {
      allow create: if true; // Public form submissions
      allow read, update, delete: if isSignedIn() && (
        resource.data.institutionId == request.auth.uid || isAdmin()
      );
    }

    // ─── 6. TIMETABLES ──────────────────────────────────────────────────────
    match /timetables/{id} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (isTeacher() || isInstitution() || isAdmin());
    }

    // ─── 7. STUDENT ALLOTMENTS ──────────────────────────────────────────────
    // Students see own; institution/teacher sees their institution's students
    match /student_allotments/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isTeacher() ||
        isInstitution() ||
        isAdmin()
      );
      // Only institution or admin can create/update/delete allotments
      allow create: if isSignedIn() && (isInstitution() || isAdmin()) && writingToMyInst();
      allow update, delete: if isSignedIn() && (isInstitution() || isAdmin()) && myDoc();
    }

    // ─── 8. TEACHER ALLOTMENTS ──────────────────────────────────────────────
    match /teacher_allotments/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        myDoc() ||
        isAdmin()
      );
      allow create: if isSignedIn() && (isInstitution() || isAdmin()) && writingToMyInst();
      allow update, delete: if isSignedIn() && (isInstitution() || isAdmin()) && myDoc();
    }

    // ─── 9. ATTENDANCE ──────────────────────────────────────────────────────
    match /attendance/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isTeacher() ||
        isInstitution() ||
        isAdmin()
      );
      allow create: if isSignedIn() && (isTeacher() || isInstitution() || isAdmin());
      allow update, delete: if isSignedIn() && (
        myDoc() || isAdmin()
      );
    }

    // ─── 9.5 EXAM SEATING ───────────────────────────────────────────────────
    match /exam_seating/{id} {
      allow read: if isSignedIn() && (
        isTeacher() ||
        isStudent() ||
        isInstitution() ||
        isAdmin()
      );
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    // ─── 10. SUBMISSIONS ────────────────────────────────────────────────────
    match /submissions/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        request.auth.uid == resource.data.teacherId ||
        myDoc() ||
        isAdmin()
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        myDoc() ||
        isAdmin()
      );
    }

    // ─── 11. MARKS ──────────────────────────────────────────────────────────
    match /marks/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        request.auth.uid == resource.data.teacherId ||
        myDoc() ||
        isAdmin()
      );
      allow write: if isSignedIn() && (isTeacher() || isInstitution() || isAdmin());
    }

    // ─── 12. HOMEWORK ───────────────────────────────────────────────────────
    match /homework/{id} {
      allow read: if isSignedIn() && (myDoc() || isAdmin());
      allow write: if isSignedIn() && (isTeacher() || isInstitution() || isAdmin());
    }

    match /homework_submissions/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        request.auth.uid == resource.data.teacherId ||
        myDoc() ||
        isAdmin()
      );
      allow create: if isSignedIn() && isStudent();
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isTeacher() ||
        isAdmin()
      );
    }

    // ─── 13. LIBRARY ────────────────────────────────────────────────────────
    match /library_books/{id} {
      allow read: if isSignedIn() && (myDoc() || isAdmin());
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    match /library_issued_books/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        myDoc() ||
        isAdmin()
      );
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    match /library_reservations/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        myDoc() ||
        isAdmin()
      );
      allow create: if isSignedIn() && isStudent();
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isInstitution() ||
        isAdmin()
      );
    }

    // ─── 14. HEALTH RECORDS ─────────────────────────────────────────────────
    match /health_records/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        myDoc() ||
        isAdmin()
      );
      allow write: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isInstitution() ||
        isAdmin()
      );
    }

    // ─── 15. EMERGENCY REPORTS ──────────────────────────────────────────────
    match /emergency_reports/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        myDoc() ||
        isAdmin()
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isAdmin()
      );
    }

    // ─── 16. GENERAL FEEDBACK ───────────────────────────────────────────────
    match /general_feedback/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        myDoc() ||
        isAdmin()
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isAdmin()
      );
    }

    // ─── 17. OPPORTUNITIES ──────────────────────────────────────────────────
    match /opportunities/{id} {
      allow read: if isSignedIn() && (myDoc() || isAdmin());
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    // ─── 18. VIDEOS ─────────────────────────────────────────────────────────
    match /videos/{id} {
      allow read: if isSignedIn() && (resource.data.institutionId == myInstitutionId() || isAdmin());
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    // ─── 19. EXAM SEATING ───────────────────────────────────────────────────
    match /exam_seating_plans/{id} {
      // Institution sees own; students/teachers at that institution can read
      allow read: if isSignedIn() && (myDoc() || isAdmin());
      allow write: if isSignedIn() && (isInstitution() || isAdmin()) && (
        resource == null || myDoc()  // null = creating new doc
      );
    }

    match /exam_seating/{id} {
      allow read: if isSignedIn() && (myDoc() || isAdmin());
      allow write: if isSignedIn() && (isInstitution() || isAdmin());
    }

    // ─── 20. AI CHATS ───────────────────────────────────────────────────────
    match /ai_chats/{userId} {
      allow read, write: if isOwner(userId);
      match /sessions/{sessionId} {
        allow read, write: if isOwner(userId);
        match /messages/{msgId} { allow read, write: if isOwner(userId); }
      }
    }

    // ─── 21. FALLBACK (deny everything else) ────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
