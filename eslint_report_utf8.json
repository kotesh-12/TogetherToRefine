[{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\check_mysql_port.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\diagnose_mysql.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\fix_connection.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":76,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import mysql from 'mysql2/promise';\r\nimport dotenv from 'dotenv';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\ndotenv.config();\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = path.dirname(__filename);\r\nconst envPath = path.join(__dirname, '.env');\r\n\r\nconst passwordsToTry = [\r\n    process.env.MYSQL_PASSWORD, // The current one in .env\r\n    '20050701',                 // The one we tried to set\r\n    '',                         // Empty (Default XAMPP/WAMP)\r\n    'root',                     // Common default\r\n    'password',                 // Common default\r\n    'admin',                    // Common default\r\n    '123456',                   // Common default\r\n    '1234',                     // Common default\r\n    'mysql'                     // Common default\r\n];\r\n\r\nasync function findCorrectPassword() {\r\n    console.log(\"≡ƒöì Scanning for the correct MySQL password...\");\r\n\r\n    // Deduplicate\r\n    const unique = [...new Set(passwordsToTry.filter(p => p !== undefined))];\r\n\r\n    for (const pass of unique) {\r\n        process.stdout.write(`   Testing '${pass}'... `);\r\n        try {\r\n            const conn = await mysql.createConnection({\r\n                host: '127.0.0.1',\r\n                user: 'root',\r\n                password: pass\r\n            });\r\n            console.log(\"Γ£à SUCCESS!\");\r\n            await conn.end();\r\n\r\n            // Detected! Update .env\r\n            console.log(`\\n≡ƒÄë FOUND IT! Your actual password is: '${pass}'`);\r\n\r\n            if (pass !== process.env.MYSQL_PASSWORD) {\r\n                console.log(\"≡ƒô¥ Updating .env file automatically...\");\r\n                let envContent = fs.readFileSync(envPath, 'utf8');\r\n\r\n                // Regex to replace MYSQL_PASSWORD=...\r\n                if (envContent.includes('MYSQL_PASSWORD=')) {\r\n                    envContent = envContent.replace(/MYSQL_PASSWORD=.*/g, `MYSQL_PASSWORD=${pass}`);\r\n                } else {\r\n                    envContent += `\\nMYSQL_PASSWORD=${pass}`;\r\n                }\r\n\r\n                fs.writeFileSync(envPath, envContent);\r\n                console.log(\"Γ£à .env updated successfully.\");\r\n            } else {\r\n                console.log(\"Γ£à .env is already correct.\");\r\n            }\r\n\r\n            console.log(\"\\n≡ƒÜÇ Now running database initialization...\");\r\n            // Run init_db.js\r\n            try {\r\n                // Determine path to init_db.js (assuming same directory)\r\n                const initScript = path.join(__dirname, 'init_db.js');\r\n                if (fs.existsSync(initScript)) {\r\n                    const { execSync } = await import('child_process');\r\n                    execSync(`node \"${initScript}\"`, { stdio: 'inherit' });\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Init script failed:\", e.message);\r\n            }\r\n\r\n            return; // Exit after success\r\n        } catch (e) {\r\n            console.log(\"Γ¥î Failed\");\r\n        }\r\n    }\r\n\r\n    console.log(\"\\nΓÜá∩╕Å CRITICAL: None of the common passwords worked.\");\r\n    console.log(\"≡ƒæë You must reset your MySQL password manually.\");\r\n    console.log(\"   Open 'reset_mysql_password.bat' as Administrator one more time.\");\r\n}\r\n\r\nfindCorrectPassword();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\init_db.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\migrate_data.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\regex_test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\scripts\\context_bridge.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'path' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"path"},"fix":{"range":[29,39],"text":""},"desc":"Remove unused variable 'path'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":33,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":45,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":60,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs';\r\nimport path from 'path';\r\n\r\n// Configuration\r\nconst OUTPUT_FILE = 'TTR_AI_CONTEXT.txt';\r\nconst INCLUDED_FILES = [\r\n    'package.json',\r\n    'mysql_schema.sql',\r\n    'firestore.rules',\r\n    'server.js',\r\n    'src/App.jsx',\r\n    'src/App.css',\r\n    'src/firebase.js',\r\n    'src/components/ProtectedRoute.jsx',\r\n    'src/pages/Login.jsx',\r\n    'src/pages/Signup.jsx',\r\n    'src/pages/Details.jsx',\r\n    'src/context/UserContext.jsx',\r\n    'src/context/ThemeContext.jsx',\r\n    'src/components/MainLayout.jsx',\r\n    'src/components/Loading.jsx'\r\n];\r\n\r\nfunction generateContext() {\r\n    let context = \"PROJECT CONTEXT FOR AI COLLABORATION (TogetherToRefine)\\n\";\r\n    context += \"========================================================\\n\\n\";\r\n\r\n    // 1. Project Tech Stack\r\n    context += \"## 1. TECH STACK (package.json)\\n\";\r\n    try {\r\n        const pkg = fs.readFileSync('package.json', 'utf8');\r\n        context += pkg + \"\\n\\n\";\r\n    } catch (e) {\r\n        context += \"Error reading package.json\\n\\n\";\r\n    }\r\n\r\n    // 2. Database Schema\r\n    context += \"## 2. DATABASE SCHEMA (MySQL)\\n\";\r\n    try {\r\n        if (fs.existsSync('mysql_schema.sql')) {\r\n            context += fs.readFileSync('mysql_schema.sql', 'utf8') + \"\\n\\n\";\r\n        } else {\r\n            context += \"No schema file found.\\n\\n\";\r\n        }\r\n    } catch (e) {\r\n        context += \"Error reading schema.\\n\\n\";\r\n    }\r\n\r\n    // 3. Key Files Listing\r\n    context += \"## 3. KEY SOURCE FILES\\n\";\r\n    INCLUDED_FILES.forEach(file => {\r\n        if (file === 'package.json' || file === 'mysql_schema.sql') return; // Already added\r\n        context += `\\n--- START OF FILE: ${file} ---\\n`;\r\n        try {\r\n            if (fs.existsSync(file)) {\r\n                context += fs.readFileSync(file, 'utf8');\r\n            } else {\r\n                context += \"(File not found)\";\r\n            }\r\n        } catch (e) {\r\n            context += \"(Error reading file)\";\r\n        }\r\n        context += `\\n--- END OF FILE: ${file} ---\\n`;\r\n    });\r\n\r\n    // Write Output\r\n    fs.writeFileSync(OUTPUT_FILE, context);\r\n    console.log(`\\nΓ£à CONTEXT GENERATED: ${OUTPUT_FILE}`);\r\n    console.log(`\\n≡ƒôï HOW TO USE WITH ANTHROPIC/CLAUDE:`);\r\n    console.log(`1. Open ${OUTPUT_FILE}`);\r\n    console.log(`2. Copy all text.`);\r\n    console.log(`3. Paste into https://claude.ai (Free Web Chat)`);\r\n    console.log(`4. Ask: \"Conduct a Final Go-Live Audit. Verify that previously identified critical vulnerabilities (VULN 1-20) are patched. Review code quality, performance logic, and security posture for a production launch.\"`);\r\n}\r\n\r\ngenerateContext();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\setup_mysql.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":15,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e2' is defined but never used.","line":24,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import mysql from 'mysql2/promise';\r\n\r\nasync function setupDatabase() {\r\n    console.log(\"≡ƒöä Attempting to connect to MySQL...\");\r\n\r\n    // Try Default Credentials (root/empty)\r\n    let connection;\r\n    try {\r\n        connection = await mysql.createConnection({\r\n            host: 'localhost',\r\n            user: 'root',\r\n            password: ''\r\n        });\r\n        console.log(\"Γ£à Connected with root/(empty password)!\");\r\n    } catch (e) {\r\n        try {\r\n            console.log(\"ΓÜá∩╕Å Default (empty) failed. Trying root/root...\");\r\n            connection = await mysql.createConnection({\r\n                host: 'localhost',\r\n                user: 'root',\r\n                password: 'root'\r\n            });\r\n            console.log(\"Γ£à Connected with root/root!\");\r\n        } catch (e2) {\r\n            console.error(\"Γ¥î Could not connect to MySQL with default credentials.\");\r\n            console.error(\"Please edit .env and set MYSQL_PASSWORD manually.\");\r\n            process.exit(1);\r\n        }\r\n    }\r\n\r\n    try {\r\n        console.log(\"≡ƒ¢á Creating Database 'together_to_refine_db'...\");\r\n        await connection.query(`CREATE DATABASE IF NOT EXISTS together_to_refine_db`);\r\n        await connection.query(`USE together_to_refine_db`);\r\n\r\n        console.log(\"≡ƒ¢á Creating Users Table...\");\r\n        await connection.query(`\r\n            CREATE TABLE IF NOT EXISTS users (\r\n                uid VARCHAR(36) PRIMARY KEY,\r\n                email VARCHAR(255) UNIQUE NOT NULL,\r\n                password_hash VARCHAR(255) NOT NULL,\r\n                role ENUM('student', 'teacher', 'institution', 'admin') DEFAULT 'student',\r\n                name VARCHAR(255),\r\n                gender VARCHAR(50),\r\n                profile_image_url TEXT,\r\n                institution_id VARCHAR(255),\r\n                is_approved BOOLEAN DEFAULT FALSE,\r\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n            )\r\n        `);\r\n\r\n        // Additional Tables...\r\n        console.log(\"Γ£à Database Setup Complete!\");\r\n    } catch (e) {\r\n        console.error(\"Γ¥î Error setting up database:\", e.message);\r\n    } finally {\r\n        if (connection) await connection.end();\r\n    }\r\n}\r\n\r\nsetupDatabase();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\AIBadge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\AnnouncementBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\BottomNav.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'navStyle' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":9,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"navStyle"},"fix":{"range":[243,698],"text":""},"desc":"Remove unused variable 'navStyle'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\n\r\nexport default function BottomNav() {\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n\r\n    // Style for the container\r\n    const navStyle = {\r\n        position: 'fixed',\r\n        bottom: 0,\r\n        left: 0,\r\n        width: '100%',\r\n        backgroundColor: 'var(--bg-surface)',\r\n        borderTop: '1px solid var(--divider)',\r\n        padding: '10px 0',\r\n        display: 'flex',\r\n        justifyContent: 'space-around',\r\n        alignItems: 'center',\r\n        zIndex: 1000,\r\n        boxShadow: '0 -2px 10px rgba(0,0,0,0.05)',\r\n        height: '60px' // Explicit height\r\n    };\r\n\r\n    // Style for individual items\r\n    const isActive = (path) => location.pathname === path;\r\n\r\n    // Helper to render Item\r\n    const NavItem = ({ path, icon, label }) => {\r\n        const active = isActive(path);\r\n        return (\r\n            <div\r\n                onClick={() => handleNav(path)}\r\n                style={{\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    alignItems: 'center',\r\n                    cursor: 'pointer',\r\n                    color: active ? 'var(--primary)' : 'var(--text-muted)',\r\n                    flex: 1,\r\n                    transition: 'color 0.2s',\r\n                    fontSize: '10px', // Mobile standard\r\n                    fontWeight: active ? '600' : '400'\r\n                }}\r\n            >\r\n                <div style={{ fontSize: '22px', marginBottom: '2px' }}>{icon}</div>\r\n                <span>{label}</span>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const handleNav = (path) => {\r\n        if (location.pathname !== path) {\r\n            navigate(path, { replace: true });\r\n        }\r\n    };\r\n\r\n    return (\r\n        <nav className=\"bottom-nav-wrapper\">\r\n            <div onClick={() => { vibrate(); handleNav('/'); }} className={`nav-item ${isActive('/') ? 'active' : ''}`}>\r\n                <div className=\"nav-icon\">≡ƒÅá</div>\r\n                <span className=\"nav-label\">Home</span>\r\n            </div>\r\n            <div onClick={() => { vibrate(); handleNav('/group'); }} className={`nav-item ${isActive('/group') ? 'active' : ''}`}>\r\n                <div className=\"nav-icon\">≡ƒÅ½</div>\r\n                <span className=\"nav-label\">Groups</span>\r\n            </div>\r\n            <div onClick={() => { vibrate(); handleNav('/ttr-ai'); }} className={`nav-item ${isActive('/ttr-ai') ? 'active' : ''}`}>\r\n                <div className=\"nav-icon ai-nav-icon\">≡ƒñû</div>\r\n                <span className=\"nav-label\">AI</span>\r\n            </div>\r\n            <div onClick={() => { vibrate(); handleNav('/attendance'); }} className={`nav-item ${isActive('/attendance') ? 'active' : ''}`}>\r\n                <div className=\"nav-icon\">Γ£à</div>\r\n                <span className=\"nav-label\">Attend</span>\r\n            </div>\r\n            <div onClick={() => { vibrate(); handleNav('/profile'); }} className={`nav-item ${isActive('/profile') ? 'active' : ''}`}>\r\n                <div className=\"nav-icon\">≡ƒæñ</div>\r\n                <span className=\"nav-label\">Profile</span>\r\n            </div>\r\n        </nav>\r\n    );\r\n}\r\n\r\nconst vibrate = () => {\r\n    if ('vibrate' in navigator) navigator.vibrate(40);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\DeviceManagement.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":36,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":48,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, getDocs, deleteDoc, doc, query, orderBy } from 'firebase/firestore';\r\nimport { useUser } from '../context/UserContext';\r\nimport { getLocalSessionId } from '../utils/sessionManager';\r\n\r\nexport default function DeviceManagement() {\r\n    const { user } = useUser();\r\n    const [sessions, setSessions] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const currentSessionId = getLocalSessionId();\r\n\r\n    const fetchSessions = async () => {\r\n        if (!user) return;\r\n        try {\r\n            const q = query(collection(db, 'users', user.uid, 'sessions'), orderBy('lastActive', 'desc'));\r\n            const snapshot = await getDocs(q);\r\n            const sess = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));\r\n            setSessions(sess);\r\n        } catch (err) {\r\n            console.error(\"Error fetching sessions:\", err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchSessions();\r\n    }, [user]);\r\n\r\n    const handleSignOut = async (sessionId) => {\r\n        if (!window.confirm(\"Are you sure you want to sign out this device?\")) return;\r\n        try {\r\n            await deleteDoc(doc(db, 'users', user.uid, 'sessions', sessionId));\r\n            setSessions(prev => prev.filter(s => s.id !== sessionId));\r\n        } catch (err) {\r\n            alert(\"Failed to remove device.\");\r\n        }\r\n    };\r\n\r\n    const handleSignOutOthers = async () => {\r\n        if (!window.confirm(\"Sign out of all other devices?\")) return;\r\n        try {\r\n            const others = sessions.filter(s => s.id !== currentSessionId);\r\n            await Promise.all(others.map(s => deleteDoc(doc(db, 'users', user.uid, 'sessions', s.id))));\r\n            fetchSessions();\r\n            alert(\"Signed out of all other devices.\");\r\n        } catch (err) {\r\n            alert(\"Error signing out devices.\");\r\n        }\r\n    };\r\n\r\n    const getIcon = (type) => {\r\n        if (type === 'mobile') return '≡ƒô▒';\r\n        if (type === 'tablet') return 'ipod';\r\n        return '≡ƒÆ╗';\r\n    };\r\n\r\n    if (loading) return <div>Loading devices...</div>;\r\n\r\n    return (\r\n        <div className=\"device-management\" style={{ marginTop: '30px', textAlign: 'left', borderTop: '1px solid #eee', paddingTop: '20px' }}>\r\n            <h3 style={{ fontSize: '18px', marginBottom: '15px' }}>Logged in Devices</h3>\r\n\r\n            <div className=\"session-list\">\r\n                {sessions.length === 0 && <p>No active sessions found.</p>}\r\n\r\n                {sessions.map((session) => {\r\n                    const isCurrent = session.id === currentSessionId;\r\n                    return (\r\n                        <div key={session.id} style={{\r\n                            display: 'flex', alignItems: 'center', justifyContent: 'space-between',\r\n                            padding: '10px', marginBottom: '10px',\r\n                            background: isCurrent ? '#f0f9ff' : '#fff',\r\n                            border: isCurrent ? '1px solid #bae6fd' : '1px solid #eee',\r\n                            borderRadius: '8px'\r\n                        }}>\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                <span style={{ fontSize: '24px' }}>{getIcon(session.deviceType)}</span>\r\n                                <div>\r\n                                    <div style={{ fontWeight: 'bold', fontSize: '14px' }}>\r\n                                        {session.deviceName}\r\n                                        {isCurrent && <span style={{ marginLeft: '8px', fontSize: '10px', background: '#e0f2fe', color: '#0284c7', padding: '2px 6px', borderRadius: '4px' }}>THIS DEVICE</span>}\r\n                                    </div>\r\n                                    <div style={{ fontSize: '12px', color: '#666' }}>\r\n                                        {session.lastActive?.toDate ? session.lastActive.toDate().toLocaleString() : 'Just now'}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {!isCurrent && (\r\n                                <button\r\n                                    onClick={() => handleSignOut(session.id)}\r\n                                    style={{\r\n                                        background: 'none', border: '1px solid #fee2e2', color: '#dc2626',\r\n                                        padding: '5px 10px', borderRadius: '4px', cursor: 'pointer', fontSize: '12px'\r\n                                    }}\r\n                                >\r\n                                    Sign Out\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {sessions.length > 1 && (\r\n                <button\r\n                    onClick={handleSignOutOthers}\r\n                    style={{\r\n                        marginTop: '10px', width: '100%', padding: '10px',\r\n                        background: '#fff', border: '1px solid #ddd', color: '#444',\r\n                        borderRadius: '6px', cursor: 'pointer', fontWeight: '500'\r\n                    }}\r\n                >\r\n                    Sign out all other devices\r\n                </button>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\ErrorBoundary.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\FeatureTour.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\GlobalLoader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\GurukullPathSelector.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":7,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":7,"endColumn":28},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":150,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":150,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { db } from '../firebase';\r\nimport { doc, updateDoc } from 'firebase/firestore';\r\nimport { useUser } from '../context/UserContext';\r\n\r\n// ΓöÇΓöÇΓöÇ HERO DATA ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\nexport const GURUKUL_HEROES = [\r\n    {\r\n        id: 'arjuna',\r\n        name: 'Arjuna',\r\n        emoji: '≡ƒÅ╣',\r\n        title: 'The Focused Warrior',\r\n        color: '#FF6B35',\r\n        gradient: 'linear-gradient(135deg, #FF6B35, #F7931E)',\r\n        shadow: 'rgba(255, 107, 53, 0.4)',\r\n        trait: 'Laser Focus & Mastery',\r\n        description: 'Arjuna could hit a target reflected in water ΓÇö eyes only for the goal. You will master one topic completely before moving to the next.',\r\n        aiStyle: 'My TTR AI will challenge you like Dronacharya ΓÇö never satisfied until your answer is perfect.',\r\n        qualities: ['≡ƒôì Deep Focus', '≡ƒÄ» Mastery over shortcuts', '≡ƒºÿ Discipline above distraction'],\r\n        quote: '\"I see only the eye of the bird.\" ΓÇö Arjuna'\r\n    },\r\n    {\r\n        id: 'ekalavya',\r\n        name: 'Ekalavya',\r\n        emoji: '≡ƒÖÅ',\r\n        title: 'The Self-Made Scholar',\r\n        color: '#6C63FF',\r\n        gradient: 'linear-gradient(135deg, #6C63FF, #3F3D56)',\r\n        shadow: 'rgba(108, 99, 255, 0.4)',\r\n        trait: 'Self-Learning & Devotion',\r\n        description: 'Ekalavya became a master without a physical Guru ΓÇö only pure devotion. You are proof that where there is will, there is a way.',\r\n        aiStyle: 'My TTR AI will be your clay Dronacharya ΓÇö always present, guiding you when no physical teacher is there.',\r\n        qualities: ['≡ƒöÑ Learning without excuses', '≡ƒÆ¬ No dependency on others', '≡ƒî▒ Growing in silence'],\r\n        quote: '\"A student who wants to learn will always find a way.\" ΓÇö Ekalavya\\'s story'\r\n    },\r\n    {\r\n        id: 'krishna',\r\n        name: 'Krishna',\r\n        emoji: '≡ƒ¬ê',\r\n        title: 'The Strategic Thinker',\r\n        color: '#00B4D8',\r\n        gradient: 'linear-gradient(135deg, #00B4D8, #0077B6)',\r\n        shadow: 'rgba(0, 180, 216, 0.4)',\r\n        trait: 'Wisdom & Emotional Intelligence',\r\n        description: 'Krishna never fought a single battle with weapons ΓÇö he won through strategy and wisdom. You will learn to outthink problems, not brute-force them.',\r\n        aiStyle: 'My TTR AI will think with you like Krishna on the battlefield ΓÇö giving you the strategy, not just the answer.',\r\n        qualities: ['≡ƒºá Think before you act', 'ΓÖƒ∩╕Å Strategy over strength', 'Γ¥ñ∩╕Å Emotional Intelligence'],\r\n        quote: '\"You have the right to perform your actions, not to the fruits.\" ΓÇö Bhagavad Gita'\r\n    },\r\n    {\r\n        id: 'rama',\r\n        name: 'Rama',\r\n        emoji: 'ΓÜí',\r\n        title: 'The Dharma Keeper',\r\n        color: '#52B788',\r\n        gradient: 'linear-gradient(135deg, #52B788, #1B4332)',\r\n        shadow: 'rgba(82, 183, 136, 0.4)',\r\n        trait: 'Righteousness & Duty',\r\n        description: 'Rama chose duty over personal comfort every single time. Whatever the cost. You will always do the right thing ΓÇö even when it\\'s hard.',\r\n        aiStyle: 'My TTR AI will always remind you of the ethical choice ΓÇö because Dharma is the highest intelligence.',\r\n        qualities: ['ΓÜû∩╕Å Integrity above all', '≡ƒ½í Duty over desire', '≡ƒîƒ Ideal in conduct'],\r\n        quote: '\"Dharmo rakshati rakshitah ΓÇö Dharma protects those who protect Dharma.\"'\r\n    },\r\n    {\r\n        id: 'karna',\r\n        name: 'Karna',\r\n        emoji: 'ΓÿÇ∩╕Å',\r\n        title: 'The Resilient Fighter',\r\n        color: '#F4A261',\r\n        gradient: 'linear-gradient(135deg, #F4A261, #E76F51)',\r\n        shadow: 'rgba(244, 162, 97, 0.4)',\r\n        trait: 'Resilience & Generosity',\r\n        description: 'Karna was rejected, insulted, and disadvantaged ΓÇö yet he never stopped giving, never stopped fighting. Your circumstances do not define your destiny.',\r\n        aiStyle: 'My TTR AI will never judge your starting point ΓÇö only your direction. Like the sun, rise every day regardless.',\r\n        qualities: ['≡ƒîà Rise despite setbacks', '≡ƒñ¥ Generosity of spirit', '≡ƒÆÄ Character under pressure'],\r\n        quote: '\"I was born in the dark, but I chose to live in the light.\" ΓÇö Karna'\r\n    },\r\n    {\r\n        id: 'dharmaraj',\r\n        name: 'Dharmaraj',\r\n        emoji: 'ΓÜû∩╕Å',\r\n        title: 'The Truth Seeker',\r\n        color: '#9B5DE5',\r\n        gradient: 'linear-gradient(135deg, #9B5DE5, #F15BB5)',\r\n        shadow: 'rgba(155, 93, 229, 0.4)',\r\n        trait: 'Truth & Justice Always',\r\n        description: 'Yudhishthira never lied ΓÇö not even to save his life. In a world full of half-truths, you will be someone who can be completely trusted.',\r\n        aiStyle: 'My TTR AI will always present the full truth ΓÇö multiple perspectives, no bias ΓÇö just like Dharmaraj himself.',\r\n        qualities: ['≡ƒôó Truth even when it hurts', 'ΓÜû∩╕Å Justice over victory', '≡ƒö« Integrity under pressure'],\r\n        quote: '\"Satya (Truth) is the highest Dharma.\" ΓÇö Yudhishthira'\r\n    },\r\n    {\r\n        id: 'abhimanyu',\r\n        name: 'Abhimanyu',\r\n        emoji: '≡ƒ¢í∩╕Å',\r\n        title: 'The Fearless Explorer',\r\n        color: '#E63946',\r\n        gradient: 'linear-gradient(135deg, #E63946, #9B2226)',\r\n        shadow: 'rgba(230, 57, 70, 0.4)',\r\n        trait: 'Courage & Action',\r\n        description: 'Abhimanyu entered the unbreakable Chakravyuha without fear, even though he didn\\'t know the full way out. You will dive into complex problems with absolute confidence.',\r\n        aiStyle: 'My TTR AI will push you to start exploring even when you don\\'t have all the answers. Courage first, knowledge follows.',\r\n        qualities: ['ΓÜí Fearless action', '≡ƒºá Solving the unknown', '≡ƒöÑ Unbreakable spirit'],\r\n        quote: '\"I know only how to enter the formation; let the future lie in the hands of action.\" ΓÇö Abhimanyu\\'s spirit'\r\n    },\r\n    {\r\n        id: 'bheema',\r\n        name: 'Bheema',\r\n        emoji: '≡ƒÆ¬',\r\n        title: 'The Unstoppable Force',\r\n        color: '#F9C74F',\r\n        gradient: 'linear-gradient(135deg, #F9C74F, #F3722C)',\r\n        shadow: 'rgba(249, 199, 79, 0.4)',\r\n        trait: 'Raw Strength & Endurance',\r\n        description: 'Bheema swung his mace repeatedly until mountains crumbled. Your mind will become equally unstoppable through practice and repetition.',\r\n        aiStyle: 'My TTR AI will focus on foundational strength and repetition. We will master the core basics until you are unshakeable.',\r\n        qualities: ['≡ƒÅï∩╕Å Limitless endurance', 'ΓÜÆ∩╕Å Hard work over talent', '≡ƒ¢í∩╕Å Protective strength'],\r\n        quote: '\"True strength is born of pure effort, not privilege.\"'\r\n    },\r\n    {\r\n        id: 'ghatotkacha',\r\n        name: 'Ghatotkacha',\r\n        emoji: 'Γ¢░∩╕Å',\r\n        title: 'The Loyal Giant',\r\n        color: '#2A9D8F',\r\n        gradient: 'linear-gradient(135deg, #2A9D8F, #264653)',\r\n        shadow: 'rgba(42, 157, 143, 0.4)',\r\n        trait: 'Power & Selflessness',\r\n        description: 'Ghatotkacha possessed terrifying power but used it entirely in service of his people, even sacrificing himself for the greater good. You will become incredibly capable to help others.',\r\n        aiStyle: 'My TTR AI will teach you to think big and bold, lifting up your entire team with your massive abilities.',\r\n        qualities: ['≡ƒÖî Ultimate loyalty', '≡ƒÆÑ Massive impact', '≡ƒñ¥ Selfless application'],\r\n        quote: '\"My strength belongs to those who need it.\"'\r\n    },\r\n    {\r\n        id: 'hanuman',\r\n        name: 'Hanuman',\r\n        emoji: '≡ƒÉÆ',\r\n        title: 'The Devoted Student',\r\n        color: '#FFA1A1',\r\n        gradient: 'linear-gradient(135deg, #FF7B54, #E25E3E)',\r\n        shadow: 'rgba(226, 94, 62, 0.4)',\r\n        trait: 'Intellect & Humility',\r\n        description: 'Despite knowing all the Vedas and possessing absolute power, Hanuman remained the most humble servant. You will learn to recognize your limitless potential.',\r\n        aiStyle: 'My TTR AI will constantly remind you of your hidden strength while keeping you grounded in humility and devotion to your craft.',\r\n        qualities: ['≡ƒôÜ Infinite knowledge', '≡ƒÖÅ Absolute humility', '≡ƒîè Leaping over doubt'],\r\n        quote: '\"With faith, one can leap across oceans.\"'\r\n    }\r\n];\r\n\r\nexport const GURUKUL_TEACHER_HEROES = [\r\n    {\r\n        id: 'dronacharya',\r\n        name: 'Dronacharya',\r\n        emoji: '≡ƒÄ»',\r\n        title: 'The Ultimate Master',\r\n        color: '#FF6B35',\r\n        gradient: 'linear-gradient(135deg, #FF6B35, #F7931E)',\r\n        shadow: 'rgba(255, 107, 53, 0.4)',\r\n        trait: 'Discipline & Excellence',\r\n        description: 'Dronacharya demanded absolute excellence and was capable of turning raw talent into legendary skill. You will expect the best from your students and accept nothing less.',\r\n        aiStyle: 'My TTR AI will give you advanced pedagogical strategies to push your students beyond their perceived limits.',\r\n        qualities: ['≡ƒæü∩╕Å Spotting hidden genius', '≡ƒöÑ Forging excellence', '≡ƒÅ╣ Absolute discipline'],\r\n        quote: '\"A teacher provides the arrow, the student must draw the bow.\"'\r\n    },\r\n    {\r\n        id: 'bhishma',\r\n        name: 'Bhishma',\r\n        emoji: '≡ƒææ',\r\n        title: 'The Elder Statesman',\r\n        color: '#6C63FF',\r\n        gradient: 'linear-gradient(135deg, #6C63FF, #3F3D56)',\r\n        shadow: 'rgba(108, 99, 255, 0.4)',\r\n        trait: 'Wisdom & Duty',\r\n        description: 'Bhishma carried the weight of history and unbreakable vows. You will teach with incredible patience, historical perspective, and a sense of absolute duty.',\r\n        aiStyle: 'My TTR AI will support you with timeless wisdom and steady guidance, helping you maintain principles across generations of students.',\r\n        qualities: ['ΓÅ│ Timeless patience', '≡ƒô£ Unbreakable principles', '≡ƒÅ¢∩╕Å Historical perspective'],\r\n        quote: '\"Duty is the highest calling. Fulfill it with unwavering resolve.\"'\r\n    },\r\n    {\r\n        id: 'parashurama',\r\n        name: 'Parashurama',\r\n        emoji: '≡ƒ¬ô',\r\n        title: 'The Fierce Instructor',\r\n        color: '#D90429',\r\n        gradient: 'linear-gradient(135deg, #D90429, #8D0801)',\r\n        shadow: 'rgba(217, 4, 41, 0.4)',\r\n        trait: 'Purity & Rigor',\r\n        description: 'Parashurama hated arrogance and only imparted his ultimate knowledge to those with pure intent. You will run a rigorous classroom where entitlement has no place.',\r\n        aiStyle: 'My TTR AI will give you sharp, unyielding frameworks to instill true respect and rigor in your students.',\r\n        qualities: ['≡ƒÜ½ Zero tolerance for arrogance', 'ΓÜû∩╕Å Absolute intellectual purity', 'ΓÜö∩╕Å Rigorous standards'],\r\n        quote: '\"Knowledge given to the unworthy destroys them.\"'\r\n    },\r\n    {\r\n        id: 'chanakya',\r\n        name: 'Chanakya',\r\n        emoji: '≡ƒô£',\r\n        title: 'The Kingmaker',\r\n        color: '#2A9D8F',\r\n        gradient: 'linear-gradient(135deg, #2A9D8F, #264653)',\r\n        shadow: 'rgba(42, 157, 143, 0.4)',\r\n        trait: 'Strategy & Pragmatism',\r\n        description: 'Chanakya built empires by shaping leaders. You do not just teach subjects; you teach strategy, political intelligence, and real-world dominance.',\r\n        aiStyle: 'My TTR AI will help you craft lessons that tie every academic concept to real-world power and leadership.',\r\n        qualities: ['≡ƒºá Ruthless logic', '≡ƒææ Building leaders', '≡ƒÅù∩╕Å Nation building'],\r\n        quote: '\"Education is the tool with which we build empires.\"'\r\n    }\r\n];\r\n\r\n// ΓöÇΓöÇΓöÇ COMPONENT ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\nexport default function GurukullPathSelector({ onClose, onSelect, isTeacher = false }) {\r\n    const { user: authUser } = useUser();\r\n    const [selected, setSelected] = useState(null);\r\n    const [saving, setSaving] = useState(false);\r\n    const [step, setStep] = useState('choose'); // 'choose' | 'confirm'\r\n\r\n    const HERO_LIST = isTeacher ? GURUKUL_TEACHER_HEROES : GURUKUL_HEROES;\r\n\r\n    const handleConfirm = async () => {\r\n        if (!selected || !authUser) return;\r\n        setSaving(true);\r\n        try {\r\n            await updateDoc(doc(db, 'users', authUser.uid), {\r\n                gurukul_path: selected.id\r\n            });\r\n            onSelect(selected);\r\n        } catch (e) {\r\n            console.error('Failed to save Gurukul path:', e);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed', inset: 0, zIndex: 9999,\r\n            background: 'rgba(0,0,0,0.92)',\r\n            display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n            padding: '16px',\r\n            backdropFilter: 'blur(8px)',\r\n            animation: 'fadeIn 0.4s ease'\r\n        }}>\r\n            <div style={{\r\n                background: 'linear-gradient(160deg, #0f0f1a 0%, #1a1a2e 100%)',\r\n                border: '1px solid rgba(255,255,255,0.08)',\r\n                borderRadius: '24px',\r\n                width: '100%',\r\n                maxWidth: '680px',\r\n                maxHeight: '90vh',\r\n                overflowY: 'auto',\r\n                padding: '32px 24px',\r\n                boxShadow: '0 40px 80px rgba(0,0,0,0.5)',\r\n                position: 'relative'\r\n            }}>\r\n                {/* Close button */}\r\n                {onClose && (\r\n                    <button onClick={onClose} style={{\r\n                        position: 'absolute', top: '16px', right: '16px',\r\n                        background: 'rgba(255,255,255,0.08)', border: 'none',\r\n                        borderRadius: '50%', width: '36px', height: '36px',\r\n                        color: '#fff', cursor: 'pointer', fontSize: '18px',\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                    }}>Γ£ò</button>\r\n                )}\r\n\r\n                {step === 'choose' && (\r\n                    <>\r\n                        {/* Header */}\r\n                        <div style={{ textAlign: 'center', marginBottom: '28px' }}>\r\n                            <div style={{ fontSize: '40px', marginBottom: '8px' }}>≡ƒÅ¢∩╕Å</div>\r\n                            <h2 style={{\r\n                                color: '#fff', fontSize: '22px', fontWeight: '900',\r\n                                margin: '0 0 8px', letterSpacing: '-0.5px'\r\n                            }}>\r\n                                {isTeacher ? 'Choose Your Teaching Framework' : 'Choose Your Learning Path'}\r\n                            </h2>\r\n                            <p style={{ color: 'rgba(255,255,255,0.5)', fontSize: '13px', margin: 0 }}>\r\n                                {isTeacher ? 'Ancient masters. Modern teaching. Who will you embody?' : 'Ancient heroes. Modern learning. Who will you become?'}\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Hero Grid */}\r\n                        <div style={{\r\n                            display: 'grid',\r\n                            gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))',\r\n                            gap: '12px',\r\n                            marginBottom: '24px'\r\n                        }}>\r\n                            {HERO_LIST.map(hero => (\r\n                                <div\r\n                                    key={hero.id}\r\n                                    onClick={() => setSelected(hero)}\r\n                                    style={{\r\n                                        background: selected?.id === hero.id\r\n                                            ? hero.gradient\r\n                                            : 'rgba(255,255,255,0.04)',\r\n                                        border: selected?.id === hero.id\r\n                                            ? `2px solid ${hero.color}`\r\n                                            : '2px solid rgba(255,255,255,0.07)',\r\n                                        borderRadius: '16px',\r\n                                        padding: '18px 14px',\r\n                                        cursor: 'pointer',\r\n                                        textAlign: 'center',\r\n                                        transition: 'all 0.25s ease',\r\n                                        boxShadow: selected?.id === hero.id\r\n                                            ? `0 8px 30px ${hero.shadow}`\r\n                                            : 'none',\r\n                                        transform: selected?.id === hero.id ? 'translateY(-3px)' : 'none'\r\n                                    }}\r\n                                >\r\n                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>{hero.emoji}</div>\r\n                                    <div style={{\r\n                                        color: '#fff', fontWeight: '800', fontSize: '15px', marginBottom: '4px'\r\n                                    }}>{hero.name}</div>\r\n                                    <div style={{\r\n                                        color: 'rgba(255,255,255,0.7)', fontSize: '10px',\r\n                                        fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px'\r\n                                    }}>{hero.trait}</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n\r\n                        {/* Next Button */}\r\n                        <button\r\n                            onClick={() => selected && setStep('confirm')}\r\n                            disabled={!selected}\r\n                            style={{\r\n                                width: '100%', padding: '16px',\r\n                                background: selected ? selected.gradient : 'rgba(255,255,255,0.1)',\r\n                                border: 'none', borderRadius: '14px',\r\n                                color: '#fff', fontWeight: '800', fontSize: '15px',\r\n                                cursor: selected ? 'pointer' : 'default',\r\n                                opacity: selected ? 1 : 0.5,\r\n                                transition: 'all 0.3s ease',\r\n                                boxShadow: selected ? `0 8px 25px ${selected?.shadow}` : 'none'\r\n                            }}\r\n                        >\r\n                            {selected ? `Select ${selected.name} ΓåÆ` : 'Select Your Path First'}\r\n                        </button>\r\n                    </>\r\n                )}\r\n\r\n                {step === 'confirm' && selected && (\r\n                    <>\r\n                        {/* Hero Detail View */}\r\n                        <div style={{ textAlign: 'center', marginBottom: '24px' }}>\r\n                            <div style={{\r\n                                width: '80px', height: '80px', borderRadius: '50%',\r\n                                background: selected.gradient,\r\n                                display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                                fontSize: '40px', margin: '0 auto 16px',\r\n                                boxShadow: `0 12px 35px ${selected.shadow}`\r\n                            }}>{selected.emoji}</div>\r\n                            <h2 style={{ color: '#fff', fontSize: '24px', fontWeight: '900', margin: '0 0 4px' }}>\r\n                                The {selected.title}\r\n                            </h2>\r\n                            <div style={{\r\n                                display: 'inline-block',\r\n                                background: selected.gradient,\r\n                                color: '#fff', fontWeight: '700',\r\n                                fontSize: '11px', padding: '4px 12px',\r\n                                borderRadius: '20px', marginBottom: '16px',\r\n                                textTransform: 'uppercase', letterSpacing: '1px'\r\n                            }}>{selected.trait}</div>\r\n                            <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: '14px', lineHeight: '1.6' }}>\r\n                                {selected.description}\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Qualities */}\r\n                        <div style={{\r\n                            background: 'rgba(255,255,255,0.04)',\r\n                            borderRadius: '14px', padding: '16px',\r\n                            marginBottom: '16px'\r\n                        }}>\r\n                            <p style={{\r\n                                color: 'rgba(255,255,255,0.4)', fontSize: '11px', fontWeight: '700',\r\n                                textTransform: 'uppercase', letterSpacing: '1px', margin: '0 0 10px'\r\n                            }}>\r\n                                Your Core Qualities\r\n                            </p>\r\n                            {selected.qualities.map((q, i) => (\r\n                                <div key={i} style={{\r\n                                    color: '#fff', fontSize: '13px', padding: '6px 0',\r\n                                    borderBottom: i < selected.qualities.length - 1 ? '1px solid rgba(255,255,255,0.07)' : 'none'\r\n                                }}>{q}</div>\r\n                            ))}\r\n                        </div>\r\n\r\n                        {/* AI Style */}\r\n                        <div style={{\r\n                            background: `linear-gradient(135deg, ${selected.color}22, ${selected.color}11)`,\r\n                            border: `1px solid ${selected.color}44`,\r\n                            borderRadius: '14px', padding: '14px',\r\n                            marginBottom: '20px'\r\n                        }}>\r\n                            <p style={{\r\n                                color: 'rgba(255,255,255,0.5)', fontSize: '10px', fontWeight: '700',\r\n                                textTransform: 'uppercase', letterSpacing: '1px', margin: '0 0 6px'\r\n                            }}>\r\n                                ≡ƒñû Your AI Will Teach You Like...\r\n                            </p>\r\n                            <p style={{ color: '#fff', fontSize: '13px', lineHeight: '1.6', margin: 0 }}>\r\n                                {selected.aiStyle}\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Quote */}\r\n                        <div style={{ textAlign: 'center', marginBottom: '24px' }}>\r\n                            <p style={{\r\n                                color: 'rgba(255,255,255,0.4)', fontSize: '12px',\r\n                                fontStyle: 'italic', margin: 0\r\n                            }}>{selected.quote}</p>\r\n                        </div>\r\n\r\n                        {/* Action Buttons */}\r\n                        <div style={{ display: 'flex', gap: '10px' }}>\r\n                            <button\r\n                                onClick={() => setStep('choose')}\r\n                                style={{\r\n                                    flex: 1, padding: '14px',\r\n                                    background: 'rgba(255,255,255,0.07)',\r\n                                    border: '1px solid rgba(255,255,255,0.1)',\r\n                                    borderRadius: '12px', color: '#fff',\r\n                                    fontWeight: '700', cursor: 'pointer', fontSize: '14px'\r\n                                }}\r\n                            >ΓåÉ Go Back</button>\r\n                            <button\r\n                                onClick={handleConfirm}\r\n                                disabled={saving}\r\n                                style={{\r\n                                    flex: 2, padding: '14px',\r\n                                    background: selected.gradient,\r\n                                    border: 'none', borderRadius: '12px',\r\n                                    color: '#fff', fontWeight: '900',\r\n                                    cursor: saving ? 'default' : 'pointer',\r\n                                    fontSize: '15px',\r\n                                    boxShadow: `0 8px 25px ${selected.shadow}`,\r\n                                    opacity: saving ? 0.7 : 1\r\n                                }}\r\n                            >\r\n                                {saving ? 'ΓÅ│ Saving...' : `Γ£à I am ${selected.name}`}\r\n                            </button>\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\Header.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'language' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"language"},"fix":{"range":[615,625],"text":""},"desc":"Remove unused variable 'language'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'toggleLanguage' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"toggleLanguage"},"fix":{"range":[625,641],"text":""},"desc":"Remove unused variable 'toggleLanguage'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'toggleDesktopMode' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":27,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"toggleDesktopMode"},"fix":{"range":[1144,1658],"text":""},"desc":"Remove unused variable 'toggleDesktopMode'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { useTheme } from '../context/ThemeContext';\r\nimport { useLanguage } from '../context/LanguageContext';\r\nimport LanguageSelector from './LanguageSelector';\r\nimport { auth, db } from '../firebase';\r\nimport { collection, query, where, getDocs } from 'firebase/firestore';\r\nimport logo from '../assets/logo.png';\r\n\r\nexport default function Header({ onToggleSidebar }) {\r\n    const { userData } = useUser();\r\n    const { theme, toggleTheme } = useTheme();\r\n    const { t, language, toggleLanguage } = useLanguage();\r\n    const navigate = useNavigate();\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [menuOpen, setMenuOpen] = useState(false);\r\n    const [isSearchMode, setIsSearchMode] = useState(false); // YouTube-style search toggle\r\n    const [desktopMode, setDesktopMode] = useState(false);\r\n\r\n    const handleLogout = () => {\r\n        if (window.confirm(\"Are you sure you want to logout?\")) {\r\n            auth.signOut().then(() => navigate('/'));\r\n        }\r\n    };\r\n\r\n    const toggleDesktopMode = () => {\r\n        const metaViewport = document.querySelector('meta[name=viewport]');\r\n        if (!desktopMode) {\r\n            // Switch to Desktop\r\n            metaViewport.setAttribute('content', 'width=1024');\r\n            setDesktopMode(true);\r\n        } else {\r\n            // Switch back to Mobile/Responsive\r\n            metaViewport.setAttribute('content', 'width=device-width, initial-scale=1');\r\n            setDesktopMode(false);\r\n        }\r\n        setMenuOpen(false);\r\n    };\r\n\r\n    const [suggestions, setSuggestions] = useState([]);\r\n\r\n    const handleSuggestionClick = (item) => {\r\n        setIsSearchMode(false);\r\n        setSearchTerm('');\r\n        navigate('/profile-view', { state: { target: item } });\r\n    };\r\n\r\n    // Auto-Search with improved filtering and robust error handling\r\n    React.useEffect(() => {\r\n        if (!searchTerm || searchTerm.length < 2 || !userData) {\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        const delayDebounceFn = setTimeout(async () => {\r\n            const lowerTerm = searchTerm.toLowerCase();\r\n            let results = [];\r\n            const uniqueResults = new Map();\r\n\r\n            try {\r\n                // Determine Institution ID\r\n                // 1. If I am Institution -> My UID\r\n                // 2. If I am Student/Teacher -> My 'institutionId' or 'createdBy'\r\n                const instId = userData.role === 'institution'\r\n                    ? userData.uid\r\n                    : (userData.institutionId || userData.createdBy);\r\n\r\n                console.log(\"Search Context:\", { role: userData.role, instId, term: lowerTerm });\r\n\r\n                if (!instId) {\r\n                    console.warn(\"Search aborted: No Institution ID found for user.\");\r\n                    return;\r\n                }\r\n\r\n                // 1. Fetch Local Matches (Teachers/Students based on role)\r\n                if (userData.role === 'student') {\r\n                    // Student searches for Teachers in their institution\r\n                    const q = query(collection(db, \"teacher_allotments\"), where(\"createdBy\", \"==\", instId));\r\n                    const snap = await getDocs(q);\r\n                    snap.forEach(d => {\r\n                        const data = d.data();\r\n                        const name = data.name || data.teacherName;\r\n                        if (name && name.toLowerCase().includes(lowerTerm)) {\r\n                            // Important: Capture the real userId (teacherId) if available to fetch profile pic later\r\n                            const realId = data.teacherId || data.userId || d.id;\r\n                            uniqueResults.set(realId, { id: realId, ...data, name: name, type: 'Teacher', collection: 'teacher_allotments' });\r\n                        }\r\n                    });\r\n                } else if (userData.role === 'teacher') {\r\n                    // Teacher searches for Students in their institution\r\n                    const q = query(collection(db, \"student_allotments\"), where(\"createdBy\", \"==\", instId));\r\n                    const snap = await getDocs(q);\r\n                    snap.forEach(d => {\r\n                        const data = d.data();\r\n                        const name = data.name || data.studentName;\r\n                        if (name && name.toLowerCase().includes(lowerTerm)) {\r\n                            const realId = data.studentId || data.userId || d.id;\r\n                            uniqueResults.set(realId, { id: realId, ...data, name: name, type: 'Student', collection: 'student_allotments' });\r\n                        }\r\n                    });\r\n                } else if (userData.role === 'institution') {\r\n                    // Institution Search (Both Teachers & Students)\r\n                    // 1. Teachers\r\n                    const qT = query(collection(db, \"teacher_allotments\"), where(\"createdBy\", \"==\", instId));\r\n                    const snapT = await getDocs(qT);\r\n                    snapT.forEach(d => {\r\n                        const data = d.data();\r\n                        if ((data.name || '').toLowerCase().includes(lowerTerm)) {\r\n                            const realId = data.teacherId || data.userId || d.id;\r\n                            uniqueResults.set(realId, { id: realId, ...data, name: data.name || '', type: 'Teacher' });\r\n                        }\r\n                    });\r\n\r\n                    // 2. Students\r\n                    const qS = query(collection(db, \"student_allotments\"), where(\"createdBy\", \"==\", instId));\r\n                    const snapS = await getDocs(qS);\r\n                    snapS.forEach(d => {\r\n                        const data = d.data();\r\n                        if ((data.name || '').toLowerCase().includes(lowerTerm)) {\r\n                            const realId = data.studentId || data.userId || d.id;\r\n                            uniqueResults.set(realId, { id: realId, ...data, name: data.name || '', type: 'Student' });\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // 2. Fetch Global Institutions (Both Students and Teachers can search Institutions)\r\n                // Fetch ALL institutions and filter locally since Firestore 'includes' is partial\r\n                const instQuery = query(collection(db, \"users\"), where(\"role\", \"==\", \"institution\"));\r\n                const instSnap = await getDocs(instQuery);\r\n                instSnap.forEach(d => {\r\n                    const data = d.data();\r\n                    const name = data.institutionName || data.name;\r\n                    if (name && name.toLowerCase().includes(lowerTerm)) {\r\n                        uniqueResults.set(d.id, { id: d.id, ...data, name: name, type: 'Institution', collection: 'users' });\r\n                    }\r\n                });\r\n\r\n                results = Array.from(uniqueResults.values());\r\n                setSuggestions(results.slice(0, 10));\r\n            } catch (e) {\r\n                console.error(\"Search error:\", e);\r\n            }\r\n        }, 500);\r\n\r\n        return () => clearTimeout(delayDebounceFn);\r\n    }, [searchTerm, userData]);\r\n\r\n    // SEARCH MODE HEADER (YouTube Style)\r\n    if (isSearchMode) {\r\n        return (\r\n            <header className=\"app-header header-search-mode\">\r\n                <button\r\n                    onClick={() => { setIsSearchMode(false); setSearchTerm(''); }}\r\n                    className=\"icon-button back-search\"\r\n                >\r\n                    ΓåÉ\r\n                </button>\r\n                <div className=\"search-input-wrapper\">\r\n                    <input\r\n                        autoFocus\r\n                        type=\"text\"\r\n                        placeholder={userData?.role === 'student' ? \"Search Teachers...\" : \"Search Students...\"}\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                        className=\"input-field header-search-input\"\r\n                        autoComplete=\"off\"\r\n                        autoCorrect=\"off\"\r\n                        spellCheck=\"false\"\r\n                    />\r\n                    {searchTerm && (\r\n                        <button onClick={() => setSearchTerm('')} className=\"search-clear\">├ù</button>\r\n                    )}\r\n\r\n                    {/* Suggestions Dropdown */}\r\n                    {suggestions.length > 0 && (\r\n                        <div className=\"search-suggestions-dropdown shadow-lg\">\r\n                            {suggestions.map((item, idx) => (\r\n                                <div\r\n                                    key={idx}\r\n                                    onClick={() => handleSuggestionClick(item)}\r\n                                    className=\"suggestion-item\"\r\n                                >\r\n                                    <div className=\"suggestion-avatar\" style={{ background: item.type === 'Teacher' ? 'var(--primary)' : 'var(--warning)' }}>\r\n                                        {item.name ? item.name.charAt(0).toUpperCase() : '?'}\r\n                                    </div>\r\n                                    <div className=\"suggestion-content\">\r\n                                        <div className=\"suggestion-name\">{item.name}</div>\r\n                                        <div className=\"suggestion-meta\">{item.type} ΓÇó {item.subject || (item.classAssigned ? `Class ${item.classAssigned}` : '')}</div>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </header>\r\n        );\r\n    }\r\n\r\n    // DEFAULT HEADER\r\n    return (\r\n        <header className=\"app-header shadow-sm\">\r\n            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', width: '100%', padding: '0 16px' }}>\r\n                {/* Left: Logo & Menu */}\r\n                <div className=\"header-left\" style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                    <button onClick={onToggleSidebar} className=\"menu-toggle\" aria-label=\"Menu\">\r\n                        <svg viewBox=\"0 0 24 24\" width=\"24\" height=\"24\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                            <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\"></line>\r\n                            <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\"></line>\r\n                            <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\"></line>\r\n                        </svg>\r\n                    </button>\r\n                    <div\r\n                        onClick={() => navigate('/')}\r\n                        className=\"header-brand\"\r\n                        style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}\r\n                    >\r\n                        <img src={logo} alt=\"TTR\" className=\"logo\" style={{ height: '36px', width: 'auto', objectFit: 'contain' }} />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Center: Desktop Search */}\r\n                {window.innerWidth > 768 && (\r\n                    <div className=\"header-center hide-mobile\" style={{ flex: 1, maxWidth: '500px', margin: '0 20px' }}>\r\n                        <div className=\"search-input-wrapper\">\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder={t('search_placeholder') || \"Search students, teachers...\"}\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                                className=\"input-field header-search-input\"\r\n                                style={{ width: '100%', margin: 0 }}\r\n                            />\r\n                            {suggestions.length > 0 && (\r\n                                <div className=\"search-suggestions-dropdown shadow-lg\">\r\n                                    {suggestions.map((item, idx) => (\r\n                                        <div key={idx} onClick={() => handleSuggestionClick(item)} className=\"suggestion-item\">\r\n                                            <div className=\"suggestion-avatar\" style={{ background: item.type === 'Teacher' ? 'var(--primary)' : 'var(--warning)' }}>\r\n                                                {item.name ? item.name.charAt(0).toUpperCase() : '?'}\r\n                                            </div>\r\n                                            <div className=\"suggestion-content\">\r\n                                                <div className=\"suggestion-name\">{item.name}</div>\r\n                                                <div className=\"suggestion-meta\">{item.type} {item.subject ? `ΓÇó ${item.subject}` : ''}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Right: User Menu */}\r\n                <div className=\"header-right\" style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                    <div className=\"dropdown-wrapper\" style={{ position: 'relative' }}>\r\n                        <div\r\n                            onClick={() => setMenuOpen(!menuOpen)}\r\n                            className=\"profile-trigger\"\r\n                            style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '10px' }}\r\n                        >\r\n                            <div className=\"profile-avatar-mini\" style={{ width: '35px', height: '35px', borderRadius: '50%', background: 'var(--primary)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold', boxShadow: '0 2px 10px rgba(108, 92, 231, 0.2)' }}>\r\n                                {userData?.name ? userData.name.charAt(0).toUpperCase() : 'U'}\r\n                            </div>\r\n                            <button className=\"more-toggle\" style={{ background: 'none', border: 'none', color: 'var(--text-main)', padding: 0, display: 'flex', alignItems: 'center' }}>\r\n                                <svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                                    <circle cx=\"12\" cy=\"12\" r=\"1\"></circle>\r\n                                    <circle cx=\"12\" cy=\"5\" r=\"1\"></circle>\r\n                                    <circle cx=\"12\" cy=\"19\" r=\"1\"></circle>\r\n                                </svg>\r\n                            </button>\r\n                        </div>\r\n\r\n                        {menuOpen && (\r\n                            <div className=\"dropdown-menu shadow-lg\" style={{ position: 'absolute', top: '110%', right: 0, background: 'white', borderRadius: '12px', minWidth: '200px', padding: '10px', zIndex: 1000 }}>\r\n                                <div className=\"menu-header\" style={{ padding: '10px', borderBottom: '1px solid #eee', marginBottom: '10px' }}>\r\n                                    <div style={{ fontWeight: 'bold' }}>{userData?.name || 'User'}</div>\r\n                                    <div style={{ fontSize: '11px', color: '#888', textTransform: 'uppercase' }}>{userData?.role}</div>\r\n                                </div>\r\n                                <button onClick={() => { navigate('/settings'); setMenuOpen(false); }} className=\"menu-item\" style={{ ...menuItemStyle }}>ΓÜÖ∩╕Å Settings</button>\r\n                                <button onClick={() => { toggleTheme(); setMenuOpen(false); }} className=\"menu-item\" style={{ ...menuItemStyle }}>\r\n                                    {theme === 'Light' ? '≡ƒîÖ Dark Mode' : 'ΓÿÇ∩╕Å Light Mode'}\r\n                                </button>\r\n                                <div className=\"menu-divider\" style={{ height: '1px', background: '#eee', margin: '10px 0' }} />\r\n                                <button onClick={handleLogout} className=\"menu-item\" style={{ ...menuItemStyle, color: 'var(--error)' }}>≡ƒÜ¬ Logout</button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </header>\r\n    );\r\n}\r\n\r\nconst menuItemStyle = {\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    gap: '10px',\r\n    width: '100%',\r\n    padding: '10px 16px',\r\n    background: 'none',\r\n    border: 'none',\r\n    fontSize: '14px',\r\n    color: 'var(--text-main)',\r\n    cursor: 'pointer',\r\n    textAlign: 'left'\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\LanguageSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\MainLayout.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'userData' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"userData"},"fix":{"range":[361,392],"text":""},"desc":"Remove unused variable 'userData'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'location' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":11,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"location"},"fix":{"range":[398,429],"text":""},"desc":"Remove unused variable 'location'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Outlet, useLocation } from 'react-router-dom';\r\nimport Header from './Header';\r\nimport Sidebar from './Sidebar';\r\nimport { useUser } from '../context/UserContext';\r\nimport BottomNav from './BottomNav';\r\nimport AnnouncementBar from './AnnouncementBar';\r\n\r\nexport default function MainLayout() {\r\n    const { userData } = useUser();\r\n    const location = useLocation();\r\n\r\n    // Sidebar State\r\n    const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 900);\r\n\r\n    // Responsive Sidebar\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            if (window.innerWidth < 900) setIsSidebarOpen(false);\r\n            else setIsSidebarOpen(true);\r\n        };\r\n        window.addEventListener('resize', handleResize);\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n\r\n\r\n\r\n\r\n    return (\r\n        <div className=\"layout-wrapper\">\r\n            {/* 1. Sticky Header */}\r\n            <Header onToggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} />\r\n\r\n            {/* Announcement Bar (Global) - Now pinned below Header */}\r\n            <AnnouncementBar leftIcon={false} />\r\n\r\n            {/* 2. Flex Body */}\r\n            <div className=\"layout-body\">\r\n\r\n                {/* 3. Sidebar (Left) - Desktop Only via CSS */}\r\n                <div className=\"sidebar-wrapper\">\r\n                    <Sidebar isOpen={isSidebarOpen} />\r\n                </div>\r\n\r\n                {/* 4. Main Content (Right) */}\r\n                <main className=\"main-content-area\">\r\n                    <Outlet />\r\n                </main>\r\n            </div>\r\n\r\n            {/* 5. Bottom Nav - Mobile Only via CSS */}\r\n            <div className=\"bottom-nav-wrapper\">\r\n                <BottomNav />\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\ProtectedRoute.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"useEffect"},"fix":{"range":[16,26],"text":""},"desc":"Remove unused variable 'useEffect'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'isOk' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"isOk"},"fix":{"range":[321,325],"text":""},"desc":"Remove unused variable 'isOk'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setIsOk' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"setIsOk"},"fix":{"range":[325,334],"text":""},"desc":"Remove unused variable 'setIsOk'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { Navigate, Outlet, useLocation } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nconst ProtectedRoute = ({ allowedRoles }) => {\r\n    const { user, userData, loading } = useUser();\r\n    const location = useLocation();\r\n    const [isOk, setIsOk] = useState(false);\r\n\r\n    if (loading) {\r\n        return (\r\n            <div style={{ height: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '20px' }}>\r\n                <p>Verifying Access...</p>\r\n                <button\r\n                    onClick={() => {\r\n                        // Force logout via auth and clear session\r\n                        import('../firebase').then(({ auth }) => {\r\n                            auth.signOut();\r\n                            sessionStorage.clear();\r\n                            window.location.href = '/';\r\n                        });\r\n                    }}\r\n                    style={{ padding: '8px 16px', background: '#e74c3c', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}\r\n                >\r\n                    Stuck? Click to Reset\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!user) {\r\n        return <Navigate to=\"/\" replace />;\r\n    }\r\n\r\n    if (!userData) {\r\n        // Technically logged in but no data (maybe network slow or detail setup pending)\r\n        // If really no data, maybe send to Details? But usually UserContext handles loading until it's sure.\r\n        // Let's assume if loading is false and no userData, they need setup.\r\n        // However, if they just signed up, they might be here.\r\n        return <Navigate to=\"/details\" replace />;\r\n    }\r\n\r\n    // Role Check (Case Insensitive)\r\n    // Role Check (Case Insensitive & Trimmed)\r\n    const userRole = (userData.role || '').toLowerCase().trim();\r\n    if (!userRole) {\r\n        console.warn(\"ProtectedRoute: No role found in userData\", userData);\r\n        return <Navigate to=\"/details\" replace />;\r\n    }\r\n\r\n    const isAuthorized = allowedRoles.some(r => r.toLowerCase().trim() === userRole);\r\n\r\n    if (allowedRoles && !isAuthorized) {\r\n        // Unauthorized. \r\n        console.warn(`Access Denied: User role '${userRole}' is not authorized. Allowed: [${allowedRoles.join(', ')}]`);\r\n        console.log(\"Debug UserData:\", userData);\r\n        return <Navigate to=\"/access-denied\" replace />;\r\n    }\r\n\r\n    // APPROVAL CHECK (Bug Fix)\r\n    // If they are allowed by role, but NOT approved yet, send to pending.\r\n    // SECURE FIX: Check explicitly for !== true to catch undefined/null cases\r\n    if ((userData.role === 'student' || userData.role === 'teacher') && userData.approved !== true) {\r\n        return <Navigate to=\"/pending-approval\" replace />;\r\n    }\r\n\r\n    // ONBOARDING CHECK (Verified via Firestore/Context)\r\n    // If user is logged in but hasn't done setup, send to Onboarding\r\n    // Exception: If already there, allow it.\r\n    if (!userData.onboardingCompleted && location.pathname !== '/onboarding') {\r\n        return <Navigate to=\"/onboarding\" replace />;\r\n    }\r\n\r\n    return <Outlet />;\r\n};\r\n\r\nexport default ProtectedRoute;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\Sidebar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\SmartAdmission.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\SmartMarksScan.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\SplashScreen.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'onFinish' is defined but never used.","line":3,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"onFinish"},"fix":{"range":[92,104],"text":""},"desc":"Remove unused variable 'onFinish'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\n\r\nexport default function SplashScreen({ onFinish }) {\r\n    const [step, setStep] = useState(0);\r\n\r\n    useEffect(() => {\r\n        // Timeline of animation\r\n        // 0ms: Start (Middle T visible)\r\n        // 500ms: T and R start moving out\r\n        // 1500ms: TTR fully placed\r\n        // 1500ms: Tagline starts entering\r\n        // 2500ms: Animation Complete\r\n\r\n        const timer1 = setTimeout(() => setStep(1), 500); // Start spreading\r\n        const timer2 = setTimeout(() => setStep(2), 1500); // Tagline enters\r\n\r\n        // Optional: If we want to guarantee the splash shows for a min time\r\n        // The parent (UserContext) controls removal, but we can animate nicely.\r\n\r\n        return () => {\r\n            clearTimeout(timer1);\r\n            clearTimeout(timer2);\r\n        };\r\n    }, []);\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n            background: '#ffffff', display: 'flex', flexDirection: 'column',\r\n            alignItems: 'center', justifyContent: 'center', zIndex: 9999\r\n        }}>\r\n            <div style={{ position: 'relative', height: '100px', width: '300px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>\r\n\r\n                {/* Left T */}\r\n                <h1 style={{\r\n                    position: 'absolute',\r\n                    fontSize: '80px', margin: 0, color: '#1a73e8',\r\n                    opacity: step >= 1 ? 1 : 0,\r\n                    transform: step >= 1 ? 'translateX(-60px)' : 'translateX(0)',\r\n                    transition: 'all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)'\r\n                }}>T</h1>\r\n\r\n                {/* Middle T (Anchor) */}\r\n                <h1 style={{\r\n                    position: 'absolute',\r\n                    fontSize: '80px', margin: 0, color: '#1a73e8',\r\n                    zIndex: 2\r\n                }}>T</h1>\r\n\r\n                {/* Right R */}\r\n                <h1 style={{\r\n                    position: 'absolute',\r\n                    fontSize: '80px', margin: 0, color: '#1a73e8',\r\n                    opacity: step >= 1 ? 1 : 0,\r\n                    transform: step >= 1 ? 'translateX(60px)' : 'translateX(0)',\r\n                    transition: 'all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)'\r\n                }}>R</h1>\r\n\r\n            </div>\r\n\r\n            {/* Tagline */}\r\n            <div style={{\r\n                overflow: 'hidden', height: '40px', marginTop: '10px',\r\n                display: 'flex', alignItems: 'center'\r\n            }}>\r\n                <p style={{\r\n                    fontSize: '18px', color: '#5f6368', letterSpacing: '2px', textTransform: 'uppercase',\r\n                    transform: step >= 2 ? 'translateX(0)' : 'translateX(100%)',\r\n                    opacity: step >= 2 ? 1 : 0,\r\n                    transition: 'all 0.8s ease-out'\r\n                }}>\r\n                    for a right future\r\n                </p>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\UpdateManager.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"useEffect"},"fix":{"range":[16,26],"text":""},"desc":"Remove unused variable 'useEffect'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'useState' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"useState"},"fix":{"range":[25,35],"text":""},"desc":"Remove unused variable 'useState'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\n\r\nexport default function UpdateManager() {\r\n    // Temporarily disabled to fix deployment crash\r\n    return null;\r\n\r\n    /* DISABLED CODE - Will re-enable after cache clears\r\n    const [updateAvailable, setUpdateAvailable] = useState(false);\r\n    const [versionDetails, setVersionDetails] = useState({ latest: '', current: '' });\r\n\r\n    useEffect(() => {\r\n        const checkVersion = async () => {\r\n            try {\r\n                const res = await fetch('/version.json?t=' + Date.now(), { cache: \"no-store\" });\r\n                if (!res.ok) return;\r\n                const data = await res.json();\r\n                const latestVersion = (data.version || '').trim();\r\n                const currentVersion = (localStorage.getItem('ttr_version') || '').trim();\r\n\r\n                setVersionDetails({ latest: latestVersion, current: currentVersion });\r\n\r\n                // Loop Protection\r\n                const attempts = parseInt(localStorage.getItem('ttr_update_attempts') || '0');\r\n                if (attempts > 3) {\r\n                    console.warn(\"Too many update attempts, suppressing prompt.\");\r\n                    return;\r\n                }\r\n\r\n                if (currentVersion && latestVersion && currentVersion !== latestVersion) {\r\n                    setUpdateAvailable(true);\r\n                } else if (!currentVersion || currentVersion !== latestVersion) {\r\n                    localStorage.setItem('ttr_version', latestVersion);\r\n                    localStorage.removeItem('ttr_update_attempts'); // Reset on success/sync\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Version check failed\", e);\r\n            }\r\n        };\r\n\r\n        checkVersion();\r\n        const interval = setInterval(checkVersion, 5 * 60 * 1000);\r\n        return () => clearInterval(interval);\r\n    }, []);\r\n\r\n    const handleUpdate = async () => {\r\n        const btn = document.getElementById('update-btn-react');\r\n        if (btn) btn.innerText = \"Updating...\";\r\n\r\n        // Increment attempts\r\n        const attempts = parseInt(localStorage.getItem('ttr_update_attempts') || '0');\r\n        localStorage.setItem('ttr_update_attempts', (attempts + 1).toString());\r\n\r\n        try {\r\n            if ('serviceWorker' in navigator) {\r\n                const regs = await navigator.serviceWorker.getRegistrations();\r\n                for (let r of regs) await r.unregister();\r\n            }\r\n            const keys = await caches.keys();\r\n            await Promise.all(keys.map(k => caches.delete(k)));\r\n            localStorage.removeItem('ttr_version');\r\n        } catch (e) { console.error(e); }\r\n\r\n        window.location.href = window.location.origin + \"/?v=\" + Date.now();\r\n    };\r\n\r\n    if (updateAvailable) {\r\n        // Temporarily suppressed UI to prevent crash\r\n        return null;\r\n        \r\n        return (\r\n            <div style={{\r\n                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',\r\n                background: '#2d3436', color: 'white', padding: '15px 25px', borderRadius: '30px',\r\n                boxShadow: '0 10px 30px rgba(0,0,0,0.3)', zIndex: 9999, display: 'flex', alignItems: 'center', gap: '15px',\r\n                flexDirection: 'column'\r\n            }}>\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                    <span>≡ƒÜÇ Update v{versionDetails.latest} Available</span>\r\n                    <button\r\n                        id=\"update-btn-react\"\r\n                        onClick={handleUpdate}\r\n                        style={{\r\n                            background: '#0984e3', border: 'none', color: 'white',\r\n                            padding: '8px 15px', borderRadius: '20px', cursor: 'pointer', fontWeight: 'bold'\r\n                        }}\r\n                    >\r\n                        Update Now\r\n                    </button>\r\n                    <button \r\n                        onClick={() => {\r\n                            setUpdateAvailable(false);\r\n                            // Optional: ignore until next reload\r\n                        }}\r\n                        style={{\r\n                            background: 'transparent', border: '1px solid #aaa', color: '#ccc',\r\n                            width: '30px', height: '30px', borderRadius: '50%', cursor: 'pointer',\r\n                            display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                        }}\r\n                    >\r\n                        Γ£ò\r\n                    </button>\r\n                </div>\r\n                <div style={{ fontSize: '10px', opacity: 0.7 }}>\r\n                    Current: {versionDetails.current || 'Old'}\r\n                </div>\r\n            </div>\r\n        );\r\n        \r\n    }\r\n\r\n    return null;\r\n    */\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\components\\VoiceCommandAssistant.jsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`processCommand` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  37 |                 const text = event.results[0][0].transcript;\n  38 |                 setTranscript(text);\n> 39 |                 processCommand(text);\n     |                 ^^^^^^^^^^^^^^ `processCommand` accessed before it is declared\n  40 |             };\n  41 |\n  42 |             recognition.current.onerror = (event) => {\n\n  187 |\n  188 |     // --- MAIN INTELLIGENCE (GEMINI + REGEX) ---\n> 189 |     const processCommand = async (command) => {\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 190 |         setIsProcessing(true);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 191 |         const lowerCmd = command.toLowerCase();\n      ΓÇª\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 266 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 267 |     };\n      | ^^^^^^^ `processCommand` is declared here\n  268 |\n  269 |\n  270 |","line":39,"column":17,"nodeType":null,"endLine":39,"endColumn":31},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":182,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":182,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport jsPDF from 'jspdf';\r\nimport 'jspdf-autotable';\r\nimport { useUser } from '../context/UserContext';\r\nimport { auth } from '../firebase';\r\nimport axios from 'axios';\r\n\r\nconst API_BASE = 'https://together-to-refine.vercel.app';\r\n\r\n// WEB SPEECH API COMPATIBILITY\r\nconst SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\r\n\r\nexport default function VoiceCommandAssistant({ onAnnouncement }) {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    // States\r\n    const [isListening, setIsListening] = useState(false);\r\n    const [transcript, setTranscript] = useState('');\r\n    const [isProcessing, setIsProcessing] = useState(false);\r\n    const [responseMessage, setResponseMessage] = useState(null);\r\n    const recognition = useRef(null);\r\n\r\n    // Initialize Recognition\r\n    useEffect(() => {\r\n        if (SpeechRecognition) {\r\n            recognition.current = new SpeechRecognition();\r\n            recognition.current.continuous = false;\r\n            recognition.current.lang = 'en-IN'; // Default to Indian English, catches Hindi words too often\r\n            recognition.current.interimResults = false;\r\n\r\n            recognition.current.onstart = () => setIsListening(true);\r\n            recognition.current.onend = () => setIsListening(false);\r\n\r\n            recognition.current.onresult = (event) => {\r\n                const text = event.results[0][0].transcript;\r\n                setTranscript(text);\r\n                processCommand(text);\r\n            };\r\n\r\n            recognition.current.onerror = (event) => {\r\n                console.error(\"Voice Error:\", event.error);\r\n                setIsListening(false);\r\n                setResponseMessage(\"ΓÜá∩╕Å Could not hear you. Try again.\");\r\n                setTimeout(() => setResponseMessage(null), 3000);\r\n            };\r\n        } else {\r\n            console.warn(\"Speech Recognition not supported in this browser.\");\r\n        }\r\n    }, []);\r\n\r\n    const toggleListening = () => {\r\n        if (!SpeechRecognition) {\r\n            alert(\"Voice features rely on Web Speech API (Chrome/Edge/Safari). Please use a supported browser.\");\r\n            return;\r\n        }\r\n\r\n        if (isListening) {\r\n            recognition.current.stop();\r\n        } else {\r\n            setTranscript(\"Listening...\");\r\n            setResponseMessage(null);\r\n            recognition.current.start();\r\n        }\r\n    };\r\n\r\n    const resetUI = (msg) => {\r\n        setResponseMessage(msg);\r\n        setIsProcessing(false);\r\n        setTimeout(() => {\r\n            setTranscript('');\r\n            setResponseMessage(null);\r\n        }, 2500);\r\n    };\r\n\r\n    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);\r\n\r\n    const generatePDF = (data) => {\r\n        const doc = new jsPDF();\r\n\r\n        // Header\r\n        doc.setFontSize(18);\r\n        doc.text(userData?.institutionName || \"School Test\", 105, 15, { align: 'center' });\r\n        doc.setFontSize(14);\r\n        doc.text(data.title || \"Class Test\", 105, 25, { align: 'center' });\r\n        doc.setFontSize(10);\r\n        doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });\r\n\r\n        // Questions\r\n        let y = 45;\r\n        doc.setFontSize(11);\r\n\r\n        data.questions.forEach((q, i) => {\r\n            if (y > 270) { doc.addPage(); y = 20; }\r\n\r\n            // Question Text\r\n            const qTitle = `${i + 1}. ${q.q}`;\r\n            doc.setFont('helvetica', 'bold');\r\n            const splitTitle = doc.splitTextToSize(qTitle, 170);\r\n            doc.text(splitTitle, 15, y);\r\n            y += (splitTitle.length * 6) + 2;\r\n\r\n            // Options\r\n            doc.setFont('helvetica', 'normal');\r\n            q.options.forEach((opt, idx) => {\r\n                doc.text(`   ${String.fromCharCode(97 + idx)}) ${opt}`, 15, y);\r\n                y += 6;\r\n            });\r\n            y += 4; // Spacing between questions\r\n        });\r\n\r\n        doc.save(\"Generated_Test.pdf\");\r\n    };\r\n\r\n    // INTENT 1: GENERATE TEST PAPER\r\n    const handleTestGeneration = async (prompt) => {\r\n        setResponseMessage(\"≡ƒñû AI is writing the test paper...\");\r\n\r\n        try {\r\n            // Call Backend to generate structured JSON for the test\r\n            const systemPrompt = `\r\n                You are a Teacher's Assistant. The user wants a test paper.\r\n                Extract the Subject, Topic, Class, and Number of Questions from: \"${prompt}\".\r\n                If missing, assume General Knowledge, 5 questions.\r\n                \r\n                OUTPUT JSON ONLY:\r\n                {\r\n                    \"title\": \"Class Test: [Topic]\",\r\n                    \"questions\": [\r\n                        { \"q\": \"Question text\", \"options\": [\"A\", \"B\", \"C\", \"D\"], \"correct\": \"A\" }\r\n                    ]\r\n                }\r\n            `;\r\n\r\n            // Use existing generic chat endpoint but with high temp for creativity\r\n            const token = await auth.currentUser?.getIdToken();\r\n            // Note: In real app, we should use a dedicated endpoint or secure token. \r\n            // Assuming we have a helper or can direct fetch.\r\n            // Using the /api/chat endpoint from server.js\r\n\r\n            const res = await axios.post(`${API_BASE}/api/chat`, {\r\n                message: prompt,\r\n                // userContext: removed to force use of systemInstruction for JSON output\r\n                systemInstruction: systemPrompt\r\n            }, {\r\n                headers: { 'Authorization': `Bearer ${token}` }\r\n            });\r\n\r\n            const text = res.data.text;\r\n            // Clean markdown code blocks if present\r\n            const jsonStr = text.replace(/```json|```/g, '').trim();\r\n            const data = JSON.parse(jsonStr);\r\n\r\n            generatePDF(data);\r\n            resetUI(\"Γ£à Test Paper Downloaded!\");\r\n\r\n        } catch (e) {\r\n            console.error(e);\r\n            setResponseMessage(\"Γ¥î AI Error. Please try again.\");\r\n            setIsProcessing(false);\r\n        }\r\n    };\r\n\r\n    // INTENT 2: GENERAL EXPLANATION / TRANSLATION\r\n    const handleGeneralQuery = async (prompt) => {\r\n        setResponseMessage(\"≡ƒñö Thinking...\");\r\n        try {\r\n            const token = await auth.currentUser?.getIdToken();\r\n            const res = await axios.post(`${API_BASE}/api/chat`, {\r\n                message: prompt,\r\n                userContext: { role: 'teacher', name: userData.name },\r\n                // Allow the server's default \"Teacher\" persona to handler it, which interprets pedagogical questions well\r\n            }, {\r\n                headers: { 'Authorization': `Bearer ${token}` }\r\n            });\r\n\r\n            // For now, just show the result in an alert or small modal. \r\n            // Ideally we'd have a chat bubble, but this is a \"Command\" interface.\r\n            alert(`AI Response:\\n\\n${res.data.text}`);\r\n            resetUI(\"Done.\");\r\n        } catch (e) {\r\n            setResponseMessage(\"Error.\");\r\n            setIsProcessing(false);\r\n        }\r\n    };\r\n\r\n    // --- MAIN INTELLIGENCE (GEMINI + REGEX) ---\r\n    const processCommand = async (command) => {\r\n        setIsProcessing(true);\r\n        const lowerCmd = command.toLowerCase();\r\n\r\n        // 1. SIMPLE NAVIGATION COMMANDS (Instant)\r\n        if (lowerCmd.includes(\"attendance\")) {\r\n            navigate('/attendance');\r\n            resetUI(\"Opening Attendance...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"timetable\") || lowerCmd.includes(\"schedule\") || lowerCmd.includes(\"my class\")) {\r\n            navigate('/timetable');\r\n            resetUI(\"Opening Timetable...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"video\") || lowerCmd.includes(\"library\") || lowerCmd.includes(\"movie\")) {\r\n            navigate('/video-library');\r\n            resetUI(\"Opening Video Library...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"marks\") || lowerCmd.includes(\"result\") || lowerCmd.includes(\"score\")) {\r\n            navigate('/marks');\r\n            resetUI(\"Opening Marks Management...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"group\") || lowerCmd.includes(\"students\") || lowerCmd.includes(\"my class\")) {\r\n            navigate('/group');\r\n            resetUI(\"Opening Class Groups...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"homework\") || lowerCmd.includes(\"assignment\")) {\r\n            navigate('/homework');\r\n            resetUI(\"Opening Homework...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"analytic\") || lowerCmd.includes(\"report\") || lowerCmd.includes(\"progress\")) {\r\n            navigate('/analytics');\r\n            resetUI(\"Opening Analytics...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"feedback\") || lowerCmd.includes(\"comment\")) {\r\n            navigate('/general-feedback');\r\n            resetUI(\"Opening Feedback...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"exam\") || lowerCmd.includes(\"seating\")) {\r\n            navigate('/view-exam-seating');\r\n            resetUI(\"Opening Exam Seating...\");\r\n            return;\r\n        }\r\n        if (lowerCmd.includes(\"scan\") || lowerCmd.includes(\"digitize\") || lowerCmd.includes(\"paper\")) {\r\n            navigate('/universal-scanner');\r\n            resetUI(\"Opening AI Scanner...\");\r\n            return;\r\n        }\r\n\r\n        // 2. COMPLEX GENERATIVE COMMANDS (AI Powered)\r\n        // Check for specific intents\r\n        if (lowerCmd.includes(\"test\") || lowerCmd.includes(\"paper\") || lowerCmd.includes(\"quiz\")) {\r\n            await handleTestGeneration(command);\r\n        } else if (lowerCmd.includes(\"announce\") || lowerCmd.includes(\"message\") || lowerCmd.includes(\"tell the class\")) {\r\n            // Extract message content roughly\r\n            const msg = command.replace(/announce|announcement|send message|tell class|tell the class/gi, \"\").trim();\r\n            if (onAnnouncement && msg) {\r\n                onAnnouncement(capitalize(msg));\r\n                resetUI(\"Drafting Announcement...\");\r\n            } else {\r\n                setResponseMessage(\"≡ƒôó Say: 'Announce tomorrow is a holiday'\");\r\n                setIsProcessing(false);\r\n            }\r\n        } else if (lowerCmd.includes(\"explain\") || lowerCmd.includes(\"what is\") || lowerCmd.includes(\"how to\")) {\r\n            // Priority to general queries for \"Explain...\"\r\n            await handleGeneralQuery(command);\r\n        } else {\r\n            // Fallback: Try to find a route anyway\r\n            setResponseMessage(\"≡ƒñö Searching for that page...\");\r\n            setIsProcessing(false);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    return (\r\n        <>\r\n            {/* FLOATING ACTION BUTTON */}\r\n            <button\r\n                onClick={toggleListening}\r\n                style={{\r\n                    position: 'fixed', bottom: '90px', right: '20px',\r\n                    width: '60px', height: '60px', borderRadius: '50%',\r\n                    background: isListening ? '#ff4757' : '#2ed573',\r\n                    color: 'white', border: 'none',\r\n                    boxShadow: '0 4px 15px rgba(0,0,0,0.3)',\r\n                    zIndex: 9999, cursor: 'pointer',\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                    fontSize: '24px', transition: 'all 0.3s'\r\n                }}\r\n            >\r\n                {isListening ? '≡ƒ¢æ' : '≡ƒÄÖ∩╕Å'}\r\n            </button>\r\n\r\n            {/* STATUS OVERLAY */}\r\n            {(isListening || responseMessage || transcript) && (\r\n                <div style={{\r\n                    position: 'fixed', bottom: '160px', right: '20px',\r\n                    background: 'white', padding: '15px', borderRadius: '15px',\r\n                    boxShadow: '0 5px 20px rgba(0,0,0,0.15)',\r\n                    maxWidth: '300px', zIndex: 1999,\r\n                    border: '1px solid #eee',\r\n                    animation: 'slideUp 0.3s ease-out'\r\n                }}>\r\n                    <h4 style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#636e72' }}>\r\n                        {isProcessing ? 'ΓÜí AI Processing...' : (isListening ? '≡ƒæé Listening...' : 'Γ£à Assistant')}\r\n                    </h4>\r\n\r\n                    <p style={{ margin: 0, fontSize: '16px', fontWeight: 'bold', color: '#2d3436' }}>\r\n                        {responseMessage || transcript || \"Speak now...\"}\r\n                    </p>\r\n\r\n                    {!SpeechRecognition && (\r\n                        <p style={{ color: 'red', fontSize: '10px' }}>Browser not supported.</p>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            <style>{`\r\n                @keyframes slideUp {\r\n                    from { transform: translateY(20px); opacity: 0; }\r\n                    to { transform: translateY(0); opacity: 1; }\r\n                }\r\n            `}</style>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\context\\LanguageContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":39,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":39,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { createContext, useContext, useState, useEffect } from 'react';\r\nimport { resources } from '../translations/resources';\r\n\r\nconst LanguageContext = createContext();\r\n\r\nexport const LanguageProvider = ({ children }) => {\r\n    // Default to 'en' (English), but load from localStorage if available\r\n    const [language, setLanguage] = useState(localStorage.getItem('ttr_language') || 'en');\r\n\r\n    useEffect(() => {\r\n        localStorage.setItem('ttr_language', language);\r\n        // Optionally update <html> lang attribute for accessibility\r\n        document.documentElement.lang = language;\r\n    }, [language]);\r\n\r\n    const toggleLanguage = () => {\r\n        // Updated to cycle through languages or be replaced by setLanguage\r\n        setLanguage((prev) => (prev === 'en' ? 'hi' : 'en'));\r\n    };\r\n\r\n    // Explicit setter for dropdowns\r\n    const setLanguageOverride = (langCode) => {\r\n        setLanguage(langCode);\r\n    };\r\n\r\n    // Helper translation function with Fallback to English\r\n    const t = (key) => {\r\n        return resources[language]?.translation[key] || resources['en']?.translation[key] || key;\r\n    };\r\n\r\n    return (\r\n        <LanguageContext.Provider value={{ language, toggleLanguage, setLanguageOverride, t }}>\r\n            {children}\r\n        </LanguageContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useLanguage = () => useContext(LanguageContext);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\context\\PWAContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":5,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":5,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect } from 'react';\r\n\r\nconst PWAContext = createContext();\r\n\r\nexport const usePWA = () => useContext(PWAContext);\r\n\r\nexport const PWAProvider = ({ children }) => {\r\n    const [installPrompt, setInstallPrompt] = useState(null);\r\n\r\n    useEffect(() => {\r\n        const handler = (e) => {\r\n            // Prevent the mini-infobar from appearing on mobile\r\n            e.preventDefault();\r\n            // Stash the event so it can be triggered later.\r\n            setInstallPrompt(e);\r\n            console.log('PWA Install Triggered', e);\r\n        };\r\n\r\n        window.addEventListener('beforeinstallprompt', handler);\r\n\r\n        return () => window.removeEventListener('beforeinstallprompt', handler);\r\n    }, []);\r\n\r\n    const promptInstall = async () => {\r\n        if (!installPrompt) {\r\n            console.log('Installation prompt not available');\r\n            return;\r\n        }\r\n\r\n        // Show the install prompt\r\n        installPrompt.prompt();\r\n\r\n        // Wait for the user to respond to the prompt\r\n        const { outcome } = await installPrompt.userChoice;\r\n        console.log(`User response to the install prompt: ${outcome}`);\r\n\r\n        // We've used the prompt, and can't use it again, discard it\r\n        setInstallPrompt(null);\r\n    };\r\n\r\n    return (\r\n        <PWAContext.Provider value={{ installPrompt, promptInstall }}>\r\n            {children}\r\n        </PWAContext.Provider>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\context\\ThemeContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":5,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":5,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect } from 'react';\r\n\r\nconst ThemeContext = createContext();\r\n\r\nexport const useTheme = () => useContext(ThemeContext);\r\n\r\nexport const ThemeProvider = ({ children }) => {\r\n    // Default to light, or read from local storage\r\n    const [theme, setTheme] = useState(() => {\r\n        const savedTheme = localStorage.getItem('app-theme');\r\n        return savedTheme || 'Light';\r\n    });\r\n\r\n    useEffect(() => {\r\n        // Update the data-theme attribute on the root element\r\n        document.documentElement.setAttribute('data-theme', theme);\r\n        localStorage.setItem('app-theme', theme);\r\n    }, [theme]);\r\n\r\n    const toggleTheme = () => {\r\n        setTheme(prevTheme => prevTheme === 'Light' ? 'Dark' : 'Light');\r\n    };\r\n\r\n    return (\r\n        <ThemeContext.Provider value={{ theme, toggleTheme }}>\r\n            {children}\r\n        </ThemeContext.Provider>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\context\\UserContext.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":153,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":31},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":153,"column":33,"nodeType":"BlockStatement","messageId":"unexpected","endLine":153,"endColumn":36,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[7524,7525],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":170,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":170,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"err"},"fix":{"range":[8534,8537],"text":""},"desc":"Remove unused variable 'err'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'handleLogout' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":197,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":197,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleLogout"},"fix":{"range":[9392,9521],"text":""},"desc":"Remove unused variable 'handleLogout'."}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":210,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":210,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect } from 'react';\r\nimport { auth, db } from '../firebase';\r\nimport { onAuthStateChanged } from 'firebase/auth';\r\nimport { doc, getDoc, onSnapshot } from 'firebase/firestore';\r\nimport { registerSession, clearLocalSession } from '../utils/sessionManager';\r\n\r\nconst UserContext = createContext();\r\n\r\nexport function UserProvider({ children }) {\r\n    const [user, setUser] = useState(null);\r\n    const [userData, setUserData] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    // Helper to update state and cache consistently\r\n    const updateUserData = React.useCallback((data) => {\r\n        if (!data) return;\r\n        console.log(\"Context: Updating User Data\", data.role);\r\n        setUserData(data);\r\n        try {\r\n            sessionStorage.setItem('user_profile_cache', JSON.stringify(data));\r\n        } catch (e) {\r\n            console.warn(\"Storage update failed\", e);\r\n        }\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        let unsubscribeSnapshot = null;\r\n        let unsubscribeSession = null;\r\n        let retryCount = 0;\r\n        const MAX_RETRIES = 3;\r\n\r\n        console.log(\"UserContext: Initializing Auth Listener...\");\r\n\r\n        // Failsafe: Force stop loading after 6 seconds\r\n        const failsafe = setTimeout(() => {\r\n            setLoading((prev) => {\r\n                if (prev) {\r\n                    console.warn(\"UserContext: Force clearing loading state due to timeout.\");\r\n                    return false;\r\n                }\r\n                return prev;\r\n            });\r\n        }, 6000);\r\n\r\n        const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {\r\n            console.log(\"Auth State Changed:\", currentUser ? `Logged In [${currentUser.uid}]` : \"Logged Out\");\r\n            setUser(currentUser);\r\n\r\n            // Cleanup\r\n            if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot = null; }\r\n            if (unsubscribeSession) { unsubscribeSession(); unsubscribeSession = null; }\r\n\r\n            if (currentUser) {\r\n                setLoading(true);\r\n\r\n                // CRITICAL: Check if running in Mock Mode\r\n                if (db.type === 'mock') {\r\n                    setUserData(null);\r\n                    setLoading(false);\r\n                    return;\r\n                }\r\n\r\n                // Session Management\r\n                registerSession(currentUser.uid).then((sessionId) => {\r\n                    if (sessionId) {\r\n                        const sessionRef = doc(db, 'users', currentUser.uid, 'sessions', sessionId);\r\n                        unsubscribeSession = onSnapshot(sessionRef, (docSnap) => {\r\n                            if (!docSnap.exists()) {\r\n                                auth.signOut().then(() => {\r\n                                    clearLocalSession();\r\n                                    alert(\"Session expired/revoked.\");\r\n                                });\r\n                            }\r\n                        });\r\n                    }\r\n                }).catch(e => console.error(\"Session Error:\", e));\r\n\r\n                // 2. Detection Logic\r\n                const detectFull = async () => {\r\n                    if (retryCount >= MAX_RETRIES) {\r\n                        setUserData(null);\r\n                        setLoading(false);\r\n                        return;\r\n                    }\r\n                    retryCount++;\r\n\r\n                    console.log(`Detecting profile (Attempt ${retryCount})...`);\r\n                    const instRef = doc(db, \"institutions\", currentUser.uid);\r\n                    const teachRef = doc(db, \"teachers\", currentUser.uid);\r\n                    const userRef = doc(db, \"users\", currentUser.uid);\r\n\r\n                    try {\r\n                        const results = await Promise.allSettled([\r\n                            getDoc(instRef),\r\n                            getDoc(teachRef),\r\n                            getDoc(userRef)\r\n                        ]);\r\n\r\n                        const instSnap = results[0].status === 'fulfilled' ? results[0].value : { exists: () => false };\r\n                        const teachSnap = results[1].status === 'fulfilled' ? results[1].value : { exists: () => false };\r\n                        const userSnap = results[2].status === 'fulfilled' ? results[2].value : { exists: () => false };\r\n\r\n                        if (instSnap.exists()) {\r\n                            const data = { ...instSnap.data(), uid: currentUser.uid, role: (instSnap.data().role || 'institution').toLowerCase() };\r\n                            updateUserData(data);\r\n                            setLoading(false);\r\n                            sessionStorage.setItem('user_collection_cache', 'institutions');\r\n\r\n                            unsubscribeSnapshot = onSnapshot(instRef, (d) => {\r\n                                if (!d.exists()) { detectFull(); return; }\r\n                                updateUserData({ ...d.data(), uid: currentUser.uid, role: (d.data().role || 'institution').toLowerCase() });\r\n                            });\r\n                        } else if (teachSnap.exists()) {\r\n                            const data = { ...teachSnap.data(), uid: currentUser.uid, role: (teachSnap.data().role || 'teacher').toLowerCase() };\r\n                            updateUserData(data);\r\n                            setLoading(false);\r\n                            sessionStorage.setItem('user_collection_cache', 'teachers');\r\n\r\n                            unsubscribeSnapshot = onSnapshot(teachRef, (d) => {\r\n                                if (!d.exists()) { detectFull(); return; }\r\n                                updateUserData({ ...d.data(), uid: currentUser.uid, role: (d.data().role || 'teacher').toLowerCase() });\r\n                            });\r\n                        } else if (userSnap.exists()) {\r\n                            const data = { ...userSnap.data(), uid: currentUser.uid, role: (userSnap.data().role || 'student').toLowerCase() };\r\n                            updateUserData(data);\r\n                            setLoading(false);\r\n                            sessionStorage.setItem('user_collection_cache', 'users');\r\n\r\n                            unsubscribeSnapshot = onSnapshot(userRef, (d) => {\r\n                                if (!d.exists()) { detectFull(); return; }\r\n                                updateUserData({ ...d.data(), uid: currentUser.uid, role: (d.data().role || 'student').toLowerCase() });\r\n                            });\r\n                        } else {\r\n                            console.log(\"No profile found.\");\r\n                            setUserData(null);\r\n                            setLoading(false);\r\n                        }\r\n                    } catch (e) {\r\n                        console.error(\"Detection Error\", e);\r\n                        setLoading(false);\r\n                    }\r\n                };\r\n\r\n                // --- OPTIMIZATION: Instant Load from Profile Cache ---\r\n                const cachedProfileJSON = sessionStorage.getItem('user_profile_cache');\r\n                if (cachedProfileJSON) {\r\n                    try {\r\n                        const cachedProfile = JSON.parse(cachedProfileJSON);\r\n                        if (cachedProfile && cachedProfile.uid === currentUser.uid) {\r\n                            setUserData(cachedProfile);\r\n                            setLoading(false);\r\n                        }\r\n                    } catch (e) { }\r\n                }\r\n\r\n                // Background Validation\r\n                const cachedCollection = sessionStorage.getItem('user_collection_cache');\r\n                if (cachedCollection) {\r\n                    unsubscribeSnapshot = onSnapshot(doc(db, cachedCollection, currentUser.uid), (d) => {\r\n                        if (d.exists()) {\r\n                            const data = d.data();\r\n                            let role = data.role || (cachedCollection === 'institutions' ? 'institution' : (cachedCollection === 'teachers' ? 'teacher' : 'student'));\r\n                            updateUserData({ ...data, uid: currentUser.uid, role: role.toLowerCase() });\r\n                            setLoading(false);\r\n                        } else {\r\n                            sessionStorage.removeItem('user_collection_cache');\r\n                            sessionStorage.removeItem('user_profile_cache');\r\n                            detectFull();\r\n                        }\r\n                    }, (err) => {\r\n                        if (!cachedProfileJSON) detectFull();\r\n                    });\r\n                } else {\r\n                    detectFull();\r\n                }\r\n\r\n            } else {\r\n                setUserData(null);\r\n                setLoading(false);\r\n                sessionStorage.removeItem('user_collection_cache');\r\n                sessionStorage.removeItem('user_profile_cache');\r\n            }\r\n        });\r\n\r\n        return () => {\r\n            clearTimeout(failsafe);\r\n            unsubscribeAuth();\r\n            if (unsubscribeSnapshot) unsubscribeSnapshot();\r\n            if (unsubscribeSession) unsubscribeSession();\r\n        };\r\n    }, [updateUserData]);\r\n\r\n    const values = React.useMemo(() => ({\r\n        user, userData, loading, setUserData, updateUserData\r\n    }), [user, userData, loading, updateUserData]);\r\n\r\n    const handleLogout = () => {\r\n        auth.signOut();\r\n        sessionStorage.clear();\r\n        window.location.reload();\r\n    };\r\n\r\n    return (\r\n        <UserContext.Provider value={values}>\r\n            {children}\r\n        </UserContext.Provider>\r\n    );\r\n}\r\n\r\nexport function useUser() {\r\n    const context = useContext(UserContext);\r\n    if (!context) {\r\n        console.error(\"useUser must be used within a UserProvider\");\r\n    }\r\n    return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\firebase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\hooks\\useSpeech.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'utteranceRef' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":7,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"utteranceRef"},"fix":{"range":[254,288],"text":""},"desc":"Remove unused variable 'utteranceRef'."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\[.","line":28,"column":46,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":28,"endColumn":47,"suggestions":[{"messageId":"removeEscape","fix":{"range":[937,938],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[937,937],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useRef, useEffect } from 'react';\r\n\r\nexport function useSpeech() {\r\n    const [isListening, setIsListening] = useState(false);\r\n    const [speakingText, setSpeakingText] = useState(null);\r\n    const recognitionRef = useRef(null);\r\n    const utteranceRef = useRef(null);\r\n\r\n    // Initial load for voices (optional fix for Chrome)\r\n    useEffect(() => {\r\n        const load = () => window.speechSynthesis.getVoices();\r\n        window.speechSynthesis.onvoiceschanged = load;\r\n        load();\r\n        return () => window.speechSynthesis.cancel();\r\n    }, []);\r\n\r\n    // Text-to-Speech (TTS)\r\n    const speak = (text, langCode = 'en-US') => {\r\n        if (!('speechSynthesis' in window) || !text) return;\r\n\r\n        window.speechSynthesis.cancel(); // Clears queue\r\n\r\n        if (speakingText === text) {\r\n            setSpeakingText(null);\r\n            return;\r\n        }\r\n\r\n        const cleanText = text.replace(/[*#_`\\[\\]]/g, '');\r\n\r\n        // Chunking logic for Mobile stability\r\n        // Split by reasonable punctuation or length\r\n        const chunks = cleanText.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [cleanText];\r\n\r\n        // Refine chunks if still too long (fallback split by simple length)\r\n        const safeChunks = [];\r\n        chunks.forEach(chunk => {\r\n            if (chunk.length > 180) {\r\n                const subChunks = chunk.match(/.{1,180}(\\s|$)/g) || [chunk];\r\n                safeChunks.push(...subChunks);\r\n            } else {\r\n                safeChunks.push(chunk);\r\n            }\r\n        });\r\n\r\n        // Determine voice ONCE\r\n        const voices = window.speechSynthesis.getVoices();\r\n        let targetVoice = null;\r\n        if (langCode && langCode !== 'en-US') {\r\n            targetVoice = voices.find(v => v.lang.includes(langCode))\r\n                || voices.find(v => v.lang.startsWith(langCode.split('-')[0]));\r\n        }\r\n        if (!targetVoice) {\r\n            targetVoice = voices.find(v => v.name.includes(\"Google\") && v.lang.includes(\"en\"))\r\n                || voices.find(v => v.lang.startsWith(\"en\"));\r\n        }\r\n\r\n        // Queue utterances\r\n        safeChunks.forEach((chunkText, index) => {\r\n            const utterance = new SpeechSynthesisUtterance(chunkText);\r\n\r\n            if (targetVoice) {\r\n                utterance.voice = targetVoice;\r\n                utterance.lang = targetVoice.lang;\r\n            }\r\n\r\n            // Only clear state on the very last chunk\r\n            if (index === safeChunks.length - 1) {\r\n                utterance.onend = () => setSpeakingText(null);\r\n                utterance.onerror = () => setSpeakingText(null);\r\n            }\r\n\r\n            window.speechSynthesis.speak(utterance);\r\n        });\r\n\r\n        setSpeakingText(text);\r\n    };\r\n\r\n    // Speech-to-Text (STT)\r\n    const listen = (onResult, lang = 'en-US') => {\r\n        if (!('webkitSpeechRecognition' in window)) {\r\n            alert(\"Voice input requires Google Chrome or Edge.\");\r\n            return;\r\n        }\r\n\r\n        if (isListening) {\r\n            recognitionRef.current?.stop();\r\n            setIsListening(false);\r\n            return;\r\n        }\r\n\r\n        const recognition = new window.webkitSpeechRecognition();\r\n        recognition.continuous = false;\r\n        recognition.interimResults = true;\r\n        recognition.lang = lang;\r\n\r\n        recognition.onstart = () => setIsListening(true);\r\n        recognition.onend = () => setIsListening(false);\r\n        recognition.onerror = (e) => {\r\n            console.error(\"Speech Error\", e);\r\n            setIsListening(false);\r\n        };\r\n\r\n        recognition.onresult = (event) => {\r\n            const transcript = Array.from(event.results)\r\n                .map(result => result[0])\r\n                .map(result => result.transcript)\r\n                .join('');\r\n            onResult(transcript);\r\n        };\r\n\r\n        recognitionRef.current = recognition;\r\n        recognition.start();\r\n    };\r\n\r\n    return { speak, listen, isListening, speakingText };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\main.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'updateSW' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateSW"},"fix":{"range":[257,447],"text":""},"desc":"Remove unused variable 'updateSW'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { StrictMode } from 'react'\nimport { createRoot } from 'react-dom/client'\nimport './index.css'\nimport App from './App.jsx'\n\n// Service Worker is now managed by UpdateManager.jsx\n// PWA Registration\nimport { registerSW } from 'virtual:pwa-register';\n\nconst updateSW = registerSW({\n  onNeedRefresh() {\n    console.log('New content available, auto-updating...');\n  },\n  onOfflineReady() {\n    console.log('App ready to work offline');\n  },\n});\n\nconst APP_VERSION = '0.0.57'; // TOUR UID FIX\nconsole.log(\"TTR App Version:\", APP_VERSION);\n\n// Version Check for Debugging\nconst storedVersion = localStorage.getItem('ttr_version');\nif (!storedVersion || storedVersion !== APP_VERSION) {\n  localStorage.setItem('ttr_version', APP_VERSION);\n  // Optional: Force update if version mismatch (handled by autoUpdate usually)\n}\n\n// Render App\ncreateRoot(document.getElementById('root')).render(\n  <App />\n)\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\mysql_db.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'rows' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":21,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"rows"},"fix":{"range":[573,615],"text":""},"desc":"Remove unused variable 'rows'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import mysql from 'mysql2';\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config();\r\n\r\nconst pool = mysql.createPool({\r\n    host: process.env.MYSQL_HOST || 'localhost',\r\n    user: process.env.MYSQL_USER || 'root',\r\n    password: process.env.MYSQL_PASSWORD || '', // User must set this in .env\r\n    database: process.env.MYSQL_DATABASE || 'together_to_refine_db',\r\n    waitForConnections: true,\r\n    connectionLimit: 10,\r\n    queueLimit: 0\r\n});\r\n\r\n// Convert pool to promise-based\r\nexport const db = pool.promise();\r\n\r\nexport async function testConnection() {\r\n    try {\r\n        const [rows] = await db.query('SELECT 1');\r\n        console.log('Γ£à Connected to MySQL Database');\r\n        return true;\r\n    } catch (error) {\r\n        console.error('Γ¥î MySQL Connection Failed:', error.message);\r\n        console.error('   Please checks your .env file for MYSQL_USER and MYSQL_PASSWORD');\r\n        return false;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\AccessDenied.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[130,141],"text":""},"desc":"Remove unused variable 'updateDoc'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { db, auth } from '../firebase';\r\nimport { doc, updateDoc, setDoc } from 'firebase/firestore';\r\nimport { signOut } from 'firebase/auth';\r\n\r\nimport { useUser } from '../context/UserContext';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\n// ...\r\nexport default function AccessDenied() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    console.log(\"AccessDenied Component Loaded. User Role:\", userData?.role);\r\n\r\n    const handleLogout = async () => {\r\n        await signOut(auth);\r\n        localStorage.clear(); // Clear any cached data\r\n        navigate('/'); // Go to Login\r\n    };\r\n\r\n    const makeMeAdmin = async () => {\r\n        if (!userData || !userData.uid) return;\r\n        try {\r\n            // Smart update: Use the collection we found the user in\r\n            const targetCol = userData.collection || 'users';\r\n            await setDoc(doc(db, targetCol, userData.uid), { role: 'admin' }, { merge: true });\r\n\r\n            alert(`Role updated to Admin in '${targetCol}'! Redirecting...`);\r\n            localStorage.clear(); // Clear cache to forced re-fetch\r\n            window.location.href = '/admin';\r\n        } catch (e) {\r\n            alert(\"Error updating role: \" + e.message);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{ minHeight: '100vh', background: '#f1f2f6' }}>\r\n            <AnnouncementBar title=\"Access Denied\" />\r\n\r\n            <div style={{\r\n                display: 'flex', flexDirection: 'column',\r\n                justifyContent: 'center', alignItems: 'center',\r\n                height: 'calc(100vh - 120px)', // Centered in remaining space\r\n                padding: '20px'\r\n            }}>\r\n                <div style={{ fontSize: '60px' }}>≡ƒÜ½</div>\r\n                <h1 style={{ color: '#d63031', marginBottom: '10px' }}>Access Denied</h1>\r\n                <p style={{ color: '#636e72', marginBottom: '10px' }}>\r\n                    You do not have permission to view this page.\r\n                </p>\r\n                {/* SECURITY: Only show this to the specific Admin Email */}\r\n                {userData && (userData.email === 'kotesh.business12@gmail.com' || userData.email === 'koteshbitra789@gmail.com') && (\r\n                    <div style={{ marginTop: '20px', padding: '15px', background: '#f8f9fa', borderRadius: '8px', border: '1px solid #ddd', textAlign: 'left', maxWidth: '400px', margin: '20px auto' }}>\r\n                        <p style={{ marginTop: 0 }}><strong>Debug Info:</strong></p>\r\n                        <p><strong>Current Role:</strong> <code>{userData.role}</code></p>\r\n                        <p><strong>User ID:</strong> <code style={{ fontSize: '10px' }}>{userData.uid}</code></p>\r\n                        <p><strong>Email:</strong> <code>{userData.email}</code></p>\r\n\r\n                        <button\r\n                            onClick={makeMeAdmin}\r\n                            style={{\r\n                                marginTop: '10px',\r\n                                padding: '8px 12px',\r\n                                background: '#d63031',\r\n                                color: 'white',\r\n                                border: 'none',\r\n                                borderRadius: '4px',\r\n                                cursor: 'pointer',\r\n                                fontSize: '12px',\r\n                                fontWeight: 'bold'\r\n                            }}\r\n                        >\r\n                            ≡ƒ¢á∩╕Å Fix: Set my Role to Admin\r\n                        </button>\r\n                    </div>\r\n                )}\r\n                <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>\r\n                    <button\r\n                        className=\"btn\"\r\n                        onClick={() => {\r\n                            localStorage.clear();\r\n                            window.location.reload();\r\n                        }}\r\n                        style={{ padding: '10px 20px', background: '#636e72', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer' }}\r\n                    >\r\n                        ≡ƒöä Clear Cache\r\n                    </button>\r\n                    <button\r\n                        className=\"btn\"\r\n                        onClick={handleLogout}\r\n                        style={{ padding: '10px 20px', background: '#d63031', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer', fontWeight: 'bold' }}\r\n                    >\r\n                        ≡ƒÜ¬ Logout\r\n                    </button>\r\n                    <button\r\n                        className=\"btn\"\r\n                        onClick={() => navigate('/')}\r\n                        style={{ padding: '10px 20px', background: '#0984e3', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer' }}\r\n                    >\r\n                        Go Home\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\AdminDashboard.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":52,"suggestions":[{"messageId":"removeVar","data":{"varName":"where"},"fix":{"range":[132,139],"text":""},"desc":"Remove unused variable 'where'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":81,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":87,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[166,174],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'activeTab' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":21,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"activeTab"},"fix":{"range":[840,849],"text":""},"desc":"Remove unused variable 'activeTab'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setActiveTab' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":21,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"setActiveTab"},"fix":{"range":[849,863],"text":""},"desc":"Remove unused variable 'setActiveTab'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, getDocs, query, orderBy, where, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { getAuth } from 'firebase/auth';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport AIBadge from '../components/AIBadge';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\nexport default function AdminDashboard() {\r\n    const navigate = useNavigate();\r\n    const [stats, setStats] = useState({\r\n        students: 0,\r\n        teachers: 0,\r\n        institutions: 0,\r\n        feedbacks: 0,\r\n        totalFees: 0,\r\n        collectedFees: 0\r\n    });\r\n    const [pendingInstitutions, setPendingInstitutions] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [activeTab, setActiveTab] = useState('overview');\r\n    const [allInstitutions, setAllInstitutions] = useState([]);\r\n    const [showInstModal, setShowInstModal] = useState(false);\r\n    const [showFeedbackModal, setShowFeedbackModal] = useState(false);\r\n    const [allFeedbacks, setAllFeedbacks] = useState([]);\r\n    const [message, setMessage] = useState('');\r\n    const [showAnnouncementModal, setShowAnnouncementModal] = useState(false);\r\n\r\n    const handlePostAnnouncement = async () => {\r\n        const text = message.trim();\r\n        if (!text) return alert(\"Please enter text.\");\r\n        try {\r\n            const auth = getAuth();\r\n            await addDoc(collection(db, \"announcements\"), {\r\n                text,\r\n                createdAt: serverTimestamp(),\r\n                authorName: \"Announcement\",\r\n                authorId: auth.currentUser?.uid || 'ADMIN',\r\n                type: 'global',\r\n                role: 'admin'\r\n            });\r\n            alert(\"Announcement Posted!\");\r\n            setMessage('');\r\n            setShowAnnouncementModal(false);\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error posting.\");\r\n        }\r\n    };\r\n\r\n    // Fetch Feedbacks when Modal Opens\r\n    useEffect(() => {\r\n        if (!showFeedbackModal) return;\r\n\r\n        const fetchAllFeedbacks = async () => {\r\n            // 1. Fetch General Feedbacks\r\n            // 2. Fetch Emergency Reports\r\n            try {\r\n                const [fbSnap, repSnap] = await Promise.all([\r\n                    getDocs(query(collection(db, \"general_feedback\"), orderBy(\"timestamp\", \"desc\"))),\r\n                    getDocs(query(collection(db, \"emergency_reports\"), orderBy(\"createdAt\", \"desc\")))\r\n                ]);\r\n\r\n                let merged = [];\r\n                fbSnap.forEach(d => merged.push({ id: d.id, isReport: false, ...d.data() }));\r\n                repSnap.forEach(d => merged.push({ id: d.id, isReport: true, ...d.data(), timestamp: d.data().createdAt }));\r\n\r\n                // Sort merged list\r\n                merged.sort((a, b) => {\r\n                    const tA = a.timestamp?.seconds || 0;\r\n                    const tB = b.timestamp?.seconds || 0;\r\n                    return tB - tA;\r\n                });\r\n\r\n                setAllFeedbacks(merged);\r\n            } catch (e) {\r\n                console.error(\"Error fetching all feedbacks\", e);\r\n            }\r\n        };\r\n\r\n        fetchAllFeedbacks();\r\n    }, [showFeedbackModal]);\r\n\r\n    useEffect(() => {\r\n        const fetchGlobalStats = async () => {\r\n            try {\r\n                // ... (existing imports)\r\n                const [usersSnap, instSnap, teacherSnap, feedbackSnap] = await Promise.all([\r\n                    getDocs(collection(db, \"users\")),\r\n                    getDocs(collection(db, \"institutions\")),\r\n                    getDocs(collection(db, \"teachers\")),\r\n                    getDocs(collection(db, \"general_feedback\"))\r\n                ]);\r\n\r\n                setStats({\r\n                    students: usersSnap.size,\r\n                    teachers: teacherSnap.size,\r\n                    institutions: instSnap.size,\r\n                    feedbacks: feedbackSnap.size\r\n                });\r\n\r\n                // Fee Stats\r\n                let total = 0;\r\n                let collected = 0;\r\n                const feesSnap = await getDocs(collection(db, \"fees\"));\r\n                feesSnap.forEach(d => {\r\n                    const data = d.data();\r\n                    total += Number(data.amount || 0);\r\n                    if (data.status === 'paid') {\r\n                        collected += Number(data.amount || 0);\r\n                    }\r\n                });\r\n\r\n                setStats(prev => ({ ...prev, totalFees: total, collectedFees: collected }));\r\n\r\n                // Pending Institutions Logic & All Institutions\r\n                const pending = [];\r\n                const allInst = [];\r\n                instSnap.forEach(d => {\r\n                    const data = d.data();\r\n                    allInst.push({ id: d.id, ...data });\r\n                    if (data.approved === false) {\r\n                        pending.push({ id: d.id, ...data });\r\n                    }\r\n                });\r\n                setPendingInstitutions(pending.sort((a, b) => (a.schoolName || a.name || \"\").localeCompare(b.schoolName || b.name || \"\")));\r\n                setAllInstitutions(allInst.sort((a, b) => (a.schoolName || a.name || \"\").localeCompare(b.schoolName || b.name || \"\")));\r\n\r\n            } catch (e) {\r\n                console.error(\"Admin stats error:\", e);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchGlobalStats();\r\n    }, []);\r\n\r\n    const approveInstitution = async (id) => {\r\n        if (!confirm(\"Approve this Institution?\")) return;\r\n        try {\r\n            await updateDoc(doc(db, \"institutions\", id), { approved: true });\r\n\r\n            // 1. Remove from Pending List\r\n            setPendingInstitutions(prev => prev.filter(i => i.id !== id));\r\n\r\n            // 2. Update status in All Institutions List (Fixes View button issue)\r\n            setAllInstitutions(prev => prev.map(inst =>\r\n                inst.id === id ? { ...inst, approved: true } : inst\r\n            ));\r\n\r\n            alert(\"Institution Approved!\");\r\n        } catch (e) {\r\n            alert(\"Error: \" + e.message);\r\n        }\r\n    };\r\n\r\n    const deleteInstitution = async (id) => {\r\n        if (!confirm(\"Are you sure you want to DELETE this institution? This action cannot be undone.\")) return;\r\n        try {\r\n            await deleteDoc(doc(db, \"institutions\", id));\r\n            setAllInstitutions(prev => prev.filter(i => i.id !== id));\r\n            setPendingInstitutions(prev => prev.filter(i => i.id !== id));\r\n            setStats(prev => ({ ...prev, institutions: prev.institutions - 1 }));\r\n            alert(\"Institution Deleted Successfully.\");\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error deleting: \" + e.message);\r\n        }\r\n    };\r\n\r\n    if (loading) return <div className=\"container\" style={{ textAlign: 'center', marginTop: '50px' }}>Loading Admin Dashboard...</div>;\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ position: 'relative', background: '#f1f2f6', minHeight: '100vh', paddingBottom: '20px' }}>\r\n            <AIBadge />\r\n\r\n            {/* Notification (Announcement) Icon - Moved to Left Side below Home Button (Absolute) */}\r\n            <div style={{ position: 'absolute', top: '150px', left: '20px', zIndex: 90 }}>\r\n                <button\r\n                    onClick={() => setShowAnnouncementModal(true)}\r\n                    style={{\r\n                        width: '50px', height: '50px', borderRadius: '50%',\r\n                        background: '#fff', border: 'none',\r\n                        boxShadow: '0 4px 15px rgba(0,0,0,0.1)',\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                        fontSize: '24px', cursor: 'pointer', color: '#0984e3',\r\n                        transition: 'transform 0.2s'\r\n                    }}\r\n                    onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.1)'}\r\n                    onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}\r\n                    title=\"Post Notification\"\r\n                >\r\n                    ≡ƒôó\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"container\" style={{ maxWidth: '1100px', margin: '30px auto' }}>\r\n\r\n\r\n\r\n                {/* Stats Grid */}\r\n                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '40px' }}>\r\n                    <div className=\"card text-center\" style={{ padding: '30px', borderLeft: '5px solid #0984e3' }}>\r\n                        <div style={{ fontSize: '40px', color: '#0984e3' }}>≡ƒÄô</div>\r\n                        <h2 style={{ margin: '10px 0', fontSize: '30px' }}>{stats.students}</h2>\r\n                        <span style={{ color: '#636e72' }}>Students</span>\r\n                    </div>\r\n                    <div className=\"card text-center\" style={{ padding: '30px', borderLeft: '5px solid #00b894' }}>\r\n                        <div style={{ fontSize: '40px', color: '#00b894' }}>≡ƒæ¿ΓÇì≡ƒÅ½</div>\r\n                        <h2 style={{ margin: '10px 0', fontSize: '30px' }}>{stats.teachers}</h2>\r\n                        <span style={{ color: '#636e72' }}>Teachers</span>\r\n                    </div>\r\n                    <div className=\"card text-center\"\r\n                        onClick={() => setShowInstModal(true)}\r\n                        style={{ padding: '30px', borderLeft: '5px solid #d63031', cursor: 'pointer', transition: 'transform 0.2s' }}\r\n                        onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.02)'}\r\n                        onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}\r\n                    >\r\n                        <div style={{ fontSize: '40px', color: '#d63031' }}>≡ƒÅ½</div>\r\n                        <h2 style={{ margin: '10px 0', fontSize: '30px' }}>{stats.institutions}</h2>\r\n                        <span style={{ color: '#636e72' }}>Institutions</span>\r\n                        <div style={{ fontSize: '12px', color: '#b2bec3', marginTop: '5px' }}>Click to view details</div>\r\n                    </div>\r\n                    <div className=\"card text-center\"\r\n                        onClick={() => setShowFeedbackModal(true)}\r\n                        style={{ padding: '30px', borderLeft: '5px solid #fdcb6e', cursor: 'pointer', transition: 'transform 0.2s' }}\r\n                        onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.02)'}\r\n                        onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}\r\n                    >\r\n                        <div style={{ fontSize: '40px', color: '#fdcb6e' }}>≡ƒÆ¼</div>\r\n                        <h2 style={{ margin: '10px 0', fontSize: '30px' }}>{stats.feedbacks}</h2>\r\n                        <span style={{ color: '#636e72' }}>Total Feedbacks</span>\r\n                        <div style={{ fontSize: '12px', color: '#b2bec3', marginTop: '5px' }}>Click to view all</div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Dashboard Controls */}\r\n                <div style={{ display: 'flex', gap: '20px' }}>\r\n                    <div className=\"card\" style={{ flex: 1 }}>\r\n                        <h3>Pending Actions</h3>\r\n                        {pendingInstitutions.length === 0 ? (\r\n                            <p style={{ color: '#b2bec3' }}>No pending institutions to approve.</p>\r\n                        ) : (\r\n                            <div>\r\n                                {pendingInstitutions.map((inst, index) => (\r\n                                    <div key={inst.id} style={{\r\n                                        display: 'flex', justifyContent: 'space-between', alignItems: 'center',\r\n                                        padding: '15px', borderBottom: '1px solid #eee'\r\n                                    }}>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                                            <span style={{ fontWeight: 'bold', color: '#636e72', minWidth: '20px' }}>{index + 1}.</span>\r\n                                            <div>\r\n                                                <strong>{inst.schoolName || inst.name}</strong>\r\n                                                <div style={{ fontSize: '12px' }}>{inst.principalName}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                        <button className=\"btn\" style={{ padding: '5px 15px', fontSize: '12px' }} onClick={() => approveInstitution(inst.id)}>Approve</button>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"card\" style={{ flex: 1 }}>\r\n                        <h3>System Tools</h3>\r\n                        <div style={{ display: 'grid', gap: '10px' }}>\r\n                            {/* Removed generic view button as the card is now clickable */}\r\n                            <button className=\"btn\" style={{ background: '#2d3436' }} onClick={() => navigate('/admin/settings')}>\r\n                                ≡ƒöº Site Settings\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Announcement Poster */}\r\n                <div className=\"card\" style={{ marginTop: '20px' }}>\r\n                    <h3>≡ƒôó Post Global Announcement</h3>\r\n                    <div style={{ display: 'flex', gap: '10px' }}>\r\n                        <input\r\n                            placeholder=\"Type announcement here...\"\r\n                            style={{ flex: 1, padding: '10px', borderRadius: '5px', border: '1px solid #ddd' }}\r\n                            id=\"announcementInput\"\r\n                            value={message}\r\n                            onChange={(e) => setMessage(e.target.value)}\r\n                        />\r\n                        <button\r\n                            className=\"btn\"\r\n                            style={{ background: '#0984e3' }}\r\n                            onClick={handlePostAnnouncement}\r\n                        >\r\n                            Post\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n            {/* Feedback List Modal */}\r\n            {showFeedbackModal && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                    background: 'rgba(0,0,0,0.8)', zIndex: 2000,\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                }}>\r\n                    <div className=\"card\" style={{ width: '90%', maxWidth: '900px', maxHeight: '85vh', overflowY: 'auto', position: 'relative' }}>\r\n                        <button\r\n                            onClick={() => setShowFeedbackModal(false)}\r\n                            style={{\r\n                                position: 'absolute', top: '15px', right: '15px',\r\n                                background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer'\r\n                            }}\r\n                        >\r\n                            &times;\r\n                        </button>\r\n                        <h2 style={{ marginTop: 0, borderBottom: '1px solid #eee', paddingBottom: '15px' }}>Global Feedback & Reports</h2>\r\n\r\n                        <div style={{ display: 'grid', gap: '15px', marginTop: '20px' }}>\r\n                            {allFeedbacks.length === 0 ? <p className=\"text-center text-muted\">Loading or No Feedbacks...</p> : allFeedbacks.map(f => {\r\n                                if (f.isReport) {\r\n                                    // Emergency Report Card\r\n                                    return (\r\n                                        <div key={f.id} style={{ padding: '20px', border: '2px solid #ff7675', borderRadius: '12px', background: '#fff0f0' }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                                <div>\r\n                                                    <strong style={{ color: '#d63031', fontSize: '16px' }}>\r\n                                                        {f.type === 'sexual_harassment' ? '≡ƒÜ¿ SEXUAL HARASSMENT REPORT' : 'ΓÜá∩╕Å MISBEHAVIOR REPORT'}\r\n                                                    </strong>\r\n                                                    <span style={{ display: 'block', fontSize: '13px', color: '#636e72', marginTop: '4px' }}>\r\n                                                        From: {f.authorName || 'Anonymous'} | Inst: {f.institutionName || 'Unknown'}\r\n                                                    </span>\r\n                                                </div>\r\n                                                <span style={{ fontSize: '12px', color: '#b2bec3' }}>{f.createdAt?.seconds ? new Date(f.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span>\r\n                                            </div>\r\n\r\n                                            <div style={{ marginBottom: '5px' }}><strong>Accused:</strong> {f.accusedName}</div>\r\n                                            <div style={{ marginBottom: '10px' }}><strong>Location:</strong> {f.location}</div>\r\n\r\n                                            <p style={{ margin: '5px 0', background: 'white', padding: '10px', border: '1px solid #ffdcdc', borderRadius: '5px', color: '#d63031' }}>\r\n                                                \"{f.description}\"\r\n                                            </p>\r\n                                        </div>\r\n                                    );\r\n                                } else {\r\n                                    // Standard Feedback Card\r\n                                    return (\r\n                                        <div key={f.id} style={{ padding: '20px', border: '1px solid #eee', borderRadius: '12px', background: '#f9f9f9' }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                                <div>\r\n                                                    <strong>{f.authorName || \"Anonymous\"}</strong> <span style={{ fontSize: '12px', color: '#636e72' }}> to {f.targetName || 'Institution'}</span>\r\n                                                </div>\r\n                                                <span style={{ fontSize: '12px', color: '#b2bec3' }}>{f.timestamp?.seconds ? new Date(f.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}</span>\r\n                                            </div>\r\n\r\n                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '10px' }}>\r\n                                                {['behavior', 'communication', 'bodyLanguage', 'hardworking'].map(cat => f[cat] ? (\r\n                                                    <span key={cat} style={{ fontSize: '12px', background: '#e3f2fd', padding: '5px 10px', borderRadius: '15px' }}>\r\n                                                        {cat.charAt(0).toUpperCase() + cat.slice(1)}: <strong>{f[cat].stars}Γÿà</strong>\r\n                                                    </span>\r\n                                                ) : null)}\r\n                                            </div>\r\n\r\n                                            {f.comment && <p style={{ margin: '5px 0', fontStyle: 'italic', color: '#2d3436' }}>\"{f.comment}\"</p>}\r\n                                        </div>\r\n                                    );\r\n                                }\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Institution List Modal */}\r\n            {showInstModal && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                    background: 'rgba(0,0,0,0.8)', zIndex: 2000,\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                }}>\r\n                    <div className=\"card\" style={{ width: '90%', maxWidth: '800px', maxHeight: '80vh', overflowY: 'auto', position: 'relative' }}>\r\n                        <button\r\n                            onClick={() => setShowInstModal(false)}\r\n                            style={{\r\n                                position: 'absolute', top: '15px', right: '15px',\r\n                                background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer'\r\n                            }}\r\n                        >\r\n                            &times;\r\n                        </button>\r\n                        <h2 style={{ marginTop: 0, borderBottom: '1px solid #eee', paddingBottom: '15px' }}>Registered Institutions ({allInstitutions.length})</h2>\r\n\r\n                        <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '15px' }}>\r\n                            <thead>\r\n                                <tr style={{ background: '#f8f9fa', textAlign: 'left' }}>\r\n                                    <th style={{ padding: '10px', width: '40px' }}>#</th>\r\n                                    <th style={{ padding: '10px' }}>Name</th>\r\n                                    <th style={{ padding: '10px' }}>Principal</th>\r\n                                    <th style={{ padding: '10px' }}>Est. Year</th>\r\n                                    <th style={{ padding: '10px' }}>Status</th>\r\n                                    <th style={{ padding: '10px' }}>Action</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {allInstitutions.map((inst, index) => (\r\n                                    <tr key={inst.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                        <td style={{ padding: '10px', color: '#636e72', fontWeight: 'bold' }}>{index + 1}</td>\r\n                                        <td style={{ padding: '10px' }}>\r\n                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                                {inst.profileImageURL ? (\r\n                                                    <img src={inst.profileImageURL} alt=\"\" style={{ width: '30px', height: '30px', borderRadius: '50%', objectFit: 'cover' }} />\r\n                                                ) : (\r\n                                                    <div style={{ width: '30px', height: '30px', borderRadius: '50%', background: '#eee', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>≡ƒÅ½</div>\r\n                                                )}\r\n                                                <strong>{inst.institutionName || inst.schoolName}</strong>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td style={{ padding: '10px' }}>{inst.principalName}</td>\r\n                                        <td style={{ padding: '10px' }}>{inst.estYear}</td>\r\n                                        <td style={{ padding: '10px' }}>\r\n                                            <span style={{\r\n                                                padding: '4px 10px', borderRadius: '12px', fontSize: '12px',\r\n                                                background: inst.approved ? '#d4edda' : '#fff3cd',\r\n                                                color: inst.approved ? '#155724' : '#856404'\r\n                                            }}>\r\n                                                {inst.approved ? 'Active' : 'Pending'}\r\n                                            </span>\r\n                                        </td>\r\n                                        <td style={{ padding: '10px' }}>\r\n                                            <div style={{ display: 'flex', gap: '8px' }}>\r\n                                                {!inst.approved && (\r\n                                                    <button className=\"btn\" style={{ padding: '5px 10px', fontSize: '12px' }} onClick={() => approveInstitution(inst.id)}>Approve</button>\r\n                                                )}\r\n                                                {inst.approved && (\r\n                                                    <button className=\"btn\" style={{ padding: '5px 10px', fontSize: '12px', background: '#b2bec3' }} onClick={() => navigate(`/admin/institution/${inst.id}`)}>View</button>\r\n                                                )}\r\n                                                <button className=\"btn\" style={{ padding: '5px 10px', fontSize: '12px', background: '#d63031', color: 'white' }} onClick={() => deleteInstitution(inst.id)}>Delete</button>\r\n                                            </div>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n                        {allInstitutions.length === 0 && <p className=\"text-center text-muted\">No institutions found.</p>}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Announcement Modal */}\r\n            {showAnnouncementModal && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                    background: 'rgba(0,0,0,0.8)', zIndex: 3000,\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                }}>\r\n                    <div className=\"card\" style={{ width: '90%', maxWidth: '500px', position: 'relative', padding: '25px' }}>\r\n                        <button\r\n                            onClick={() => setShowAnnouncementModal(false)}\r\n                            style={{\r\n                                position: 'absolute', top: '10px', right: '10px',\r\n                                background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#636e72'\r\n                            }}\r\n                        >\r\n                            &times;\r\n                        </button>\r\n                        <h3 style={{ marginTop: 0, textAlign: 'center', color: '#2d3436' }}>≡ƒôó Post Global Notification</h3>\r\n                        <p className=\"text-center text-muted\" style={{ fontSize: '14px', marginBottom: '20px' }}>\r\n                            This announcement will be visible to ALL users (Students, Teachers, Institutions).\r\n                        </p>\r\n\r\n                        <textarea\r\n                            className=\"input-field\"\r\n                            rows=\"5\"\r\n                            placeholder=\"Type your announcement here...\"\r\n                            value={message}\r\n                            onChange={(e) => setMessage(e.target.value)}\r\n                            style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #ddd', resize: 'vertical' }}\r\n                        />\r\n\r\n                        <button\r\n                            className=\"btn\"\r\n                            onClick={handlePostAnnouncement}\r\n                            style={{ width: '100%', marginTop: '15px', background: '#0984e3', padding: '12px' }}\r\n                        >\r\n                            Post Announcement\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\AdminSettings.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Admission.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Allotment.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":234,"column":94,"nodeType":"Identifier","messageId":"unusedVar","endLine":234,"endColumn":95,"suggestions":[{"messageId":"removeVar","data":{"varName":"e"},"fix":{"range":[10245,10246],"text":"()"},"desc":"Remove unused variable 'e'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":458,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":458,"endColumn":27},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":458,"column":29,"nodeType":"BlockStatement","messageId":"unexpected","endLine":458,"endColumn":32,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[20322,20323],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":462,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":462,"endColumn":27},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":462,"column":29,"nodeType":"BlockStatement","messageId":"unexpected","endLine":462,"endColumn":32,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[20479,20480],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db, auth } from '../firebase';\r\nimport { collection, query, where, getDocs, addDoc, deleteDoc, doc, updateDoc, setDoc, getDoc, limit } from 'firebase/firestore';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport { onAuthStateChanged } from 'firebase/auth';\r\nimport AIBadge from '../components/AIBadge';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function Allotment() {\r\n    const { userData } = useUser();\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n\r\n    // Check if we came from Waiting List to allot someone specific\r\n    const personToAllot = location.state?.personToAllot;\r\n\r\n    const [role, setRole] = useState(personToAllot ? personToAllot.role : null);\r\n    const [cls, setCls] = useState('');\r\n    const [sec, setSec] = useState('');\r\n    const [entries, setEntries] = useState([]);\r\n    const [name, setName] = useState(personToAllot ? personToAllot.name : '');\r\n    const [extra, setExtra] = useState(personToAllot ? (personToAllot.subject || personToAllot.age) : '');\r\n    const [currentUser, setCurrentUser] = useState(null);\r\n    const [existingTeachers, setExistingTeachers] = useState([]);\r\n    const [selectedUserId, setSelectedUserId] = useState(null);\r\n\r\n    // Transfer Modal State\r\n    const [transferTarget, setTransferTarget] = useState(null); // { id, name, subject, oldClass, oldSection, userId }\r\n    const [targetClass, setTargetClass] = useState('');\r\n    const [targetSection, setTargetSection] = useState('');\r\n\r\n    // Fetch Teachers for dropdown\r\n    useEffect(() => {\r\n        if (role === 'teacher') {\r\n            const fetchTeachers = async () => {\r\n                const instId = userData?.role === 'institution' ? userData.uid : userData?.institutionId;\r\n                // Fix: Only show teachers from THIS institution\r\n                let q;\r\n                if (instId) {\r\n                    q = query(collection(db, \"teachers\"), where(\"institutionId\", \"==\", instId));\r\n                } else {\r\n                    setExistingTeachers([]); // Prevent global leak\r\n                    return;\r\n                }\r\n                const snap = await getDocs(q);\r\n                setExistingTeachers(snap.docs.map(d => ({ uid: d.id, ...d.data() })));\r\n            };\r\n            fetchTeachers();\r\n        }\r\n    }, [role, userData]);\r\n\r\n    const handleSelectTeacher = (e) => {\r\n        const uid = e.target.value;\r\n        setSelectedUserId(uid);\r\n        if (uid) {\r\n            const t = existingTeachers.find(t => t.uid === uid);\r\n            if (t) {\r\n                setName(t.name);\r\n                setExtra(t.subject || '');\r\n            }\r\n        } else {\r\n            setName('');\r\n            setExtra('');\r\n        }\r\n    };\r\n\r\n    // If Allotting a person, verify we are in the right Role tab\r\n    useEffect(() => {\r\n        if (personToAllot && role !== personToAllot.role) {\r\n            setRole(personToAllot.role);\r\n        }\r\n    }, [personToAllot, role]);\r\n\r\n    useEffect(() => {\r\n        const unsubscribe = onAuthStateChanged(auth, (user) => {\r\n            if (user) {\r\n                setCurrentUser(user);\r\n            } else {\r\n                navigate('/');\r\n            }\r\n        });\r\n        return () => unsubscribe();\r\n    }, [navigate]);\r\n\r\n    const fetchEntries = async () => {\r\n        if (!cls || !sec || !role) return;\r\n\r\n        try {\r\n            const colName = role === 'teacher' ? 'teacher_allotments' : 'student_allotments';\r\n\r\n            // Standard query with constraints\r\n            // We use spread operator to easily add more constraints later if needed\r\n            const q = query(\r\n                collection(db, colName),\r\n                where('classAssigned', '==', cls),\r\n                where('section', '==', sec),\r\n                limit(50) // SCALABILITY: Prevent loading too many rows at once\r\n            );\r\n\r\n            const snapshot = await getDocs(q);\r\n            const list = [];\r\n            snapshot.forEach(d => list.push({ id: d.id, ...d.data() }));\r\n            setEntries(list);\r\n        } catch (e) {\r\n            console.error(\"Data fetch error:\", e);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchEntries();\r\n    }, [role, cls, sec]);\r\n\r\n    // Helper to update Timetable text\r\n    // Modes:\r\n    // 1. REPLACE: oldName + newName -> Swaps them\r\n    // 2. REMOVE: oldName + null -> Removes oldName\r\n    // 3. INJECT: null + newName -> Finds Subject (without name) and appends newName\r\n    const updateTimetableTeacher = async (classIds, section, subject, oldName, newName, instId) => {\r\n        try {\r\n\r\n\r\n            // Query 1: New Schema\r\n            const q1 = query(\r\n                collection(db, \"timetables\"),\r\n                where(\"institutionId\", \"==\", instId),\r\n                where(\"section\", \"==\", section)\r\n            );\r\n\r\n            // Query 2: Legacy Schema (some older docs might only have createdBy)\r\n            const q2 = query(\r\n                collection(db, \"timetables\"),\r\n                where(\"createdBy\", \"==\", instId),\r\n                where(\"section\", \"==\", section)\r\n            );\r\n\r\n            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);\r\n\r\n            // Merge results by ID to handle overlaps\r\n            const combinedDocs = new Map();\r\n            snap1.docs.forEach(d => combinedDocs.set(d.id, d));\r\n            snap2.docs.forEach(d => combinedDocs.set(d.id, d));\r\n\r\n            const updates = [];\r\n            combinedDocs.forEach(d => {\r\n                const data = d.data();\r\n                const dClass = String(data.class).replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n                const targetClass = String(classIds[0]).replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n\r\n                if (dClass !== targetClass) return;\r\n\r\n                let scheduleChanged = false;\r\n                const schedule = data.schedule || {};\r\n                const newSchedule = typeof structuredClone === 'function' ? structuredClone(schedule) : JSON.parse(JSON.stringify(schedule));\r\n\r\n                Object.keys(newSchedule).forEach(day => {\r\n                    Object.keys(newSchedule[day]).forEach(pId => {\r\n                        const cell = newSchedule[day][pId];\r\n                        let val = typeof cell === 'object' ? (cell.subject || '') : cell;\r\n\r\n                        // Check for SUBJECT match with BOUNDARIES\r\n                        // We use a custom boundary check because \\b fails for symbols like \"C++\"\r\n                        // Logic: PRE takes Start or Non-Word. POST checks for End or Non-Word.\r\n                        const escapedSub = subject.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n\r\n                        // Regex:\r\n                        // Group 1: (^|[^a-zA-Z0-9_])  -> Prefix (Start or Non-Word)\r\n                        // Group 2: (Subject)           -> The Subject\r\n                        // Group 3: (\\s*\\(.*?\\))?       -> Optional Existing Name \" (John)\"\r\n                        // Lookahead: (?=$|[^a-zA-Z0-9_]) -> Followed by End or Non-Word\r\n\r\n                        const tokenRegex = new RegExp(`(^|[^a-zA-Z0-9_])(${escapedSub})(\\\\s*\\\\(.*?\\\\))?(?=$|[^a-zA-Z0-9_])`, 'gi');\r\n\r\n                        if (tokenRegex.test(val)) {\r\n                            if (newName) {\r\n                                // REPLACE / INJECT Mode -> \"Subject (NewName)\"\r\n                                // Keep Prefix ($1), Keep Subject ($2), Discard Old Name ($3), Add New Name\r\n                                val = val.replace(tokenRegex, `$1$2 (${newName})`);\r\n                                scheduleChanged = true;\r\n                            } else {\r\n                                // REMOVE Mode -> \"Subject\"\r\n                                // Keep Prefix ($1), Keep Subject ($2), Discard Old Name ($3)\r\n                                val = val.replace(tokenRegex, '$1$2');\r\n                                scheduleChanged = true;\r\n                            }\r\n                        }\r\n\r\n                        // Save back\r\n                        if (typeof cell === 'object') {\r\n                            newSchedule[day][pId] = { ...cell, subject: val };\r\n                        } else {\r\n                            newSchedule[day][pId] = val;\r\n                        }\r\n                    });\r\n                });\r\n\r\n                if (scheduleChanged) {\r\n                    updates.push(updateDoc(doc(db, \"timetables\", d.id), { schedule: newSchedule }));\r\n                }\r\n            });\r\n\r\n            await Promise.all(updates);\r\n            // console.log(\"Timetable Updated Successfully.\");\r\n        } catch (e) {\r\n            console.error(\"Timetable Update Failed:\", e);\r\n        }\r\n    };\r\n\r\n    const handleAdd = async () => {\r\n        if (!name || !extra || !cls || !sec || !role) return alert('Fill all fields');\r\n\r\n        try {\r\n            const finalUserId = personToAllot?.userId || selectedUserId || null;\r\n            const instId = (userData?.role === 'institution' ? userData.uid : userData?.institutionId);\r\n\r\n            // CHECK FOR EXISTING TEACHER (COLLISION)\r\n            if (role === 'teacher') {\r\n                const existing = entries.find(e => e.subject.toLowerCase() === extra.toLowerCase());\r\n                if (existing) {\r\n                    if (!window.confirm(`'${existing.name}' is already assigned as '${existing.subject}' teacher for ${cls}-${sec}.\\n\\nDo you want to REPLACE them with '${name}'?`)) {\r\n                        return;\r\n                    }\r\n\r\n                    // 1. Update Allotment\r\n                    await updateDoc(doc(db, \"teacher_allotments\", existing.id), {\r\n                        name: name,\r\n                        teacherId: finalUserId,\r\n                        userId: finalUserId,\r\n                        updatedAt: new Date()\r\n                    });\r\n\r\n                    // 2. Update Group\r\n                    const groupId = `${instId}_${extra}_${cls}_${sec}`.replace(/\\s+/g, \"_\").toUpperCase();\r\n                    await updateDoc(doc(db, \"groups\", groupId), { teacherName: name }).catch(e => console.log(\"Group update skipped\"));\r\n\r\n                    // 3. Update Timetable (Old Name -> New Name)\r\n                    await updateTimetableTeacher([cls], sec, extra, existing.name, name, instId);\r\n\r\n                    alert(`Replaced ${existing.name} with ${name} successfully!`);\r\n                    setName(''); setExtra(''); setSelectedUserId(null); fetchEntries();\r\n                    return;\r\n                }\r\n            }\r\n\r\n            const colName = role === 'teacher' ? 'teacher_allotments' : 'student_allotments';\r\n            const docData = {\r\n                name,\r\n                classAssigned: cls,\r\n                section: sec,\r\n                [role === 'teacher' ? 'subject' : 'age']: extra,\r\n                createdBy: currentUser ? currentUser.uid : 'unknown',\r\n                institutionId: instId || null,\r\n                userId: finalUserId\r\n            };\r\n            if (role === 'teacher' && finalUserId) docData.teacherId = finalUserId;\r\n\r\n            await addDoc(collection(db, colName), docData);\r\n\r\n            // Group Creation\r\n            if (role === 'teacher') {\r\n                const subject = extra;\r\n                const groupId = `${instId}_${subject}_${cls}_${sec}`.replace(/\\s+/g, \"_\").toUpperCase();\r\n                const instRef = doc(db, \"institutions\", instId);\r\n                const instSnap = await getDoc(instRef);\r\n                const instName = instSnap.exists() ? (instSnap.data().schoolName || instSnap.data().name) : userData.institutionName;\r\n\r\n                await setDoc(doc(db, \"groups\", groupId), {\r\n                    groupName: `${subject} (${cls}-${sec})`,\r\n                    subject: subject,\r\n                    className: cls,\r\n                    section: sec,\r\n                    teacherName: name,\r\n                    teacherId: finalUserId || null,\r\n                    institutionId: instId || null,\r\n                    institutionName: instName || null,\r\n                    createdBy: currentUser ? currentUser.uid : 'system',\r\n                    createdAt: new Date(),\r\n                    type: 'academic'\r\n                });\r\n\r\n                // INJECT into Timetable (Subject-Only slots get Name)\r\n                if (instId) {\r\n                    await updateTimetableTeacher([cls], sec, extra, null, name, instId);\r\n                }\r\n            }\r\n\r\n            // Profile Updates\r\n            if (finalUserId) {\r\n                try {\r\n                    const userColl = (role === 'teacher') ? 'teachers' : 'users';\r\n\r\n                    // Use institution data from the current user (the admin/institution)\r\n                    const instIdToSave = instId;\r\n                    const instNameToSave = userData?.schoolName || userData?.institutionName || userData?.name || null;\r\n\r\n                    await setDoc(doc(db, userColl, finalUserId), {\r\n                        approved: true,\r\n                        assignedClass: cls,\r\n                        assignedSection: sec,\r\n                        class: cls,\r\n                        section: sec,\r\n                        institutionId: instIdToSave,\r\n                        institutionName: instNameToSave,\r\n                        ...(role === 'teacher' ? { subject: extra } : { age: extra }),\r\n                        updatedAt: new Date()\r\n                    }, { merge: true });\r\n                } catch (profErr) {\r\n                    console.error(\"Profile update failed during allotment:\", profErr);\r\n                }\r\n            }\r\n\r\n            if (personToAllot) {\r\n                await updateDoc(doc(db, \"admissions\", personToAllot.id), { status: 'allotted', assignedClass: cls, assignedSection: sec, allottedAt: new Date() });\r\n                alert(`${name} allotted to ${cls}-${sec}!`);\r\n                navigate('/waiting-list');\r\n                return;\r\n            }\r\n\r\n            setName(''); setExtra(''); setSelectedUserId(null); fetchEntries();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error adding entry\");\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (id) => {\r\n        if (!window.confirm('Delete?')) return;\r\n        const colName = role === 'teacher' ? 'teacher_allotments' : 'student_allotments';\r\n\r\n        // Fetch to get details before delete\r\n        try {\r\n            const entryRef = doc(db, colName, id);\r\n            const entrySnap = await getDoc(entryRef);\r\n\r\n            if (entrySnap.exists()) {\r\n                const entry = entrySnap.data();\r\n\r\n                // If it's a teacher, clean up Timetable\r\n                if (role === 'teacher') {\r\n                    const instId = userData?.role === 'institution' ? userData.uid : userData?.institutionId;\r\n                    if (instId && entry.name && entry.subject && entry.classAssigned && entry.section) {\r\n                        await updateTimetableTeacher(\r\n                            [entry.classAssigned],\r\n                            entry.section,\r\n                            entry.subject,\r\n                            entry.name,\r\n                            null, // Remove mode\r\n                            instId\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n\r\n            await deleteDoc(entryRef);\r\n            fetchEntries();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Delete failed\");\r\n        }\r\n    };\r\n\r\n    const initiateTransfer = (entry) => {\r\n        setTransferTarget({\r\n            id: entry.id,\r\n            name: entry.name,\r\n            subject: entry.subject,\r\n            oldClass: entry.classAssigned,\r\n            oldSection: entry.section,\r\n            userId: entry.userId, // allotments usually have userId\r\n            teacherId: entry.teacherId\r\n        });\r\n        setTargetClass('');\r\n        setTargetSection('');\r\n    };\r\n\r\n    const handleTransfer = async () => {\r\n        if (!targetClass || !targetSection) return alert(\"Please select target Class and Section\");\r\n        if (!transferTarget) return;\r\n\r\n        // confirm\r\n        if (!window.confirm(`Transfer ${transferTarget.name} from ${transferTarget.oldClass}-${transferTarget.oldSection} to ${targetClass}-${targetSection}?`)) return;\r\n\r\n        try {\r\n            const { id, subject, oldClass, oldSection, userId, teacherId } = transferTarget;\r\n            const finalUserId = teacherId || userId;\r\n\r\n            // 1. Calculate Group IDs\r\n            const oldGroupId = `${subject}_${oldClass}_${oldSection}`.replace(/\\s+/g, \"_\").toUpperCase();\r\n            const newGroupId = `${subject}_${targetClass}_${targetSection}`.replace(/\\s+/g, \"_\").toUpperCase();\r\n\r\n            console.log(`Transferring Group: ${oldGroupId} -> ${newGroupId}`);\r\n\r\n            // 2. Move Group (Create New, Delete Old - Firestore doesn't support rename)\r\n            // Check if old group exists\r\n            const oldGroupRef = doc(db, \"groups\", oldGroupId);\r\n            const oldGroupSnap = await getDoc(oldGroupRef);\r\n\r\n            if (oldGroupSnap.exists()) {\r\n                const groupData = oldGroupSnap.data();\r\n                // Get institution name for transfer metadata\r\n                const instRef = doc(db, \"institutions\", instId || groupData.institutionId || groupData.createdBy);\r\n                const instSnap = await getDoc(instRef);\r\n                const instName = instSnap.exists() ? (instSnap.data().schoolName || instSnap.data().name) : null;\r\n\r\n                // Create New Group\r\n                await setDoc(doc(db, \"groups\", newGroupId), {\r\n                    ...groupData,\r\n                    className: targetClass,\r\n                    section: targetSection,\r\n                    institutionId: instId || groupData.institutionId || groupData.createdBy,\r\n                    institutionName: instName || groupData.institutionName || null,\r\n                    groupName: `${subject} (${targetClass}-${targetSection})`, // Update name\r\n                    updatedAt: new Date()\r\n                });\r\n                // Delete Old Group\r\n                await deleteDoc(oldGroupRef);\r\n            } else {\r\n                // If old group missing, create new one anyway\r\n                const instRefAdd = doc(db, \"institutions\", instId);\r\n                const instSnapAdd = await getDoc(instRefAdd);\r\n                const instNameAdd = instSnapAdd.exists() ? (instSnapAdd.data().schoolName || instSnapAdd.data().name) : null;\r\n\r\n                await setDoc(doc(db, \"groups\", newGroupId), {\r\n                    groupName: `${subject} (${targetClass}-${targetSection})`,\r\n                    subject: subject,\r\n                    className: targetClass,\r\n                    section: targetSection,\r\n                    teacherName: transferTarget.name,\r\n                    institutionId: instId || null,\r\n                    institutionName: instNameAdd || null,\r\n                    createdBy: currentUser ? currentUser.uid : 'system',\r\n                    createdAt: new Date(),\r\n                    type: 'academic'\r\n                });\r\n            }\r\n\r\n            // 3. Update Allotment Doc\r\n            await updateDoc(doc(db, \"teacher_allotments\", id), {\r\n                classAssigned: targetClass,\r\n                section: targetSection\r\n            });\r\n\r\n            // 4. Update Profile (if linked)\r\n            if (finalUserId) {\r\n                // Try updating standard users or teachers collection\r\n                const instNameToSave = userData?.schoolName || userData?.institutionName || userData?.name || null;\r\n                const profileUpdates = {\r\n                    assignedClass: targetClass,\r\n                    assignedSection: targetSection,\r\n                    class: targetClass,\r\n                    section: targetSection,\r\n                    institutionId: instId,\r\n                    institutionName: instNameToSave\r\n                };\r\n\r\n                try {\r\n                    await setDoc(doc(db, \"teachers\", finalUserId), profileUpdates, { merge: true });\r\n                } catch (e) { }\r\n\r\n                try {\r\n                    await setDoc(doc(db, \"users\", finalUserId), profileUpdates, { merge: true });\r\n                } catch (e) { }\r\n            }\r\n\r\n            // 5. Update Timetable (Remove Teacher Name from OLD Class)\r\n            const instId = userData?.role === 'institution' ? userData.uid : userData?.institutionId;\r\n            if (instId) {\r\n                await updateTimetableTeacher([oldClass], oldSection, subject, transferTarget.name, null, instId);\r\n            }\r\n\r\n            alert(\"Transfer Successful!\");\r\n            setTransferTarget(null);\r\n            fetchEntries(); // Refresh list (item will disappear from current view)\r\n\r\n        } catch (e) {\r\n            console.error(\"Transfer Error:\", e);\r\n            alert(\"Transfer failed: \" + e.message);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <AIBadge />\r\n            <AnnouncementBar title=\"Class & Section Allotment\" />\r\n\r\n            {/* Teaching Context Warning */}\r\n            <div style={{\r\n                background: 'linear-gradient(to right, #ff6b6b, #ff9f43)',\r\n                color: 'white',\r\n                padding: '10px',\r\n                textAlign: 'center',\r\n                fontWeight: 'bold',\r\n                fontSize: '14px'\r\n            }}>\r\n                ≡ƒôó Attention: Assign teachers and students only after proper feedback and evaluation process!\r\n            </div>\r\n\r\n            <div className=\"container\">\r\n                <div className=\"card\">\r\n                    {/* H2 removed as title is now in TopBar */}\r\n\r\n                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'center', marginBottom: '20px', flexWrap: 'wrap' }}>\r\n                        <select value={cls} onChange={e => setCls(e.target.value)} className=\"input-field\" style={{ width: 'auto', minWidth: '150px' }}>\r\n                            <option value=\"\">Select Class</option>\r\n                            {['Nursery', 'LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                        </select>\r\n                        <select value={sec} onChange={e => setSec(e.target.value)} className=\"input-field\" style={{ width: 'auto', minWidth: '150px' }}>\r\n                            <option value=\"\">Select Section</option>\r\n                            {['A', 'B', 'C', 'D'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                        </select>\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', marginBottom: '20px' }}>\r\n                        <button\r\n                            className=\"btn\"\r\n                            style={{ backgroundColor: role === 'teacher' ? '#0984e3' : '#b2bec3', flex: 1 }}\r\n                            onClick={() => setRole(role === 'teacher' ? null : 'teacher')}\r\n                        >\r\n                            ≡ƒæ¿ΓÇì≡ƒÅ½ {role === 'teacher' ? 'Close Teachers' : 'Teachers'}\r\n                        </button>\r\n                        <button\r\n                            className=\"btn\"\r\n                            style={{ backgroundColor: role === 'student' ? '#00b894' : '#b2bec3', flex: 1 }}\r\n                            onClick={() => setRole(role === 'student' ? null : 'student')}\r\n                        >\r\n                            ≡ƒæ⌐ΓÇì≡ƒÄô {role === 'student' ? 'Close Students' : 'Students'}\r\n                        </button>\r\n                    </div>\r\n\r\n                    {role && (\r\n                        <div style={{ animation: 'fadeIn 0.5s' }}>\r\n                            <h3 className=\"text-center\" style={{ margin: '20px 0' }}>{role === 'teacher' ? 'Teachers' : 'Students'} in {cls} - {sec}</h3>\r\n\r\n                            <div style={{ marginBottom: '20px', maxHeight: '500px', overflowY: 'auto' }}>\r\n                                {entries.length === 0 ? <p className=\"text-center text-muted\">No entries found.</p> : (\r\n                                    role === 'teacher' ? (\r\n                                        <table style={{ width: '100%', borderCollapse: 'collapse', background: 'white', borderRadius: '8px', overflow: 'hidden', boxShadow: '0 2px 5px rgba(0,0,0,0.05)' }}>\r\n                                            <thead style={{ background: '#f8f9fa', borderBottom: '2px solid #dfe6e9' }}>\r\n                                                <tr>\r\n                                                    <th style={{ padding: '12px', textAlign: 'center', width: '50px', color: '#636e72', fontSize: '13px' }}>S.No</th>\r\n                                                    <th style={{ padding: '12px', textAlign: 'left', color: '#636e72', fontSize: '13px' }}>Name</th>\r\n                                                    <th style={{ padding: '12px', textAlign: 'left', color: '#636e72', fontSize: '13px' }}>Subject</th>\r\n                                                    <th style={{ padding: '12px', textAlign: 'center', color: '#636e72', fontSize: '13px' }}>Actions</th>\r\n                                                </tr>\r\n                                            </thead>\r\n                                            <tbody>\r\n                                                {entries.map((e, index) => (\r\n                                                    <tr key={e.id} style={{ borderBottom: '1px solid #f1f2f6' }}>\r\n                                                        <td style={{ padding: '12px', textAlign: 'center', fontWeight: 'bold' }}>{index + 1}</td>\r\n                                                        <td style={{ padding: '12px' }}>{e.name}</td>\r\n                                                        <td style={{ padding: '12px' }}>\r\n                                                            <span style={{ background: '#e1f5fe', color: '#0288d1', padding: '2px 8px', borderRadius: '4px', fontSize: '12px' }}>\r\n                                                                {e.subject}\r\n                                                            </span>\r\n                                                        </td>\r\n                                                        <td style={{ padding: '12px', textAlign: 'center' }}>\r\n                                                            <div style={{ display: 'flex', gap: '8px', justifyContent: 'center' }}>\r\n                                                                <button\r\n                                                                    onClick={() => {\r\n                                                                        setName(e.name);\r\n                                                                        setExtra(e.subject || '');\r\n                                                                        if (e.userId) setSelectedUserId(e.userId);\r\n                                                                        alert(`Selected ${e.name}. \\n1. Now change Class/Section dropdowns at the top. \\n2. Then click 'Add' below.`);\r\n                                                                    }}\r\n                                                                    style={{\r\n                                                                        border: 'none', background: '#e3f2fd', color: '#1976d2', padding: '6px 10px',\r\n                                                                        borderRadius: '4px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'\r\n                                                                    }}\r\n                                                                    title=\"Add to Another Class\"\r\n                                                                >\r\n                                                                    + Another Class\r\n                                                                </button>\r\n\r\n                                                                <button\r\n                                                                    onClick={() => initiateTransfer(e)}\r\n                                                                    style={{\r\n                                                                        border: 'none', background: '#fff3e0', color: '#f57c00', padding: '6px 10px',\r\n                                                                        borderRadius: '4px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'\r\n                                                                    }}\r\n                                                                >\r\n                                                                    Transfer\r\n                                                                </button>\r\n\r\n                                                                <button\r\n                                                                    onClick={() => handleDelete(e.id)}\r\n                                                                    style={{\r\n                                                                        border: 'none', background: '#ffebee', color: '#c62828', padding: '6px 10px',\r\n                                                                        borderRadius: '4px', cursor: 'pointer', fontSize: '12px', fontWeight: '600'\r\n                                                                    }}\r\n                                                                >\r\n                                                                    Delete\r\n                                                                </button>\r\n                                                            </div>\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                ))}\r\n                                            </tbody>\r\n                                        </table>\r\n                                    ) : (\r\n                                        // Student List (Original Card Style)\r\n                                        entries.map(e => (\r\n                                            <div key={e.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px', background: '#f4f4f4', marginBottom: '8px', borderRadius: '8px' }}>\r\n                                                <span style={{ fontWeight: 'bold' }}>{e.name}</span>\r\n                                                <span style={{ color: '#666' }}>({role === 'teacher' ? e.subject : `${e.age} yrs`})</span>\r\n                                                <div style={{ display: 'flex', gap: '5px' }}>\r\n                                                    {role === 'teacher' && (\r\n                                                        <button\r\n                                                            className=\"btn\"\r\n                                                            style={{ backgroundColor: '#0984e3', padding: '5px 12px', fontSize: '12px' }}\r\n                                                            onClick={() => {\r\n                                                                setName(e.name);\r\n                                                                setExtra(e.subject || '');\r\n                                                                if (e.userId) setSelectedUserId(e.userId);\r\n                                                                alert(`Selected ${e.name}. \\n1. Now change Class/Section dropdowns at the top. \\n2. Then click 'Add' below.`);\r\n                                                            }}\r\n                                                        >\r\n                                                            + Another Class\r\n                                                        </button>\r\n                                                    )}\r\n                                                    <button className=\"btn\" style={{ backgroundColor: '#e74c3c', padding: '5px 12px', fontSize: '12px' }} onClick={() => handleDelete(e.id)}>Delete</button>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))\r\n                                    )\r\n                                )}\r\n                            </div>\r\n\r\n                            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', background: '#ecf0f1', padding: '15px', borderRadius: '8px' }}>\r\n                                {role === 'teacher' && (\r\n                                    <select className=\"input-field\" style={{ flex: 2 }} value={selectedUserId || ''} onChange={handleSelectTeacher}>\r\n                                        <option value=\"\">-- Select Existing Teacher --</option>\r\n                                        {existingTeachers.map(t => <option key={t.uid} value={t.uid}>{t.name} ({t.subject})</option>)}\r\n                                        <option value=\"\">(Or Type Manually)</option>\r\n                                    </select>\r\n                                )}\r\n                                <input className=\"input-field\" style={{ flex: 2 }} placeholder=\"Name\" value={name} onChange={e => setName(e.target.value)} disabled={!!selectedUserId} />\r\n                                <input className=\"input-field\" style={{ flex: 1 }} placeholder={role === 'teacher' ? 'Subject' : 'Age'} value={extra} onChange={e => setExtra(e.target.value)} />\r\n                                <button className=\"btn\" style={{ flex: 1, backgroundColor: '#2ecc71' }} onClick={handleAdd}>Add</button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    <div style={{ textAlign: 'center', marginTop: '30px' }}>\r\n                        <button className=\"btn\" style={{ backgroundColor: '#6c5ce7', marginRight: '10px' }} onClick={() => navigate('/admission')}>Γ₧ò New Admission</button>\r\n                        <button className=\"btn\" style={{ backgroundColor: '#fdcb6e', color: '#333' }} onClick={() => navigate('/waiting-list')}>≡ƒòÆ View Waiting List</button>\r\n                    </div>\r\n\r\n                </div>\r\n\r\n                {/* Transfer Modal */}\r\n                {transferTarget && (\r\n                    <div style={{\r\n                        position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n                        background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000\r\n                    }}>\r\n                        <div style={{ background: 'white', padding: '25px', borderRadius: '12px', width: '350px', boxShadow: '0 4px 15px rgba(0,0,0,0.2)' }}>\r\n                            <h3 style={{ marginTop: 0, color: '#2d3436' }}>Transfer Teacher</h3>\r\n                            <p style={{ color: '#636e72', fontSize: '14px' }}>\r\n                                Move <strong>{transferTarget.name}</strong> from\r\n                                <span style={{ background: '#dfe6e9', padding: '2px 5px', borderRadius: '3px', margin: '0 5px' }}>\r\n                                    {transferTarget.oldClass}-{transferTarget.oldSection}\r\n                                </span>\r\n                                to:\r\n                            </p>\r\n\r\n                            <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>\r\n                                <select\r\n                                    className=\"input-field\"\r\n                                    value={targetClass}\r\n                                    onChange={e => setTargetClass(e.target.value)}\r\n                                    style={{ flex: 1 }}\r\n                                >\r\n                                    <option value=\"\">Class</option>\r\n                                    {['Nursery', 'LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                                </select>\r\n                                <select\r\n                                    className=\"input-field\"\r\n                                    value={targetSection}\r\n                                    onChange={e => setTargetSection(e.target.value)}\r\n                                    style={{ flex: 1 }}\r\n                                >\r\n                                    <option value=\"\">Section</option>\r\n                                    {['A', 'B', 'C', 'D'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                                </select>\r\n                            </div>\r\n\r\n                            <div style={{ display: 'flex', gap: '10px' }}>\r\n                                <button\r\n                                    className=\"btn\"\r\n                                    onClick={handleTransfer}\r\n                                    style={{ flex: 1, backgroundColor: '#f1c40f', color: '#333' }}\r\n                                >\r\n                                    Confirm Transfer\r\n                                </button>\r\n                                <button\r\n                                    className=\"btn\"\r\n                                    onClick={() => setTransferTarget(null)}\r\n                                    style={{ flex: 1, backgroundColor: '#b2bec3' }}\r\n                                >\r\n                                    Cancel\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n            <style>{`\r\n                @keyframes fadeIn {\r\n                    from { opacity: 0; transform: translateY(10px); }\r\n                    to { opacity: 1; transform: translateY(0); }\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Announcements.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Attendance.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'teacherClasses' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":32,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"teacherClasses"},"fix":{"range":[1432,1446],"text":""},"desc":"Remove unused variable 'teacherClasses'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'debugLogs' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":34,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"debugLogs"},"fix":{"range":[1628,1637],"text":""},"desc":"Remove unused variable 'debugLogs'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'prev' is defined but never used.","line":167,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":167,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"prev"},"fix":{"range":[7898,7902],"text":"()"},"desc":"Remove unused variable 'prev'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'classNum' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":494,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":494,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"classNum"},"fix":{"range":[25387,25418],"text":""},"desc":"Remove unused variable 'classNum'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'sec' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":495,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":495,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"sec"},"fix":{"range":[25436,25464],"text":""},"desc":"Remove unused variable 'sec'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'currentSuspension' is defined but never used.","line":689,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":689,"endColumn":62,"suggestions":[{"messageId":"removeVar","data":{"varName":"currentSuspension"},"fix":{"range":[34718,34737],"text":""},"desc":"Remove unused variable 'currentSuspension'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'backPath' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":773,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":773,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"backPath"},"fix":{"range":[38019,38154],"text":""},"desc":"Remove unused variable 'backPath'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":1118,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":1118,"endColumn":59,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[63185,63192],"text":""},"desc":"Remove unused variable 'index'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, setDoc, doc, updateDoc } from 'firebase/firestore';\r\n\r\nimport AIBadge from '../components/AIBadge';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function Attendance() {\r\n    const { userData } = useUser();\r\n    const navigate = useNavigate();\r\n\r\n    // Prevent crash if context is loading\r\n    if (!userData) return <div className=\"p-4 text-center\">Loading...</div>;\r\n\r\n    const role = userData.role;\r\n    const instId = role === 'institution' ? userData.uid : userData.institutionId;\r\n\r\n    // View State\r\n    const [view, setView] = useState('students');\r\n    const [selectedClass, setSelectedClass] = useState('10');\r\n    const [selectedSection, setSelectedSection] = useState('A');\r\n    const [subject, setSubject] = useState(''); // New: Subject Context\r\n    const [list, setList] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);\r\n\r\n    // Student Stats State\r\n    const [mySubjectStats, setMySubjectStats] = useState([]);\r\n    const [myOverallStats, setMyOverallStats] = useState({ present: 0, total: 0, percent: 0 });\r\n    const [myHistory, setMyHistory] = useState([]); // New: History State\r\n    const [teacherClasses, setTeacherClasses] = useState([]); // Restricted classes for Teacher\r\n    const [showSubjects, setShowSubjects] = useState(false); // Toggle state for subject dropdown\r\n    const [debugLogs, setDebugLogs] = useState([]); // Troubleshooting Logs\r\n\r\n    // Student specific monthly timetable-based attendance\r\n    const [attendanceMonth, setAttendanceMonth] = useState(() => {\r\n        const d = new Date();\r\n        const m = String(d.getMonth() + 1).padStart(2, '0');\r\n        return `${d.getFullYear()}-${m}`;\r\n    });\r\n    const [studentTimetable, setStudentTimetable] = useState(null);\r\n    const [studentPeriods, setStudentPeriods] = useState([]);\r\n\r\n\r\n    useEffect(() => {\r\n        if (role === 'teacher' && userData?.uid) {\r\n            const fetchAllowedClasses = async () => {\r\n                try {\r\n                    // Fetch allotments linked to this teacher\r\n                    let classes = [];\r\n                    const clsHelper = (docSnap) => {\r\n                        const data = docSnap.data();\r\n                        return { class: data.classAssigned, section: data.section };\r\n                    };\r\n\r\n                    // 1. By userId (New)\r\n                    const q1 = query(collection(db, \"teacher_allotments\"), where(\"userId\", \"==\", userData.uid));\r\n                    const snap1 = await getDocs(q1);\r\n                    snap1.forEach(d => classes.push(clsHelper(d)));\r\n\r\n                    // 2. By teacherId (Legacy)\r\n                    const q2 = query(collection(db, \"teacher_allotments\"), where(\"teacherId\", \"==\", userData.uid));\r\n                    const snap2 = await getDocs(q2);\r\n                    snap2.forEach(d => classes.push(clsHelper(d)));\r\n\r\n                    // 3. By Name (Legacy Fallback)\r\n                    if (classes.length === 0 && userData.name) {\r\n                        const q3 = query(collection(db, \"teacher_allotments\"), where(\"name\", \"==\", userData.name));\r\n                        const snap3 = await getDocs(q3);\r\n                        snap3.forEach(d => classes.push(clsHelper(d)));\r\n                    }\r\n\r\n                    // Filter unique\r\n                    const uniqueMap = new Map();\r\n                    classes.forEach(c => {\r\n                        const key = `${c.class}-${c.section}`;\r\n                        if (!uniqueMap.has(key)) uniqueMap.set(key, c);\r\n                    });\r\n                    const uniqueClasses = Array.from(uniqueMap.values());\r\n\r\n                    setTeacherClasses(uniqueClasses);\r\n                    // Auto-select first if available (Overriding default '10' helps show actual data immediately)\r\n                    if (uniqueClasses.length > 0) {\r\n                        // FORCE UPDATE: Even if '10' is selected, if the teacher teaches '9', switch to '9'.\r\n                        // We check if the current 'selectedClass' is actually in the teacher's list?\r\n                        // Actually, simpler is just to default to the first one found.\r\n                        setSelectedClass(uniqueClasses[0].class);\r\n                        setSelectedSection(uniqueClasses[0].section);\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"Error fetching teacher classes\", e);\r\n                }\r\n            };\r\n            fetchAllowedClasses();\r\n        }\r\n    }, [role, userData]);\r\n\r\n    useEffect(() => {\r\n        if (role === 'student' && userData?.uid) {\r\n            const fetchStudentTimetable = async () => {\r\n                try {\r\n                    const uInstId = userData.institutionId || userData.createdBy;\r\n                    const uClass = (userData.class || userData.assignedClass || userData.classAssigned || '').toString().trim();\r\n                    const uSec = (userData.section || 'A').toString().trim();\r\n                    if (!uInstId || !uClass) return;\r\n\r\n                    const normClass = uClass.replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n                    const classVariants = [normClass, uClass, `${normClass}th`];\r\n\r\n                    const qT = query(collection(db, \"timetables\"), where(\"institutionId\", \"==\", uInstId));\r\n                    const snap = await getDocs(qT);\r\n\r\n                    let foundT = null;\r\n                    for (const d of snap.docs) {\r\n                        const dt = d.data();\r\n                        const dtClass = (dt.class || '').toString().trim();\r\n                        const dtClassNorm = dtClass.replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n\r\n                        if (classVariants.includes(dtClass) || normClass === dtClassNorm) {\r\n                            if ((dt.section || '').toLowerCase() === uSec.toLowerCase()) {\r\n                                foundT = dt;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (foundT) {\r\n                        setStudentTimetable(foundT.schedule || {});\r\n                        setStudentPeriods(foundT.periods || Array.from({ length: 8 }, (_, i) => ({ id: `p${i + 1}`, name: `${i + 1}th Period`, type: 'class' })));\r\n                    } else {\r\n                        setStudentPeriods(Array.from({ length: 8 }, (_, i) => ({ id: `p${i + 1}`, name: `${i + 1}th Period`, type: 'class' })));\r\n                    }\r\n                } catch (err) {\r\n                    console.error(\"Failed to fetch student timetable\", err);\r\n                }\r\n            };\r\n            fetchStudentTimetable();\r\n        }\r\n    }, [userData, role]);\r\n\r\n    useEffect(() => {\r\n        if (role) {\r\n            if (role === 'institution') setView('teachers');\r\n            else setView('students');\r\n\r\n            if (role === 'student' || role === 'teacher') {\r\n                fetchMyStats();\r\n            }\r\n        }\r\n    }, [role, userData]);\r\n\r\n    useEffect(() => {\r\n        if (role === 'student') return;\r\n        fetchData();\r\n    }, [selectedClass, selectedSection, selectedDate, view, role, userData, instId]);\r\n\r\n    const fetchMyStats = async () => {\r\n        if (!userData?.uid) return;\r\n        try {\r\n            let mergedDocs = [];\r\n            const seenIds = new Set();\r\n            const attendanceQueries = []; // Holds promises for parallel fetching\r\n\r\n            const uClass = userData.assignedClass || userData.class;\r\n            const uSection = userData.assignedSection || userData.section;\r\n            setDebugLogs(prev => [`Starting Fetch for ${userData.name} (${uClass}-${uSection})...`]);\r\n\r\n            // 1. Fetch by correct User UID\r\n            const q1 = query(collection(db, \"attendance\"), where(\"userId\", \"==\", userData.uid));\r\n            const snap1 = await getDocs(q1);\r\n            setDebugLogs(prev => [...prev, `Direct UID Match: Found ${snap1.size} records.`]);\r\n\r\n            snap1.forEach(d => {\r\n                if (!seenIds.has(d.id)) {\r\n                    seenIds.add(d.id);\r\n                    mergedDocs.push(d);\r\n                }\r\n            });\r\n\r\n            // 2. Teacher Fallback: Fetch by Allotment (Enhanced)\r\n            if (userData.role === 'teacher') {\r\n                try {\r\n                    // A. Linked Allotments (Fast)\r\n                    const tLinkedQ = query(collection(db, \"teacher_allotments\"), where(\"userId\", \"==\", userData.uid));\r\n                    const tLinkedSnap = await getDocs(tLinkedQ);\r\n                    setDebugLogs(prev => [...prev, `Teacher Linked Allotments: ${tLinkedSnap.size}`]);\r\n\r\n                    const linkedIds = new Set();\r\n                    tLinkedSnap.forEach(d => {\r\n                        linkedIds.add(d.id);\r\n                        if (d.id !== userData.uid) {\r\n                            attendanceQueries.push(getDocs(query(collection(db, \"attendance\"), where(\"userId\", \"==\", d.id))));\r\n                        }\r\n                    });\r\n\r\n                    // B. Name Match (Robust Client-Side)\r\n                    // Fetch all teacher allotments to ensure we match even if name spelling varies slightly\r\n                    const allTQ = query(collection(db, \"teacher_allotments\"));\r\n                    const allTSnap = await getDocs(allTQ);\r\n\r\n                    const myNameRaw = (userData.name || \"\").toLowerCase().replace(/\\s+/g, '');\r\n                    let nameMatches = 0;\r\n\r\n                    allTSnap.forEach(d => {\r\n                        if (linkedIds.has(d.id)) return; // Already handled\r\n\r\n                        const data = d.data();\r\n                        const tName = (data.name || \"\").toLowerCase().replace(/\\s+/g, '');\r\n\r\n                        // Robust Match: Contains check\r\n                        if (tName && myNameRaw && (tName.includes(myNameRaw) || myNameRaw.includes(tName))) {\r\n                            nameMatches++;\r\n                            if (d.id !== userData.uid) {\r\n                                attendanceQueries.push(getDocs(query(collection(db, \"attendance\"), where(\"userId\", \"==\", d.id))));\r\n                            }\r\n\r\n                            // Self-Healing\r\n                            if (!data.userId) {\r\n                                console.log(`Linking Teacher Allotment ${d.id} to ${userData.uid}`);\r\n                                updateDoc(doc(db, \"teacher_allotments\", d.id), { userId: userData.uid });\r\n                            }\r\n                        }\r\n                    });\r\n                    setDebugLogs(prev => [...prev, `Teacher Name Matches: ${nameMatches}`]);\r\n\r\n                } catch (err) {\r\n                    console.warn(\"Teacher fetch failed\", err);\r\n                    setDebugLogs(prev => [...prev, `Teacher Fetch Error: ${err.message}`]);\r\n                }\r\n            }\r\n\r\n\r\n            // 3. Student Fallback: Fetch by Allotment ID\r\n            if (userData.role === 'student') {\r\n                try {\r\n                    // A. Explicit Link Match: Allotments already linked to this User UID\r\n                    // (This catches cases where name might be different but ID is linked)\r\n                    const linkedAllotQ = query(collection(db, \"student_allotments\"), where(\"userId\", \"==\", userData.uid));\r\n                    const linkedSnap = await getDocs(linkedAllotQ);\r\n                    setDebugLogs(prev => [...prev, `Linked Allotments (by UID): Found ${linkedSnap.size}.`]);\r\n\r\n                    linkedSnap.forEach(d => {\r\n                        // For each linked allotment (e.g. \"Pradeep's Allotment\"), verify if attendance is stored under the Allotment ID...\r\n                        if (d.id !== userData.uid) {\r\n                            const q2 = query(collection(db, \"attendance\"), where(\"userId\", \"==\", d.id));\r\n                            attendanceQueries.push(getDocs(q2));\r\n                        }\r\n\r\n                        // ...OR under the User ID itself (data.userId) if it was ever used directly\r\n                        const data = d.data();\r\n                        if (data.userId && data.userId !== d.id) {\r\n                            const q3 = query(collection(db, \"attendance\"), where(\"userId\", \"==\", data.userId));\r\n                            attendanceQueries.push(getDocs(q3));\r\n                        }\r\n                    });\r\n\r\n                    // B. Legacy Name Match: Allotments matching Name/Class (if not linked)\r\n                    // DATA NORMALIZATION FIX:\r\n                    // 1. Construct Name: If 'name' is missing, combine first/second strings.\r\n                    // 2. Normalize Class: Convert '10th' -> '10', '1st' -> '1', etc to match Allotment format.\r\n\r\n                    const rawName = userData.name || `${userData.firstName || ''} ${userData.secondName || ''}`.trim();\r\n\r\n                    // Remove non-numeric characters from class (e.g. \"10th\" -> \"10\") to match Allotment's simpler format\r\n                    // If it's \"Nursery\"/\"LKG\"/\"UKG\", it stays the same.\r\n                    const normalizedClass = (uClass || '').replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n\r\n                    if (normalizedClass && uSection && rawName) {\r\n\r\n                        // Fetch ALL students in this class/section\r\n                        // Robust fetch: Check multiple class formats: \"5\", \"5th\", \"05\", \"Class 5\"\r\n                        const classVariants = [\r\n                            normalizedClass,\r\n                            uClass,\r\n                            `${normalizedClass}th`,\r\n                            normalizedClass.replace(/^0+/, ''), // Remove leading zeros\r\n                            `Class ${normalizedClass}`\r\n                        ].filter(Boolean); // Remove null/undefined\r\n\r\n                        // Remove duplicates\r\n                        const uniqueVariants = [...new Set(classVariants)];\r\n\r\n                        // Better Fallback: Fetch by institutionId/createdBy to avoid missing records that use 'class' instead of 'classAssigned'\r\n                        let altDocs = [];\r\n                        const uInstId = userData.institutionId || userData.createdBy;\r\n                        if (uInstId) {\r\n                            const qA = query(collection(db, \"student_allotments\"), where(\"institutionId\", \"==\", uInstId));\r\n                            const qB = query(collection(db, \"student_allotments\"), where(\"createdBy\", \"==\", uInstId));\r\n                            const [snapA, snapB] = await Promise.all([\r\n                                getDocs(qA).catch(() => ({ docs: [] })),\r\n                                getDocs(qB).catch(() => ({ docs: [] }))\r\n                            ]);\r\n                            const seenA = new Set();\r\n                            [...snapA.docs, ...snapB.docs].forEach(d => {\r\n                                if (!seenA.has(d.id)) {\r\n                                    seenA.add(d.id);\r\n                                    altDocs.push(d);\r\n                                }\r\n                            });\r\n                        } else {\r\n                            const altQ = query(collection(db, \"student_allotments\"), where(\"classAssigned\", \"in\", uniqueVariants));\r\n                            const altSnap = await getDocs(altQ);\r\n                            altDocs = altSnap.docs;\r\n                        }\r\n\r\n                        setDebugLogs(prev => [...prev, `Scanning ${altDocs.length} allotments in Institution`]);\r\n\r\n                        const targetName = rawName.toLowerCase().replace(/\\s+/g, ''); // normalize spaces\r\n                        const targetSec = (uSection || '').trim().toLowerCase();\r\n                        const targetNormClass = normalizedClass.toLowerCase();\r\n                        const targetRoll = (userData.rollNo || userData.rollNumber || userData.pid || '').toString().trim().toLowerCase();\r\n\r\n                        let nameMatches = 0;\r\n\r\n                        altDocs.forEach(d => {\r\n                            const data = d.data();\r\n\r\n                            const docRoll = (data.rollNo || data.rollNumber || data.pid || '').toString().trim().toLowerCase();\r\n                            const isRollMatch = (docRoll && targetRoll && docRoll === targetRoll);\r\n\r\n                            const allotmentName = (data.name || \"\").toLowerCase().replace(/\\s+/g, '');\r\n                            let isNameMatch = false;\r\n\r\n                            if (allotmentName && targetName) {\r\n                                if (allotmentName === targetName) isNameMatch = true;\r\n                                else if (targetName.length > 3 && allotmentName.includes(targetName)) isNameMatch = true;\r\n                                else if (allotmentName.length > 3 && targetName.includes(allotmentName)) isNameMatch = true;\r\n\r\n                                if (!isNameMatch) {\r\n                                    const ap = (data.name || \"\").toLowerCase().split(/\\s+/).filter(p => p.length > 2);\r\n                                    const tp = rawName.toLowerCase().split(/\\s+/).filter(p => p.length > 2);\r\n                                    if (tp.length > 0 && ap.length > 0) {\r\n                                        const overlap = tp.filter(t => ap.some(a => a.includes(t) || t.includes(a)));\r\n                                        if (overlap.length > 0) isNameMatch = true;\r\n                                    }\r\n                                }\r\n                            }\r\n\r\n                            // If neither roll matches nor name matches, skip entirely\r\n                            if (!isRollMatch && !isNameMatch) return;\r\n\r\n                            // If name matches but roll doesn't exist, we must still respect class and section lightly\r\n                            if (!isRollMatch) {\r\n                                const iClass = (data.class || data.assignedClass || data.classAssigned || '').toString().trim().toLowerCase();\r\n                                const normIClass = iClass.replace(/(\\d+)(st|nd|rd|th)/, '$1');\r\n\r\n                                // Only block if we have strong class details on both ends completely clashing\r\n                                if (normIClass && targetNormClass && normIClass !== targetNormClass && iClass !== (uClass || '').trim().toLowerCase() && iClass !== `${targetNormClass}th`) {\r\n                                    return; // Skip wrong class\r\n                                }\r\n\r\n                                const docSec = (data.section || '').trim().toLowerCase();\r\n                                if (docSec && targetSec && docSec !== targetSec) {\r\n                                    return; // Skip wrong section\r\n                                }\r\n                            }\r\n\r\n                            // 3. Match Found!\r\n                            if (d.id !== userData.uid) {\r\n                                nameMatches++;\r\n\r\n                                // SELF-HEALING: Link this allotment to my UID so next time it's instant\r\n                                if (!data.userId) {\r\n                                    console.log(`Self-healing Link: Linking Allotment ${d.id} (${data.name}) to User ${userData.uid}`);\r\n                                    updateDoc(doc(db, \"student_allotments\", d.id), { userId: userData.uid })\r\n                                        .then(() => setDebugLogs(prev => [...prev, \" Self-healed student link successfully.\"]))\r\n                                        .catch(e => console.warn(\"Heal failed\", e));\r\n                                } else if (data.userId !== userData.uid) {\r\n                                    // If linked to WRONG user (rare but possible during testing), minimal log\r\n                                    console.warn(`Allotment ${d.id} linked to other user ${data.userId}`);\r\n                                }\r\n\r\n                                const q3 = query(collection(db, \"attendance\"), where(\"userId\", \"==\", d.id)); // Attendance marked against Allotment ID\r\n                                attendanceQueries.push(getDocs(q3));\r\n\r\n                                // ALSO check for attendance marked against the USER ID if the teacher just started using the new system\r\n                                if (data.userId) { // If it was already linked\r\n                                    const q4 = query(collection(db, \"attendance\"), where(\"userId\", \"==\", data.userId));\r\n                                    attendanceQueries.push(getDocs(q4));\r\n                                }\r\n                            }\r\n                        });\r\n                        setDebugLogs(prev => [...prev, `Name & Section Matches: ${nameMatches}`]);\r\n                    }\r\n\r\n                    // Execute all legacy/fallback queries\r\n                    const fallbackResults = await Promise.all(attendanceQueries);\r\n                    fallbackResults.forEach(snap => {\r\n                        snap.forEach(d => {\r\n                            if (!seenIds.has(d.id)) {\r\n                                seenIds.add(d.id);\r\n                                mergedDocs.push(d);\r\n                            }\r\n                        });\r\n                    });\r\n                    setDebugLogs(prev => [...prev, `Total Attendance Docs Merged: ${mergedDocs.length}`]);\r\n\r\n                } catch (err) {\r\n                    console.warn(\"Legacy attendance fetch failed\", err);\r\n                    setDebugLogs(prev => [...prev, `Error: ${err.message}`]);\r\n                }\r\n            } // End Student If\r\n\r\n            // 4. SHARED EXECUTION (Ensures Teacher Queries Run)\r\n            if (attendanceQueries.length > 0) {\r\n                const finalRes = await Promise.all(attendanceQueries);\r\n                finalRes.forEach(snap => {\r\n                    snap.forEach(d => {\r\n                        if (!seenIds.has(d.id)) {\r\n                            seenIds.add(d.id);\r\n                            mergedDocs.push(d);\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n\r\n            const subjectsObj = {};\r\n            let globalTotal = 0;\r\n            let globalPresent = 0;\r\n            const historyList = [];\r\n\r\n            mergedDocs.forEach(d => {\r\n                const data = d.data();\r\n                historyList.push({ id: d.id, ...data });\r\n\r\n                const subj = data.subject || 'General';\r\n\r\n                if (!subjectsObj[subj]) subjectsObj[subj] = { total: 0, present: 0 };\r\n\r\n                subjectsObj[subj].total++;\r\n                globalTotal++;\r\n\r\n                const rawStatus = typeof data.status === 'string' ? data.status.toLowerCase().trim() : data.status;\r\n                if (rawStatus === 'present' || rawStatus === 'p') {\r\n                    subjectsObj[subj].present++;\r\n                    globalPresent++;\r\n                }\r\n            });\r\n\r\n            // Sort history by date descending\r\n            historyList.sort((a, b) => new Date(b.date) - new Date(a.date));\r\n            setMyHistory(historyList); // React key use `h.id`\r\n\r\n            // Convert to Array\r\n            const statsArr = Object.keys(subjectsObj).map(key => ({\r\n                subject: key,\r\n                present: subjectsObj[key].present,\r\n                total: subjectsObj[key].total,\r\n                percent: subjectsObj[key].total > 0 ? ((subjectsObj[key].present / subjectsObj[key].total) * 100).toFixed(0) : 0\r\n            }));\r\n\r\n            setMySubjectStats(statsArr);\r\n            setMyOverallStats({\r\n                present: globalPresent,\r\n                total: globalTotal,\r\n                percent: globalTotal > 0 ? ((globalPresent / globalTotal) * 100).toFixed(0) : 0\r\n            });\r\n\r\n        } catch (e) {\r\n            console.error(\"Error fetching stats\", e);\r\n            setDebugLogs(prev => [...prev, `Critical Error: ${e.message}`]);\r\n        }\r\n    };\r\n\r\n    const fetchData = async () => {\r\n        if (view === 'students' && !selectedClass) {\r\n            setList([]);\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setList([]);\r\n        try {\r\n            const colName = view === 'teachers' ? 'teacher_allotments' : 'student_allotments';\r\n\r\n            // Robust check using lowercased role\r\n            const userRole = (role || \"\").toLowerCase();\r\n            const creatorId = userRole === 'institution' ? userData.uid : userData.institutionId;\r\n\r\n            if (!creatorId) {\r\n                console.warn(\"No creator/institution ID found, aborting fetch.\");\r\n                setDebugLogs(prev => [...prev, \"Abort: No Creator ID (Inst/Admin ID) found on User Data.\"]);\r\n                setLoading(false);\r\n                return;\r\n            }\r\n\r\n            console.log(`FetchData Start | Role: ${role} | View: ${view} | Creator: ${creatorId} | Class: ${selectedClass} | Sec: ${selectedSection}`);\r\n\r\n\r\n            const fetchPromises = [];\r\n\r\n            if (view === 'students') {\r\n                const classNum = selectedClass;\r\n                const sec = selectedSection;\r\n\r\n                // BROAD FETCH STRATEGY:\r\n                // Query all students for this institution, then filter client-side.\r\n                // This bypasses issues with \"10\" vs \"10th\" vs \"Class 10\" mismatch in Firestore indexes or fields.\r\n\r\n                // Query A: CreatedBy (Legacy)\r\n                fetchPromises.push(getDocs(query(collection(db, colName), where('createdBy', '==', creatorId))));\r\n\r\n                // Query B: InstitutionId (Robust/New)\r\n                fetchPromises.push(getDocs(query(collection(db, colName), where('institutionId', '==', creatorId))));\r\n\r\n                // Query C: FALLBACK (Direct Class/Sec Match - Use sparingly, but needed if ID linkage is broken)\r\n                // If we are a teacher, we might not have 'createdBy' set to us, but we have 'class' rights?\r\n                // Actually, for Teachers, we rely on 'institutionId' on the student doc.\r\n                // If that is missing, we try to match simply by Class + Section if we are desperate.\r\n                if (role === 'teacher') {\r\n                    // CAUTION: This might return students from other schools if not careful, but we filter by ID later?\r\n                    // No, let's trust the Teacher's 'institutionId' field. If that fails...\r\n                    // Let's add a query that matches Class + Section broadly, then we filter?\r\n                    // Risk: Data scraping from other schools. \r\n                    // SAFETY: Only do this if we have a valid Inst ID to check against, OR just rely on Index.\r\n\r\n                    // Safer Fallback: Query by 'assignedClass' (legacy user field) or 'classAssigned'\r\n                    // Only fetch if we have a specific class selected\r\n                    if (selectedClass) {\r\n                        // Generate variants: \"10\", \"10th\", \"Class 10\", \"Grade 10\"\r\n                        const baseVal = selectedClass.replace(/[^0-9]/g, ''); // Extract '10'\r\n                        const variants = [\r\n                            selectedClass,\r\n                            baseVal,\r\n                            `${baseVal}th`,\r\n                            `Class ${baseVal}`,\r\n                            `Grade ${baseVal}`\r\n                        ];\r\n                        // Remove duplicates/empty\r\n                        const uniqueVariants = [...new Set(variants)].filter(Boolean);\r\n\r\n                        console.log(\"Using Fallback Variants:\", uniqueVariants);\r\n                        fetchPromises.push(getDocs(query(collection(db, colName), where('classAssigned', 'in', uniqueVariants))));\r\n                    }\r\n                }\r\n            } else {\r\n                // View == Teachers\r\n                // Query A: CreatedBy\r\n                fetchPromises.push(getDocs(query(collection(db, colName), where('createdBy', '==', creatorId))));\r\n\r\n                // Query B: InstitutionId\r\n                fetchPromises.push(getDocs(query(collection(db, colName), where('institutionId', '==', creatorId))));\r\n            }\r\n\r\n            // ADDED: Swallow errors from individual queries so one failure doesn't kill all\r\n            const snapshots = await Promise.all(fetchPromises.map(p => p.catch(e => {\r\n                console.warn(\"Sub-query failed\", e);\r\n                return { forEach: () => { } }; // Return empty dummy\r\n            })));\r\n\r\n            // Merge & Deduplicate\r\n            const uniqueMap = new Map();\r\n            snapshots.forEach(snap => {\r\n                snap.forEach(d => {\r\n                    if (!uniqueMap.has(d.id)) {\r\n                        uniqueMap.set(d.id, { id: d.id, ...d.data() });\r\n                    }\r\n                });\r\n            });\r\n\r\n            let rawList = Array.from(uniqueMap.values());\r\n\r\n            // CLIENT-SIDE FILTERING (Robust)\r\n            if (view === 'students') {\r\n                const targetSec = (selectedSection || '').trim().toLowerCase();\r\n                const targetClassRaw = (selectedClass || '').toLowerCase().trim();\r\n                const targetClassNorm = targetClassRaw.replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n\r\n                rawList = rawList.filter(item => {\r\n                    if (targetSec && targetSec !== 'all') {\r\n                        if ((item.section || '').trim().toLowerCase() !== targetSec) return false;\r\n                    }\r\n                    const itemClass = (item.classAssigned || '').toLowerCase().trim();\r\n                    const itemClassNorm = itemClass.replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n                    return (\r\n                        itemClass === targetClassRaw ||\r\n                        itemClassNorm === targetClassNorm ||\r\n                        itemClass === targetClassNorm ||\r\n                        itemClassNorm === targetClassRaw\r\n                    );\r\n                });\r\n            }\r\n\r\n            // Deduplicate & Merge\r\n            let fetched = rawList;\r\n            if (view === 'students') {\r\n                const uniqueMap = new Map();\r\n                rawList.forEach(item => {\r\n                    // Deduplicate by userId if available, otherwise by roll number + name combo\r\n                    const stId = item.userId || `${(item.rollNo || item.rollNumber || item.pid || 'NOROLL')}-${(item.studentName || item.name || 'NONAME').toLowerCase().trim()}`;\r\n                    if (!uniqueMap.has(stId)) {\r\n                        uniqueMap.set(stId, {\r\n                            ...item,\r\n                            id: item.id,\r\n                            name: item.studentName || item.name || 'Unknown Student'\r\n                        });\r\n                    }\r\n                });\r\n                fetched = Array.from(uniqueMap.values());\r\n            } else if (view === 'teachers') {\r\n                const uniqueMap = new Map();\r\n                rawList.forEach(item => {\r\n                    const tId = item.userId || item.teacherId || item.id;\r\n                    if (!uniqueMap.has(tId)) {\r\n                        uniqueMap.set(tId, {\r\n                            ...item,\r\n                            id: tId,\r\n                            name: item.teacherName || item.name || 'Unknown Teacher'\r\n                        });\r\n                    }\r\n                });\r\n                fetched = Array.from(uniqueMap.values());\r\n                if (subject) {\r\n                    fetched = fetched.filter(t => (t.subject || '').toLowerCase().includes(subject.toLowerCase()));\r\n                }\r\n            }\r\n\r\n            // Fetch Attendance for Date\r\n            let attQuery = query(collection(db, \"attendance\"), where(\"date\", \"==\", selectedDate));\r\n            if (view === 'students' && subject) {\r\n                attQuery = query(collection(db, \"attendance\"), where(\"date\", \"==\", selectedDate), where(\"subject\", \"==\", subject));\r\n            }\r\n\r\n            const attendanceSnap = await getDocs(attQuery);\r\n            const attendanceMap = {};\r\n            attendanceSnap.docs.forEach(d => {\r\n                attendanceMap[d.data().userId] = d.data().status;\r\n            });\r\n\r\n            // Calculate Stats for Percentages\r\n            const stats = await Promise.all(fetched.map(async (p) => {\r\n                const targetId = p.userId || p.id;\r\n                let qStats;\r\n                if (view === 'students' && subject) {\r\n                    qStats = query(collection(db, \"attendance\"), where(\"userId\", \"==\", targetId), where(\"subject\", \"==\", subject));\r\n                } else {\r\n                    qStats = query(collection(db, \"attendance\"), where(\"userId\", \"==\", targetId));\r\n                }\r\n\r\n                const allAtt = await getDocs(qStats);\r\n                let total = 0, present = 0;\r\n                allAtt.forEach(doc => {\r\n                    total++;\r\n                    const statusStr = typeof doc.data().status === 'string' ? doc.data().status.toLowerCase().trim() : doc.data().status;\r\n                    if (statusStr === 'present' || statusStr === 'p') present++;\r\n                });\r\n\r\n                return {\r\n                    id: p.id,\r\n                    targetId, // actual UID used for marking\r\n                    percent: total > 0 ? ((present / total) * 100).toFixed(0) : 0,\r\n                    present,\r\n                    total\r\n                };\r\n            }));\r\n\r\n            const statsMap = {};\r\n            stats.forEach(s => statsMap[s.id] = s);\r\n\r\n            const merged = fetched.map(p => {\r\n                const s = statsMap[p.id];\r\n                return {\r\n                    ...p,\r\n                    status: attendanceMap[s.targetId] || 'pending',\r\n                    percentage: s.percent,\r\n                    statsData: s\r\n                };\r\n            });\r\n\r\n            // Sort Alphabetically\r\n            merged.sort((a, b) => (a.name || \"\").localeCompare(b.name || \"\"));\r\n            setList(merged);\r\n\r\n            // Sort Alphabetically by Name\r\n            merged.sort((a, b) => (a.name || \"\").localeCompare(b.name || \"\"));\r\n\r\n            setList(merged);\r\n\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // --- ACTIONS ---\r\n\r\n    const handleSuspend = async (studentId, currentSuspension) => {\r\n        const daysStr = prompt(\"Enter suspension duration in days (0 to lift):\", \"3\");\r\n        if (daysStr === null) return;\r\n        const days = parseInt(daysStr, 10);\r\n        if (isNaN(days)) return alert(\"Invalid number\");\r\n\r\n        const until = new Date();\r\n        until.setDate(until.getDate() + days); // Add days\r\n\r\n        try {\r\n            // Update Student Allotment\r\n            await updateDoc(doc(db, \"student_allotments\", studentId), {\r\n                suspendedUntil: days > 0 ? until : null\r\n            });\r\n            // Update local state\r\n            setList(prev => prev.map(item => item.id === studentId ? {\r\n                ...item,\r\n                suspendedUntil: days > 0 ? { seconds: until.getTime() / 1000 } : null\r\n            } : item));\r\n            alert(days > 0 ? `Student suspended for ${days} days.` : \"Suspension lifted.\");\r\n        } catch (e) {\r\n            console.error(\"Suspension failed\", e);\r\n            alert(\"Error updating suspension.\");\r\n        }\r\n    };\r\n\r\n    const markAttendance = async (id, status) => {\r\n        // Validation Removed: Subject is now optional (defaults to General)\r\n\r\n        const person = list.find(l => l.id === id);\r\n        if (!person) return;\r\n\r\n        // 1. Suspension Check (Teachers)\r\n        if (view === 'students' && role === 'teacher') {\r\n            if (person.suspendedUntil) {\r\n                const suspendDate = new Date(person.suspendedUntil.seconds * 1000);\r\n                if (suspendDate > new Date()) {\r\n                    alert(`≡ƒÜ½ Cannot mark attendance. Student is suspended until ${suspendDate.toLocaleDateString()}`);\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        // 3. \"Only 1 Time\" Rule (Duplicate Check)\r\n        if (person.status !== 'pending') {\r\n            alert(\"ΓÜá∩╕Å Attendance already marked for this subject today! updates are not allowed.\");\r\n            return;\r\n        }\r\n\r\n        // CRITICAL FIX: Use the linked User UID if available\r\n        const targetId = person.userId || id;\r\n\r\n        try {\r\n            const finalSubject = view === 'teachers' ? 'General' : (subject || userData.subject || 'General');\r\n            const docId = `${selectedDate}_${targetId}_${finalSubject}`;\r\n\r\n            await setDoc(doc(db, \"attendance\", docId), {\r\n                userId: targetId,\r\n                date: selectedDate,\r\n                subject: finalSubject,\r\n                status: status,\r\n                role: view === 'teachers' ? 'teacher' : 'student',\r\n                updater: userData.uid,\r\n                updaterName: userData.name || \"Unknown Staff\", // Store name for student view\r\n                timestamp: new Date()\r\n            });\r\n            setList(prev => prev.map(item => item.id === id ? { ...item, status } : item));\r\n        } catch (e) {\r\n            console.error(\"Error marking attendance:\", e);\r\n            alert(\"Error marking attendance\");\r\n        }\r\n    };\r\n\r\n    // Helper to check suspension status for UI\r\n    const isSuspended = (person) => {\r\n        if (!person.suspendedUntil) return false;\r\n        // Compare dates\r\n        const now = new Date();\r\n        const susp = new Date(person.suspendedUntil.seconds * 1000);\r\n        return susp > now;\r\n    };\r\n\r\n\r\n    const backPath = role === 'student' ? '/student' : (role === 'teacher' ? '/teacher' : (role === 'institution' ? '/institution' : '/'));\r\n\r\n    // --- STUDENT VIEW ---\r\n    if (role === 'student') {\r\n        if (!userData) return <div className=\"text-center p-4\">Loading Data...</div>;\r\n\r\n        return (\r\n            <div className=\"page-wrapper\" style={{ minHeight: '100vh', background: '#f5f7fa' }}>\r\n                <AIBadge />\r\n\r\n                <div className=\"container\" style={{ maxWidth: '800px', margin: '20px auto', paddingBottom: '50px' }}>\r\n\r\n                    {/* Overall Score Card */}\r\n                    <div className=\"card text-center\" style={{ padding: '30px', marginBottom: '20px', background: 'linear-gradient(135deg, #6c5ce7, #a29bfe)', color: 'white', borderRadius: '15px' }}>\r\n                        <h2 style={{ margin: 0, color: 'white' }}>Overall Attendance</h2>\r\n                        <div style={{ fontSize: '3.5rem', fontWeight: 'bold', margin: '10px 0' }}>\r\n                            {myOverallStats?.percent || 0}%\r\n                        </div>\r\n                        <p style={{ opacity: 0.9 }}>\r\n                            {myOverallStats?.present || 0} / {myOverallStats?.total || 0} Classes Attended\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* Subject-Wise Breakdown */}\r\n                    <h3 style={{ marginLeft: '10px', color: '#2d3436' }}>Subject-Wise Breakdown</h3>\r\n                    <div className=\"responsive-grid\" style={{ marginTop: '10px' }}>\r\n                        {mySubjectStats && mySubjectStats.length > 0 ? mySubjectStats.map((stat, idx) => (\r\n                            <div key={idx} className=\"card\" style={{ padding: '20px', textAlign: 'center', borderRadius: '12px' }}>\r\n                                <div style={{ fontWeight: 'bold', fontSize: '1.2rem', marginBottom: '10px', color: '#2d3436' }}>\r\n                                    {stat?.subject || 'Subject'}\r\n                                </div>\r\n                                <div style={{ fontSize: '2rem', fontWeight: 'bold', color: parseInt(stat.percent) >= 75 ? '#00b894' : '#d63031' }}>\r\n                                    {stat?.percent || 0}%\r\n                                </div>\r\n                                <div style={{ fontSize: '0.9rem', color: '#636e72', marginTop: '5px' }}>\r\n                                    {stat?.present || 0} / {stat?.total || 0} Classes\r\n                                </div>\r\n                            </div>\r\n                        )) : (\r\n                            <p className=\"text-muted\" style={{ padding: '20px', width: '100%' }}>No subject records found yet.</p>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Monthly Timetable Attendance View */}\r\n                    <div className=\"card\" style={{ marginTop: '30px', overflowX: 'auto', borderRadius: '12px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>\r\n                            <h3 style={{ margin: 0, color: '#2d3436' }}>≡ƒôà Monthly Period Tracker</h3>\r\n                            <input\r\n                                type=\"month\"\r\n                                className=\"input-field\"\r\n                                style={{ width: 'auto', margin: 0, padding: '5px 10px' }}\r\n                                value={attendanceMonth}\r\n                                onChange={(e) => setAttendanceMonth(e.target.value)}\r\n                            />\r\n                        </div>\r\n\r\n                        {studentPeriods && studentPeriods.length > 0 ? (\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse', textAlign: 'center', fontSize: '14px' }}>\r\n                                <thead>\r\n                                    <tr style={{ background: '#f5f7fa', borderBottom: '2px solid #dfe6e9' }}>\r\n                                        <th style={{ padding: '12px 10px', color: '#636e72', fontWeight: 'bold' }}>S.No</th>\r\n                                        <th style={{ padding: '12px 10px', color: '#636e72', fontWeight: 'bold' }}>Date</th>\r\n                                        {studentPeriods.filter(p => p.type !== 'break').map(p => (\r\n                                            <th key={p.id} style={{ padding: '12px 10px', color: '#636e72', fontWeight: 'bold' }}>{p.name}</th>\r\n                                        ))}\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {(() => {\r\n                                        const [y, m] = attendanceMonth.split('-');\r\n                                        const year = parseInt(y, 10);\r\n                                        const month = parseInt(m, 10);\r\n                                        const daysInMonth = new Date(year, month, 0).getDate();\r\n\r\n                                        const histMap = {};\r\n                                        myHistory.forEach(h => {\r\n                                            if (h.date) {\r\n                                                const parts = h.date.split('-');\r\n                                                if (parts.length === 3) {\r\n                                                    const dKey = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;\r\n                                                    if (!histMap[dKey]) histMap[dKey] = {};\r\n                                                    const s = (h.subject || 'General').trim().toLowerCase();\r\n                                                    const strStatus = typeof h.status === 'string' ? h.status.toLowerCase().trim() : h.status;\r\n                                                    histMap[dKey][s] = strStatus;\r\n\r\n                                                }\r\n                                            }\r\n                                        });\r\n\r\n                                        const rows = [];\r\n                                        const classPeriods = studentPeriods.filter(p => p.type !== 'break');\r\n                                        const today = new Date();\r\n\r\n                                        for (let day = 1; day <= daysInMonth; day++) {\r\n                                            const dateObj = new Date(year, month - 1, day);\r\n                                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\r\n                                            const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dateObj.getDay()];\r\n                                            const daySchedule = studentTimetable ? studentTimetable[dayOfWeek] : null;\r\n\r\n                                            const isSunday = dateObj.getDay() === 0;\r\n                                            const isFuture = dateObj > today;\r\n\r\n                                            rows.push(\r\n                                                <tr key={day} style={{ borderBottom: '1px solid #f1f2f6', background: isSunday ? '#fff3cd' : 'transparent' }}>\r\n                                                    <td style={{ padding: '12px 10px', color: '#636e72' }}>{day}</td>\r\n                                                    <td style={{ padding: '12px 10px', fontWeight: 'bold', color: '#2d3436' }}>{dateStr.slice(5)}</td>\r\n                                                    {classPeriods.map(p => {\r\n                                                        const subj = daySchedule ? daySchedule[p.id]?.subject : null;\r\n                                                        let displayStatus = <span style={{ color: '#b2bec3' }}>-</span>;\r\n\r\n                                                        const targetedSubject = (subj || '').trim().toLowerCase();\r\n                                                        let status = null;\r\n\r\n                                                        if (histMap[dateStr]) {\r\n                                                            if (targetedSubject && histMap[dateStr][targetedSubject]) {\r\n                                                                status = histMap[dateStr][targetedSubject];\r\n                                                            }\r\n                                                        }\r\n\r\n                                                        // Override output hierarchically\r\n                                                        if (status === 'present') {\r\n                                                            displayStatus = <span style={{ color: '#00b894', fontWeight: 'bold', fontSize: '16px' }}>P</span>;\r\n                                                        } else if (status === 'absent') {\r\n                                                            displayStatus = <span style={{ color: '#d63031', fontWeight: 'bold', fontSize: '16px' }}>A</span>;\r\n                                                        } else if (status === 'leave') {\r\n                                                            displayStatus = <span style={{ color: '#e1b12c', fontWeight: 'bold', fontSize: '16px' }}>L</span>;\r\n                                                        } else if (isSunday) {\r\n                                                            displayStatus = <span style={{ color: '#d63031', fontSize: '10px', fontWeight: 'bold' }}>HOLIDAY</span>;\r\n                                                        } else if (isFuture) {\r\n                                                            displayStatus = <span style={{ color: '#dfe6e9' }}>-</span>;\r\n                                                        } else if (subj) {\r\n                                                            displayStatus = <span style={{ color: '#636e72', fontSize: '11px', textTransform: 'uppercase', opacity: 0.7 }}>{subj.length > 5 ? subj.substring(0, 5) + '..' : subj}</span>;\r\n                                                        }\r\n\r\n                                                        return <td key={p.id} style={{ padding: '12px 10px' }}>{displayStatus}</td>;\r\n                                                    })}\r\n                                                </tr>\r\n                                            );\r\n                                        }\r\n                                        return rows;\r\n                                    })()}\r\n                                </tbody>\r\n                            </table>\r\n                        ) : (\r\n                            <div style={{ textAlign: 'center', padding: '40px', color: '#636e72' }}>\r\n                                No timetable mapped.\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // --- TEACHER & INSTITUTION VIEW ---\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <AIBadge />\r\n\r\n\r\n            <div className=\"container\" style={{ maxWidth: '900px', margin: '20px auto' }}>\r\n\r\n                {/* Teacher's Own Stats */}\r\n                {role === 'teacher' && (\r\n                    <div className=\"card\" style={{ background: 'linear-gradient(to right, #74b9ff, #a29bfe)', color: 'white', marginBottom: '20px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '15px' }}>\r\n                            <div>\r\n                                <h3 style={{ margin: 0, color: 'white' }}>My Attendance</h3>\r\n                                <p style={{ margin: 0, opacity: 0.9 }}>Overall</p>\r\n                            </div>\r\n                            <div style={{ textAlign: 'right' }}>\r\n                                <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{myOverallStats.percent}%</div>\r\n                                <div style={{ fontSize: '0.9rem' }}>{myOverallStats.present}/{myOverallStats.total} Days</div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Recent History Toggle/View */}\r\n                        <div style={{ background: 'rgba(255,255,255,0.2)', padding: '10px', borderRadius: '8px' }}>\r\n                            <h4 style={{ margin: '0 0 10px 0', fontSize: '14px', borderBottom: '1px solid rgba(255,255,255,0.3)', paddingBottom: '5px' }}>Recent History</h4>\r\n                            <div style={{ maxHeight: '150px', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '5px' }}>\r\n                                {myHistory.length > 0 ? myHistory.map((h, index) => (\r\n                                    <div key={h.id} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '13px', background: 'rgba(255,255,255,0.1)', padding: '5px 10px', borderRadius: '4px' }}>\r\n                                        <span>{index + 1}. {h.date}</span>\r\n                                        <span style={{ fontWeight: 'bold', color: h.status === 'present' ? '#55efc4' : '#fab1a0' }}>\r\n                                            {h.status.toUpperCase()}\r\n                                        </span>\r\n                                    </div>\r\n                                )) : <div style={{ fontSize: '12px' }}>No records yet.</div>}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n\r\n\r\n                <div className=\"card\">\r\n                    <h3 className=\"text-center\" style={{ marginBottom: '20px' }}>Manage Attendance</h3>\r\n\r\n                    {/* Controls Row */}\r\n                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', justifyContent: 'center', marginBottom: '20px', alignItems: 'center' }}>\r\n\r\n                        <input type=\"date\" className=\"input-field\" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} style={{ width: 'auto', margin: 0 }} />\r\n\r\n                        {view === 'students' && (\r\n                            <>\r\n                                <select\r\n                                    className=\"input-field\"\r\n                                    value={selectedClass}\r\n                                    onChange={(e) => setSelectedClass(e.target.value)}\r\n                                    style={{ width: 'auto', margin: 0, minWidth: '80px' }}\r\n                                >\r\n                                    <option value=\"\">Class</option>\r\n                                    {['Nursery', 'LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'].map(c => (\r\n                                        <option key={c} value={c}>{c}</option>\r\n                                    ))}\r\n                                </select>\r\n                                <select\r\n                                    className=\"input-field\"\r\n                                    value={selectedSection}\r\n                                    onChange={(e) => setSelectedSection(e.target.value)}\r\n                                    style={{ width: 'auto', margin: 0, minWidth: '70px' }}\r\n                                >\r\n                                    <option value=\"\">Sec</option>\r\n                                    {['A', 'B', 'C', 'D'].map(s => (\r\n                                        <option key={s} value={s}>{s}</option>\r\n                                    ))}\r\n                                </select>\r\n                            </>\r\n                        )}\r\n\r\n                        {/* Custom Subject Dropdown */}\r\n                        <div style={{ position: 'relative' }}>\r\n                            <div style={{ position: 'relative' }}>\r\n                                <input\r\n                                    className=\"input-field\"\r\n                                    placeholder={view === 'teachers' ? \"Filter by Subject\" : \"Subject (Optional)\"}\r\n                                    value={subject}\r\n                                    onChange={(e) => setSubject(e.target.value)}\r\n                                    onClick={() => setShowSubjects(!showSubjects)}\r\n                                    style={{ width: '180px', margin: 0, paddingRight: '30px' }}\r\n                                />\r\n                                <span\r\n                                    onClick={() => setShowSubjects(!showSubjects)}\r\n                                    style={{ position: 'absolute', right: '10px', top: '50%', transform: 'translateY(-50%)', cursor: 'pointer', color: '#888', fontSize: '10px' }}\r\n                                >\r\n                                    {showSubjects ? 'Γû▓' : 'Γû╝'}\r\n                                </span>\r\n                            </div>\r\n\r\n                            {showSubjects && (\r\n                                <div style={{\r\n                                    position: 'absolute', top: '105%', left: 0, width: '100%',\r\n                                    background: 'white', border: '1px solid #ddd', borderRadius: '8px',\r\n                                    maxHeight: '200px', overflowY: 'auto', zIndex: 100, boxShadow: '0 4px 15px rgba(0,0,0,0.1)'\r\n                                }}>\r\n                                    {['Telugu', 'Hindi', 'English', 'Maths', 'Science', 'Social Studies', 'Physical Science', 'Natural Science', 'Environmental Science (EVS)', 'Sanskrit']\r\n                                        .filter(s => s.toLowerCase().includes(subject.toLowerCase()))\r\n                                        .map(s => (\r\n                                            <div\r\n                                                key={s}\r\n                                                onClick={() => { setSubject(s); setShowSubjects(false); }}\r\n                                                style={{ padding: '10px 12px', cursor: 'pointer', borderBottom: '1px solid #f1f1f1', fontSize: '13px', color: '#2d3436' }}\r\n                                                onMouseEnter={(e) => e.target.style.background = '#f8f9fa'}\r\n                                                onMouseLeave={(e) => e.target.style.background = 'white'}\r\n                                            >\r\n                                                {s}\r\n                                            </div>\r\n                                        ))}\r\n                                    {/* Option to clear */}\r\n                                    <div\r\n                                        onClick={() => { setSubject(''); setShowSubjects(false); }}\r\n                                        style={{ padding: '10px 12px', cursor: 'pointer', fontSize: '13px', color: '#d63031', fontStyle: 'italic' }}\r\n                                        onMouseEnter={(e) => e.target.style.background = '#fff5f5'}\r\n                                        onMouseLeave={(e) => e.target.style.background = 'white'}\r\n                                    >\r\n                                        Clear Selection\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div style={{ display: 'flex', gap: '5px' }}>\r\n                            <button className={`btn`} style={{ padding: '10px', background: view === 'students' ? '#0984e3' : '#b2bec3' }} onClick={() => setView('students')}>Students</button>\r\n                            <button className={`btn`} style={{ padding: '10px', background: view === 'teachers' ? '#e17055' : '#b2bec3' }} onClick={() => setView('teachers')}>Teachers</button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* List */}\r\n                    <div className=\"list-container\">\r\n                        {loading && <p className=\"text-center\">Loading...</p>}\r\n                        {!loading && list.length === 0 && (\r\n                            <div className=\"text-center text-muted\">\r\n                                {view === 'students' && !selectedClass ? \"Select a Class.\" : \"No records found.\"}\r\n                            </div>\r\n                        )}\r\n\r\n                        {view === 'teachers' ? (\r\n                            <div className=\"attendance-list-wrapper\">\r\n                                {/* Desktop Table View */}\r\n                                <div className=\"hide-mobile\" style={{ overflowX: 'auto', background: 'white', borderRadius: '8px', boxShadow: '0 2px 5px rgba(0,0,0,0.05)' }}>\r\n                                    <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '600px' }}>\r\n                                        <thead>\r\n                                            <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #dfe6e9', color: '#636e72', fontSize: '13px', textTransform: 'uppercase' }}>\r\n                                                <th style={{ padding: '15px', textAlign: 'center', width: '60px' }}>S.No</th>\r\n                                                <th style={{ padding: '15px', textAlign: 'left' }}>Teacher Name</th>\r\n                                                <th style={{ padding: '15px', textAlign: 'left' }}>Subject</th>\r\n                                                <th style={{ padding: '15px', textAlign: 'center' }}>Attendance</th>\r\n                                                <th style={{ padding: '15px', textAlign: 'center' }}>Total Days</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {list.map((item, index) => (\r\n                                                <tr key={item.id} style={{ borderBottom: '1px solid #f1f2f6', background: item.status === 'present' ? '#e6ffec' : (item.status === 'absent' ? '#fff0f0' : 'white') }}>\r\n                                                    <td style={{ padding: '12px', textAlign: 'center', fontWeight: 'bold', color: '#b2bec3' }}>{index + 1}</td>\r\n                                                    <td style={{ padding: '12px', fontWeight: 'bold', color: '#2d3436' }}>{item.name}</td>\r\n                                                    <td style={{ padding: '12px', color: '#636e72' }}>{item.subject || '-'}</td>\r\n                                                    <td style={{ padding: '12px', textAlign: 'center' }}>\r\n                                                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'center' }}>\r\n                                                            <button\r\n                                                                onClick={() => markAttendance(item.id, 'present')}\r\n                                                                style={{\r\n                                                                    width: '35px', height: '35px', borderRadius: '6px', border: 'none', fontWeight: 'bold', cursor: 'pointer',\r\n                                                                    background: item.status === 'present' ? '#00b894' : '#ecf0f1', color: item.status === 'present' ? 'white' : '#b2bec3'\r\n                                                                }}>P</button>\r\n                                                            <button\r\n                                                                onClick={() => markAttendance(item.id, 'absent')}\r\n                                                                style={{\r\n                                                                    width: '35px', height: '35px', borderRadius: '6px', border: 'none', fontWeight: 'bold', cursor: 'pointer',\r\n                                                                    background: item.status === 'absent' ? '#d63031' : '#ecf0f1', color: item.status === 'absent' ? 'white' : '#b2bec3'\r\n                                                                }}>A</button>\r\n                                                        </div>\r\n                                                    </td>\r\n                                                    <td style={{ padding: '12px', textAlign: 'center', color: '#6c5ce7', fontWeight: '800' }}>\r\n                                                        {new Date(new Date(selectedDate).getFullYear(), new Date(selectedDate).getMonth() + 1, 0).getDate()}\r\n                                                    </td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n\r\n                                {/* Mobile Card View - centered and fits screen */}\r\n                                <div className=\"show-mobile-only\" style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>\r\n                                    {list.map((item, index) => (\r\n                                        <div key={item.id} style={{\r\n                                            background: 'white', border: '1px solid #eee', borderRadius: '12px', padding: '16px',\r\n                                            display: 'flex', justifyContent: 'space-between', alignItems: 'center',\r\n                                            boxShadow: 'var(--shadow-sm)'\r\n                                        }}>\r\n                                            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>\r\n                                                <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: 'var(--primary)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: '800' }}>\r\n                                                    {item.name?.charAt(0)}\r\n                                                </div>\r\n                                                <div>\r\n                                                    <div style={{ fontWeight: '700', fontSize: '15px' }}>{item.name}</div>\r\n                                                    <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{item.subject || 'All Subjects'}</div>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div style={{ display: 'flex', gap: '8px' }}>\r\n                                                <button\r\n                                                    onClick={() => markAttendance(item.id, 'present')}\r\n                                                    style={{\r\n                                                        padding: '10px 18px', borderRadius: '8px', border: 'none', fontWeight: '800',\r\n                                                        background: item.status === 'present' ? '#00b894' : '#ecf0f1', color: item.status === 'present' ? 'white' : 'var(--text-main)'\r\n                                                    }}>P</button>\r\n                                                <button\r\n                                                    onClick={() => markAttendance(item.id, 'absent')}\r\n                                                    style={{\r\n                                                        padding: '10px 18px', borderRadius: '8px', border: 'none', fontWeight: '800',\r\n                                                        background: item.status === 'absent' ? '#d63031' : '#ecf0f1', color: item.status === 'absent' ? 'white' : 'var(--text-main)'\r\n                                                    }}>A</button>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            list.map((item, index) => {\r\n                                const suspended = isSuspended(item);\r\n                                return (\r\n                                    <div key={item.id} style={{\r\n                                        display: 'flex', justifyContent: 'space-between', alignItems: 'center',\r\n                                        padding: '12px', borderBottom: '1px solid #eee',\r\n                                        background: suspended ? '#f3a683' : (item.status === 'present' ? '#e6ffec' : (item.status === 'absent' ? '#ffe6e6' : 'white')),\r\n                                        opacity: suspended && role === 'teacher' ? 0.6 : 1\r\n                                    }}>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                                            {/* Number Count */}\r\n                                            <div style={{ fontWeight: 'bold', color: '#636e72', fontSize: '14px', width: '25px' }}>\r\n                                                {index + 1}.\r\n                                            </div>\r\n                                            <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: '#dfe6e9', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold' }}>\r\n                                                {item.name.charAt(0)}\r\n                                            </div>\r\n                                            <div>\r\n                                                <div style={{ fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                                                    {item.name}\r\n                                                    {suspended && <span style={{ fontSize: '10px', background: '#d63031', color: 'white', padding: '2px 6px', borderRadius: '4px' }}>SUSPENDED</span>}\r\n                                                </div>\r\n                                                <div style={{ fontSize: '13px', color: '#636e72' }}>{item.classAssigned} {item.subject ? `ΓÇó ${item.subject}` : ''}</div>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>\r\n\r\n                                            {/* Actual Stats Display (Visible to Everyone) */}\r\n                                            <div style={{ textAlign: 'center', marginRight: '15px', minWidth: '50px' }}>\r\n                                                <div style={{ fontWeight: 'bold', fontSize: '14px', color: item.percentage < 75 ? '#d63031' : '#00b894' }}>\r\n                                                    {item.percentage}%\r\n                                                </div>\r\n                                                <div style={{ fontSize: '10px', color: '#636e72', fontWeight: '500' }}>\r\n                                                    {item.statsData?.present || 0} / {item.statsData?.total || 0} classes\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Institution Suspends Students + Mark Attendance */}\r\n                                            <div style={{ display: 'flex', gap: '5px', alignItems: 'center' }}>\r\n                                                {role === 'institution' && view === 'students' && (\r\n                                                    <button\r\n                                                        onClick={() => handleSuspend(item.id, item.suspendedUntil)}\r\n                                                        style={{ border: 'none', background: '#d63031', color: 'white', padding: '5px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', height: '30px', marginRight: '5px' }}\r\n                                                        title=\"Suspend Student\"\r\n                                                    >\r\n                                                        {suspended ? 'Lift' : 'Γ¢ö'}\r\n                                                    </button>\r\n                                                )}\r\n\r\n                                                <>\r\n                                                    <button\r\n                                                        disabled={suspended}\r\n                                                        onClick={() => markAttendance(item.id, 'present')}\r\n                                                        style={{\r\n                                                            padding: '6px 14px', borderRadius: '6px', border: 'none',\r\n                                                            cursor: suspended ? 'not-allowed' : 'pointer',\r\n                                                            background: item.status === 'present' ? '#00b894' : '#ecf0f1', color: item.status === 'present' ? 'white' : '#2d3436'\r\n                                                        }}>\r\n                                                        P\r\n                                                    </button>\r\n                                                    <button\r\n                                                        disabled={suspended}\r\n                                                        onClick={() => markAttendance(item.id, 'absent')}\r\n                                                        style={{\r\n                                                            padding: '6px 14px', borderRadius: '6px', border: 'none',\r\n                                                            cursor: suspended ? 'not-allowed' : 'pointer',\r\n                                                            background: item.status === 'absent' ? '#d63031' : '#ecf0f1', color: item.status === 'absent' ? 'white' : '#2d3436'\r\n                                                        }}>\r\n                                                        A\r\n                                                    </button>\r\n                                                </>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                );\r\n                            })\r\n                        )}\r\n                    </div>\r\n\r\n                    {list.length > 0 && (\r\n                        <div style={{ textAlign: 'center', marginTop: '20px', marginBottom: '40px' }}>\r\n                            <button\r\n                                className=\"btn\"\r\n                                disabled={list.some(item => item.status === 'pending')}\r\n                                style={{\r\n                                    backgroundColor: list.some(item => item.status === 'pending') ? '#b2bec3' : '#00b894',\r\n                                    padding: '12px 40px',\r\n                                    fontSize: '1.2rem',\r\n                                    boxShadow: list.some(item => item.status === 'pending') ? 'none' : '0 4px 10px rgba(0,184,148,0.4)',\r\n                                    cursor: list.some(item => item.status === 'pending') ? 'not-allowed' : 'pointer'\r\n                                }}\r\n                                onClick={() => {\r\n                                    alert(\"Attendance Submitted Successfully! Γ£à\");\r\n                                    navigate(-1);\r\n                                }}\r\n                            >\r\n                                Submit Attendance\r\n                            </button>\r\n                        </div>\r\n                    )}\r\n\r\n\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\AttendanceAnalytics.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'heatmapData' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":16,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"heatmapData"},"fix":{"range":[699,710],"text":""},"desc":"Remove unused variable 'heatmapData'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, orderBy } from 'firebase/firestore';\r\n\r\nexport default function AttendanceAnalytics() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [loading, setLoading] = useState(true);\r\n    const [selectedClass, setSelectedClass] = useState('');\r\n    const [selectedSection, setSelectedSection] = useState('');\r\n    const [students, setStudents] = useState([]);\r\n    const [attendanceData, setAttendanceData] = useState({});\r\n    const [heatmapData, setHeatmapData] = useState([]);\r\n    const [classStats, setClassStats] = useState({ avgAttendance: 0, totalDays: 0 });\r\n\r\n    useEffect(() => {\r\n        if (userData?.role === 'teacher' || userData?.role === 'institution') {\r\n            // Auto-select first class if teacher\r\n            if (userData.assignedClass) {\r\n                setSelectedClass(userData.assignedClass.toString());\r\n                setSelectedSection(userData.assignedSection || 'A');\r\n            }\r\n        } else if (userData?.role === 'student') {\r\n            // Student sees their own analytics\r\n            setSelectedClass(userData.class || userData.assignedClass);\r\n            setSelectedSection(userData.section || userData.assignedSection);\r\n        }\r\n    }, [userData]);\r\n\r\n    useEffect(() => {\r\n        if (selectedClass && selectedSection) {\r\n            fetchAttendanceData();\r\n        }\r\n    }, [selectedClass, selectedSection]);\r\n\r\n    const fetchAttendanceData = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // 1. Fetch students in this class\r\n            const studentsQuery = query(\r\n                collection(db, \"student_allotments\"),\r\n                where(\"classAssigned\", \"==\", selectedClass),\r\n                where(\"section\", \"==\", selectedSection)\r\n            );\r\n            const studentsSnap = await getDocs(studentsQuery);\r\n            const studentsList = studentsSnap.docs.map(d => ({\r\n                id: d.data().studentId || d.id,\r\n                name: d.data().studentName || d.data().name\r\n            }));\r\n            setStudents(studentsList);\r\n\r\n            // 2. Fetch attendance records\r\n            const attQuery = query(\r\n                collection(db, \"attendance\"),\r\n                where(\"class\", \"==\", selectedClass),\r\n                where(\"section\", \"==\", selectedSection),\r\n                orderBy(\"date\", \"desc\")\r\n            );\r\n            const attSnap = await getDocs(attQuery);\r\n\r\n            // Process attendance data\r\n            const attMap = {};\r\n            const dateSet = new Set();\r\n            let totalPresent = 0;\r\n            let totalRecords = 0;\r\n\r\n            attSnap.docs.forEach(doc => {\r\n                const data = doc.data();\r\n                const studentId = data.studentId;\r\n                const date = data.date?.toDate?.()?.toLocaleDateString() || 'Unknown';\r\n\r\n                dateSet.add(date);\r\n\r\n                if (!attMap[studentId]) {\r\n                    attMap[studentId] = { present: 0, absent: 0, total: 0, dates: {} };\r\n                }\r\n\r\n                attMap[studentId].total++;\r\n                attMap[studentId].dates[date] = data.status;\r\n\r\n                if (data.status === 'present') {\r\n                    attMap[studentId].present++;\r\n                    totalPresent++;\r\n                } else {\r\n                    attMap[studentId].absent++;\r\n                }\r\n                totalRecords++;\r\n            });\r\n\r\n            setAttendanceData(attMap);\r\n\r\n            // Calculate class average\r\n            const avgAtt = totalRecords > 0 ? ((totalPresent / totalRecords) * 100).toFixed(1) : 0;\r\n            setClassStats({ avgAttendance: avgAtt, totalDays: dateSet.size });\r\n\r\n            // Generate heatmap data (last 30 days)\r\n            const dates = Array.from(dateSet).slice(0, 30);\r\n            setHeatmapData(dates);\r\n\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const sendWhatsAppAlert = (student) => {\r\n        const attRecord = attendanceData[student.id];\r\n        const percentage = attRecord ? ((attRecord.present / attRecord.total) * 100).toFixed(1) : 0;\r\n\r\n        const message = `≡ƒÜ¿ ATTENDANCE ALERT\\n\\nDear Parent,\\n\\nYour child ${student.name} has low attendance:\\n- Present: ${attRecord?.present || 0} days\\n- Absent: ${attRecord?.absent || 0} days\\n- Attendance: ${percentage}%\\n\\nPlease ensure regular attendance.\\n\\n- ${userData.name}\\n${userData.institutionName || 'School'}`;\r\n\r\n        window.open(`https://wa.me/919876543210?text=${encodeURIComponent(message)}`, '_blank');\r\n    };\r\n\r\n    const getAttendanceColor = (percentage) => {\r\n        if (percentage >= 75) return '#27ae60';\r\n        if (percentage >= 60) return '#f39c12';\r\n        return '#e74c3c';\r\n    };\r\n\r\n    const StatCard = ({ icon, title, value, subtitle, color }) => (\r\n        <div style={{\r\n            background: 'white', borderRadius: '12px', padding: '20px',\r\n            boxShadow: '0 2px 8px rgba(0,0,0,0.08)', flex: '1 1 200px',\r\n            borderLeft: `4px solid ${color}`\r\n        }}>\r\n            <div style={{ fontSize: '32px', marginBottom: '10px' }}>{icon}</div>\r\n            <div style={{ fontSize: '13px', color: '#636e72', textTransform: 'uppercase', marginBottom: '5px' }}>{title}</div>\r\n            <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#2d3436' }}>{value}</div>\r\n            {subtitle && <div style={{ fontSize: '12px', color: color, marginTop: '5px' }}>{subtitle}</div>}\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ background: '#f5f6fa', minHeight: '100vh' }}>\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', paddingTop: '20px' }}>\r\n                    <h2>≡ƒôè Attendance Analytics</h2>\r\n                    <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                </div>\r\n\r\n                {/* Class Selector */}\r\n                {(userData?.role === 'teacher' || userData?.role === 'institution') && (\r\n                    <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>\r\n                        <select className=\"input-field\" value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)} style={{ maxWidth: '150px' }}>\r\n                            <option value=\"\">Select Class</option>\r\n                            {[...Array(12)].map((_, i) => <option key={i} value={i + 1}>{i + 1}</option>)}\r\n                        </select>\r\n                        <select className=\"input-field\" value={selectedSection} onChange={(e) => setSelectedSection(e.target.value)} style={{ maxWidth: '150px' }}>\r\n                            <option value=\"\">Select Section</option>\r\n                            {['A', 'B', 'C', 'D'].map(s => <option key={s} value={s}>{s}</option>)}\r\n                        </select>\r\n                    </div>\r\n                )}\r\n\r\n                {loading ? (\r\n                    <div style={{ textAlign: 'center', padding: '60px' }}>Loading analytics...</div>\r\n                ) : !selectedClass || !selectedSection ? (\r\n                    <div className=\"card\" style={{ textAlign: 'center', padding: '60px' }}>\r\n                        <div style={{ fontSize: '64px', marginBottom: '20px' }}>≡ƒôà</div>\r\n                        <h3>Select Class & Section</h3>\r\n                    </div>\r\n                ) : (\r\n                    <>\r\n                        {/* Stats Overview */}\r\n                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '15px', marginBottom: '20px' }}>\r\n                            <StatCard\r\n                                icon=\"≡ƒôê\"\r\n                                title=\"Class Average\"\r\n                                value={`${classStats.avgAttendance}%`}\r\n                                subtitle={classStats.avgAttendance >= 75 ? \"Excellent!\" : \"Needs Improvement\"}\r\n                                color={getAttendanceColor(classStats.avgAttendance)}\r\n                            />\r\n                            <StatCard\r\n                                icon=\"≡ƒôà\"\r\n                                title=\"Total Days\"\r\n                                value={classStats.totalDays}\r\n                                subtitle=\"Attendance recorded\"\r\n                                color=\"#3498db\"\r\n                            />\r\n                            <StatCard\r\n                                icon=\"≡ƒæÑ\"\r\n                                title=\"Students\"\r\n                                value={students.length}\r\n                                subtitle={`Class ${selectedClass}-${selectedSection}`}\r\n                                color=\"#9b59b6\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Student List with Heatmap */}\r\n                        <div className=\"card\">\r\n                            <h3 style={{ marginBottom: '15px' }}>Student Attendance Records</h3>\r\n\r\n                            {students.length === 0 ? (\r\n                                <p style={{ textAlign: 'center', color: '#999', padding: '40px' }}>No students found</p>\r\n                            ) : (\r\n                                <div style={{ overflowX: 'auto' }}>\r\n                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>\r\n                                        <thead style={{ background: '#f8f9fa', position: 'sticky', top: 0 }}>\r\n                                            <tr>\r\n                                                <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6', minWidth: '150px' }}>Student Name</th>\r\n                                                <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Present</th>\r\n                                                <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Absent</th>\r\n                                                <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>%</th>\r\n                                                <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Action</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {students.map(student => {\r\n                                                const attRecord = attendanceData[student.id] || { present: 0, absent: 0, total: 0 };\r\n                                                const percentage = attRecord.total > 0 ? ((attRecord.present / attRecord.total) * 100).toFixed(1) : 0;\r\n                                                const color = getAttendanceColor(percentage);\r\n                                                const isLow = percentage < 75;\r\n\r\n                                                return (\r\n                                                    <tr key={student.id} style={{\r\n                                                        borderBottom: '1px solid #eee',\r\n                                                        background: isLow ? '#fff5f5' : 'white'\r\n                                                    }}>\r\n                                                        <td style={{ padding: '10px' }}>\r\n                                                            {student.name}\r\n                                                            {isLow && <span style={{ marginLeft: '8px', color: '#e74c3c', fontSize: '12px' }}>ΓÜá∩╕Å Low</span>}\r\n                                                        </td>\r\n                                                        <td style={{ padding: '10px', textAlign: 'center', color: '#27ae60', fontWeight: 'bold' }}>\r\n                                                            {attRecord.present}\r\n                                                        </td>\r\n                                                        <td style={{ padding: '10px', textAlign: 'center', color: '#e74c3c', fontWeight: 'bold' }}>\r\n                                                            {attRecord.absent}\r\n                                                        </td>\r\n                                                        <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                            <span style={{\r\n                                                                background: `${color}20`,\r\n                                                                color: color,\r\n                                                                padding: '4px 10px',\r\n                                                                borderRadius: '20px',\r\n                                                                fontSize: '12px',\r\n                                                                fontWeight: 'bold'\r\n                                                            }}>\r\n                                                                {percentage}%\r\n                                                            </span>\r\n                                                        </td>\r\n                                                        <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                            {isLow && (\r\n                                                                <button\r\n                                                                    onClick={() => sendWhatsAppAlert(student)}\r\n                                                                    style={{\r\n                                                                        background: '#25D366', color: 'white',\r\n                                                                        border: 'none', padding: '5px 10px',\r\n                                                                        borderRadius: '4px', cursor: 'pointer',\r\n                                                                        fontSize: '12px', fontWeight: 'bold'\r\n                                                                    }}\r\n                                                                >\r\n                                                                    ≡ƒÆ¼ Alert Parent\r\n                                                                </button>\r\n                                                            )}\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                );\r\n                                            })}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Leaderboard */}\r\n                        <div className=\"card\" style={{ marginTop: '20px' }}>\r\n                            <h3 style={{ marginBottom: '15px' }}>≡ƒÅå Attendance Leaderboard</h3>\r\n                            <div style={{ display: 'grid', gap: '10px' }}>\r\n                                {students\r\n                                    .map(s => ({\r\n                                        ...s,\r\n                                        percentage: attendanceData[s.id]?.total > 0\r\n                                            ? ((attendanceData[s.id].present / attendanceData[s.id].total) * 100).toFixed(1)\r\n                                            : 0\r\n                                    }))\r\n                                    .sort((a, b) => b.percentage - a.percentage)\r\n                                    .slice(0, 5)\r\n                                    .map((student, index) => (\r\n                                        <div key={student.id} style={{\r\n                                            display: 'flex', justifyContent: 'space-between', alignItems: 'center',\r\n                                            padding: '12px', background: index === 0 ? '#fff9e6' : '#f8f9fa',\r\n                                            borderRadius: '8px', borderLeft: `4px solid ${index === 0 ? '#f39c12' : '#ddd'}`\r\n                                        }}>\r\n                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                                <div style={{\r\n                                                    fontSize: '20px',\r\n                                                    fontWeight: 'bold',\r\n                                                    color: index === 0 ? '#f39c12' : '#636e72'\r\n                                                }}>\r\n                                                    {index === 0 ? '≡ƒÑç' : index === 1 ? '≡ƒÑê' : index === 2 ? '≡ƒÑë' : `#${index + 1}`}\r\n                                                </div>\r\n                                                <div>{student.name}</div>\r\n                                            </div>\r\n                                            <div style={{\r\n                                                fontWeight: 'bold',\r\n                                                color: getAttendanceColor(student.percentage),\r\n                                                fontSize: '16px'\r\n                                            }}>\r\n                                                {student.percentage}%\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                            </div>\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Details.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'isRoleLocked' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":20,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"isRoleLocked"},"fix":{"range":[890,902],"text":""},"desc":"Remove unused variable 'isRoleLocked'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":278,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":278,"endColumn":76},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":278,"column":78,"nodeType":"BlockStatement","messageId":"unexpected","endLine":278,"endColumn":81,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[12312,12313],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport { collection, getDocs, doc, setDoc, getDoc, addDoc, deleteDoc, query, where, updateDoc } from 'firebase/firestore';\r\nimport { db, auth } from '../firebase';\r\nimport { onAuthStateChanged, signOut } from 'firebase/auth';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function Details() {\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n    const { setUserData } = useUser();\r\n\r\n    // Check if role was passed from Login/Signup page (PRIORITY)\r\n    const passedRole = location.state?.role;\r\n\r\n    const [role, setRole] = useState(passedRole || '');\r\n    const [institutions, setInstitutions] = useState([]);\r\n    const [userId, setUserId] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isRoleLocked, setIsRoleLocked] = useState(false);\r\n\r\n    // Form states\r\n    const [formData, setFormData] = useState({});\r\n    const [initialData, setInitialData] = useState({}); // To detecting changes\r\n\r\n    const handleBack = async () => {\r\n        // If it's a new user setting up for the first time, Back means Logout/Cancel to avoid redirect loops\r\n        if (!initialData || Object.keys(initialData).length === 0) {\r\n            await signOut(auth);\r\n            navigate('/');\r\n        } else {\r\n            // If editing existing profile, just go back\r\n            navigate(-1);\r\n        }\r\n    };\r\n\r\n    // DATA PROPAGATION HELPER (DML-like Cascading Update)\r\n    const propagateUserUpdates = async (uid, userRole, newName, newSubject = null) => {\r\n        console.log(`≡ƒöä Propagating updates for ${userRole}: ${newName} ${newSubject ? `(Subject: ${newSubject})` : ''}`);\r\n        const promises = [];\r\n\r\n        try {\r\n            // 1. Update Admissions (Student/Teacher)\r\n            if (userRole === 'student' || userRole === 'teacher') {\r\n                const q = query(collection(db, \"admissions\"), where(\"userId\", \"==\", uid));\r\n                const snap = await getDocs(q);\r\n                snap.forEach(d => {\r\n                    const updates = { name: newName };\r\n                    if (userRole === 'teacher' && newSubject) updates.subject = newSubject;\r\n                    promises.push(updateDoc(d.ref, updates));\r\n                });\r\n            }\r\n\r\n            // 2. Update Student Allotments (Student only)\r\n            if (userRole === 'student') {\r\n                const q = query(collection(db, \"student_allotments\"), where(\"userId\", \"==\", uid));\r\n                const snap = await getDocs(q);\r\n                snap.forEach(d => {\r\n                    promises.push(updateDoc(d.ref, { name: newName, studentName: newName }));\r\n                });\r\n            }\r\n\r\n            // 3. Update Teacher Allotments & Groups (Teacher only)\r\n            if (userRole === 'teacher') {\r\n                // Update Allotments\r\n                const q = query(collection(db, \"teacher_allotments\"), where(\"userId\", \"==\", uid));\r\n                const snap = await getDocs(q);\r\n                snap.forEach(d => {\r\n                    const updates = { name: newName, teacherName: newName };\r\n                    if (newSubject) updates.subject = newSubject;\r\n                    promises.push(updateDoc(d.ref, updates));\r\n                });\r\n\r\n                // Update 'groups' metadata where this teacher is the owner/teacher\r\n                // Note: Groups usually link by teacherId\r\n                const qGroup = query(collection(db, \"groups\"), where(\"teacherId\", \"==\", uid));\r\n                const snapGroup = await getDocs(qGroup);\r\n                snapGroup.forEach(d => {\r\n                    const updates = { teacherName: newName };\r\n                    if (newSubject) updates.subject = newSubject;\r\n                    promises.push(updateDoc(d.ref, updates));\r\n                });\r\n            }\r\n\r\n            // 4. Institution Name Propagation\r\n            if (userRole === 'institution') {\r\n                // Update Students/Teachers linked to this Institution\r\n                const q = query(collection(db, \"users\"), where(\"institutionId\", \"==\", uid));\r\n                const snap = await getDocs(q);\r\n                snap.forEach(d => {\r\n                    promises.push(updateDoc(d.ref, { institutionName: newName }));\r\n                });\r\n                const q2 = query(collection(db, \"teachers\"), where(\"institutionId\", \"==\", uid));\r\n                const snap2 = await getDocs(q2);\r\n                snap2.forEach(d => {\r\n                    promises.push(updateDoc(d.ref, { institutionName: newName }));\r\n                });\r\n\r\n                // Update Admissions linked to this Inst\r\n                const q3 = query(collection(db, \"admissions\"), where(\"institutionId\", \"==\", uid));\r\n                const snap3 = await getDocs(q3);\r\n                snap3.forEach(d => {\r\n                    promises.push(updateDoc(d.ref, { institutionName: newName }));\r\n                });\r\n            }\r\n\r\n            if (promises.length > 0) {\r\n                await Promise.all(promises);\r\n                console.log(`Γ£à Updated ${promises.length} related documents.`);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Propagation Error:\", e);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        const unsubscribe = onAuthStateChanged(auth, async (user) => {\r\n            if (user) {\r\n                setUserId(user.uid);\r\n\r\n                // If we received a role from Login page, trust it and skip DB check\r\n                if (passedRole) {\r\n                    setRole(passedRole);\r\n                    setLoading(false);\r\n                    setIsRoleLocked(true); // LOCK THE ROLE to prevent changing\r\n                    return;\r\n                }\r\n\r\n                // Try to get role from Firestore if not in local state\r\n                try {\r\n                    // Check 'users' (Student)\r\n                    let userDoc = await getDoc(doc(db, \"users\", user.uid));\r\n                    if (userDoc.exists()) {\r\n                        const data = userDoc.data();\r\n                        setRole(data.role || 'student'); // Fallback to 'student' if role field is missing\r\n                        setFormData(data);\r\n                        setInitialData(data); // Capture baseline\r\n                        setIsRoleLocked(true);\r\n                    } else {\r\n                        // Check 'teachers'\r\n                        userDoc = await getDoc(doc(db, \"teachers\", user.uid));\r\n                        if (userDoc.exists()) {\r\n                            const data = userDoc.data();\r\n                            setRole(data.role || 'teacher'); // Fallback to 'teacher'\r\n                            setFormData(data);\r\n                            setInitialData(data); // Capture baseline\r\n                            setIsRoleLocked(true);\r\n                        } else {\r\n                            // Check 'institutions'\r\n                            userDoc = await getDoc(doc(db, \"institutions\", user.uid));\r\n                            if (userDoc.exists()) {\r\n                                const data = userDoc.data();\r\n                                setRole(data.role || 'institution'); // Fallback to 'institution'\r\n                                setFormData(data);\r\n                                setInitialData(data); // Capture baseline\r\n                                setIsRoleLocked(true);\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"Error fetching role: \", e);\r\n                }\r\n            } else {\r\n                // Return to login if not authenticated\r\n                navigate('/');\r\n            }\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [navigate]);\r\n\r\n    // Load institutions\r\n    useEffect(() => {\r\n        if (role === 'student' || role === 'teacher') {\r\n            const fetchInstitutions = async () => {\r\n                try {\r\n                    // Fetch only APPROVED institutions\r\n                    const q = query(collection(db, \"institutions\"), where(\"approved\", \"==\", true));\r\n                    const querySnapshot = await getDocs(q);\r\n                    const list = [];\r\n                    querySnapshot.forEach((doc) => {\r\n                        list.push({ id: doc.id, ...doc.data() });\r\n                    });\r\n\r\n                    console.log(\"Institutions loaded:\", list);\r\n                    setInstitutions(list);\r\n                } catch (error) {\r\n                    console.error(\"Failed to load institutions\", error);\r\n                }\r\n            };\r\n            fetchInstitutions();\r\n        }\r\n    }, [role]);\r\n\r\n    const handleChange = (e) => {\r\n        const { name, value, type, checked } = e.target;\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            [name]: type === 'checkbox' ? checked : value\r\n        }));\r\n    };\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        console.log(\"Submitting form...\", formData);\r\n\r\n        if (!userId) {\r\n            alert(\"User ID missing. Please login again.\");\r\n            return;\r\n        }\r\n\r\n        // STRICT VALIDATION\r\n        if (!role) {\r\n            alert(\"Please select a role.\");\r\n            return;\r\n        }\r\n\r\n        // REQUIRED FIELDS CHECK\r\n        if ((role === 'student' || role === 'teacher') && !formData.institutionId) {\r\n            alert(\"ΓÜá∩╕Å Please select a School/Institution.\");\r\n            return;\r\n        }\r\n\r\n        if (role === 'student') {\r\n            if (!formData.firstName || !formData.class || !formData.dob) return alert(\"Please fill Name, Class, DOB.\");\r\n        } else if (role === 'teacher') {\r\n            if (!formData.firstName || !formData.subject) return alert(\"Please fill Name, Subject.\");\r\n        } else if (role === 'institution') {\r\n            if (!formData.schoolName || !formData.phoneNumber) return alert(\"Please fill School Name, Phone.\");\r\n        }\r\n\r\n        // --- UX LOGIC: DETECT MAJOR CHANGES ---\r\n        // Major changes require Re-Approval (Status: Pending)\r\n        // Minor changes (Name, Phone, etc) are instant updates.\r\n\r\n        let isMajorUpdate = false;\r\n\r\n        // 1. New User (No initial data) -> Always Major\r\n        if (!initialData || Object.keys(initialData).length === 0) {\r\n            isMajorUpdate = true;\r\n        } else {\r\n            // 2. Existing User -> Check specific fields\r\n            // If Not Approved, allow changes freely (correction mode)\r\n            // If Approved, changing Institution is Major.\r\n            const isApproved = initialData.approved === true;\r\n\r\n            if (role === 'student') {\r\n                if (isApproved) {\r\n                    if (String(formData.institutionId) !== String(initialData.institutionId) ||\r\n                        String(formData.class) !== String(initialData.class)) {\r\n                        isMajorUpdate = true;\r\n                    }\r\n                } else {\r\n                    isMajorUpdate = true;\r\n                }\r\n            } else if (role === 'teacher') {\r\n                if (isApproved) {\r\n                    if (String(formData.institutionId) !== String(initialData.institutionId)) {\r\n                        isMajorUpdate = true;\r\n                    }\r\n                } else {\r\n                    isMajorUpdate = true;\r\n                }\r\n            }\r\n            // Note: If ROLE changed, it's major, but role is usually locked or handled by separate flow.\r\n            // But if user manually unlocked and changed it:\r\n            if (role !== initialData.role && initialData.role) isMajorUpdate = true;\r\n        }\r\n\r\n        // Allow Institution Admins to update freely? Yes, usually self-managed.\r\n        // BUT for initial setup, we force check.\r\n        if (role === 'institution' && (!initialData || !initialData.approved)) isMajorUpdate = true;\r\n\r\n        try {\r\n            // Cleanup stale collections if role changed (rare)\r\n            if ((role === 'teacher' || role === 'institution') && initialData && initialData.role !== role) {\r\n                try { await deleteDoc(doc(db, \"users\", userId)); } catch (e) { }\r\n            }\r\n\r\n            const collectionName = role === 'institution' ? 'institutions' : (role === 'teacher' ? 'teachers' : 'users');\r\n\r\n            // Format Name\r\n            const newDisplayName = role === 'institution' ? formData.schoolName : `${formData.firstName} ${formData.secondName}`;\r\n\r\n            // Generate PID if new\r\n            let finalPid = formData.pid;\r\n            if (!finalPid) {\r\n                const prefix = role === 'student' ? 'ST' : (role === 'teacher' ? 'TE' : 'IN');\r\n                finalPid = `${prefix}-${Math.floor(100000 + Math.random() * 900000)}`;\r\n            }\r\n\r\n            // --- CASE 1: SAFE UPDATE (Minor Changes) ---\r\n            if (!isMajorUpdate) {\r\n                console.log(\"Γ£à Safe Update Detected. Updating profile without resetting approval.\");\r\n                await setDoc(doc(db, collectionName, userId), {\r\n                    ...formData,\r\n                    role: role, // Ensure role is saved\r\n                    name: newDisplayName,\r\n                    pid: finalPid,\r\n                    profileCompleted: true,\r\n                    updatedAt: new Date()\r\n                    // DO NOT TOUCH 'approved' or 'institutionName' (unless inst changed which is major)\r\n                }, { merge: true });\r\n\r\n                // Propagate Name Changes\r\n                await propagateUserUpdates(userId, role, newDisplayName, formData.subject);\r\n\r\n                // Optimistic UI\r\n                setUserData(prev => ({ ...prev, ...formData, name: newDisplayName }));\r\n\r\n                alert(\"Profile Updated Successfully! Γ£à\");\r\n                navigate(-1); // Go back\r\n                return;\r\n            }\r\n\r\n            // --- CASE 2: MAJOR UPDATE (Re-Admission Required) ---\r\n            console.log(\"ΓÜá∩╕Å Major Update Detected. Requesting new approval.\");\r\n\r\n            // 1. Update Core Profile\r\n            await setDoc(doc(db, collectionName, userId), {\r\n                ...formData,\r\n                role: role, // Ensure role is saved\r\n                name: newDisplayName,\r\n                pid: finalPid,\r\n                profileCompleted: true,\r\n                updatedAt: new Date()\r\n            }, { merge: true });\r\n\r\n            // 2. Handle Re-Admission Logic (Student/Teacher)\r\n            if (role === 'student' || role === 'teacher') {\r\n                const instRef = doc(db, \"institutions\", formData.institutionId);\r\n                const instSnap = await getDoc(instRef);\r\n                const instName = instSnap.exists() ? (instSnap.data().schoolName || instSnap.data().name) : \"Unknown Institution\";\r\n\r\n                // Set Approved = False, Update linked Institution\r\n                await setDoc(doc(db, collectionName, userId), {\r\n                    institutionName: instName,\r\n                    approved: false\r\n                }, { merge: true });\r\n\r\n                // CLEANUP: Cancel/Delete ALL previous 'waiting' admission requests to avoid confusion\r\n                // (e.g. if I applied to School A, then changed to School B, School A request should die)\r\n                try {\r\n                    const qAdmissions = query(\r\n                        collection(db, \"admissions\"),\r\n                        where(\"userId\", \"==\", userId),\r\n                        where(\"status\", \"==\", \"waiting\")\r\n                    );\r\n                    const snapAdmissions = await getDocs(qAdmissions);\r\n                    const cleanupPromises = [];\r\n                    snapAdmissions.forEach((d) => {\r\n                        console.log(`Deleting obsolete admission request: ${d.id}`);\r\n                        cleanupPromises.push(deleteDoc(d.ref));\r\n                    });\r\n                    if (cleanupPromises.length > 0) await Promise.all(cleanupPromises);\r\n                } catch (cleanupErr) {\r\n                    console.warn(\"Cleanup of old admissions failed (non-fatal):\", cleanupErr);\r\n                }\r\n\r\n                // Create Admission Request\r\n                await addDoc(collection(db, \"admissions\"), {\r\n                    name: newDisplayName,\r\n                    role: role,\r\n                    [role === 'teacher' ? 'subject' : 'age']: role === 'teacher' ? (formData.subject || 'General') : (formData.dob ? new Date().getFullYear() - new Date(formData.dob).getFullYear() : 'N/A'),\r\n                    class: formData.class || '',\r\n                    institutionId: formData.institutionId,\r\n                    institutionName: instName,\r\n                    userId: userId,\r\n                    status: 'waiting',\r\n                    joinedAt: new Date()\r\n                });\r\n\r\n                setUserData(prev => ({ ...prev, approved: false })); // Lock UI\r\n                navigate('/pending-approval');\r\n            } else if (role === 'institution') {\r\n                // New Institution Registration Logic\r\n                await setDoc(doc(db, \"institutions\", userId), {\r\n                    approved: false\r\n                }, { merge: true });\r\n\r\n                setUserData(prev => ({ ...prev, approved: false }));\r\n                navigate('/pending-approval');\r\n            }\r\n\r\n\r\n        } catch (err) {\r\n            console.error(\"Submission Error:\", err);\r\n            alert(\"Error saving: \" + err.message);\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"container\" style={{ textAlign: 'center', paddingTop: '50px' }}>\r\n                <div className=\"spinner\" style={{ width: '40px', height: '40px', margin: '0 auto 20px', borderRadius: '50%', border: '4px solid #f3f3f3', borderTop: '4px solid #3498db', animation: 'spin 1s linear infinite' }}></div>\r\n                <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>\r\n                <p>Loading Profile...</p>\r\n                <button\r\n                    onClick={() => {\r\n                        import('../firebase').then(({ auth }) => {\r\n                            auth.signOut();\r\n                            sessionStorage.clear();\r\n                            window.location.href = '/';\r\n                        });\r\n                    }}\r\n                    style={{ padding: '8px 16px', background: '#e74c3c', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', marginTop: '20px' }}\r\n                >\r\n                    Stuck? Click to Reset\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"container\">\r\n            <button\r\n                onClick={handleBack}\r\n                style={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    background: 'none',\r\n                    border: 'none',\r\n                    cursor: 'pointer',\r\n                    fontSize: '16px',\r\n                    color: '#6c5ce7',\r\n                    fontWeight: 'bold',\r\n                    marginBottom: '10px'\r\n                }}\r\n            >\r\n                ΓåÉ Back\r\n            </button>\r\n            <header className=\"details-header\">\r\n                {role ? `${role.charAt(0).toUpperCase() + role.slice(1)} Profile Setup` : 'Complete Your Profile'}\r\n            </header>\r\n\r\n            <div className=\"card details-card\">\r\n                <form onSubmit={handleSubmit}>\r\n\r\n                    {/* 1. ROLE SELECTION (Show ONLY if role is not set) */}\r\n                    {!role && (\r\n                        <div className=\"form-group fallback-role-box\" style={{ background: '#fff3cd', padding: '20px', borderRadius: '10px', border: '1px solid #ffeeba' }}>\r\n                            <h3 style={{ marginTop: 0, color: '#856404' }}>Welcome! Please select your path:</h3>\r\n                            <p style={{ fontSize: '14px', color: '#856404' }}>To customize your profile, we need to know who you are.</p>\r\n\r\n                            <label className=\"warning-label\" style={{ display: 'block', marginBottom: '10px' }}>I am a:</label>\r\n                            <select value={role} onChange={(e) => setRole(e.target.value)} className=\"input-field\" style={{ fontSize: '16px', padding: '10px' }} required>\r\n                                <option value=\"\">-- Choose Your Role --</option>\r\n                                <option value=\"student\">≡ƒæ¿ΓÇì≡ƒÄô Student</option>\r\n                                <option value=\"teacher\">≡ƒæ⌐ΓÇì≡ƒÅ½ Teacher</option>\r\n                                <option value=\"institution\">≡ƒÅ½ Institution / School</option>\r\n                            </select>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 2. FORM FIELDS (Show ONLY if role is set) */}\r\n                    {role && (\r\n                        <div className=\"role-specific-form fade-in\">\r\n                            <div className=\"role-status-box\" style={{ marginBottom: '20px', padding: '10px', background: '#e2e6ea', borderRadius: '5px' }}>\r\n                                <strong>Selected Role:</strong> {role.toUpperCase()}\r\n                                <span onClick={() => { if (!passedRole && !initialData.isInstitutionCreated) setRole(''); }} style={{ float: 'right', cursor: 'pointer', color: 'blue', fontSize: '12px', textDecoration: 'underline' }}>\r\n                                    {(!passedRole && !initialData.isInstitutionCreated) && \"(Change)\"}\r\n                                </span>\r\n                            </div>\r\n\r\n                            {/* Teacher Fields */}\r\n                            {role === 'teacher' && (\r\n                                <div className=\"form-group\">\r\n                                    <h3 style={{ borderBottom: '2px solid #0984e3', paddingBottom: '5px', marginBottom: '15px', color: '#0984e3' }}>≡ƒæ¿ΓÇì≡ƒÅ½ Teacher Details</h3>\r\n\r\n                                    <label>First Name</label>\r\n                                    <input name=\"firstName\" value={formData.firstName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>Second Name</label>\r\n                                    <input name=\"secondName\" value={formData.secondName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>Subject Specialization</label>\r\n                                    <input\r\n                                        name=\"subject\"\r\n                                        value={formData.subject || ''}\r\n                                        className=\"input-field\"\r\n                                        placeholder=\"e.g. Mathematics, Science\"\r\n                                        required\r\n                                        onChange={handleChange}\r\n                                    // Subject is now editable by Teacher\r\n                                    />\r\n                                    {/* <p style={{ fontSize: '11px', color: '#d63031', marginTop: '-5px' }}>* Subject is assigned by Institution</p> */}\r\n\r\n                                    <label>Gender</label>\r\n                                    <select name=\"gender\" value={formData.gender || ''} className=\"input-field\" onChange={handleChange}>\r\n                                        <option value=\"\" disabled>Select Gender</option>\r\n                                        <option>Male</option><option>Female</option><option>Other</option>\r\n                                    </select>\r\n\r\n                                    <label>Age (Date of Birth)</label>\r\n                                    <input type=\"date\" name=\"dob\" value={formData.dob || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label className=\"text-muted\">Experience</label>\r\n                                    <div className=\"experience-container\">\r\n                                        <select name=\"expYears\" value={formData.expYears || '0 Years'} className=\"input-field\" onChange={handleChange}>\r\n                                            <option>0 Years</option><option>1 Year</option><option>2 Years</option><option>3 Years</option><option>4 Years</option><option>5+ Years</option>\r\n                                        </select>\r\n                                        <select name=\"expMonths\" value={formData.expMonths || '0 Months'} className=\"input-field\" onChange={handleChange}>\r\n                                            <option>0 Months</option><option>6 Months</option><option>11 Months</option>\r\n                                        </select>\r\n                                    </div>\r\n\r\n                                    <label className=\"checkbox-label\">\r\n                                        <input type=\"checkbox\" name=\"noExp\" checked={formData.noExp || false} onChange={handleChange} /> No Experience\r\n                                    </label>\r\n\r\n                                    <label style={{ color: '#d63031', fontWeight: 'bold', marginTop: '15px' }}>Apply to School/Institution:</label>\r\n                                    {institutions.length === 0 && <p style={{ color: 'red', fontSize: '12px' }}>No registered institutions found. You cannot submit without selecting one.</p>}\r\n                                    <p style={{ fontSize: '12px', color: '#666', marginTop: '-5px', marginBottom: '10px' }}>Select the school you want to join. They will receive your application.</p>\r\n                                    <select\r\n                                        name=\"institutionId\"\r\n                                        value={formData.institutionId || ''}\r\n                                        className=\"input-field\"\r\n                                        required\r\n                                        onChange={handleChange}\r\n                                        disabled={!!initialData.institutionId && initialData.approved === true} // Allow edit if NOT approved\r\n                                    >\r\n                                        <option value=\"\" disabled>Select a School to Apply</option>\r\n                                        {institutions.map(inst => (\r\n                                            <option key={inst.id} value={inst.id}>{inst.schoolName || inst.name || \"Unnamed\"}</option>\r\n                                        ))}\r\n                                    </select>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Student Fields */}\r\n                            {role === 'student' && (\r\n                                <div className=\"form-group\">\r\n                                    <h3 style={{ borderBottom: '2px solid #00b894', paddingBottom: '5px', marginBottom: '15px', color: '#00b894' }}>≡ƒÄô Student Details</h3>\r\n\r\n                                    <label>First Name</label>\r\n                                    <input name=\"firstName\" value={formData.firstName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>Second Name</label>\r\n                                    <input name=\"secondName\" value={formData.secondName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>Class</label>\r\n                                    <select name=\"class\" value={formData.class || 'Nursery'} className=\"input-field\" onChange={handleChange}>\r\n                                        <option>Nursery</option>\r\n                                        {['LKG', 'UKG', '1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th', '11th', '12th'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                                    </select>\r\n\r\n                                    <label style={{ color: '#d63031', fontWeight: 'bold', marginTop: '15px' }}>Apply to School/Institution:</label>\r\n                                    {institutions.length === 0 && <p style={{ color: 'red', fontSize: '12px' }}>No registered institutions found. You cannot submit without selecting one.</p>}\r\n                                    <select\r\n                                        name=\"institutionId\"\r\n                                        value={formData.institutionId || ''}\r\n                                        className=\"input-field\"\r\n                                        required\r\n                                        onChange={handleChange}\r\n                                        disabled={!!initialData.institutionId && (initialData.approved === true || !!initialData.isInstitutionCreated)} // Allow edit if NOT approved and not inst-created\r\n                                    >\r\n                                        <option value=\"\" disabled>Select a School to Apply</option>\r\n                                        {institutions.map(inst => (\r\n                                            <option key={inst.id} value={inst.id}>{inst.schoolName || inst.name || \"Unnamed\"}</option>\r\n                                        ))}\r\n                                    </select>\r\n\r\n                                    <label>Gender</label>\r\n                                    <select name=\"gender\" value={formData.gender || ''} className=\"input-field\" onChange={handleChange}>\r\n                                        <option value=\"\" disabled>Select Gender</option>\r\n                                        <option>Male</option><option>Female</option><option>Other</option>\r\n                                    </select>\r\n\r\n                                    <label>Age (Date of Birth)</label>\r\n                                    <input type=\"date\" name=\"dob\" value={formData.dob || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label className=\"text-muted\">Father Name</label>\r\n                                    <input name=\"fatherName\" value={formData.fatherName || ''} className=\"input-field\" onChange={handleChange} />\r\n\r\n                                    <label className=\"text-muted\">Mother Name</label>\r\n                                    <input name=\"motherName\" value={formData.motherName || ''} className=\"input-field\" onChange={handleChange} />\r\n\r\n                                    <label className=\"help-text\">Parent/Guardian Phone Number (For Parent Login)</label>\r\n                                    <input\r\n                                        name=\"parentPhone\"\r\n                                        type=\"tel\"\r\n                                        value={formData.parentPhone || ''}\r\n                                        className=\"input-field\"\r\n                                        placeholder=\"Use this number for Parent Login\"\r\n                                        onChange={handleChange}\r\n                                    />\r\n\r\n                                    <label className=\"text-muted\">Prizes</label>\r\n                                    <textarea name=\"prizes\" value={formData.prizes || ''} className=\"input-field\" placeholder=\"Mention prizes received, if any\" onChange={handleChange}></textarea>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Institution Fields */}\r\n                            {role === 'institution' && (\r\n                                <div className=\"form-group\">\r\n                                    <h3 style={{ borderBottom: '2px solid #6c5ce7', paddingBottom: '5px', marginBottom: '15px', color: '#6c5ce7' }}>≡ƒÅ½ Institution Registration</h3>\r\n\r\n                                    <label>Chairman Name</label>\r\n                                    <input name=\"chairmanName\" value={formData.chairmanName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>Principal Name</label>\r\n                                    <input name=\"principalName\" value={formData.principalName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>School Name</label>\r\n                                    <input name=\"schoolName\" value={formData.schoolName || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label>Establishment Year</label>\r\n                                    <input type=\"date\" name=\"estYear\" value={formData.estYear || ''} className=\"input-field\" required onChange={handleChange} />\r\n\r\n                                    <label className=\"text-muted\">Chairman Profile Link <span style={{ fontSize: '12px', color: '#888' }}>(Optional)</span></label>\r\n                                    <input type=\"url\" name=\"chairmanLink\" value={formData.chairmanLink || ''} className=\"input-field\" onChange={handleChange} />\r\n\r\n                                    <label className=\"text-muted\">Principal Profile Link <span style={{ fontSize: '12px', color: '#888' }}>(Optional)</span></label>\r\n                                    <input type=\"url\" name=\"principalLink\" value={formData.principalLink || ''} className=\"input-field\" onChange={handleChange} />\r\n\r\n                                    <h4 className=\"section-header\">≡ƒô₧ Institution Contact Details</h4>\r\n                                    <p className=\"text-muted help-text\">This will be visible to students for admissions/inquiries.</p>\r\n\r\n                                    <label>Official Phone Number</label>\r\n                                    <input name=\"phoneNumber\" type=\"tel\" value={formData.phoneNumber || ''} className=\"input-field\" placeholder=\"+91 9876543210\" required onChange={handleChange} />\r\n\r\n                                    <label className=\"checkbox-label-sm\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            onChange={(e) => {\r\n                                                if (e.target.checked) {\r\n                                                    setFormData(prev => ({ ...prev, whatsappNumber: prev.phoneNumber }));\r\n                                                }\r\n                                            }}\r\n                                        />\r\n                                        WhatsApp number is same as Phone Number\r\n                                    </label>\r\n\r\n                                    <label>WhatsApp Number</label>\r\n                                    <input name=\"whatsappNumber\" type=\"tel\" value={formData.whatsappNumber || ''} className=\"input-field\" placeholder=\"+91 9876543210\" required onChange={handleChange} />\r\n\r\n                                    <h4 className=\"section-header\">≡ƒÜæ Emergency & Safety Contacts</h4>\r\n                                    <p className=\"text-muted help-text\">These numbers will be shown to your students in the Report Harassment page.</p>\r\n\r\n                                    <label>Local Police Station Name</label>\r\n                                    <input name=\"localPoliceName\" value={formData.localPoliceName || ''} className=\"input-field\" placeholder=\"e.g. Banjara Hills PS\" required onChange={handleChange} />\r\n\r\n                                    <label>Local Police Phone Number</label>\r\n                                    <input name=\"localPolicePhone\" value={formData.localPolicePhone || ''} className=\"input-field\" placeholder=\"e.g. 040-23456789\" required onChange={handleChange} />\r\n                                </div>\r\n                            )}\r\n                            <div className=\"submit-container\">\r\n                                <button type=\"submit\" className=\"btn submit-button\">Submit Details</button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </form>\r\n\r\n                {/* Debug Info Removed for Security */}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\DownloadApp.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useState' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"useState"},"fix":{"range":[16,25],"text":""},"desc":"Remove unused variable 'useState'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"useEffect"},"fix":{"range":[24,35],"text":""},"desc":"Remove unused variable 'useEffect'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'userData' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":7,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"userData"},"fix":{"range":[238,269],"text":""},"desc":"Remove unused variable 'userData'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'isWindows' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"isWindows"},"fix":{"range":[520,575],"text":""},"desc":"Remove unused variable 'isWindows'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { usePWA } from '../context/PWAContext';\r\nimport logo from '../assets/logo.png';\r\n\r\nexport default function DownloadApp() {\r\n    const { userData } = useUser();\r\n    const navigate = useNavigate();\r\n    const { installPrompt, promptInstall } = usePWA();\r\n\r\n    // Check Platform\r\n    const isAndroid = /Android/i.test(navigator.userAgent);\r\n    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);\r\n    const isWindows = /Windows/i.test(navigator.userAgent);\r\n\r\n    const handleInstallClick = () => {\r\n        promptInstall();\r\n    };\r\n\r\n\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n            background: 'rgba(0,0,0,0.85)', // Darker dim for more focus\r\n            display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',\r\n            zIndex: 9999, backdropFilter: 'blur(8px)',\r\n            fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif'\r\n        }}>\r\n            {/* BACK BUTTON (Top Left) */}\r\n            <button\r\n                onClick={() => navigate(-1)}\r\n                style={{\r\n                    position: 'absolute', top: '20px', left: '20px',\r\n                    background: 'none', border: 'none', color: 'white', fontSize: '18px', cursor: 'pointer',\r\n                    zIndex: 10001, display: 'flex', alignItems: 'center', gap: '5px', fontWeight: '500'\r\n                }}\r\n            >\r\n                ΓåÉ Back\r\n            </button>\r\n\r\n            {/* CLOSE BUTTON (Top Right) */}\r\n            <button\r\n                onClick={() => navigate('/')}\r\n                style={{\r\n                    position: 'absolute', top: '20px', right: '20px',\r\n                    background: 'none', border: 'none', color: 'white', fontSize: '30px', cursor: 'pointer',\r\n                    zIndex: 10001\r\n                }}\r\n            >\r\n                &times;\r\n            </button>\r\n\r\n            {/* MAIN CARD */}\r\n            <div style={{\r\n                background: 'white',\r\n                width: '90%', maxWidth: '380px',\r\n                borderRadius: '24px',\r\n                padding: '40px 30px',\r\n                textAlign: 'center',\r\n                boxShadow: '0 25px 60px rgba(0,0,0,0.5)',\r\n                animation: 'popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28)',\r\n                position: 'relative'\r\n            }}>\r\n                <img\r\n                    src={`${logo}?v=58`}\r\n                    alt=\"App Icon\"\r\n                    style={{\r\n                        width: '90px', height: '90px', borderRadius: '22px',\r\n                        marginBottom: '20px', boxShadow: '0 10px 25px rgba(0,0,0,0.15)'\r\n                    }}\r\n                    onError={(e) => e.target.style.display = 'none'}\r\n                />\r\n\r\n                <h2 style={{ fontSize: '24px', margin: '0 0 10px 0', color: '#1a1a1a', fontWeight: '700' }}>\r\n                    Install App\r\n                </h2>\r\n\r\n                <p style={{ fontSize: '15px', color: '#666', marginBottom: '35px', lineHeight: '1.6' }}>\r\n                    Together To Refine works best as an app. Install it now for easy access.\r\n                </p>\r\n\r\n                {/* INSTALL ACTION AREA */}\r\n                {installPrompt ? (\r\n                    // 1. NATIVE PROMPT AVAILABLE (Android/Chrome/Edge)\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>\r\n                        <button\r\n                            onClick={handleInstallClick}\r\n                            style={{\r\n                                background: 'linear-gradient(135deg, #0984e3, #6c5ce7)',\r\n                                color: 'white',\r\n                                border: 'none', padding: '16px', borderRadius: '14px',\r\n                                fontSize: '17px', fontWeight: 'bold', cursor: 'pointer',\r\n                                width: '100%', boxShadow: '0 8px 15px rgba(108, 92, 231, 0.3)',\r\n                                transition: 'transform 0.1s'\r\n                            }}\r\n                            className=\"active-btn\"\r\n                        >\r\n                            Tap to Install\r\n                        </button>\r\n                        <button\r\n                            onClick={() => navigate(-1)}\r\n                            style={{\r\n                                background: '#f1f2f6', color: '#636e72',\r\n                                border: 'none', padding: '16px', borderRadius: '14px',\r\n                                fontSize: '16px', fontWeight: '600', cursor: 'pointer', width: '100%'\r\n                            }}\r\n                        >\r\n                            Not Now\r\n                        </button>\r\n                    </div>\r\n                ) : isIOS ? (\r\n                    // 2. iOS INSTRUCTIONS (Animated)\r\n                    <div style={{ background: '#f8f9fa', padding: '20px', borderRadius: '16px', textAlign: 'left', border: '1px solid #e9ecef' }}>\r\n                        <p style={{ margin: '0 0 15px 0', fontSize: '15px', fontWeight: '600', color: '#2d3436', lineHeight: '1.5' }}>\r\n                            To install on iPhone/iPad:\r\n                        </p>\r\n                        <ol style={{ paddingLeft: '20px', margin: '0', fontSize: '14px', color: '#555', lineHeight: '1.8' }}>\r\n                            <li>Tap the <b>Share</b> button <img src=\"https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Apple_Share_icon.svg/1200px-Apple_Share_icon.svg.png\" style={{ width: '14px', verticalAlign: '-2px' }} alt=\"\" /> below.</li>\r\n                            <li>Scroll down and tap <b>\"Add to Home Screen\"</b>.</li>\r\n                        </ol>\r\n                        <div style={{ display: 'flex', justifyContent: 'center', marginTop: '15px' }}>\r\n                            <span style={{ fontSize: '28px', animation: 'bounce 2s infinite', opacity: '0.8' }}>Γ¼ç∩╕Å</span>\r\n                        </div>\r\n                    </div>\r\n                ) : (\r\n                    // 3. NO PROMPT DETECTED (Manual Instructions or Desktop)\r\n                    <div style={{ textAlign: 'left', width: '100%' }}>\r\n                        {isAndroid ? (\r\n                            <div style={{ background: '#e3f2fd', padding: '20px', borderRadius: '16px', border: '1px solid #bbdefb' }}>\r\n                                <p style={{ margin: '0 0 10px 0', fontSize: '15px', fontWeight: 'bold', color: '#0d47a1' }}>\r\n                                    Automatic install not ready.\r\n                                </p>\r\n                                <p style={{ fontSize: '14px', color: '#1565c0', marginBottom: '10px' }}>\r\n                                    Please install manually:\r\n                                </p>\r\n                                <ol style={{ paddingLeft: '20px', margin: '0', fontSize: '14px', color: '#0d47a1', lineHeight: '1.6' }}>\r\n                                    <li>Tap the <b>three dots</b> (Γï«) in the browser menu.</li>\r\n                                    <li>Select <b>\"Install App\"</b> or <b>\"Add to Home Screen\"</b>.</li>\r\n                                </ol>\r\n                            </div>\r\n                        ) : (\r\n                            <div style={{ background: '#f5f6fa', color: '#2d3436', padding: '15px', borderRadius: '12px', fontSize: '14px', marginBottom: '20px', lineHeight: '1.5' }}>\r\n                                Γ£à <b>To Install:</b><br />\r\n                                Check your browser's menu for an <b>\"Install App\"</b> option.\r\n                                <br /><br />\r\n                                <span style={{ fontSize: '12px', color: '#636e72' }}>If exploring on PC, you can continue to the website.</span>\r\n                            </div>\r\n                        )}\r\n\r\n                        <button\r\n                            onClick={() => navigate('/')}\r\n                            style={{\r\n                                marginTop: '20px',\r\n                                background: '#1a1a1a', color: 'white',\r\n                                border: 'none', padding: '16px', borderRadius: '14px',\r\n                                fontSize: '16px', fontWeight: 'bold', cursor: 'pointer', width: '100%'\r\n                            }}\r\n                        >\r\n                            Continue to Website\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* STYLE FOR ANIMATION */}\r\n            <style>{`\r\n                @keyframes popIn {\r\n                    0% { transform: scale(0.9); opacity: 0; }\r\n                    100% { transform: scale(1); opacity: 1; }\r\n                }\r\n                @keyframes bounce {\r\n                    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}\r\n                    40% {transform: translateY(-10px);}\r\n                    60% {transform: translateY(-5px);}\r\n                }\r\n                .active-btn:active {\r\n                    transform: scale(0.98);\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\EarlyWarningSystem.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Exam.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\ExamSeatingPlanner.jsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/exhaustive-deps').","line":65,"column":9,"severity":1,"nodeType":null,"fix":{"range":[2537,2592],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, addDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';\r\n\r\nconst CLASSES = ['Nursery', 'LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];\r\nconst SECTIONS = ['A', 'B', 'C', 'D', 'E'];\r\n\r\nexport default function ExamSeatingPlanner() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [selectedClass, setSelectedClass] = useState('');\r\n    const [selectedSection, setSelectedSection] = useState('');\r\n    const [dbStudents, setDbStudents] = useState([]);\r\n\r\n    const [examName, setExamName] = useState('');\r\n    const [examDate, setExamDate] = useState('');\r\n    const [totalStudents, setTotalStudents] = useState('');\r\n    const [roomsCount, setRoomsCount] = useState('');\r\n    const [seatsPerRoom, setSeatsPerRoom] = useState('');\r\n\r\n    const [roomConfigs, setRoomConfigs] = useState([]); // { roomNo, roomName, teacherId }\r\n    const [teachers, setTeachers] = useState([]);\r\n\r\n    const [seatingPlan, setSeatingPlan] = useState(null);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [isFetchingStudents, setIsFetchingStudents] = useState(false);\r\n\r\n    // Initial Fetch (teachers)\r\n    useEffect(() => {\r\n        if (userData?.uid) {\r\n            fetchInitialData();\r\n        }\r\n    }, [userData]);\r\n\r\n    const fetchInitialData = async () => {\r\n        const instId = userData.role === 'institution' ? userData.uid : userData.institutionId;\r\n        if (!instId) return;\r\n\r\n        try {\r\n            // Fetch Teachers\r\n            const qT = query(collection(db, 'teachers'), where('institutionId', '==', instId));\r\n            const snapT = await getDocs(qT);\r\n            setTeachers(snapT.docs.map(d => ({\r\n                id: d.id,\r\n                ...d.data(),\r\n                name: d.data().name || d.data().firstName || 'Unnamed Teacher'\r\n            })));\r\n        } catch (error) {\r\n            console.error(\"Error fetching initial data:\", error);\r\n        }\r\n    };\r\n\r\n    // When a class or section changes, fetch students automatically\r\n    useEffect(() => {\r\n        if (selectedClass && selectedSection) {\r\n            fetchStudents(selectedClass, selectedSection);\r\n        } else {\r\n            setDbStudents([]);\r\n            setTotalStudents('');\r\n            setSeatingPlan(null);\r\n        }\r\n        // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    }, [selectedClass, selectedSection]);\r\n\r\n    const fetchStudents = async (cls, sec) => {\r\n        const instId = userData.role === 'institution' ? userData.uid : userData.institutionId;\r\n        setIsFetchingStudents(true);\r\n        setSeatingPlan(null);\r\n        try {\r\n            const q = query(\r\n                collection(db, \"student_allotments\"),\r\n                where(\"institutionId\", \"==\", instId),\r\n                where(\"classAssigned\", \"==\", cls)\r\n            );\r\n            const snapshot = await getDocs(q);\r\n            const students = snapshot.docs\r\n                .map(d => ({ id: d.id, ...d.data() }))\r\n                .filter(d => (d.section || '').trim().toLowerCase() === sec.trim().toLowerCase())\r\n                .map(data => ({\r\n                    id: data.id,\r\n                    userId: data.userId || null,\r\n                    name: data.studentName || data.name || 'Unknown Student',\r\n                    rollNo: data.rollNumber || data.rollNo || data.pid || `STU-${data.id.slice(-4)}`\r\n                }));\r\n            setDbStudents(students);\r\n            setTotalStudents(students.length.toString());\r\n        } catch (error) {\r\n            console.error(error);\r\n            alert(\"Error fetching students\");\r\n        } finally {\r\n            setIsFetchingStudents(false);\r\n        }\r\n    };\r\n\r\n    // When roomsCount changes, generate the roomConfigs array\r\n    const handleRoomsCountChange = (e) => {\r\n        const count = parseInt(e.target.value) || 0;\r\n        setRoomsCount(count.toString());\r\n\r\n        const newConfigs = [];\r\n        for (let i = 1; i <= count; i++) {\r\n            // Preserve existing config if it exists\r\n            const existing = roomConfigs.find(r => r.roomNo === i);\r\n            newConfigs.push(existing || { roomNo: i, roomName: `Room ${i}`, teacherId: '' });\r\n        }\r\n        setRoomConfigs(newConfigs);\r\n    };\r\n\r\n    const updateRoomConfig = (roomNo, field, value) => {\r\n        setRoomConfigs(prev => prev.map(r => r.roomNo === roomNo ? { ...r, [field]: value } : r));\r\n    };\r\n\r\n    const generateSeatingPlan = () => {\r\n        if (!selectedClass || !selectedSection) return alert(\"Please select a class and section first.\");\r\n        if (!examName || !examDate) return alert(\"Please provide an Exam Name and Date.\");\r\n\r\n        const studentsCount = parseInt(totalStudents);\r\n        const rooms = parseInt(roomsCount);\r\n        const seatsPerRm = parseInt(seatsPerRoom);\r\n\r\n        if (!studentsCount || studentsCount <= 0) return alert(\"No students available. Check total students.\");\r\n        if (!rooms || rooms <= 0) return alert(\"Please enter the number of rooms.\");\r\n        if (!seatsPerRm || seatsPerRm <= 0) return alert(\"Please enter seats per room.\");\r\n\r\n        if (studentsCount > (rooms * seatsPerRm)) {\r\n            return alert(`Capacity exceeded! ${rooms} rooms with ${seatsPerRm} seats can only hold ${rooms * seatsPerRm} students, but you have ${studentsCount} students.`);\r\n        }\r\n\r\n        // Validate Teachers assigned\r\n        const unassignedRoom = roomConfigs.find(r => !r.teacherId);\r\n        if (unassignedRoom) {\r\n            return alert(`Please assign a teacher to ${unassignedRoom.roomName || 'Room ' + unassignedRoom.roomNo}.`);\r\n        }\r\n\r\n        // Shuffle students\r\n        let dataToDistribute = [...dbStudents];\r\n        for (let i = dataToDistribute.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            [dataToDistribute[i], dataToDistribute[j]] = [dataToDistribute[j], dataToDistribute[i]];\r\n        }\r\n\r\n        const plan = [];\r\n        let studentIndex = 0;\r\n\r\n        for (let i = 0; i < roomConfigs.length; i++) {\r\n            const config = roomConfigs[i];\r\n            const roomSeats = [];\r\n\r\n            // Fill seats up to seatsPerRm or remaining students\r\n            const studentsInRoom = Math.min(seatsPerRm, dataToDistribute.length - studentIndex);\r\n\r\n            for (let seat = 1; seat <= studentsInRoom; seat++) {\r\n                const student = dataToDistribute[studentIndex];\r\n                roomSeats.push({\r\n                    seatNo: seat,\r\n                    rollNo: student.rollNo,\r\n                    studentName: student.name,\r\n                    userId: student.userId\r\n                });\r\n                studentIndex++;\r\n            }\r\n\r\n            const assignedTeacher = teachers.find(t => t.id === config.teacherId);\r\n\r\n            plan.push({\r\n                roomNo: config.roomNo,\r\n                roomName: config.roomName,\r\n                seats: roomSeats,\r\n                totalSeats: studentsInRoom,\r\n                invigilatorId: config.teacherId,\r\n                invigilatorName: assignedTeacher?.name || ''\r\n            });\r\n\r\n            if (studentIndex >= dataToDistribute.length) break;\r\n        }\r\n\r\n        setSeatingPlan(plan);\r\n    };\r\n\r\n    const saveSeatingPlan = async () => {\r\n        if (!seatingPlan) return;\r\n        setIsSaving(true);\r\n        try {\r\n            const instId = userData.role === 'institution' ? userData.uid : userData.institutionId;\r\n            const docData = {\r\n                examName: examName.trim(),\r\n                examDate: examDate,\r\n                totalStudents: parseInt(totalStudents),\r\n                roomsCount: parseInt(roomsCount),\r\n                seatsPerRoom: parseInt(seatsPerRoom),\r\n                seatingPlan: seatingPlan,\r\n                institutionId: instId,\r\n                createdBy: userData.uid,\r\n                createdAt: serverTimestamp()\r\n            };\r\n\r\n            await addDoc(collection(db, \"exam_seating\"), docData);\r\n            alert(\"Γ£à Seating plan generated and published live! Teachers & Students can now view it.\");\r\n            navigate('/institution');\r\n        } catch (e) {\r\n            alert(\"Save Error: \" + e.message);\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <div className=\"container\" style={{ maxWidth: '800px', margin: '0 auto' }}>\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                    <h2>≡ƒ¬æ AI Exam Seating Wizard</h2>\r\n                    <div style={{ display: 'flex', gap: '10px' }}>\r\n                        <button onClick={() => navigate('/view-exam-seating')} className=\"btn-outline\">\r\n                            ≡ƒô£ View History\r\n                        </button>\r\n                        <button onClick={() => navigate(-1)} className=\"btn-outline\">Exit</button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"card\" style={{ marginBottom: '20px' }}>\r\n                    <h3 style={{ marginBottom: '15px' }}>Step 1: Select Class</h3>\r\n                    <div style={{ display: 'flex', gap: '15px', marginBottom: '10px' }}>\r\n                        <div style={{ flex: 1 }}>\r\n                            <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>Class</label>\r\n                            <select\r\n                                className=\"input-field\"\r\n                                value={selectedClass}\r\n                                onChange={(e) => setSelectedClass(e.target.value)}\r\n                            >\r\n                                <option value=\"\">-- Select Class --</option>\r\n                                {CLASSES.map(cls => <option key={cls} value={cls}>{cls}</option>)}\r\n                            </select>\r\n                        </div>\r\n                        <div style={{ flex: 1 }}>\r\n                            <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>Section</label>\r\n                            <select\r\n                                className=\"input-field\"\r\n                                value={selectedSection}\r\n                                onChange={(e) => setSelectedSection(e.target.value)}\r\n                            >\r\n                                <option value=\"\">-- Select Section --</option>\r\n                                {SECTIONS.map(sec => <option key={sec} value={sec}>{sec}</option>)}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {isFetchingStudents && <div style={{ color: '#888', fontSize: '12px', marginTop: '10px' }}>Fetching student data for {selectedClass} - {selectedSection}...</div>}\r\n\r\n                    {selectedClass && selectedSection && !isFetchingStudents && (\r\n                        <div style={{ background: '#e8f5e9', padding: '10px', borderRadius: '8px', color: '#27ae60', fontSize: '13px', marginTop: '10px' }}>\r\n                            Γ£ô Located <strong>{totalStudents}</strong> students in {selectedClass} - {selectedSection}.\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {selectedClass && selectedSection && !isFetchingStudents && dbStudents.length > 0 && (\r\n                    <div className=\"card\" style={{ marginBottom: '20px' }}>\r\n                        <h3 style={{ marginBottom: '15px' }}>Step 2: Exam & Room Setup</h3>\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '15px' }}>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>Exam Name</label>\r\n                                <input type=\"text\" className=\"input-field\" placeholder=\"e.g., Midterm Maths\" value={examName} onChange={e => setExamName(e.target.value)} />\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>Date</label>\r\n                                <input type=\"date\" className=\"input-field\" value={examDate} onChange={e => setExamDate(e.target.value)} />\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>No. of Students per Class</label>\r\n                                <input type=\"number\" className=\"input-field\" value={totalStudents} onChange={e => setTotalStudents(e.target.value)} />\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>No. of Rooms</label>\r\n                                <input type=\"number\" className=\"input-field\" placeholder=\"e.g., 3\" value={roomsCount} onChange={handleRoomsCountChange} min=\"1\" />\r\n                            </div>\r\n                            <div style={{ gridColumn: '1 / -1' }}>\r\n                                <label style={{ fontSize: '12px', color: '#666', marginBottom: '5px', display: 'block' }}>Seats per Room</label>\r\n                                <input type=\"number\" className=\"input-field\" placeholder=\"e.g., 30\" value={seatsPerRoom} onChange={e => setSeatsPerRoom(e.target.value)} min=\"1\" />\r\n                            </div>\r\n                        </div>\r\n\r\n                        {roomConfigs.length > 0 && (\r\n                            <div style={{ marginTop: '20px', padding: '15px', border: '1px solid #ddd', borderRadius: '8px', background: '#f8f9fa' }}>\r\n                                <h4 style={{ marginBottom: '15px', color: '#2c3e50' }}>Room & Teacher Assignments</h4>\r\n                                {roomConfigs.map((room, index) => (\r\n                                    <div key={room.roomNo} style={{ display: 'flex', gap: '10px', marginBottom: '10px', alignItems: 'center', flexWrap: 'wrap' }}>\r\n                                        <div style={{ fontWeight: 'bold', width: '20px', color: '#7f8c8d' }}>{index + 1}.</div>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            className=\"input-field\"\r\n                                            placeholder=\"Room Number/Name\"\r\n                                            value={room.roomName}\r\n                                            onChange={(e) => updateRoomConfig(room.roomNo, 'roomName', e.target.value)}\r\n                                            style={{ flex: 1, minWidth: '150px' }}\r\n                                        />\r\n                                        <select\r\n                                            className=\"input-field\"\r\n                                            value={room.teacherId}\r\n                                            onChange={(e) => updateRoomConfig(room.roomNo, 'teacherId', e.target.value)}\r\n                                            style={{ flex: 1, minWidth: '150px' }}\r\n                                        >\r\n                                            <option value=\"\">-- Assign Teacher from Dropdown --</option>\r\n                                            {teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n\r\n                        <div style={{ marginTop: '20px' }}>\r\n                            <button onClick={generateSeatingPlan} className=\"btn\" style={{ width: '100%', padding: '12px', fontSize: '16px', background: '#6c5ce7' }}>\r\n                                ΓÜí Generate AI Seating Plan\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {seatingPlan && (\r\n                    <div className=\"card\" style={{ marginTop: '20px', borderTop: '4px solid #27ae60' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                            <h3 style={{ color: '#27ae60', margin: 0 }}>≡ƒÄë Success! Verify & Publish</h3>\r\n                            <button onClick={saveSeatingPlan} className=\"btn\" style={{ background: '#27ae60' }} disabled={isSaving}>\r\n                                {isSaving ? 'Publishing...' : '≡ƒÜÇ Publish Live'}\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'grid', gap: '15px' }}>\r\n                            {seatingPlan.map(room => (\r\n                                <div key={room.roomNo} style={{ border: '1px solid #dfe6e9', borderRadius: '8px', padding: '15px' }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px', flexWrap: 'wrap' }}>\r\n                                        <strong style={{ fontSize: '16px', color: '#2c3e50' }}>{room.roomName} ({room.totalSeats} seats)</strong>\r\n                                        <div style={{ background: '#e0ece4', color: '#2d3436', padding: '4px 10px', borderRadius: '4px', fontSize: '12px' }}>\r\n                                            ≡ƒæ«ΓÇìΓÖé∩╕Å Invigilator: <strong>{room.invigilatorName}</strong>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>\r\n                                        {room.seats.map(s => (\r\n                                            <div key={s.seatNo} style={{\r\n                                                padding: '6px 10px', background: '#ecf0f1', borderRadius: '6px', fontSize: '11px', minWidth: '80px', textAlign: 'center', border: '1px solid #bdc3c7'\r\n                                            }}>\r\n                                                <div style={{ color: '#7f8c8d' }}>Seat {s.seatNo}</div>\r\n                                                <div style={{ fontWeight: 'bold', color: '#34495e' }}>{s.rollNo}</div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\FacultyFeedback.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":52,"suggestions":[{"messageId":"removeVar","data":{"varName":"orderBy"},"fix":{"range":[130,139],"text":""},"desc":"Remove unused variable 'orderBy'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"navigate"},"fix":{"range":[396,427],"text":""},"desc":"Remove unused variable 'navigate'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, orderBy, Timestamp } from 'firebase/firestore';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\n\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function FacultyFeedback() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n    const [teachers, setTeachers] = useState([]);\r\n    const [selectedTeacher, setSelectedTeacher] = useState(null);\r\n    const [feedbacks, setFeedbacks] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [loadingFeedbacks, setLoadingFeedbacks] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const fetchTeachers = async () => {\r\n            if (!userData) return;\r\n\r\n            try {\r\n                // Include Institution (Self) in the list\r\n                const selfEntry = { id: userData.uid, name: 'Institution (Me)', isInstitution: true };\r\n\r\n                // Fetch teachers from teacher_allotments \r\n                // We should ideally filter by 'createdBy' == userData.uid\r\n                const q = query(collection(db, \"teacher_allotments\"), where(\"createdBy\", \"==\", userData.uid));\r\n                const snap = await getDocs(q);\r\n\r\n                // Deduplicate teachers\r\n                const uniqueTeachers = new Map();\r\n\r\n                // Add Self first\r\n                uniqueTeachers.set(selfEntry.id, selfEntry);\r\n\r\n                snap.forEach(d => {\r\n                    const data = d.data();\r\n                    const name = data.name || data.teacherName;\r\n                    // FIX: Prioritize teacherId to match SelectFeedbackTarget logic\r\n                    const id = data.teacherId || data.userId || d.id;\r\n                    if (name && !uniqueTeachers.has(id)) {\r\n                        uniqueTeachers.set(id, { id, name });\r\n                    }\r\n                });\r\n\r\n                setTeachers(Array.from(uniqueTeachers.values()));\r\n            } catch (e) {\r\n                console.error(\"Error fetching teachers\", e);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n        fetchTeachers();\r\n    }, [userData]);\r\n\r\n    const handleSelectTeacher = async (teacher) => {\r\n        setSelectedTeacher(teacher);\r\n        setLoadingFeedbacks(true);\r\n        try {\r\n            // Fetch last 1 year feedbacks for this teacher\r\n            const oneYearAgo = new Date();\r\n            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);\r\n\r\n            const queries = [\r\n                getDocs(query(collection(db, \"general_feedback\"), where(\"targetId\", \"==\", teacher.id)))\r\n            ];\r\n\r\n            // If viewing Institution, also fetch Emergency Reports\r\n            if (teacher.isInstitution) {\r\n                queries.push(\r\n                    getDocs(query(collection(db, \"emergency_reports\"), where(\"institutionId\", \"==\", teacher.id)))\r\n                );\r\n            }\r\n\r\n            const snapshots = await Promise.all(queries);\r\n            const feedbackSnap = snapshots[0];\r\n            const reportSnap = snapshots[1]; // Undefined if not institution\r\n\r\n            let list = feedbackSnap.docs\r\n                .map(d => ({ id: d.id, ...d.data(), isReport: false }))\r\n                .filter(f => f.timestamp && f.timestamp.toDate() >= oneYearAgo);\r\n\r\n            if (reportSnap) {\r\n                const reports = reportSnap.docs.map(d => ({\r\n                    id: d.id,\r\n                    ...d.data(),\r\n                    isReport: true,\r\n                    timestamp: d.data().createdAt // normalize timestamp for sort\r\n                }));\r\n                // Filter reports by date too if needed? Let's show all recent ones.\r\n                list = [...list, ...reports];\r\n            }\r\n\r\n            // Client-side Sort\r\n            list.sort((a, b) => {\r\n                const tA = a.timestamp?.seconds || 0;\r\n                const tB = b.timestamp?.seconds || 0;\r\n                return tB - tA;\r\n            });\r\n\r\n            setFeedbacks(list);\r\n        } catch (e) {\r\n            console.error(\"Error fetching feedback details\", e);\r\n        } finally {\r\n            setLoadingFeedbacks(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <AnnouncementBar title=\"Faculty Feedback Review\" leftIcon={false} backPath=\"/institution\" />\r\n\r\n            <div className=\"container\" style={{ maxWidth: '1000px', margin: '20px auto' }}>\r\n                {!selectedTeacher ? (\r\n                    <div className=\"card\">\r\n                        <h2 className=\"text-center\">Select Faculty Member</h2>\r\n                        <p className=\"text-center text-muted\">View feedback analytics for the past year.</p>\r\n\r\n                        {loading ? <div className=\"text-center\">Loading Faculty List...</div> : (\r\n                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '15px', marginTop: '20px' }}>\r\n                                {teachers.map(t => (\r\n                                    <div\r\n                                        key={t.id}\r\n                                        onClick={() => handleSelectTeacher(t)}\r\n                                        className=\"card\"\r\n                                        style={{\r\n                                            cursor: 'pointer', textAlign: 'center', padding: '20px',\r\n                                            border: '1px solid #eee', transition: 'transform 0.2s',\r\n                                            background: 'linear-gradient(to bottom right, #ffffff, #f8f9fa)'\r\n                                        }}\r\n                                        onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}\r\n                                        onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}\r\n                                    >\r\n                                        <div style={{ fontSize: '40px', marginBottom: '10px' }}>≡ƒæ¿ΓÇì≡ƒÅ½</div>\r\n                                        <h3 style={{ fontSize: '16px', margin: '0', color: '#2d3436' }}>{t.name}</h3>\r\n                                        <div style={{ fontSize: '12px', color: '#636e72', marginTop: '5px' }}>Click to View Report</div>\r\n                                    </div>\r\n                                ))}\r\n                                {teachers.length === 0 && <div className=\"text-center text-muted\" style={{ gridColumn: '1/-1' }}>No faculty members found.</div>}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                ) : (\r\n                    <div>\r\n                        <button className=\"btn\" style={{ marginBottom: '20px', background: '#b2bec3' }} onClick={() => setSelectedTeacher(null)}>ΓåÉ Back to List</button>\r\n\r\n                        <div className=\"card\">\r\n                            <div style={{ borderBottom: '1px solid #eee', paddingBottom: '15px', marginBottom: '15px' }}>\r\n                                <h2 style={{ margin: 0 }}>Feedback Report: {selectedTeacher.name}</h2>\r\n                                <p style={{ color: '#666', margin: '5px 0' }}>Showing feedback from the last 1 year.</p>\r\n                            </div>\r\n\r\n                            {loadingFeedbacks ? <div className=\"text-center\">Loading Feedback Data...</div> : (\r\n                                <>\r\n                                    {feedbacks.length === 0 ? (\r\n                                        <div className=\"text-center\" style={{ padding: '40px', color: '#b2bec3' }}>No feedback received in the last year.</div>\r\n                                    ) : (\r\n                                        <div className=\"list-container\">\r\n                                            {feedbacks.map(f => {\r\n                                                if (f.isReport) {\r\n                                                    return (\r\n                                                        <div key={f.id} style={{\r\n                                                            padding: '20px', border: '2px solid #ff7675', marginBottom: '15px',\r\n                                                            borderRadius: '12px', background: '#fff0f0'\r\n                                                        }}>\r\n                                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                                                <div>\r\n                                                                    <strong style={{ color: '#d63031', fontSize: '16px' }}>\r\n                                                                        {f.type === 'sexual_harassment' ? '≡ƒÜ¿ SEXUAL HARASSMENT REPORT' : 'ΓÜá∩╕Å MISBEHAVIOR REPORT'}\r\n                                                                    </strong>\r\n                                                                    <span style={{ display: 'block', fontSize: '13px', color: '#636e72', marginTop: '4px' }}>\r\n                                                                        From: {f.authorName || 'Anonymous'} ({f.authorRole || 'Student'})\r\n                                                                    </span>\r\n                                                                </div>\r\n                                                                <span style={{ fontSize: '12px', color: '#b2bec3' }}>\r\n                                                                    {f.timestamp?.seconds ? new Date(f.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}\r\n                                                                </span>\r\n                                                            </div>\r\n\r\n                                                            <div style={{ marginBottom: '10px', fontSize: '14px', color: '#2d3436' }}>\r\n                                                                <span style={{ fontWeight: 'bold' }}>Accused:</span> {f.accusedName}\r\n                                                            </div>\r\n                                                            <div style={{ marginBottom: '10px', fontSize: '14px', color: '#2d3436' }}>\r\n                                                                <span style={{ fontWeight: 'bold' }}>Location:</span> {f.location}\r\n                                                            </div>\r\n\r\n                                                            <p style={{ margin: '5px 0', background: 'white', padding: '10px', border: '1px solid #ffdcdc', borderRadius: '5px', color: '#d63031' }}>\r\n                                                                \"{f.description}\"\r\n                                                            </p>\r\n\r\n                                                            {f.evidence && (\r\n                                                                <div style={{ marginTop: '10px' }}>\r\n                                                                    <a href={f.evidence} target=\"_blank\" rel=\"noreferrer\" style={{ color: '#0984e3', textDecoration: 'underline', fontSize: '14px' }}>View Evidence</a>\r\n                                                                </div>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    );\r\n                                                } else {\r\n                                                    return (\r\n                                                        <div key={f.id} style={{\r\n                                                            padding: '15px', borderBottom: '1px solid #f1f2f6',\r\n                                                            display: 'flex', flexDirection: 'column', gap: '10px'\r\n                                                        }}>\r\n                                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '14px' }}>\r\n                                                                <div>\r\n                                                                    <span style={{ fontWeight: 'bold', color: '#0984e3' }}>\r\n                                                                        {f.authorPid ? (<span>≡ƒò╡∩╕Å {f.authorPid}</span>) : (<span>≡ƒæñ {f.authorName}</span>)}\r\n                                                                    </span>\r\n                                                                    <span style={{ color: '#636e72', marginLeft: '5px' }}>({f.authorRole})</span>\r\n                                                                </div>\r\n                                                                <div style={{ color: '#b2bec3', fontSize: '12px' }}>\r\n                                                                    {f.timestamp?.toDate().toLocaleDateString()}\r\n                                                                </div>\r\n                                                            </div>\r\n\r\n                                                            <div style={{ display: 'flex', gap: '15px', fontSize: '13px', color: '#2d3436' }}>\r\n                                                                <span><strong>Behavior:</strong> {f.behavior?.stars}Γÿà</span>\r\n                                                                <span><strong>Comm:</strong> {f.communication?.stars}Γÿà</span>\r\n                                                                <span><strong>Body Lang:</strong> {f.bodyLanguage?.stars}Γÿà</span>\r\n                                                                <span><strong>Hardwork:</strong> {f.hardworking?.stars}Γÿà</span>\r\n                                                            </div>\r\n\r\n                                                            {f.comment && (\r\n                                                                <div style={{\r\n                                                                    background: '#fff3cd', padding: '10px', borderRadius: '6px',\r\n                                                                    fontSize: '13px', color: '#856404', fontStyle: 'italic'\r\n                                                                }}>\r\n                                                                    \"{f.comment}\"\r\n                                                                </div>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    );\r\n                                                }\r\n                                            })}\r\n                                        </div>\r\n                                    )}\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\FeeDetails.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'feeId' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"feeId"},"fix":{"range":[393,423],"text":""},"desc":"Remove unused variable 'feeId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useParams, useSearchParams, useNavigate } from 'react-router-dom';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs } from 'firebase/firestore';\r\nimport { useUser } from '../context/UserContext';\r\nimport jsPDF from 'jspdf';\r\nimport autoTable from 'jspdf-autotable';\r\n\r\nconst FeeDetails = () => {\r\n    const { feeId } = useParams();\r\n    const [searchParams] = useSearchParams();\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [loading, setLoading] = useState(true);\r\n    const [paidStudents, setPaidStudents] = useState([]);\r\n    const [unpaidStudents, setUnpaidStudents] = useState([]);\r\n    const [feeInfo, setFeeInfo] = useState(null);\r\n\r\n    const classParam = searchParams.get('class');\r\n    const sectionParam = searchParams.get('section');\r\n    const titleParam = searchParams.get('title');\r\n\r\n    const instId = userData?.role === 'institution' ? userData?.uid : userData?.institutionId;\r\n\r\n    useEffect(() => {\r\n        if (!instId || !classParam || !titleParam) {\r\n            console.log('Missing required params:', { instId, classParam, titleParam });\r\n            return;\r\n        }\r\n\r\n        const fetchPaymentStatus = async () => {\r\n            setLoading(true);\r\n            try {\r\n                console.log('Fetching fees with params:', { instId, classParam, sectionParam, titleParam });\r\n\r\n                // Fetch all fee records for this class and title\r\n                const feesRef = collection(db, 'fees');\r\n                const q = query(\r\n                    feesRef,\r\n                    where('institutionId', '==', instId),\r\n                    where('class', '==', classParam),\r\n                    where('title', '==', titleParam)\r\n                );\r\n\r\n                const snapshot = await getDocs(q);\r\n                console.log('Total fee records found:', snapshot.docs.length);\r\n\r\n                const feeRecords = snapshot.docs.map(doc => ({\r\n                    id: doc.id,\r\n                    ...doc.data()\r\n                }));\r\n\r\n                console.log('Fee records:', feeRecords);\r\n\r\n                // Filter by section if needed\r\n                const filteredRecords = sectionParam && sectionParam !== 'All'\r\n                    ? feeRecords.filter(f => f.section === sectionParam)\r\n                    : feeRecords;\r\n\r\n                console.log('Filtered records:', filteredRecords.length);\r\n\r\n                // Get fee info from first record\r\n                if (filteredRecords.length > 0) {\r\n                    setFeeInfo({\r\n                        title: filteredRecords[0].title,\r\n                        amount: filteredRecords[0].amount,\r\n                        class: filteredRecords[0].class,\r\n                        section: filteredRecords[0].section || sectionParam,\r\n                        dueDate: filteredRecords[0].dueDate\r\n                    });\r\n                }\r\n\r\n                // Separate paid and unpaid\r\n                const paid = filteredRecords.filter(f => f.status === 'paid' || f.status === 'approved');\r\n                const unpaid = filteredRecords.filter(f => f.status === 'pending' || !f.status);\r\n\r\n                console.log('Paid students:', paid.length);\r\n                console.log('Unpaid students:', unpaid.length);\r\n\r\n                setPaidStudents(paid);\r\n                setUnpaidStudents(unpaid);\r\n            } catch (error) {\r\n                console.error('Error fetching payment status:', error);\r\n                alert('Failed to load payment details: ' + error.message);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchPaymentStatus();\r\n    }, [instId, classParam, sectionParam, titleParam]);\r\n\r\n    const totalStudents = paidStudents.length + unpaidStudents.length;\r\n    const collectedAmount = paidStudents.length * (feeInfo?.amount || 0);\r\n    const pendingAmount = unpaidStudents.length * (feeInfo?.amount || 0);\r\n    const collectionPercentage = totalStudents > 0 ? ((paidStudents.length / totalStudents) * 100).toFixed(1) : 0;\r\n\r\n    const downloadUnpaidReport = () => {\r\n        if (unpaidStudents.length === 0) {\r\n            alert(\"No unpaid students to report!\");\r\n            return;\r\n        }\r\n\r\n        const doc = new jsPDF();\r\n\r\n        // Header\r\n        doc.setFontSize(10);\r\n        doc.setTextColor(150, 150, 150);\r\n        doc.text(\"CONFIDENTIAL - FOR OFFICE USE ONLY\", 14, 10);\r\n\r\n        doc.setFontSize(18);\r\n        doc.setTextColor(40, 40, 40);\r\n        doc.text(\"Pending Fee Report\", 14, 20);\r\n\r\n        doc.setFontSize(12);\r\n        doc.setTextColor(100, 100, 100);\r\n        doc.text(`Fee: ${feeInfo?.title}`, 14, 30);\r\n        doc.text(`Class: ${feeInfo?.class} - ${feeInfo?.section}`, 14, 36);\r\n        doc.text(`Date Generated: ${new Date().toLocaleDateString()}`, 14, 42);\r\n\r\n        // Add a note about privacy\r\n        doc.setFontSize(10);\r\n        doc.setTextColor(220, 53, 69); // Red color for warning\r\n        doc.text(\"ΓÜá∩╕Å PRIVACY NOTICE: This document is for administrative communication with parents only.\", 14, 52);\r\n        doc.text(\"Do not display this list publicly or discuss with students to protect their dignity.\", 14, 57);\r\n\r\n        // Table\r\n        const tableColumn = [\"#\", \"Student Name\", \"Amount Due\", \"Due Date\", \"Parent Contact (Use for Reminders)\"];\r\n        const tableRows = [];\r\n\r\n        unpaidStudents.forEach((student, index) => {\r\n            const studentData = [\r\n                index + 1,\r\n                student.studentName || \"Unknown\",\r\n                `Rs. ${student.amount}`,\r\n                student.dueDate || \"N/A\",\r\n                \"___________________\" // Placeholder for manual notes if phone not available\r\n            ];\r\n            tableRows.push(studentData);\r\n        });\r\n\r\n        autoTable(doc, {\r\n            startY: 65,\r\n            head: [tableColumn],\r\n            body: tableRows,\r\n            theme: 'grid',\r\n            headStyles: { fillColor: [231, 76, 60] }, // Red header for unpaid\r\n            styles: { fontSize: 10 },\r\n        });\r\n\r\n        // Summary Footer\r\n        const finalY = (doc).lastAutoTable.finalY + 10;\r\n        doc.setFontSize(10);\r\n        doc.setTextColor(0, 0, 0);\r\n        doc.text(`Total Pending: ${unpaidStudents.length} Students`, 14, finalY);\r\n        doc.text(`Total Amount Pending: Rs. ${pendingAmount.toLocaleString()}`, 14, finalY + 6);\r\n\r\n        doc.save(`${feeInfo?.title}_Pending_Report.pdf`);\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div style={{\r\n                minHeight: '100vh',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\r\n            }}>\r\n                <p style={{ color: 'white', fontSize: '18px' }}>ΓÅ│ Loading payment details...</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div style={{\r\n            minHeight: '100vh',\r\n            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n            padding: '20px',\r\n            paddingBottom: '100px'\r\n        }}>\r\n            <div style={{ maxWidth: '1200px', margin: '0 auto' }}>\r\n                {/* Header */}\r\n                <div style={{\r\n                    background: 'white',\r\n                    borderRadius: '15px',\r\n                    padding: '30px',\r\n                    marginBottom: '20px',\r\n                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)'\r\n                }}>\r\n                    <button\r\n                        onClick={() => navigate(-1)}\r\n                        style={{\r\n                            background: '#f1f2f6',\r\n                            border: 'none',\r\n                            padding: '10px 20px',\r\n                            borderRadius: '8px',\r\n                            cursor: 'pointer',\r\n                            marginBottom: '15px',\r\n                            fontWeight: '600'\r\n                        }}\r\n                    >\r\n                        ΓåÉ Back\r\n                    </button>\r\n                    <h1 style={{\r\n                        fontSize: '32px',\r\n                        fontWeight: 'bold',\r\n                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n                        WebkitBackgroundClip: 'text',\r\n                        WebkitTextFillColor: 'transparent',\r\n                        marginBottom: '10px'\r\n                    }}>\r\n                        ≡ƒÆ░ {feeInfo?.title || titleParam || 'Fee Details'}\r\n                    </h1>\r\n                    <p style={{ color: '#666', fontSize: '16px' }}>\r\n                        Class {feeInfo?.class || classParam} - Section {feeInfo?.section || sectionParam}\r\n                    </p>\r\n                </div>\r\n\r\n                {/* No Data Message */}\r\n                {totalStudents === 0 && !loading && (\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '40px',\r\n                        marginBottom: '20px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)',\r\n                        textAlign: 'center'\r\n                    }}>\r\n                        <div style={{ fontSize: '48px', marginBottom: '15px' }}>≡ƒô¡</div>\r\n                        <h3 style={{ fontSize: '24px', marginBottom: '10px', color: '#2d3436' }}>\r\n                            No Fee Records Found\r\n                        </h3>\r\n                        <p style={{ color: '#666', marginBottom: '20px' }}>\r\n                            No fee records found for this class and fee title.\r\n                        </p>\r\n                        <div style={{\r\n                            background: '#f8f9fa',\r\n                            padding: '20px',\r\n                            borderRadius: '10px',\r\n                            textAlign: 'left',\r\n                            maxWidth: '500px',\r\n                            margin: '0 auto'\r\n                        }}>\r\n                            <p style={{ marginBottom: '10px', fontWeight: 'bold' }}>Possible reasons:</p>\r\n                            <ul style={{ paddingLeft: '20px', color: '#666' }}>\r\n                                <li>Fee hasn't been assigned to this class yet</li>\r\n                                <li>Class or section name doesn't match</li>\r\n                                <li>Fee title is different</li>\r\n                            </ul>\r\n                            <p style={{ marginTop: '15px', fontSize: '14px', color: '#999' }}>\r\n                                Try assigning the fee from Fee Management page first.\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Stats Cards */}\r\n                <div style={{\r\n                    display: 'grid',\r\n                    gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',\r\n                    gap: '20px',\r\n                    marginBottom: '20px'\r\n                }}>\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <div style={{ fontSize: '14px', color: '#666', marginBottom: '8px' }}>Total Students</div>\r\n                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#2d3436' }}>{totalStudents}</div>\r\n                    </div>\r\n\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <div style={{ fontSize: '14px', color: '#666', marginBottom: '8px' }}>Paid</div>\r\n                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#27ae60' }}>\r\n                            {paidStudents.length}\r\n                            <span style={{ fontSize: '16px', marginLeft: '10px', color: '#666' }}>\r\n                                ({collectionPercentage}%)\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <div style={{ fontSize: '14px', color: '#666', marginBottom: '8px' }}>Pending</div>\r\n                        <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#e74c3c' }}>{unpaidStudents.length}</div>\r\n                    </div>\r\n\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <div style={{ fontSize: '14px', color: '#666', marginBottom: '8px' }}>Collected</div>\r\n                        <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#27ae60' }}>\r\n                            Γé╣{collectedAmount.toLocaleString()}\r\n                        </div>\r\n                        <div style={{ fontSize: '12px', color: '#999', marginTop: '5px' }}>\r\n                            Pending: Γé╣{pendingAmount.toLocaleString()}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Two Column Layout */}\r\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\r\n                    {/* Paid Students */}\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <h3 style={{\r\n                            fontSize: '20px',\r\n                            fontWeight: 'bold',\r\n                            marginBottom: '15px',\r\n                            color: '#27ae60',\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            gap: '10px'\r\n                        }}>\r\n                            Γ£à Paid ({paidStudents.length})\r\n                        </h3>\r\n\r\n                        {paidStudents.length === 0 ? (\r\n                            <p style={{ color: '#999', fontStyle: 'italic' }}>No payments received yet</p>\r\n                        ) : (\r\n                            <div style={{ maxHeight: '500px', overflowY: 'auto' }}>\r\n                                {paidStudents.map((student, index) => (\r\n                                    <div\r\n                                        key={student.id}\r\n                                        style={{\r\n                                            padding: '12px',\r\n                                            borderBottom: '1px solid #f0f0f0',\r\n                                            display: 'flex',\r\n                                            justifyContent: 'space-between',\r\n                                            alignItems: 'center'\r\n                                        }}\r\n                                    >\r\n                                        <div>\r\n                                            <div style={{ fontWeight: '600', fontSize: '15px' }}>\r\n                                                {index + 1}. {student.studentName || 'Student'}\r\n                                            </div>\r\n                                            {student.paidAt && (\r\n                                                <div style={{ fontSize: '12px', color: '#999' }}>\r\n                                                    Paid on: {new Date(student.paidAt.seconds * 1000).toLocaleDateString()}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                        <div style={{\r\n                                            background: '#d4edda',\r\n                                            color: '#155724',\r\n                                            padding: '4px 12px',\r\n                                            borderRadius: '12px',\r\n                                            fontSize: '12px',\r\n                                            fontWeight: 'bold'\r\n                                        }}>\r\n                                            Γé╣{student.amount}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Unpaid Students */}\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>\r\n                            <h3 style={{\r\n                                fontSize: '20px',\r\n                                fontWeight: 'bold',\r\n                                color: '#e74c3c',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                                margin: 0\r\n                            }}>\r\n                                ΓÅ│ Pending ({unpaidStudents.length})\r\n                            </h3>\r\n                            {unpaidStudents.length > 0 && (\r\n                                <button\r\n                                    onClick={downloadUnpaidReport}\r\n                                    style={{\r\n                                        background: '#2d3436',\r\n                                        color: 'white',\r\n                                        border: 'none',\r\n                                        padding: '8px 15px',\r\n                                        borderRadius: '8px',\r\n                                        fontSize: '12px',\r\n                                        cursor: 'pointer',\r\n                                        fontWeight: 'bold',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '5px'\r\n                                    }}\r\n                                >\r\n                                    ≡ƒôÑ Download Report\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n\r\n                        {unpaidStudents.length === 0 ? (\r\n                            <p style={{ color: '#27ae60', fontStyle: 'italic' }}>≡ƒÄë All students have paid!</p>\r\n                        ) : (\r\n                            <div style={{ maxHeight: '500px', overflowY: 'auto' }}>\r\n                                {unpaidStudents.map((student, index) => (\r\n                                    <div\r\n                                        key={student.id}\r\n                                        style={{\r\n                                            padding: '12px',\r\n                                            borderBottom: '1px solid #f0f0f0',\r\n                                            display: 'flex',\r\n                                            justifyContent: 'space-between',\r\n                                            alignItems: 'center'\r\n                                        }}\r\n                                    >\r\n                                        <div>\r\n                                            <div style={{ fontWeight: '600', fontSize: '15px' }}>\r\n                                                {index + 1}. {student.studentName || 'Student'}\r\n                                            </div>\r\n                                            {student.dueDate && (\r\n                                                <div style={{ fontSize: '12px', color: '#999' }}>\r\n                                                    Due: {student.dueDate}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                        <div style={{\r\n                                            background: '#f8d7da',\r\n                                            color: '#721c24',\r\n                                            padding: '4px 12px',\r\n                                            borderRadius: '12px',\r\n                                            fontSize: '12px',\r\n                                            fontWeight: 'bold'\r\n                                        }}>\r\n                                            Γé╣{student.amount}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FeeDetails;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\FeedbackOverview.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\FourWayLearning.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":87,"suggestions":[{"messageId":"removeVar","data":{"varName":"where"},"fix":{"range":[457,464],"text":""},"desc":"Remove unused variable 'where'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  15 |     useEffect(() => {\n  16 |         indexRef.current = 0;\n> 17 |         setDisplayedText('');\n     |         ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |         const interval = setInterval(() => {\n  19 |             setDisplayedText((prev) => {\n  20 |                 if (indexRef.current < text.length) {","line":17,"column":9,"nodeType":null,"endLine":17,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'userClass' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":76,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"userClass"},"fix":{"range":[2552,2600],"text":""},"desc":"Remove unused variable 'userClass'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\n// import { GoogleGenerativeAI } from \"@google/generative-ai\"; // Removed for Security\r\nimport { useSpeech } from '../hooks/useSpeech';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { db } from '../firebase';\r\nimport { collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp, where, doc, updateDoc } from 'firebase/firestore';\r\n\r\n// Helper Component for Typewriter Effect\r\nconst TypewriterMessage = ({ text }) => {\r\n    const [displayedText, setDisplayedText] = useState('');\r\n    const indexRef = useRef(0);\r\n\r\n    useEffect(() => {\r\n        indexRef.current = 0;\r\n        setDisplayedText('');\r\n        const interval = setInterval(() => {\r\n            setDisplayedText((prev) => {\r\n                if (indexRef.current < text.length) {\r\n                    const char = text.charAt(indexRef.current);\r\n                    indexRef.current++;\r\n                    return prev + char;\r\n                } else {\r\n                    clearInterval(interval);\r\n                    return prev;\r\n                }\r\n            });\r\n        }, 5);\r\n        return () => clearInterval(interval);\r\n    }, [text]);\r\n\r\n    return <ReactMarkdown>{displayedText}</ReactMarkdown>;\r\n};\r\n\r\nexport default function FourWayLearning() {\r\n    const navigate = useNavigate();\r\n    const { user: authUser, userData } = useUser();\r\n\r\n    // Active Mode Tab\r\n    const [activeTab, setActiveTab] = useState('conceptual');\r\n\r\n    // Chat Content (View Layer)\r\n    const [chats, setChats] = useState({\r\n        conceptual: [],\r\n        fictional: [],\r\n        storytelling: [],\r\n        teaching: []\r\n    });\r\n\r\n    // Active Sessions (Persistence Layer) - Maps Mode -> SessionID\r\n    const [activeSessionIds, setActiveSessionIds] = useState({\r\n        conceptual: null,\r\n        fictional: null,\r\n        storytelling: null,\r\n        teaching: null\r\n    });\r\n\r\n    // History List\r\n    const [sessions, setSessions] = useState([]);\r\n\r\n    // Inputs\r\n    const [inputs, setInputs] = useState({\r\n        conceptual: '',\r\n        fictional: '',\r\n        storytelling: '',\r\n        teaching: ''\r\n    });\r\n\r\n    const [loading, setLoading] = useState(false);\r\n    const [motherTongue, setMotherTongue] = useState('Hindi');\r\n    const [selectedImage, setSelectedImage] = useState(null);\r\n    const [showSidebar, setShowSidebar] = useState(false);\r\n\r\n    const chatContainerRef = useRef(null);\r\n    const userClass = userData?.class || \"Grade 10\";\r\n\r\n    const modes = [\r\n        {\r\n            id: 'conceptual',\r\n            title: '≡ƒºá Conceptual',\r\n            desc: 'Understand the \"Why\" and \"How\" with deep conceptual clarity.',\r\n        },\r\n        {\r\n            id: 'fictional',\r\n            title: '≡ƒÜÇ Fictional',\r\n            desc: 'Learn through analogies using Indian Mythology, History, or Sci-Fi.',\r\n        },\r\n        {\r\n            id: 'storytelling',\r\n            title: '≡ƒôû Story',\r\n            desc: 'Weave the topic into a compelling narrative.',\r\n        },\r\n        {\r\n            id: 'teaching',\r\n            title: '≡ƒæ⌐ΓÇì≡ƒÅ½ Teaching',\r\n            desc: 'Interactive 2-way communication dialogue between Teacher and Student.',\r\n        }\r\n    ];\r\n\r\n    const currentMode = modes.find(m => m.id === activeTab);\r\n\r\n    // AI Helper - MOVED TO BACKEND (/api/chat) for Security\r\n    const MODEL_NAME = \"gemini-2.0-flash\";\r\n\r\n    // Speech Hook\r\n    const { speak, listen, isListening, speakingText } = useSpeech();\r\n\r\n    const handleMicClick = () => {\r\n        let lang = 'en-US';\r\n        if (activeTab === 'teaching') {\r\n            const map = { 'Hindi': 'hi-IN', 'Telugu': 'te-IN', 'Tamil': 'ta-IN', 'Spanish': 'es-ES', 'French': 'fr-FR' };\r\n            lang = map[motherTongue] || 'en-US';\r\n        }\r\n\r\n        listen((text) => {\r\n            setInputs(prev => ({ ...prev, [activeTab]: (prev[activeTab] + ' ' + text).trim() }));\r\n        }, lang);\r\n    };\r\n\r\n    // 1. Fetch User's History (Sessions)\r\n    useEffect(() => {\r\n        if (!authUser) return;\r\n        // Fetch all 4-Way sessions sorted by new\r\n        const q = query(\r\n            collection(db, 'users', authUser.uid, 'four_way_sessions'),\r\n            orderBy('updatedAt', 'desc'),\r\n            limit(50)\r\n        );\r\n        const unsub = onSnapshot(q, (snap) => {\r\n            setSessions(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n        });\r\n        return () => unsub();\r\n    }, [authUser]);\r\n\r\n    // 2. Listen to Active Session Messages (Only for current tab to save bandwidth)\r\n    useEffect(() => {\r\n        if (!authUser) return;\r\n        const currentId = activeSessionIds[activeTab];\r\n\r\n        if (!currentId) {\r\n            // No session active for this tab, clear view (or keep local optimistic if we just started?)\r\n            // We'll keep local state if it exists, otherwise empty\r\n            return;\r\n        }\r\n\r\n        const q = query(\r\n            collection(db, 'users', authUser.uid, 'four_way_sessions', currentId, 'messages'),\r\n            orderBy('createdAt', 'asc')\r\n        );\r\n\r\n        const unsub = onSnapshot(q, (snap) => {\r\n            const msgs = snap.docs.map(d => d.data());\r\n            setChats(prev => ({ ...prev, [activeTab]: msgs }));\r\n        });\r\n\r\n        return () => unsub();\r\n    }, [activeTab, activeSessionIds, authUser]); // Refetch when tab or session ID changes\r\n\r\n    // Auto-scroll\r\n    useEffect(() => {\r\n        if (chatContainerRef.current) {\r\n            chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;\r\n        }\r\n    }, [chats[activeTab], activeTab]);\r\n\r\n\r\n    const handleGenerate = async () => {\r\n        const currentInput = inputs[activeTab];\r\n        if (!currentInput.trim() && !selectedImage) return;\r\n\r\n        setLoading(true);\r\n        const newUserMsg = { role: 'user', text: currentInput, image: selectedImage, createdAt: serverTimestamp() };\r\n\r\n        // Optimistic UI\r\n        setChats(prev => ({ ...prev, [activeTab]: [...prev[activeTab], { ...newUserMsg, createdAt: new Date() }] }));\r\n\r\n        setInputs(prev => ({ ...prev, [activeTab]: '' }));\r\n        if (activeTab === 'teaching') setSelectedImage(null);\r\n\r\n        try {\r\n            if (!authUser) throw new Error(\"Please login.\");\r\n\r\n            // 1. Ensure Persistent Session Exists\r\n            let sessionId = activeSessionIds[activeTab];\r\n            if (!sessionId) {\r\n                const sessRef = await addDoc(collection(db, 'users', authUser.uid, 'four_way_sessions'), {\r\n                    mode: activeTab,\r\n                    title: currentInput.substring(0, 30) || \"Image Query\",\r\n                    createdAt: serverTimestamp(),\r\n                    updatedAt: serverTimestamp()\r\n                });\r\n                sessionId = sessRef.id;\r\n                setActiveSessionIds(prev => ({ ...prev, [activeTab]: sessionId }));\r\n            } else {\r\n                updateDoc(doc(db, 'users', authUser.uid, 'four_way_sessions', sessionId), {\r\n                    updatedAt: serverTimestamp()\r\n                });\r\n            }\r\n\r\n            // 2. Save User Msg\r\n            await addDoc(collection(db, 'users', authUser.uid, 'four_way_sessions', sessionId, 'messages'), newUserMsg);\r\n\r\n            // 3. AI Generation ( VIA SECURE BACKEND )\r\n            let promptText = \"\";\r\n            let topic = currentInput || \"Explain this image\";\r\n\r\n            // TTR UNIVERSE: MASTER CHARACTER LIST\r\n            // We inject this context so the AI uses consistent peronalities.\r\n            const UNIVERSE_CONTEXT = `\r\n                **TTR UNIVERSE - CHARACTER RULES:**\r\n                Use these specific characters if the topic relates to their concept. Do NOT invent random names if a TTR Character exists.\r\n                \r\n                **PHYSICS:**\r\n                - Proton -> **Pranav** (Positive Leader)\r\n                - Electron -> **Esha** (Energetic Runner)\r\n                - Neutron -> **Neel** (Calm, Neutral)\r\n                - Gravity -> **Gajraj** (Heavy Giant)\r\n                - Friction -> **Firoz** (Rough Blocker)\r\n                - Velocity -> **Veer** (Speedster)\r\n                - Light -> **Lux** (The Flash)\r\n                - Time -> **Tara** (The Watcher)\r\n                \r\n                **CHEMISTRY:**\r\n                - Atom -> **Anu** (Tiny Block)\r\n                - Bond -> **Bandhan** (The Glue)\r\n                - Carbon -> **Kabir** (King of Life)\r\n                - Oxygen -> **Ojas** (The Burner)\r\n                \r\n                **BIOLOGY:**\r\n                - Cell -> **Chaitanya** (The City)\r\n                - Nucleus -> **Nawab** (The Boss)\r\n                - DNA -> **Dina** (The Blueprint)\r\n                - Mitochondria -> **Mitran** (Powerhouse)\r\n                - Brain -> **Brain** (CPU)\r\n                \r\n                **MATH:**\r\n                - Zero -> **Shoonya** (The Void)\r\n                - Infinity -> **Anant** (Endless)\r\n                - Pi -> **Pie** (Circle Master)\r\n                - X (Variable) -> **Xavier** (The Mystery)\r\n                \r\n                **TECH:**\r\n                - Code -> **Coda**\r\n                - Bug -> **Glitch**\r\n                - AI -> **Aio**\r\n                \r\n                **General Rule:** If no specific character matches, use Indian names (Aarav, Diya) with distinct personalities.\r\n            `;\r\n\r\n            if (activeTab === 'teaching') {\r\n                promptText = `\r\n                    Act as a wise and encouraging Indian Teacher (Guru) teaching a student.\r\n                    Step 1: Write a formal, academic paragraph defining/explaining \"${topic}\".\r\n                    Step 2: Act as if you are now explaining that paragraph to a student in their mother tongue (${motherTongue}).\r\n                    Break it down, use casual/spoken tone in ${motherTongue} (e.g. Hinglish if Hindi, or just ${motherTongue}), and make it super easy to grasp.\r\n                    Always end with a small moral note or advice on discipline and hard work.\r\n                `;\r\n            } else if (activeTab === 'conceptual') {\r\n                promptText = `\r\n                    Explain the concept of \"${topic}\" in depth. \r\n                    - Focus on the core principles, definitions, and the underlying logic. \r\n                    - Use simple, digestible parts.\r\n                    - If possible, relate it to an example from Indian daily life or nature.\r\n                    - Conclude with why this knowledge is important for a responsible citizen.\r\n                `;\r\n            } else if (activeTab === 'fictional') {\r\n                promptText = `\r\n                    Explain \"${topic}\" by creating a fictional story using the **TTR Universe Characters**.\r\n                    ${UNIVERSE_CONTEXT}\r\n                    \r\n                    **CRITICAL INSTRUCTION:**\r\n                    - The story MUST use the concept as a key mechanism.\r\n                    - The story MUST teach **Ethics, Moral Values, and Dharma** alongside the concept.\r\n                    - The goal is to build a \"poisonless mind\" (virtuous and ethical) in the student.\r\n                `;\r\n            } else if (activeTab === 'storytelling') {\r\n                promptText = `\r\n                    Tell a compelling story revolving around \"${topic}\" set in India.\r\n                    ${UNIVERSE_CONTEXT}\r\n                    \r\n                    **CRITICAL INSTRUCTION:**\r\n                    - Use the TTR Characters where applicable.\r\n                    - The story **MUST** carry a strong moral lesson (teaching honesty, kindness, bravery, or integrity) alongside the educational topic.\r\n                    - Example theme: \"Knowledge without character is dangerous.\"\r\n                    - Ensure the narrative flow naturally explains the topic.\r\n                `;\r\n            }\r\n\r\n            // History for API\r\n            let historyForApi = chats[activeTab].map(msg => ({\r\n                role: msg.role === 'user' ? 'user' : 'model',\r\n                parts: [{ text: msg.text || \"\" }]\r\n            })).slice(-10); // Context window\r\n\r\n            // Ensure starts with user\r\n            while (historyForApi.length > 0 && historyForApi[0].role !== 'user') historyForApi.shift();\r\n\r\n            // CALL BACKEND\r\n            const payload = {\r\n                history: historyForApi,\r\n                message: promptText,\r\n                image: newUserMsg.image ? newUserMsg.image.split(',')[1] : null,\r\n                mimeType: newUserMsg.image ? newUserMsg.image.match(/:(.*?);/)?.[1] : null\r\n            };\r\n\r\n            // Connect to Production Server if on Localhost\r\n            const API_URL = window.location.hostname === 'localhost'\r\n                ? 'https://together-to-refine.vercel.app/api/chat'\r\n                : 'https://together-to-refine.vercel.app/api/chat';\r\n\r\n            const res = await fetch(API_URL, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(payload)\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const errData = await res.json();\r\n                throw new Error(errData.error || \"Server Error (Backend offline?)\");\r\n            }\r\n\r\n            const data = await res.json();\r\n            const responseText = data.text;\r\n\r\n            // 4. Save AI Msg\r\n            await addDoc(collection(db, 'users', authUser.uid, 'four_way_sessions', sessionId, 'messages'), {\r\n                role: 'ai',\r\n                text: responseText,\r\n                createdAt: serverTimestamp()\r\n            });\r\n\r\n        } catch (error) {\r\n            console.error(error);\r\n            setChats(prev => ({\r\n                ...prev,\r\n                [activeTab]: [...prev[activeTab], { role: 'ai', text: \"Error: \" + error.message, isError: true }]\r\n            }));\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleImageChange = (e) => {\r\n        const file = e.target.files[0];\r\n        if (file) {\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => setSelectedImage(reader.result);\r\n            reader.readAsDataURL(file);\r\n        }\r\n    };\r\n\r\n    const loadSession = (session) => {\r\n        setActiveTab(session.mode);\r\n        setActiveSessionIds(prev => ({ ...prev, [session.mode]: session.id }));\r\n        setShowSidebar(false);\r\n    };\r\n\r\n    const resetCurrentChat = () => {\r\n        setActiveSessionIds(prev => ({ ...prev, [activeTab]: null }));\r\n        setChats(prev => ({ ...prev, [activeTab]: [] }));\r\n        setShowSidebar(false);\r\n    };\r\n\r\n    return (\r\n        <div className=\"four-way-container\">\r\n\r\n            {/* HEADER */}\r\n            <div style={{ background: 'var(--bg-surface)', borderBottom: '1px solid var(--divider)', flexShrink: 0, position: 'relative' }}>\r\n                <button\r\n                    onClick={() => setShowSidebar(true)}\r\n                    style={{\r\n                        position: 'absolute', top: '12px', right: '10px', zIndex: 5,\r\n                        background: '#333', color: 'white', border: 'none',\r\n                        borderRadius: '4px', padding: '4px 8px', fontSize: '10px', cursor: 'pointer'\r\n                    }}\r\n                >\r\n                    ≡ƒô£ History\r\n                </button>\r\n\r\n                <div style={{ display: 'flex', overflowX: 'auto', padding: '0 10px', scrollbarWidth: 'none' }}>\r\n                    {modes.map(m => (\r\n                        <button\r\n                            key={m.id}\r\n                            onClick={() => setActiveTab(m.id)}\r\n                            style={{\r\n                                flex: 1, padding: '15px 10px', background: 'none', border: 'none',\r\n                                borderBottom: activeTab === m.id ? '3px solid #6c5ce7' : '3px solid transparent',\r\n                                color: activeTab === m.id ? '#6c5ce7' : 'var(--text-muted)',\r\n                                fontWeight: activeTab === m.id ? 'bold' : 'normal',\r\n                                cursor: 'pointer', whiteSpace: 'nowrap', transition: 'all 0.2s'\r\n                            }}\r\n                        >\r\n                            {m.title}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            {/* CHAT AREA */}\r\n            <div ref={chatContainerRef} className=\"chat-area\">\r\n                {chats[activeTab].length === 0 && (\r\n                    <div style={{ textAlign: 'center', color: '#b2bec3', marginTop: '50px' }}>\r\n                        <div style={{ fontSize: '40px', marginBottom: '10px' }}>Γ£¿</div>\r\n                        <p>{currentMode?.desc}</p>\r\n                        <p style={{ fontSize: '13px' }}>Ask anything to start learning!</p>\r\n                    </div>\r\n                )}\r\n                {chats[activeTab].map((msg, idx) => (\r\n                    <div key={idx} className={`message-bubble ${msg.role === 'user' ? 'message-user' : 'message-ai'}`}>\r\n                        {msg.image && <img src={msg.image} alt=\"User\" style={{ maxWidth: '100%', borderRadius: '8px', marginBottom: '10px' }} />}\r\n                        {/* TEXT CONTENT (Markdown Rendered) */}\r\n                        <div className=\"markdown-content\">\r\n                            {msg.role === 'ai' && idx === chats[activeTab].length - 1 && !msg.isError ? (\r\n                                <TypewriterMessage text={msg.text} />\r\n                            ) : (\r\n                                <ReactMarkdown>{msg.text}</ReactMarkdown>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* SPEAKER BUTTON */}\r\n                        {msg.role === 'ai' && (\r\n                            <button onClick={() => {\r\n                                const langMap = { 'Hindi': 'hi-IN', 'Telugu': 'te-IN', 'Tamil': 'ta-IN', 'Spanish': 'es-ES', 'French': 'fr-FR' };\r\n                                const lang = activeTab === 'teaching' ? (langMap[motherTongue] || 'en-US') : 'en-US';\r\n                                speak(msg.text, lang);\r\n                            }} className=\"speak-button\">\r\n                                {speakingText === msg.text ? '≡ƒöç' : '≡ƒöè'}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                ))}\r\n                {loading && <div style={{ alignSelf: 'flex-start', background: 'var(--bg-surface)', padding: '10px 20px', borderRadius: '20px', color: 'var(--text-muted)' }}>Thinking...</div>}\r\n            </div>\r\n\r\n            {/* INPUT AREA */}\r\n            <div className=\"input-area\">\r\n                {selectedImage && (\r\n                    <div className=\"image-preview-container\">\r\n                        <img src={selectedImage} alt=\"Preview\" className=\"image-preview\" />\r\n                        <button onClick={() => setSelectedImage(null)} className=\"remove-image-button\">Γ£ò</button>\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"input-controls\">\r\n                    <div style={{\r\n                        position: 'absolute', top: '-20px', right: '20px',\r\n                        fontSize: '9px', color: '#138808', fontWeight: 'bold',\r\n                        display: 'flex', alignItems: 'center', gap: '3px', opacity: 0.8\r\n                    }}>\r\n                        <span style={{ width: '5px', height: '5px', borderRadius: '50%', background: '#138808', display: 'inline-block' }}></span>\r\n                        TTR Intelligent Link\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={handleMicClick}\r\n                        className={`voice-button ${isListening ? 'listening' : ''}`}\r\n                        title=\"Click to Speak\"\r\n                    >\r\n                        {isListening ? '≡ƒ¢æ' : '≡ƒÄÖ∩╕Å'}\r\n                    </button>\r\n\r\n                    {activeTab === 'teaching' && (\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>\r\n                            <select\r\n                                value={motherTongue}\r\n                                onChange={(e) => setMotherTongue(e.target.value)}\r\n                                style={{ padding: '4px', borderRadius: '4px', border: '1px solid #ddd', fontSize: '12px' }}\r\n                            >\r\n                                <option value=\"Hindi\">HI</option>\r\n                                <option value=\"Telugu\">TE</option>\r\n                                <option value=\"Tamil\">TA</option>\r\n                                <option value=\"Spanish\">ES</option>\r\n                                <option value=\"French\">FR</option>\r\n                            </select>\r\n                            <label style={{ cursor: 'pointer', fontSize: '18px' }} title=\"Add Image\">\r\n                                <input type=\"file\" accept=\"image/*\" onChange={handleImageChange} style={{ display: 'none' }} />\r\n                                ≡ƒô╖\r\n                            </label>\r\n                        </div>\r\n                    )}\r\n\r\n                    <input\r\n                        type=\"text\"\r\n                        value={inputs[activeTab]}\r\n                        onChange={(e) => setInputs(prev => ({ ...prev, [activeTab]: e.target.value }))}\r\n                        onKeyPress={(e) => e.key === 'Enter' && handleGenerate()}\r\n                        placeholder={`Explain in ${activeTab}...`}\r\n                        className=\"chat-input\"\r\n                        autoComplete=\"off\"\r\n                        spellCheck=\"false\"\r\n                        autoCorrect=\"off\"\r\n                        autoCapitalize=\"none\"\r\n                    />\r\n\r\n                    <button onClick={handleGenerate} disabled={loading || (!inputs[activeTab] && !selectedImage)} className=\"send-button\">Γ₧ñ</button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* SIDEBAR HISTORY */}\r\n            {showSidebar && (\r\n                <div className=\"sidebar-overlay\">\r\n                    <div className=\"sidebar-backdrop\" onClick={() => setShowSidebar(false)} />\r\n                    <div className=\"sidebar-content\">\r\n                        <h2>History</h2>\r\n                        <button onClick={resetCurrentChat} className=\"btn\" style={{ width: '100%', marginBottom: '15px', background: '#333' }}>+ New {currentMode?.title} Chat</button>\r\n\r\n                        <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                            {sessions.filter(s => s.mode === activeTab).length === 0 && (\r\n                                <p style={{ color: '#666', fontStyle: 'italic' }}>No {currentMode?.title} history yet.</p>\r\n                            )}\r\n\r\n                            {sessions.filter(s => s.mode === activeTab).map(sess => (\r\n                                <div key={sess.id} onClick={() => loadSession(sess)} style={{\r\n                                    padding: '10px',\r\n                                    background: activeSessionIds[sess.mode] === sess.id ? '#e3f2fd' : '#f5f5f5',\r\n                                    borderRadius: '8px', cursor: 'pointer', fontSize: '14px', borderLeft: `4px solid ${sess.mode === 'conceptual' ? '#ff7675' :\r\n                                        sess.mode === 'fictional' ? '#74b9ff' :\r\n                                            sess.mode === 'storytelling' ? '#55efc4' : '#a29bfe'\r\n                                        }`\r\n                                }}>\r\n                                    <div style={{ fontWeight: 'bold', fontSize: '12px', color: '#666', marginBottom: '4px' }}>\r\n                                        {/* No need to show mode label since list is filtered, but title is active */}\r\n                                        {sess.title}\r\n                                    </div>\r\n                                    <div style={{ fontSize: '10px', color: '#999', marginTop: '4px' }}>\r\n                                        {sess.updatedAt?.toDate ? sess.updatedAt.toDate().toLocaleDateString() : 'Just now'}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n\r\n                        <div style={{ marginTop: '10px' }}>\r\n                            <button onClick={() => {\r\n                                const r = userData?.role?.toLowerCase();\r\n                                if (r === 'admin' || authUser?.email === 'admin@ttr.com') navigate('/admin');\r\n                                else if (r === 'teacher') navigate('/teacher');\r\n                                else if (r === 'institution') navigate('/institution');\r\n                                else if (r === 'student') navigate('/student');\r\n                                else navigate('/details');\r\n                            }} className=\"btn\" style={{ width: '100%', background: '#2193b0' }}>\r\n                                ≡ƒÅá Go to Dashboard\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\GeneralFeedback.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'setTargetPerson' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"setTargetPerson"},"fix":{"range":[650,667],"text":""},"desc":"Remove unused variable 'setTargetPerson'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":129,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":129,"endColumn":35},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":129,"column":37,"nodeType":"BlockStatement","messageId":"unexpected","endLine":129,"endColumn":40,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[6610,6611],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport { collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, updateDoc, arrayUnion, doc } from 'firebase/firestore';\r\nimport { db } from '../firebase';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function GeneralFeedback() {\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n    const { userData } = useUser();\r\n\r\n    // Tabs: 'write' or 'read'\r\n    const [activeTab, setActiveTab] = useState(location.state?.target ? 'write' : 'read');\r\n    const [targetPerson, setTargetPerson] = useState(location.state?.target || null);\r\n\r\n    // Cooldown State\r\n    const [cooldown, setCooldown] = useState({ active: false, daysLeft: 0, date: null });\r\n\r\n    // Write Form State\r\n    const [ratings, setRatings] = useState({\r\n        behavior: { dropdown: '', stars: 0 },\r\n        communication: { dropdown: '', stars: 0 },\r\n        bodyLanguage: { dropdown: '', stars: 0 },\r\n        hardworking: { dropdown: '', stars: 0 }\r\n    });\r\n    const [comment, setComment] = useState('');\r\n    const [revealName, setRevealName] = useState(false);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Read List State\r\n    const [receivedFeedback, setReceivedFeedback] = useState([]);\r\n\r\n    // Check Cooldown Logic\r\n    useEffect(() => {\r\n        const checkCycle = async () => {\r\n            if (activeTab !== 'write' || !userData || !targetPerson) return;\r\n\r\n            // 1. Student -> Teacher (Existing Rule: 28 Days)\r\n            if (userData.role === 'student' && targetPerson.type === 'Teacher') {\r\n                await runCooldownCheck(28);\r\n            }\r\n            // 2. Teacher -> Student (New Rule: 28 Days Block, 75 Days Due Warning)\r\n            else if (userData.role === 'teacher' && targetPerson.type === 'Student') {\r\n                // ... existing logic ...\r\n                // Normalize class comparison (Same as before)\r\n                const myClass = (userData.assignedClass || '').toString();\r\n                const mySec = (userData.assignedSection || '').toString();\r\n                const tClass = (targetPerson.classAssigned || '').toString();\r\n                const tSec = (targetPerson.section || '').toString();\r\n\r\n                if (myClass === tClass && mySec === tSec) {\r\n                    await runCooldownCheck(28, 75);\r\n                } else {\r\n                    setCooldown({ active: false, daysLeft: 0, date: null });\r\n                }\r\n            }\r\n            // 3. Institution -> Any (28 Days Rule)\r\n            else if (userData.role === 'institution') {\r\n                await runCooldownCheck(28);\r\n            }\r\n        };\r\n\r\n        const runCooldownCheck = async (minDays, maxDaysWarning = 0) => {\r\n            try {\r\n                const q = query(\r\n                    collection(db, \"general_feedback\"),\r\n                    where(\"authorId\", \"==\", userData.uid),\r\n                    where(\"targetId\", \"==\", targetPerson.id || targetPerson.uid)\r\n                );\r\n                const snap = await getDocs(q);\r\n\r\n                if (!snap.empty) {\r\n                    const docs = snap.docs.map(d => d.data());\r\n                    docs.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);\r\n                    const lastFeedback = docs[0];\r\n                    const lastDate = lastFeedback.timestamp.toDate();\r\n                    const now = new Date();\r\n                    const diffDays = Math.floor(Math.abs(now - lastDate) / (1000 * 60 * 60 * 24));\r\n\r\n                    if (diffDays < minDays) {\r\n                        const nextAllowed = new Date(lastDate);\r\n                        nextAllowed.setDate(lastDate.getDate() + minDays);\r\n                        const dateStr = nextAllowed.toLocaleString('en-US', { day: 'numeric', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });\r\n                        setCooldown({ active: true, daysLeft: minDays - diffDays, date: lastDate.toLocaleDateString(), nextDate: dateStr, type: 'block' });\r\n                    } else if (maxDaysWarning > 0 && diffDays > maxDaysWarning) {\r\n                        setCooldown({ active: false, daysLeft: diffDays, date: lastDate.toLocaleDateString(), type: 'warning', max: maxDaysWarning });\r\n                    } else {\r\n                        setCooldown({ active: false, daysLeft: 0, date: null });\r\n                    }\r\n                } else {\r\n                    // Never given feedback\r\n                    if (maxDaysWarning > 0) {\r\n                        // technically overdue if new student? No, treating as fresh.\r\n                        setCooldown({ active: false, daysLeft: 0, date: null, type: 'new' });\r\n                    }\r\n                }\r\n            } catch (e) { console.error(e); }\r\n        };\r\n\r\n        checkCycle();\r\n    }, [activeTab, userData, targetPerson]);\r\n\r\n    // Fetch Received Feedback (Emergency Fuzzy Search)\r\n    useEffect(() => {\r\n        if (activeTab === 'read' && userData?.uid) {\r\n            const fetchFeedback = async () => {\r\n                setLoading(true);\r\n                try {\r\n                    // 1. Calculate My Aliases/IDs\r\n                    const myIds = new Set([userData.uid]);\r\n\r\n                    // Fetch linked allotments to get IDs/Names\r\n                    if (userData.role === 'teacher' || userData.role === 'student') {\r\n                        try {\r\n                            const col = userData.role === 'teacher' ? 'teacher_allotments' : 'student_allotments';\r\n                            // Linked\r\n                            const fieldId = userData.role === 'teacher' ? 'teacherId' : 'studentId';\r\n                            const qAllot = query(collection(db, col), where(fieldId, \"==\", userData.uid));\r\n                            const allotSnap = await getDocs(qAllot);\r\n                            allotSnap.forEach(d => myIds.add(d.id));\r\n\r\n                            // Try to find Name-based allotments too\r\n                            if (userData.name) {\r\n                                const fieldName = userData.role === 'teacher' ? 'teacherName' : 'studentName';\r\n                                const qAllotName = query(collection(db, col), where(fieldName, \"==\", userData.name));\r\n                                const allotSnapName = await getDocs(qAllotName);\r\n                                allotSnapName.forEach(d => myIds.add(d.id));\r\n                            }\r\n                        } catch (e) { }\r\n                    }\r\n\r\n                    // 2. EMERGENCY FETCH: Get last 100 feedbacks globally and filter client-side\r\n                    // This bypasses specific query limitations to find \"Near Matches\"\r\n                    const qGlobal = query(collection(db, \"general_feedback\"), orderBy(\"timestamp\", \"desc\"), limit(100));\r\n                    const snapGlobal = await getDocs(qGlobal);\r\n\r\n                    const filtered = snapGlobal.docs.map(d => ({ id: d.id, ...d.data() })).filter(item => {\r\n                        // Strict ID Check\r\n                        if (myIds.has(item.targetId)) return true;\r\n\r\n                        // Name Check (Loose)\r\n                        if (item.targetName && userData.name) {\r\n                            const tName = item.targetName.toLowerCase().trim();\r\n                            const uName = userData.name.toLowerCase().trim();\r\n                            // Exact\r\n                            if (tName === uName) return true;\r\n                            // Partial\r\n                            if (tName.includes(uName) || uName.includes(tName)) return true;\r\n                            // Token Match\r\n                            const tTokens = tName.split(' ');\r\n                            if (tTokens.some(t => uName.includes(t) && t.length > 3)) return true;\r\n                        }\r\n                        return false;\r\n                    });\r\n\r\n                    setReceivedFeedback(filtered);\r\n                } catch (e) {\r\n                    console.error(\"Error fetching feedback:\", e);\r\n                } finally {\r\n                    setLoading(false);\r\n                }\r\n            };\r\n            fetchFeedback();\r\n        }\r\n    }, [activeTab, userData]);\r\n\r\n    const handleDropdown = (category, val) => {\r\n        setRatings(prev => ({ ...prev, [category]: { ...prev[category], dropdown: val } }));\r\n    };\r\n\r\n    const handleStars = (category, val) => {\r\n        setRatings(prev => ({ ...prev, [category]: { ...prev[category], stars: val } }));\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        if (!targetPerson) return alert(\"No target selected.\");\r\n\r\n        // Validation\r\n        const r = ratings;\r\n        if (!r.behavior.dropdown || !r.behavior.stars ||\r\n            !r.communication.dropdown || !r.communication.stars ||\r\n            !r.bodyLanguage.dropdown || !r.bodyLanguage.stars ||\r\n            !r.hardworking.dropdown || !r.hardworking.stars) {\r\n            return alert(\"Please fill all ratings (Stars & Options).\");\r\n        }\r\n\r\n        // Fix Empty/Spam comments\r\n        const cleanComment = comment.trim();\r\n        if (cleanComment.length > 0 && cleanComment.length < 5) {\r\n            return alert(\"Please provide a more detailed comment (min 5 chars) or leave it empty.\");\r\n        }\r\n        // If they left it strictly empty, maybe that is allowed? \r\n        // The AI report said \"Logging Noise.. content 'No text'\". \r\n        // If the backend logs \"No text\" when empty, that's fine, but user submissions with just \"  \" should be blocked.\r\n        if (cleanComment.length === 0 && comment.length > 0) {\r\n            return alert(\"Comment cannot be just spaces.\");\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            // Generate UPID for Student (or use existing behavior for others)\r\n            let finalPid = userData.pid || 'Anonymous';\r\n            let isAnonymousSubmission = false;\r\n\r\n            // Logic: Higher Authorities ALWAYS reveal name. Students can choose.\r\n            // Requirement: \"submit by a upid... linked to student id... list of previous upids\"\r\n            // This implies we generate a NEW UPID for this submission if it is anonymous/student.\r\n\r\n            if (userData.role === 'student' && !revealName) {\r\n                // Generate a Random 4-char hex string\r\n                const randomPart = Math.floor(Math.random() * 0xFFFF).toString(16).toUpperCase().padStart(4, '0');\r\n                finalPid = `UPID-${randomPart}`;\r\n                isAnonymousSubmission = true;\r\n            } else if (revealName) {\r\n                finalPid = null; // Will show Name\r\n            }\r\n\r\n            // 1. Submit Feedback\r\n            await addDoc(collection(db, \"general_feedback\"), {\r\n                authorId: userData.uid,\r\n                authorPid: finalPid, // Now uses the generated UPID\r\n                authorName: userData.name,\r\n                authorRole: userData.role,\r\n                targetId: targetPerson.id || targetPerson.uid,\r\n                targetName: targetPerson.name,\r\n                targetRole: targetPerson.type || 'User',\r\n                behavior: r.behavior,\r\n                communication: r.communication,\r\n                bodyLanguage: r.bodyLanguage,\r\n                hardworking: r.hardworking,\r\n                comment,\r\n                timestamp: serverTimestamp()\r\n            });\r\n\r\n            // 2. If it was a Generated UPID, save to Student History\r\n            if (isAnonymousSubmission && userData.role === 'student') {\r\n                try {\r\n                    const userRef = doc(db, \"users\", userData.uid);\r\n                    await updateDoc(userRef, {\r\n                        upidHistory: arrayUnion({\r\n                            upid: finalPid,\r\n                            target: targetPerson.name,\r\n                            date: new Date() // Client timestamp for history display\r\n                        })\r\n                    });\r\n                } catch (histErr) {\r\n                    console.error(\"Failed to update UPID history\", histErr);\r\n                }\r\n            }\r\n\r\n            alert(\"Feedback Submitted Successfully!\" + (isAnonymousSubmission ? `\\nYour Private ID: ${finalPid}` : \"\"));\r\n            navigate(-1);\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error submitting feedback.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const categories = [\r\n        { key: 'behavior', label: 'Behavior', icon: '≡ƒñ¥' },\r\n        { key: 'communication', label: 'Communication', icon: '≡ƒùú∩╕Å' },\r\n        { key: 'bodyLanguage', label: 'Body Language', icon: '≡ƒò║' },\r\n        { key: 'hardworking', label: 'Hard Working', icon: '≡ƒÜÇ' }\r\n    ];\r\n\r\n    return (\r\n        <div style={{\r\n            minHeight: '100vh',\r\n            background: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',\r\n            padding: '40px 20px',\r\n            fontFamily: \"'Inter', sans-serif\"\r\n        }}>\r\n            <div style={{ display: 'flex', justifyContent: 'flex-start', marginBottom: '20px' }}>\r\n                <button\r\n                    onClick={() => navigate(-1)}\r\n                    className=\"btn-back-marker\"\r\n                >\r\n                    Back\r\n                </button>\r\n            </div>\r\n\r\n            <div style={{\r\n                maxWidth: '650px',\r\n                margin: '0 auto',\r\n                background: 'rgba(255, 255, 255, 0.95)',\r\n                borderRadius: '24px',\r\n                padding: '40px',\r\n                boxShadow: '0 20px 40px rgba(0,0,0,0.1)',\r\n                position: 'relative',\r\n                overflow: 'hidden'\r\n            }}>\r\n                {/* Decorative background blob */}\r\n                <div style={{\r\n                    position: 'absolute', top: '-50px', right: '-50px',\r\n                    width: '150px', height: '150px', background: '#4facfe',\r\n                    borderRadius: '50%', filter: 'blur(60px)', opacity: '0.4'\r\n                }}></div>\r\n\r\n                {/* Tabs */}\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '30px', background: '#f0f2f5', padding: '5px', borderRadius: '12px', flexWrap: 'wrap' }}>\r\n                    <button\r\n                        onClick={() => setActiveTab('read')}\r\n                        style={{\r\n                            flex: 1, padding: '12px', borderRadius: '10px', border: 'none',\r\n                            background: activeTab === 'read' ? 'white' : 'transparent',\r\n                            boxShadow: activeTab === 'read' ? '0 2px 5px rgba(0,0,0,0.1)' : 'none',\r\n                            fontWeight: 'bold', cursor: 'pointer', color: activeTab === 'read' ? '#0984e3' : '#636e72',\r\n                            minWidth: '150px'\r\n                        }}\r\n                    >\r\n                        ≡ƒô⌐ Received Feedback\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('write')}\r\n                        style={{\r\n                            flex: 1, padding: '12px', borderRadius: '10px', border: 'none',\r\n                            background: activeTab === 'write' ? 'white' : 'transparent',\r\n                            boxShadow: activeTab === 'write' ? '0 2px 5px rgba(0,0,0,0.1)' : 'none',\r\n                            fontWeight: 'bold', cursor: 'pointer', color: activeTab === 'write' ? '#0984e3' : '#636e72',\r\n                            minWidth: '150px'\r\n                        }}\r\n                    >\r\n                        ≡ƒô¥ Give Feedback\r\n                    </button>\r\n                    <button\r\n                        onClick={() => navigate('/report-misbehavior', { state: { target: targetPerson } })}\r\n                        style={{\r\n                            flex: 1, padding: '12px', borderRadius: '10px', border: 'none',\r\n                            background: '#1ef031',\r\n                            boxShadow: '0 2px 5px rgba(0,0,0,0.1)',\r\n                            fontWeight: 'bold', cursor: 'pointer', color: 'white',\r\n                            minWidth: '150px'\r\n                        }}\r\n                    >\r\n                        ΓÜá∩╕Å Misbehavior\r\n                    </button>\r\n                    <button\r\n                        onClick={() => navigate('/report-harassment', { state: { target: targetPerson } })}\r\n                        style={{\r\n                            flex: 1, padding: '12px', borderRadius: '10px', border: 'none',\r\n                            background: '#d63031',\r\n                            boxShadow: '0 2px 5px rgba(0,0,0,0.1)',\r\n                            fontWeight: 'bold', cursor: 'pointer', color: 'white',\r\n                            minWidth: '150px'\r\n                        }}\r\n                    >\r\n                        ≡ƒÜ¿ Sexual Harassment\r\n                    </button>\r\n                </div>\r\n\r\n                {activeTab === 'write' ? (\r\n                    targetPerson ? (\r\n                        <>\r\n                            <div className=\"text-center\" style={{ marginBottom: '40px', position: 'relative' }}>\r\n                                <div style={{ fontSize: '60px', marginBottom: '10px' }}>≡ƒîƒ</div>\r\n                                <h2 style={{\r\n                                    background: targetPerson.type === 'Institution' ? 'none' : 'linear-gradient(to right, #00f2fe, #4facfe)',\r\n                                    color: targetPerson.type === 'Institution' ? '#d63031' : 'inherit',\r\n                                    WebkitBackgroundClip: targetPerson.type === 'Institution' ? 'unset' : 'text',\r\n                                    WebkitTextFillColor: targetPerson.type === 'Institution' ? 'unset' : 'transparent',\r\n                                    margin: '0', fontSize: '28px', fontWeight: '800'\r\n                                }}>\r\n                                    Feedback for {targetPerson.name}\r\n                                </h2>\r\n                                <p style={{ color: '#888', marginTop: '5px' }}>Help us improve by rating honestly</p>\r\n                            </div>\r\n\r\n                            {/* Cooldown / Status Block */}\r\n                            {cooldown.active && cooldown.type === 'block' ? (\r\n                                <div className=\"card text-center\" style={{ padding: '40px', background: '#fff0f0', border: '1px solid #fab1a0' }}>\r\n                                    <div style={{ fontSize: '40px', marginBottom: '20px' }}>ΓÅ│</div>\r\n                                    <h3 style={{ color: '#d63031' }}>Feedback Cycle Active</h3>\r\n                                    <p style={{ color: '#636e72', marginBottom: '20px' }}>\r\n                                        You can submit your next feedback on:<br />\r\n                                        <strong style={{ fontSize: '1.2rem', color: '#2d3436' }}>{cooldown.nextDate}</strong>\r\n                                    </p>\r\n                                    <button className=\"btn\" onClick={() => navigate(-1)}>Go Back</button>\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    {cooldown.type === 'warning' && (\r\n                                        <div style={{ background: '#ffeaa7', padding: '15px', borderRadius: '10px', marginBottom: '20px', border: '1px solid #fdcb6e', color: '#d63031', display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                            <span style={{ fontSize: '24px' }}>ΓÜá∩╕Å</span>\r\n                                            <div>\r\n                                                <strong>Feedback Overdue!</strong>\r\n                                                <div style={{ fontSize: '13px' }}>It has been {cooldown.daysLeft} days since your last feedback. Policy requires feedback every 75 days.</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n                                    <div style={{ display: 'grid', gap: '25px' }}>\r\n                                        {categories.map(cat => (\r\n                                            <div key={cat.key} style={{\r\n                                                background: '#f8f9fa', padding: '20px', borderRadius: '16px',\r\n                                                border: '1px solid #cbd5e0', transition: 'transform 0.2s',\r\n                                                display: 'flex', flexDirection: 'column', gap: '15px',\r\n                                                boxShadow: '0 2px 5px rgba(0,0,0,0.05)'\r\n                                            }}>\r\n                                                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                                                    <div style={{\r\n                                                        fontSize: '30px', background: 'white', width: '60px', height: '60px',\r\n                                                        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                                                        borderRadius: '50%', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', border: '1px solid #e2e8f0'\r\n                                                    }}>\r\n                                                        {cat.icon}\r\n                                                    </div>\r\n                                                    <div>\r\n                                                        <label style={{ fontSize: '18px', fontWeight: '700', color: '#2d3748' }}>{cat.label}</label>\r\n                                                        <div style={{ fontSize: '12px', color: '#718096' }}>Rate their {cat.label.toLowerCase()}</div>\r\n                                                    </div>\r\n                                                </div>\r\n\r\n                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px' }}>\r\n                                                    <select\r\n                                                        style={{\r\n                                                            padding: '10px 15px', borderRadius: '12px', border: '1px solid #a0aec0',\r\n                                                            background: 'white', color: '#2d3748', fontWeight: '500', outline: 'none',\r\n                                                            minWidth: '140px', cursor: 'pointer'\r\n                                                        }}\r\n                                                        value={ratings[cat.key].dropdown}\r\n                                                        onChange={(e) => handleDropdown(cat.key, e.target.value)}\r\n                                                    >\r\n                                                        <option value=\"\" disabled>Select Rating...</option>\r\n                                                        <option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option>\r\n                                                    </select>\r\n\r\n                                                    <div style={{ display: 'flex', gap: '8px' }}>\r\n                                                        {[1, 2, 3, 4, 5].map(s => (\r\n                                                            <span\r\n                                                                key={s}\r\n                                                                style={{\r\n                                                                    fontSize: '28px', cursor: 'pointer',\r\n                                                                    color: s <= ratings[cat.key].stars ? '#fbbf24' : '#e2e8f0',\r\n                                                                    transition: 'all 0.2s', transform: s <= ratings[cat.key].stars ? 'scale(1.1)' : 'scale(1)'\r\n                                                                }}\r\n                                                                onClick={() => handleStars(cat.key, s)}\r\n                                                            >Γÿà</span>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n\r\n                                    <div style={{ marginTop: '30px' }}>\r\n                                        <label style={{ fontWeight: '700', color: '#2d3748', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                            <span>≡ƒô¥</span> Additional Comments\r\n                                        </label>\r\n                                        <textarea\r\n                                            className=\"input-field\"\r\n                                            value={comment}\r\n                                            onChange={(e) => setComment(e.target.value)}\r\n                                            placeholder=\"Share any specific details or suggestions...\"\r\n                                            style={{\r\n                                                height: '100px', resize: 'vertical', borderRadius: '16px',\r\n                                                border: '2px solid #edf2f7', padding: '15px', background: '#f8f9fa'\r\n                                            }}\r\n                                        />\r\n                                    </div>\r\n\r\n                                    {/* Reveal Name Option */}\r\n                                    {(userData.role === 'institution' || (userData.role === 'teacher' && targetPerson.type === 'Student')) ? (\r\n                                        <div style={{ marginTop: '15px', color: '#636e72', fontSize: '14px', display: 'flex', alignItems: 'center', gap: '5px' }}>\r\n                                            <span>≡ƒöÆ</span>\r\n                                            Feedback will be sent as <strong>{userData.name}</strong> (Official)\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div style={{ marginTop: '15px', display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                            <input\r\n                                                type=\"checkbox\"\r\n                                                id=\"revealName\"\r\n                                                checked={revealName}\r\n                                                onChange={(e) => setRevealName(e.target.checked)}\r\n                                                style={{ width: '18px', height: '18px', cursor: 'pointer' }}\r\n                                            />\r\n                                            <label htmlFor=\"revealName\" style={{ cursor: 'pointer', fontSize: '14px', color: '#2d3436' }}>\r\n                                                Show my Name (Uncheck for Anonymous ID)\r\n                                            </label>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <button\r\n                                        onClick={handleSubmit}\r\n                                        disabled={loading}\r\n                                        style={{\r\n                                            width: '100%', padding: '18px', marginTop: '20px',\r\n                                            background: 'linear-gradient(to right, #00c6fb, #005bea)',\r\n                                            color: 'white', border: 'none', borderRadius: '16px',\r\n                                            fontSize: '18px', fontWeight: 'bold', cursor: 'pointer',\r\n                                            boxShadow: '0 10px 20px rgba(0, 91, 234, 0.3)',\r\n                                            transition: 'transform 0.2s, box-shadow 0.2s'\r\n                                        }}\r\n                                        onMouseOver={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 15px 30px rgba(0, 91, 234, 0.4)'; }}\r\n                                        onMouseOut={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 10px 20px rgba(0, 91, 234, 0.3)'; }}\r\n                                    >\r\n                                        {loading ? '≡ƒÜÇ Sending Feedback...' : '≡ƒÜÇ Submit Feedback'}\r\n                                    </button>\r\n                                </>\r\n                            )}\r\n                        </>\r\n                    ) : (\r\n                        <div style={{ textAlign: 'center', padding: '40px 0' }}>\r\n                            <p style={{ color: '#666', marginBottom: '20px' }}>Select a person to give feedback to.</p>\r\n                            <button\r\n                                className=\"btn\"\r\n                                onClick={() => navigate('/select-feedback-target')}\r\n                                style={{ background: '#0984e3', color: 'white' }}\r\n                            >\r\n                                ≡ƒöì Find Person\r\n                            </button>\r\n                        </div>\r\n                    )\r\n                ) : (\r\n                    // READ MODE\r\n                    <div style={{ display: 'grid', gap: '15px' }}>\r\n                        {receivedFeedback.length === 0 ? (\r\n                            <div style={{ textAlign: 'center', padding: '30px', color: '#888' }}>\r\n                                No feedback received yet. ≡ƒô¡\r\n                            </div>\r\n                        ) : (\r\n                            receivedFeedback.map(f => (\r\n                                <div key={f.id} style={{\r\n                                    background: 'white', padding: '20px', borderRadius: '16px',\r\n                                    border: '1px solid #e1e8ed', boxShadow: '0 2px 10px rgba(0,0,0,0.05)'\r\n                                }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                        <div style={{ fontWeight: 'bold', color: '#2d3436' }}>\r\n                                            From: {f.authorPid || f.authorName} ({f.authorRole})\r\n                                        </div>\r\n                                        <div style={{ fontSize: '12px', color: '#b2bec3' }}>\r\n                                            {f.timestamp?.toDate().toLocaleDateString()}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>\r\n                                        {Object.keys(f).filter(k => ['behavior', 'communication', 'bodyLanguage', 'hardworking'].includes(k)).map(k => (\r\n                                            <div key={k} style={{ background: '#f8f9fa', padding: '10px', borderRadius: '8px', fontSize: '13px' }}>\r\n                                                <strong>{k.charAt(0).toUpperCase() + k.slice(1)}:</strong> {f[k].stars}Γÿà ({f[k].dropdown})\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                    {f.comment && (\r\n                                        <div style={{ marginTop: '15px', background: '#ffeaa7', padding: '10px', borderRadius: '8px', fontSize: '14px', color: '#d63031' }}>\r\n                                            ≡ƒÆ¼ \"{f.comment}\"\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            ))\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\GovernmentReports.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Group.jsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`startSelectionFlow` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  39 |\n  40 |         if (!gid) {\n> 41 |             startSelectionFlow();\n     |             ^^^^^^^^^^^^^^^^^^ `startSelectionFlow` accessed before it is declared\n  42 |             return;\n  43 |         }\n  44 |\n\n  48 |     }, [navigate, userData]);\n  49 |\n> 50 |     const startSelectionFlow = () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 51 |         setIsSelecting(true);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 52 |         if (userData?.role === 'teacher') {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 53 |             fetchTeacherClasses();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 54 |         } else {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 55 |             fetchGroupsForSelection();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 56 |         }\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 57 |     };\n     | ^^^^^^^ `startSelectionFlow` is declared here\n  58 |\n  59 |     const fetchTeacherClasses = async () => {\n  60 |         if (!userData?.uid) return;","line":41,"column":13,"nodeType":null,"endLine":41,"endColumn":31},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadGroupChat` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  44 |\n  45 |         setGroupId(gid);\n> 46 |         const unsubscribe = loadGroupChat(gid);\n     |                             ^^^^^^^^^^^^^ `loadGroupChat` accessed before it is declared\n  47 |         return () => { if (unsubscribe) unsubscribe(); };\n  48 |     }, [navigate, userData]);\n  49 |\n\n  261 |     };\n  262 |\n> 263 |     const loadGroupChat = (gid) => {\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 264 |         if (!gid) return;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 265 |\n      ΓÇª\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 394 |         return unsubscribe;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 395 |     };\n      | ^^^^^^^ `loadGroupChat` is declared here\n  396 |\n  397 |     const scrollToBottom = () => {\n  398 |         messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });","line":46,"column":29,"nodeType":null,"endLine":46,"endColumn":42},{"ruleId":"no-unused-vars","severity":1,"message":"'idField' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":121,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":121,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"idField"},"fix":{"range":[4913,4970],"text":""},"desc":"Remove unused variable 'idField'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'unsubscribeMsg' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":268,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":268,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"unsubscribeMsg"},"fix":{"range":[11683,11711],"text":""},"desc":"Remove unused variable 'unsubscribeMsg'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, doc, getDoc, getDocs } from 'firebase/firestore';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function Group() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n    const [messages, setMessages] = useState([]);\r\n    const [newMessage, setNewMessage] = useState('');\r\n    const [groupId, setGroupId] = useState(null);\r\n    const [groupData, setGroupData] = useState(null); // Store full group object\r\n    const [file, setFile] = useState(null);\r\n    const messagesEndRef = useRef(null);\r\n    const fileInputRef = useRef(null);\r\n\r\n    // Institution/Teacher Mode\r\n    const [isSelecting, setIsSelecting] = useState(false);\r\n    const [groupList, setGroupList] = useState([]);\r\n    const [loadingGroups, setLoadingGroups] = useState(false);\r\n\r\n    // Teacher Specific State\r\n    const [teacherClasses, setTeacherClasses] = useState([]);\r\n    const [selectedClassScope, setSelectedClassScope] = useState(null); // { className, section }\r\n\r\n    // UI States\r\n    const [showMenu, setShowMenu] = useState(false);\r\n    const [showAttachMenu, setShowAttachMenu] = useState(false);\r\n    const [viewMode, setViewMode] = useState(null); // 'members', 'photos', 'files', 'docs'\r\n    const [members, setMembers] = useState([]);\r\n\r\n    useEffect(() => {\r\n        const gid = localStorage.getItem(\"activeGroupId\");\r\n\r\n        // RESET NAVIGATION ON MOUNT\r\n        // If we are a teacher, we might want to start fresh or restore state?\r\n        // For now, if no GID, go to selection.\r\n\r\n        if (!gid) {\r\n            startSelectionFlow();\r\n            return;\r\n        }\r\n\r\n        setGroupId(gid);\r\n        const unsubscribe = loadGroupChat(gid);\r\n        return () => { if (unsubscribe) unsubscribe(); };\r\n    }, [navigate, userData]);\r\n\r\n    const startSelectionFlow = () => {\r\n        setIsSelecting(true);\r\n        if (userData?.role === 'teacher') {\r\n            fetchTeacherClasses();\r\n        } else {\r\n            fetchGroupsForSelection();\r\n        }\r\n    };\r\n\r\n    const fetchTeacherClasses = async () => {\r\n        if (!userData?.uid) return;\r\n        try {\r\n            // Fetch allotments for this teacher (Try userId first, then teacherId)\r\n            let q = query(collection(db, \"teacher_allotments\"), where(\"userId\", \"==\", userData.uid));\r\n            let snap = await getDocs(q);\r\n\r\n            if (snap.empty) {\r\n                // Fallback for legacy data\r\n                q = query(collection(db, \"teacher_allotments\"), where(\"teacherId\", \"==\", userData.uid));\r\n                snap = await getDocs(q);\r\n            }\r\n\r\n            const classes = [];\r\n            const seen = new Set();\r\n\r\n            snap.forEach(d => {\r\n                // Use userData from context instead of getAuth() directly for consistency\r\n                const uid = userData?.uid;\r\n                if (!uid) { alert(\"User not identified\"); return; }\r\n                const data = d.data();\r\n                if (data.classAssigned && data.section) {\r\n                    const key = `${data.classAssigned}-${data.section}`;\r\n                    if (!seen.has(key)) {\r\n                        seen.add(key);\r\n                        // Store createdBy as institutionId\r\n                        classes.push({\r\n                            className: data.classAssigned,\r\n                            section: data.section,\r\n                            institutionId: data.createdBy // Critical for scope\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n            // Sort\r\n            classes.sort((a, b) => a.className.localeCompare(b.className));\r\n            setTeacherClasses(classes);\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const fetchGroupsForSelection = async (scope = null) => {\r\n        if (!userData) return;\r\n        setGroupList([]);\r\n        setLoadingGroups(true);\r\n\r\n        try {\r\n\r\n            const role = userData.role;\r\n\r\n            // --- ROBUST ID RESOLUTION ---\r\n            let instId = (scope?.institutionId) || userData.institutionId || userData.createdBy;\r\n\r\n            // PRIORITY: If I am the institution, MY ID is the key\r\n            if (role === 'institution') instId = userData.uid;\r\n\r\n            // Fallback: If ID is missing, try to find it from Allotments (Data Repair/Safety)\r\n            if (!instId && (role === 'student' || role === 'teacher')) {\r\n                console.log(\"ΓÜá∩╕Å ID missing in profile. Attempting to resolve from allotments...\");\r\n                try {\r\n                    const collectionName = role === 'student' ? 'student_allotments' : 'teacher_allotments'; // teacher_allotments\r\n                    const idField = role === 'student' ? 'userId' : 'userId'; // Both use userId now usually, or fallback to teacherId\r\n\r\n                    let q = query(collection(db, collectionName), where(\"userId\", \"==\", userData.uid));\r\n                    let snap = await getDocs(q);\r\n\r\n                    if (snap.empty && role === 'teacher') {\r\n                        // Legacy Teacher Fallback\r\n                        q = query(collection(db, collectionName), where(\"teacherId\", \"==\", userData.uid));\r\n                        snap = await getDocs(q);\r\n                    }\r\n\r\n                    if (!snap.empty) {\r\n                        const allotData = snap.docs[0].data();\r\n                        instId = allotData.institutionId || allotData.createdBy;\r\n                        console.log(\"Γ£à Resolved Institution ID from allotment:\", instId);\r\n                    }\r\n                } catch (err) {\r\n                    console.warn(\"Failed to resolve ID from allotments\", err);\r\n                }\r\n            }\r\n\r\n            if (role === 'institution') instId = userData.uid;\r\n\r\n            if (!instId) {\r\n                console.warn(\"Could not find a valid Institution ID for selection.\");\r\n                setLoadingGroups(false);\r\n                return;\r\n            }\r\n\r\n            console.log(`≡ƒöì Group Fetch [Role: ${role}] [InstId: ${instId}] [Scope: ${scope?.className}]`);\r\n\r\n            // UNIFIED STRATEGY\r\n            const q1 = query(collection(db, \"groups\"), where(\"institutionId\", \"==\", instId));\r\n            const q2 = query(collection(db, \"groups\"), where(\"createdBy\", \"==\", instId));\r\n\r\n            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);\r\n            const mergedMap = new Map();\r\n            snap1.forEach(d => mergedMap.set(d.id, { id: d.id, ...d.data() }));\r\n            snap2.forEach(d => mergedMap.set(d.id, { id: d.id, ...d.data() }));\r\n            let rawGroups = Array.from(mergedMap.values());\r\n\r\n            console.log(`≡ƒôª Found ${rawGroups.length} total groups for institution.`);\r\n\r\n            const list = [];\r\n\r\n            // Normalize helper\r\n            const normalize = (s) => (s || '').toString().toLowerCase().replace(/[^a-z0-9]/g, '');\r\n\r\n            if (role === 'institution') {\r\n                rawGroups.forEach(g => list.push(g));\r\n            }\r\n            else if (role === 'teacher') {\r\n                const targetScope = scope || selectedClassScope;\r\n                if (!targetScope) { setLoadingGroups(false); return; }\r\n\r\n                const tCls = normalize(targetScope.className || targetScope.class);\r\n                const tSec = (targetScope.section || 'All').toString().toUpperCase();\r\n\r\n                // Fetch teacher's subjects from teacher_allotments\r\n                let teacherSubjects = [];\r\n                try {\r\n                    const allotQuery = query(\r\n                        collection(db, 'teacher_allotments'),\r\n                        where('userId', '==', userData.uid)\r\n                    );\r\n                    const allotSnap = await getDocs(allotQuery);\r\n\r\n                    if (allotSnap.empty) {\r\n                        // Legacy fallback\r\n                        const legacyQuery = query(\r\n                            collection(db, 'teacher_allotments'),\r\n                            where('teacherId', '==', userData.uid)\r\n                        );\r\n                        const legacySnap = await getDocs(legacyQuery);\r\n                        legacySnap.forEach(doc => {\r\n                            const subject = doc.data().subject || doc.data().subjectName;\r\n                            if (subject) teacherSubjects.push(normalize(subject));\r\n                        });\r\n                    } else {\r\n                        allotSnap.forEach(doc => {\r\n                            const subject = doc.data().subject || doc.data().subjectName;\r\n                            if (subject) teacherSubjects.push(normalize(subject));\r\n                        });\r\n                    }\r\n                } catch (err) {\r\n                    console.warn('Failed to fetch teacher subjects:', err);\r\n                }\r\n\r\n                console.log(`≡ƒæ¿ΓÇì≡ƒÅ½ Teacher subjects:`, teacherSubjects);\r\n\r\n                rawGroups.forEach(data => {\r\n                    const gCls = normalize(data.className);\r\n                    const gSec = (data.section || 'All').toString().toUpperCase();\r\n                    const gSubject = normalize(data.subject || data.groupName);\r\n\r\n                    // Class and Section matching\r\n                    const classMatches = gCls.includes(tCls) || tCls.includes(gCls);\r\n                    const sectionMatches = (gSec === 'ALL' || gSec === tSec);\r\n\r\n                    // Subject matching - teacher can only see groups for their subjects\r\n                    const subjectMatches = teacherSubjects.length === 0 ||\r\n                        teacherSubjects.some(ts => gSubject.includes(ts) || ts.includes(gSubject));\r\n\r\n                    if (classMatches && sectionMatches && subjectMatches) {\r\n                        list.push(data);\r\n                    }\r\n                });\r\n            }\r\n            else if (role === 'student') {\r\n                const uClsRaw = userData.class || userData.assignedClass;\r\n                const uCls = normalize(uClsRaw);\r\n                const uSec = (userData.section || userData.assignedSection || 'All').toString().toUpperCase();\r\n\r\n                if (!uCls) {\r\n                    console.warn(\"Student has no class assigned.\");\r\n                }\r\n\r\n                rawGroups.forEach(data => {\r\n                    const gCls = normalize(data.className);\r\n                    const gSec = (data.section || 'All').toString().toUpperCase();\r\n\r\n                    // Robust Matching: Check if one string contains the other (e.g. \"10\" matches \"10th\", \"Class 10\")\r\n                    const classMatches = (uCls && (gCls.includes(uCls) || uCls.includes(gCls)));\r\n\r\n                    // Section Logic: \r\n                    // 1. Group is for 'ALL' sections -> Match\r\n                    // 2. Student is 'ALL' (rare) -> Match\r\n                    // 3. Exact Match\r\n                    const sectionMatches = (gSec === 'ALL' || gSec === uSec || uSec === 'ALL');\r\n\r\n                    if (classMatches && sectionMatches) list.push(data);\r\n                });\r\n            }\r\n\r\n            setGroupList(list);\r\n            setLoadingGroups(false);\r\n        } catch (e) {\r\n            console.error(\"Error loading groups:\", e);\r\n            setLoadingGroups(false);\r\n        }\r\n    };\r\n\r\n    const loadGroupChat = (gid) => {\r\n        if (!gid) return;\r\n\r\n        // Fetch group data\r\n        const groupRef = doc(db, \"groups\", gid);\r\n        const unsubscribeMsg = null; // Placeholder if we need to unsubscribe from doc? No, just messages.\r\n\r\n        getDoc(groupRef).then(async (docSnap) => {\r\n            if (docSnap.exists()) {\r\n                const gData = { id: docSnap.id, ...docSnap.data() };\r\n                setGroupData(gData);\r\n\r\n                // FETCH MEMBERS DYNAMICALLY (Based on Class/Section)\r\n                if (gData.className && (gData.institutionId || gData.createdBy)) {\r\n                    const memberList = [];\r\n                    const instId = gData.institutionId || gData.createdBy;\r\n\r\n                    try {\r\n                        const targetCls = gData.className;\r\n                        const targetSec = (gData.section || 'All').toString().toUpperCase();\r\n\r\n                        // 1. Fetch Students (Query by Institution + Class)\r\n                        // Then filter section in memory for better flexibility\r\n                        const qS1 = query(collection(db, \"student_allotments\"),\r\n                            where(\"institutionId\", \"==\", instId),\r\n                            where(\"classAssigned\", \"==\", targetCls));\r\n                        const qS2 = query(collection(db, \"student_allotments\"),\r\n                            where(\"createdBy\", \"==\", instId),\r\n                            where(\"classAssigned\", \"==\", targetCls));\r\n\r\n                        const [snapS1, snapS2] = await Promise.all([getDocs(qS1), getDocs(qS2)]);\r\n                        const mergedSnapsS = [...snapS1.docs, ...snapS2.docs];\r\n\r\n                        mergedSnapsS.forEach(d => {\r\n                            const md = d.data();\r\n                            const mSec = (md.section || 'A').toString().toUpperCase();\r\n\r\n                            // Match section if not 'All'\r\n                            if (targetSec === 'ALL' || mSec === targetSec) {\r\n                                memberList.push({\r\n                                    id: md.userId || md.studentId || d.id,\r\n                                    userId: md.userId || md.studentId, // Explicit ID for Profile\r\n                                    studentId: md.studentId, // Explicit ID for Profile\r\n                                    name: md.name || md.studentName,\r\n                                    type: 'Student',\r\n                                    role: 'student',\r\n                                    rollNumber: md.rollNumber || 'N/A'\r\n                                });\r\n                            }\r\n                        });\r\n\r\n                        // 2. Fetch Teachers - ONLY for this group's subject\r\n                        const groupSubject = gData.subject || gData.groupName;\r\n                        const normalizeSubject = (s) => (s || '').toString().toLowerCase().replace(/[^a-z0-9]/g, '');\r\n                        const normalizedGroupSubject = normalizeSubject(groupSubject);\r\n\r\n                        const qT1 = query(collection(db, \"teacher_allotments\"),\r\n                            where(\"institutionId\", \"==\", instId),\r\n                            where(\"classAssigned\", \"==\", targetCls));\r\n                        const qT2 = query(collection(db, \"teacher_allotments\"),\r\n                            where(\"createdBy\", \"==\", instId),\r\n                            where(\"classAssigned\", \"==\", targetCls));\r\n\r\n                        const [snapT1, snapT2] = await Promise.all([getDocs(qT1), getDocs(qT2)]);\r\n                        const mergedSnapsT = [...snapT1.docs, ...snapT2.docs];\r\n\r\n                        mergedSnapsT.forEach(d => {\r\n                            const md = d.data();\r\n                            const mSec = (md.section || 'A').toString().toUpperCase();\r\n                            const teacherSubject = normalizeSubject(md.subject || md.subjectName || '');\r\n\r\n                            // Only add teacher if:\r\n                            // 1. Section matches\r\n                            // 2. Subject matches the group's subject\r\n                            const sectionMatches = (targetSec === 'ALL' || mSec === targetSec);\r\n                            const subjectMatches = !normalizedGroupSubject ||\r\n                                teacherSubject.includes(normalizedGroupSubject) ||\r\n                                normalizedGroupSubject.includes(teacherSubject);\r\n\r\n                            if (sectionMatches && subjectMatches) {\r\n                                memberList.push({\r\n                                    id: md.userId || md.teacherId || d.id,\r\n                                    userId: md.userId || md.teacherId,\r\n                                    teacherId: md.teacherId,\r\n                                    name: md.name || md.teacherName,\r\n                                    type: 'Teacher',\r\n                                    role: 'teacher',\r\n                                    subject: md.subject || 'Class Teacher'\r\n                                });\r\n                            }\r\n                        });\r\n\r\n                        // Deduplicate (Using ID as key)\r\n                        const uniqueMap = new Map();\r\n                        memberList.forEach(m => {\r\n                            if (m.id) uniqueMap.set(m.id, m);\r\n                        });\r\n\r\n                        setMembers(Array.from(uniqueMap.values()));\r\n                    } catch (err) {\r\n                        console.error(\"Error fetching group members:\", err);\r\n                        setMembers([]);\r\n                    }\r\n                } else {\r\n                    setMembers([]);\r\n                }\r\n\r\n            } else {\r\n                console.log(\"No such group!\");\r\n                setGroupData(null);\r\n                localStorage.removeItem(\"activeGroupId\");\r\n                setIsSelecting(true);\r\n            }\r\n        }).catch(e => console.error(\"Error fetching group data:\", e));\r\n\r\n        // Listen for messages\r\n        const messagesQuery = query(\r\n            collection(db, \"groups\", gid, \"messages\"),\r\n            orderBy(\"createdAt\", \"asc\")\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {\r\n            const msgs = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }));\r\n            setMessages(msgs);\r\n        }, (error) => {\r\n            console.error(\"Error fetching messages:\", error);\r\n        });\r\n\r\n        return unsubscribe;\r\n    };\r\n\r\n    const scrollToBottom = () => {\r\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n    };\r\n\r\n    useEffect(() => {\r\n        scrollToBottom();\r\n    }, [messages]);\r\n\r\n    const handleFileSelect = (e) => {\r\n        if (e.target.files[0]) {\r\n            const f = e.target.files[0];\r\n            if (f.size > 500000) return alert(\"File too big! Max 500KB.\");\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => setFile(reader.result);\r\n            reader.readAsDataURL(f);\r\n        }\r\n    };\r\n\r\n    const handleSend = async (e) => {\r\n        e.preventDefault();\r\n        if ((newMessage.trim() === '' && !file) || !groupId) return;\r\n\r\n        const payload = {\r\n            text: newMessage,\r\n            image: file || null,\r\n            createdAt: serverTimestamp(),\r\n            uid: userData?.uid || 'anon',\r\n            displayName: userData?.name || 'Anonymous',\r\n            role: userData?.role || 'student',\r\n            photoURL: userData?.profileImageURL || null\r\n        };\r\n\r\n        await addDoc(collection(db, \"groups\", groupId, \"messages\"), payload);\r\n        setNewMessage('');\r\n        setFile(null);\r\n    };\r\n\r\n    const selectGroup = (gid) => {\r\n        localStorage.setItem(\"activeGroupId\", gid);\r\n        setGroupId(gid);\r\n        setIsSelecting(false);\r\n        loadGroupChat(gid);\r\n    }\r\n\r\n    // --- RENDER GROUP SELECTION LIST ---\r\n    if (isSelecting) {\r\n        // SCENARIO 1: TEACHER SELECTING CLASS\r\n        if (userData?.role === 'teacher' && !selectedClassScope) {\r\n            return (\r\n                <div className=\"page-wrapper\">\r\n                    <header style={{ background: '#0984e3', color: 'white', padding: '15px', display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                        <button onClick={() => navigate(-1)} className=\"btn-back-marker\">Back</button>\r\n                        <h2 style={{ margin: 0, fontSize: '18px' }}>Select Class</h2>\r\n                    </header>\r\n                    <div className=\"container\" style={{ marginTop: '20px' }}>\r\n                        <p style={{ padding: '0 15px', color: '#666' }}>Select a class to view its groups.</p>\r\n                        {teacherClasses.length === 0 ? (\r\n                            <p className=\"text-center text-muted\">No classes allotted yet.</p>\r\n                        ) : (\r\n                            <div style={{ display: 'grid', gap: '15px' }}>\r\n                                {teacherClasses.map((c, idx) => (\r\n                                    <div key={idx}\r\n                                        onClick={() => {\r\n                                            setSelectedClassScope(c);\r\n                                            fetchGroupsForSelection(c);\r\n                                        }}\r\n                                        className=\"card\"\r\n                                        style={{ cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px' }}>\r\n                                        <div>\r\n                                            <h4 style={{ margin: 0, fontSize: '18px' }}>Class {c.className} - {c.section}</h4>\r\n                                        </div>\r\n                                        <span style={{ fontSize: '24px' }}>Γ₧í∩╕Å</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        // SCENARIO 2: SELECTING GROUP (Student, Institution, or Teacher after Class Select)\r\n        return (\r\n            <div className=\"page-wrapper\">\r\n                <header style={{ background: '#0984e3', color: 'white', padding: '15px', display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                    <button onClick={() => {\r\n                        if (userData?.role === 'teacher' && selectedClassScope) {\r\n                            setSelectedClassScope(null); // Go back to Class Select\r\n                        } else {\r\n                            navigate(-1);\r\n                        }\r\n                    }} className=\"btn-back-marker\">Back</button>\r\n                    <h2 style={{ margin: 0, fontSize: '18px' }}>\r\n                        {selectedClassScope ? `Groups for ${selectedClassScope.className}-${selectedClassScope.section}` : 'Select Group'}\r\n                    </h2>\r\n                </header>\r\n                <div className=\"container\" style={{ marginTop: '20px' }}>\r\n                    {loadingGroups ? (\r\n                        <div className=\"text-center\" style={{ padding: '40px' }}>\r\n                            <div className=\"spinner\" style={{ margin: '0 auto 15px' }}></div>\r\n                            <p className=\"text-muted\">Searching for your groups...</p>\r\n                        </div>\r\n                    ) : groupList.length === 0 ? (\r\n                        <div className=\"text-center\" style={{ padding: '40px', background: 'white', borderRadius: '15px', boxShadow: '0 4px 15px rgba(0,0,0,0.05)' }}>\r\n                            <span style={{ fontSize: '48px', display: 'block', marginBottom: '15px' }}>≡ƒöì</span>\r\n                            <h3 style={{ margin: '0 0 10px 0', color: 'var(--text-main)' }}>No Groups Found</h3>\r\n                            <p className=\"text-muted\" style={{ fontSize: '14px', maxWidth: '300px', margin: '0 auto' }}>\r\n                                {userData?.role === 'teacher'\r\n                                    ? \"We couldn't find any chat groups for this specific class and section.\"\r\n                                    : \"You haven't been added to any active chat groups yet. Please contact your institution admin.\"}\r\n                            </p>\r\n                            {userData?.role === 'institution' && (\r\n                                <p className=\"text-muted\" style={{ fontSize: '12px', marginTop: '20px' }}>\r\n                                    Tip: Create allotments to automatically generate class groups.\r\n                                </p>\r\n                            )}\r\n                            <button\r\n                                onClick={() => fetchGroupsForSelection()}\r\n                                style={{ marginTop: '20px', padding: '10px 20px', background: '#0984e3', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer' }}\r\n                            >\r\n                                ≡ƒöä Refresh Groups\r\n                            </button>\r\n\r\n                            <details style={{ marginTop: '20px', textAlign: 'left', fontSize: '10px', color: '#999' }}>\r\n                                <summary>Debug Info</summary>\r\n                                <p>Role: {userData?.role}</p>\r\n                                <p>UID: {userData?.uid}</p>\r\n                                <p>Inst ID: {userData?.role === 'institution' ? userData?.uid : ((selectedClassScope?.institutionId) || userData?.institutionId || userData?.createdBy || 'N/A')}</p>\r\n                                <p>Search Scope: {JSON.stringify(selectedClassScope || {})}</p>\r\n                            </details>\r\n                        </div>\r\n                    ) : (\r\n                        <div style={{ display: 'grid', gap: '15px' }}>\r\n                            {groupList.map(g => (\r\n                                <div key={g.id} onClick={() => selectGroup(g.id)} className=\"card\" style={{ cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                                    <div>\r\n                                        <h4 style={{ margin: 0 }}>{g.groupName}</h4>\r\n                                        <p style={{ margin: 0, fontSize: '12px', color: '#666' }}>\r\n                                            {g.className} - {g.section || 'All Sections'}\r\n                                        </p>\r\n                                    </div>\r\n                                    <span style={{ fontSize: '20px' }}>≡ƒÆ¼</span>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // --- RENDER CHAT ---\r\n    return (\r\n        <div style={{\r\n            position: 'fixed',\r\n            top: 0, left: 0, right: 0, bottom: 0,\r\n            background: '#f4f4f4',\r\n            display: 'flex', flexDirection: 'column',\r\n            zIndex: 1500 // Above BottomNav usually\r\n        }}>\r\n            {/* Header - Fixed Top */}\r\n            <header style={{\r\n                height: '60px',\r\n                background: '#0984e3', color: 'white',\r\n                padding: '0 15px', display: 'flex', alignItems: 'center', gap: '10px',\r\n                flexShrink: 0, boxShadow: '0 2px 5px rgba(0,0,0,0.1)'\r\n            }}>\r\n                <button onClick={() => {\r\n                    if (userData?.role === 'institution') {\r\n                        setIsSelecting(true);\r\n                        localStorage.removeItem(\"activeGroupId\");\r\n                        setMessages([]); // Clear chat\r\n                    } else if (userData?.role === 'teacher') {\r\n                        navigate('/teacher', { replace: true });\r\n                    } else if (userData?.role === 'student') {\r\n                        navigate('/student', { replace: true });\r\n                    } else {\r\n                        navigate(-1);\r\n                    }\r\n                }} className=\"btn-back-marker\">Back</button>\r\n\r\n                <div style={{ flex: 1, cursor: 'pointer' }} onClick={() => setViewMode('members')}>\r\n                    <h2 style={{ margin: 0, fontSize: '18px' }}>{groupData?.groupName || \"Chat Group\"}</h2>\r\n                    <span style={{ fontSize: '12px', opacity: 0.8 }}>Tap for Info</span>\r\n                </div>\r\n\r\n                <div style={{ position: 'relative' }}>\r\n                    <button onClick={() => setShowMenu(!showMenu)} style={{ background: 'none', border: 'none', color: 'white', fontSize: '24px', cursor: 'pointer' }}>Γï«</button>\r\n                    {showMenu && (\r\n                        <div style={{\r\n                            position: 'absolute', top: '100%', right: 0,\r\n                            background: 'white', color: '#333',\r\n                            borderRadius: '8px', boxShadow: '0 5px 15px rgba(0,0,0,0.2)',\r\n                            minWidth: '150px', display: 'flex', flexDirection: 'column',\r\n                            zIndex: 2000\r\n                        }}>\r\n                            <div style={{ padding: '12px', borderBottom: '1px solid #eee', cursor: 'pointer' }} onClick={() => { setViewMode('files'); setShowMenu(false); }}>≡ƒôé Files</div>\r\n                            <div style={{ padding: '12px', borderBottom: '1px solid #eee', cursor: 'pointer' }} onClick={() => { setViewMode('docs'); setShowMenu(false); }}>≡ƒôä Documents</div>\r\n                            <div style={{ padding: '12px', borderBottom: '1px solid #eee', cursor: 'pointer' }} onClick={() => { setViewMode('photos'); setShowMenu(false); }}>≡ƒû╝∩╕Å Photos</div>\r\n                            <div style={{ padding: '12px', cursor: 'pointer' }} onClick={() => { setViewMode('about'); setShowMenu(false); }}>Γä╣∩╕Å About</div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </header>\r\n\r\n            {/* Chat Area - Scrollable Middle */}\r\n            <div style={{ flex: 1, overflowY: 'auto', padding: '15px' }}>\r\n                {messages.map((msg) => {\r\n                    const isMe = msg.uid === userData?.uid;\r\n                    return (\r\n                        <div key={msg.id} style={{ marginBottom: '15px', display: 'flex', justifyContent: isMe ? 'flex-end' : 'flex-start' }}>\r\n                            <div style={{\r\n                                maxWidth: '70%',\r\n                                padding: '10px',\r\n                                borderRadius: '12px',\r\n                                background: isMe ? '#0984e3' : 'white',\r\n                                color: isMe ? 'white' : 'black',\r\n                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',\r\n                                borderTopLeftRadius: !isMe ? '0' : '12px',\r\n                                borderTopRightRadius: isMe ? '0' : '12px'\r\n                            }}>\r\n                                {!isMe && <div style={{ fontSize: '11px', fontWeight: 'bold', color: '#636e72', marginBottom: '4px' }}>{msg.displayName} ({msg.role})</div>}\r\n                                {msg.image && <img src={msg.image} alt=\"attachment\" style={{ width: '100%', borderRadius: '8px', marginBottom: '5px' }} />}\r\n                                <div>{msg.text}</div>\r\n                                <div style={{ fontSize: '10px', opacity: 0.7, textAlign: 'right', marginTop: '4px' }}>\r\n                                    {msg.createdAt?.seconds ? new Date(msg.createdAt.seconds * 1000).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '...'}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n                <div ref={messagesEndRef} />\r\n            </div>\r\n\r\n            {/* Footer Input - Fixed Bottom relative to container */}\r\n            <form onSubmit={handleSend} style={{\r\n                background: 'white', padding: '10px',\r\n                borderTop: '1px solid #ddd', display: 'flex', gap: '10px', alignItems: 'center',\r\n                flexShrink: 0\r\n            }}>\r\n                {/* Attachment Menu */}\r\n                {showAttachMenu && (\r\n                    <div style={{\r\n                        position: 'absolute', bottom: '60px', left: '10px',\r\n                        background: 'white', borderRadius: '8px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.2)',\r\n                        padding: '10px', display: 'flex', flexDirection: 'column', gap: '10px',\r\n                        zIndex: 2000\r\n                    }}>\r\n                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>Attach Media</div>\r\n                        <button type=\"button\" onClick={() => { fileInputRef.current.click(); setShowAttachMenu(false); }}\r\n                            style={{ display: 'flex', alignItems: 'center', gap: '10px', background: 'none', border: 'none', cursor: 'pointer', padding: '5px' }}>\r\n                            <span style={{ fontSize: '20px' }}>≡ƒû╝∩╕Å</span> Photos / Camera\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n                <input type=\"file\" ref={fileInputRef} onChange={handleFileSelect} style={{ display: 'none' }} accept=\"image/*\" />\r\n                <button type=\"button\" onClick={() => setShowAttachMenu(!showAttachMenu)} style={{ background: '#dfe6e9', border: 'none', borderRadius: '50%', width: '40px', height: '40px', fontSize: '20px', cursor: 'pointer' }}>≡ƒôÄ</button>\r\n\r\n                <div style={{ flex: 1, position: 'relative' }}>\r\n                    {file && <div style={{ position: 'absolute', bottom: '100%', left: 0, background: '#fab1a0', padding: '5px', fontSize: '12px', borderRadius: '4px' }}>Image Attached <button type=\"button\" onClick={() => setFile(null)}>x</button></div>}\r\n                    <input\r\n                        type=\"text\"\r\n                        value={newMessage}\r\n                        onChange={(e) => setNewMessage(e.target.value)}\r\n                        placeholder=\"Type a message...\"\r\n                        style={{ width: '100%', padding: '10px', borderRadius: '20px', border: '1px solid #ddd', outline: 'none' }}\r\n                    />\r\n                </div>\r\n                <button type=\"submit\" className=\"btn\" style={{ backgroundColor: '#0984e3', borderRadius: '20px', padding: '10px 20px' }}>Send</button>\r\n            </form>\r\n\r\n            <OverlayView title={viewMode === 'photos' ? \"Shared Photos\" : (viewMode === 'files' || viewMode === 'docs' ? \"Shared Content\" : \"Group Members\")}\r\n                onClose={() => setViewMode(null)}\r\n                visible={viewMode !== null}>\r\n\r\n                {viewMode === 'members' || viewMode === 'about' ? (\r\n                    members.length === 0 ? <p>Loading or no members found...</p> : (\r\n                        members.map((m, i) => (\r\n                            <div key={i}\r\n                                onClick={(e) => { e.stopPropagation(); navigate('/profile-view', { state: { target: m } }); }}\r\n                                style={{ display: 'flex', alignItems: 'center', gap: '15px', padding: '10px', borderBottom: '1px solid #f0f0f0', cursor: 'pointer' }}>\r\n                                <div\r\n                                    style={{\r\n                                        width: '40px', height: '40px', borderRadius: '50%',\r\n                                        background: m.type === 'Teacher' ? '#ff7675' : '#a29bfe',\r\n                                        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                                        color: 'white', fontWeight: 'bold'\r\n                                    }}>\r\n                                    {m.name?.[0] || '?'}\r\n                                </div>\r\n                                <div style={{ flex: 1 }}>\r\n                                    <div style={{ fontWeight: 'bold' }}>{i + 1}. {m.name} {m.type === 'Teacher' && 'Γ¡É'}</div>\r\n                                    <div style={{ fontSize: '12px', color: '#666' }}>\r\n                                        {m.type === 'Teacher' ? `Teacher ΓÇó ${m.subject || 'General'}` : `Student ΓÇó ${m.rollNumber || 'N/A'}`}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))\r\n                    )\r\n                ) : viewMode === 'photos' ? (\r\n                    <>\r\n                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '5px' }}>\r\n                            {messages.filter(m => m.image).map(m => (\r\n                                <img key={m.id} src={m.image} style={{ width: '100%', aspectRatio: '1/1', objectFit: 'cover', borderRadius: '4px' }} alt=\"shared\" />\r\n                            ))}\r\n                        </div>\r\n                        {messages.filter(m => m.image).length === 0 && <p className=\"text-center text-muted\">No photos shared.</p>}\r\n                    </>\r\n                ) : (\r\n                    <p className=\"text-center text-muted\" style={{ marginTop: '50px' }}>\r\n                        No {viewMode} shared yet. <br />\r\n                        <span style={{ fontSize: '12px' }}>(Only images supported currently)</span>\r\n                    </p>\r\n                )}\r\n            </OverlayView>\r\n        </div>\r\n    );\r\n}\r\n\r\n// --- SUB-COMPONENTS ---\r\nconst OverlayView = ({ title, onClose, children, visible }) => {\r\n    if (!visible) return null;\r\n    return (\r\n        <div style={{\r\n            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n            background: 'white', zIndex: 2000, display: 'flex', flexDirection: 'column'\r\n        }}>\r\n            <div style={{ padding: '15px', borderBottom: '1px solid #eee', display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px' }}>Γ¼à</button>\r\n                <h3 style={{ margin: 0 }}>{title}</h3>\r\n            </div>\r\n            <div style={{ flex: 1, overflowY: 'auto', padding: '15px' }}>\r\n                {children}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Health.jsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`fetchUserRole` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  26 |         if (user) {\n  27 |             setUserId(user.uid);\n> 28 |             fetchUserRole(user.uid);\n     |             ^^^^^^^^^^^^^ `fetchUserRole` accessed before it is declared\n  29 |         }\n  30 |     }, []);\n  31 |\n\n  30 |     }, []);\n  31 |\n> 32 |     const fetchUserRole = async (uid) => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 33 |         // Check Institution\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 34 |         const instSnap = await getDoc(doc(db, \"institutions\", uid));\n     ΓÇª\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 44 |         }\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 45 |     };\n     | ^^^^^^^ `fetchUserRole` is declared here\n  46 |\n  47 |     const fetchMyReport = async (uid) => {\n  48 |         try {","line":28,"column":13,"nodeType":null,"endLine":28,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, setDoc, doc, getDoc } from 'firebase/firestore';\r\nimport { getAuth } from 'firebase/auth';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport AIBadge from '../components/AIBadge';\r\n\r\nexport default function Health() {\r\n    const [role, setRole] = useState(null);\r\n    const [userId, setUserId] = useState(null);\r\n\r\n    // Institution State\r\n    const [viewClass, setViewClass] = useState('');\r\n    const [students, setStudents] = useState([]);\r\n    const [selectedStudent, setSelectedStudent] = useState(null);\r\n    const [healthData, setHealthData] = useState({\r\n        height: '', weight: '', bloodGroup: '', vision: '', remarks: '', generalHealth: 'Good'\r\n    });\r\n\r\n    // Student/Teacher State\r\n    const [myReport, setMyReport] = useState(null);\r\n\r\n    useEffect(() => {\r\n        const auth = getAuth();\r\n        const user = auth.currentUser;\r\n        if (user) {\r\n            setUserId(user.uid);\r\n            fetchUserRole(user.uid);\r\n        }\r\n    }, []);\r\n\r\n    const fetchUserRole = async (uid) => {\r\n        // Check Institution\r\n        const instSnap = await getDoc(doc(db, \"institutions\", uid));\r\n        if (instSnap.exists()) {\r\n            setRole('institution');\r\n            return;\r\n        }\r\n        // Check User\r\n        const userSnap = await getDoc(doc(db, \"users\", uid));\r\n        if (userSnap.exists()) {\r\n            setRole(userSnap.data().role);\r\n            fetchMyReport(uid);\r\n        }\r\n    };\r\n\r\n    const fetchMyReport = async (uid) => {\r\n        try {\r\n            const docSnap = await getDoc(doc(db, \"health_records\", uid));\r\n            if (docSnap.exists()) {\r\n                setMyReport(docSnap.data());\r\n            }\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const fetchStudents = async () => {\r\n        if (!viewClass) return;\r\n        const q = query(collection(db, \"student_allotments\"), where(\"classAssigned\", \"==\", viewClass));\r\n        const snap = await getDocs(q);\r\n        setStudents(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        if (!selectedStudent) return;\r\n        try {\r\n            await setDoc(doc(db, \"health_records\", selectedStudent.id), {\r\n                ...healthData,\r\n                studentId: selectedStudent.id,\r\n                name: selectedStudent.name,\r\n                class: viewClass,\r\n                updatedAt: new Date(),\r\n                institutionId: userId\r\n            });\r\n            alert(\"Health Record Updated!\");\r\n            setSelectedStudent(null);\r\n            setHealthData({ height: '', weight: '', bloodGroup: '', vision: '', remarks: '', generalHealth: 'Good' });\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error saving record\");\r\n        }\r\n    };\r\n\r\n    const renderInstitutionView = () => (\r\n        <div className=\"container\" style={{ maxWidth: '800px', margin: '20px auto' }}>\r\n            <div className=\"card\">\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>\r\n                    <select className=\"input-field\" value={viewClass} onChange={(e) => setViewClass(e.target.value)}>\r\n                        <option value=\"\">Select Class to Monitor</option>\r\n                        {['1-A', '2-A', '3-A', '4-A', '5-A', '6-A', '7-A', '8-A', '9-A', '10-A'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                    </select>\r\n                    <button className=\"btn\" onClick={fetchStudents}>Fetch Students</button>\r\n                </div>\r\n\r\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\r\n                    {/* List */}\r\n                    <div style={{ maxHeight: '400px', overflowY: 'auto', borderRight: '1px solid #eee', paddingRight: '10px' }}>\r\n                        {students.map(s => (\r\n                            <div key={s.id} onClick={() => setSelectedStudent(s)}\r\n                                style={{\r\n                                    padding: '10px', borderBottom: '1px solid #f0f0f0', cursor: 'pointer',\r\n                                    background: selectedStudent?.id === s.id ? '#e3f2fd' : 'white'\r\n                                }}>\r\n                                <strong>{s.name}</strong>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Form */}\r\n                    <div>\r\n                        {selectedStudent ? (\r\n                            <div>\r\n                                <h4>Update Record: {selectedStudent.name}</h4>\r\n                                <input className=\"input-field\" placeholder=\"Height (cm)\" value={healthData.height} onChange={e => setHealthData({ ...healthData, height: e.target.value })} />\r\n                                <input className=\"input-field\" placeholder=\"Weight (kg)\" value={healthData.weight} onChange={e => setHealthData({ ...healthData, weight: e.target.value })} />\r\n\r\n                                {/* Auto-BMI Display */}\r\n                                {healthData.height && healthData.weight && (\r\n                                    <div style={{ padding: '10px', background: '#f8f9fa', borderRadius: '5px', margin: '10px 0', borderLeft: '4px solid #0984e3' }}>\r\n                                        <strong>≡ƒº« Calculated BMI: </strong>\r\n                                        {healthData.height > 0 ? ((healthData.weight / ((healthData.height / 100) * (healthData.height / 100)))).toFixed(1) : 'N/A'}\r\n                                        <span style={{ fontSize: '12px', marginLeft: '10px' }}>\r\n                                            ({(healthData.weight / ((healthData.height / 100) * (healthData.height / 100))) < 18.5 ? \"Underweight\" :\r\n                                                (healthData.weight / ((healthData.height / 100) * (healthData.height / 100))) < 25 ? \"Normal\" : \"Overweight\"})\r\n                                        </span>\r\n                                    </div>\r\n                                )}\r\n                                <input className=\"input-field\" placeholder=\"Blood Group (e.g. O+)\" value={healthData.bloodGroup} onChange={e => setHealthData({ ...healthData, bloodGroup: e.target.value })} />\r\n                                <input className=\"input-field\" placeholder=\"Vision (e.g. 6/6)\" value={healthData.vision} onChange={e => setHealthData({ ...healthData, vision: e.target.value })} />\r\n                                <textarea className=\"input-field\" placeholder=\"Remarks/Issues\" value={healthData.remarks} onChange={e => setHealthData({ ...healthData, remarks: e.target.value })} />\r\n                                <button className=\"btn\" style={{ width: '100%', backgroundColor: '#e84393' }} onClick={handleSave}>Save Record</button>\r\n                            </div>\r\n                        ) : (\r\n                            <p className=\"text-muted\">Select a student to enter details.</p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const renderStudentView = () => (\r\n        <div className=\"container\" style={{ maxWidth: '600px', margin: '20px auto' }}>\r\n            {myReport ? (\r\n                <div className=\"card\" style={{ background: 'linear-gradient(to bottom right, #ffffff, #f0f8ff)', border: '2px solid #81ecec' }}>\r\n                    <div className=\"text-center\" style={{ marginBottom: '20px' }}>\r\n                        <div style={{ fontSize: '50px' }}>≡ƒ⌐║</div>\r\n                        <h3>Health Status: {myReport.generalHealth}</h3>\r\n                        <p className=\"text-muted\">Last Updated: {myReport.updatedAt ? new Date(myReport.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>\r\n                    </div>\r\n\r\n                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>\r\n                        <div className=\"card\" style={{ textAlign: 'center', backgroundColor: '#fff' }}>\r\n                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#0984e3' }}>{myReport.height || '--'} cm</div>\r\n                            <div style={{ fontSize: '12px', color: '#666' }}>Height</div>\r\n                        </div>\r\n                        <div className=\"card\" style={{ textAlign: 'center', backgroundColor: '#fff' }}>\r\n                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#e17055' }}>{myReport.weight || '--'} kg</div>\r\n                            <div style={{ fontSize: '12px', color: '#666' }}>Weight</div>\r\n                        </div>\r\n                        <div className=\"card\" style={{ textAlign: 'center', backgroundColor: '#fff' }}>\r\n                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#d63031' }}>{myReport.bloodGroup || '--'}</div>\r\n                            <div style={{ fontSize: '12px', color: '#666' }}>Blood Group</div>\r\n                        </div>\r\n                        <div className=\"card\" style={{ textAlign: 'center', backgroundColor: '#fff' }}>\r\n                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#6c5ce7' }}>{myReport.vision || '--'}</div>\r\n                            <div style={{ fontSize: '12px', color: '#666' }}>Vision</div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div style={{ marginTop: '20px', padding: '15px', backgroundColor: '#fff3cd', borderRadius: '8px' }}>\r\n                        <strong>≡ƒæ¿ΓÇìΓÜò∩╕Å Doctor's Remarks:</strong>\r\n                        <p>{myReport.remarks || \"No specific remarks.\"}</p>\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                <div className=\"card text-center\">\r\n                    <p>No health report found. Please contact your institution admin.</p>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <AIBadge />\r\n            <AnnouncementBar\r\n                title={role === 'institution' ? \"Health Monitoring Camp\" : \"My Health Report\"}\r\n                leftIcon={false}\r\n            />\r\n            {role === 'institution' ? renderInstitutionView() : renderStudentView()}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\HomeworkSystem.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":88,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[273,284],"text":""},"desc":"Remove unused variable 'updateDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":93,"suggestions":[{"messageId":"removeVar","data":{"varName":"doc"},"fix":{"range":[284,289],"text":""},"desc":"Remove unused variable 'doc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'attachment' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":20,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"attachment"},"fix":{"range":[937,947],"text":""},"desc":"Remove unused variable 'attachment'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setAttachment' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":20,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setAttachment"},"fix":{"range":[947,962],"text":""},"desc":"Remove unused variable 'setAttachment'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db, storage } from '../firebase';\r\nimport { collection, addDoc, query, where, getDocs, orderBy, serverTimestamp, updateDoc, doc } from 'firebase/firestore';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\n\r\nexport default function HomeworkSystem() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [activeTab, setActiveTab] = useState(userData?.role === 'teacher' ? 'create' : 'view');\r\n\r\n    // CREATE HOMEWORK (Teacher)\r\n    const [title, setTitle] = useState('');\r\n    const [description, setDescription] = useState('');\r\n    const [deadline, setDeadline] = useState('');\r\n    const [selectedClass, setSelectedClass] = useState('');\r\n    const [selectedSection, setSelectedSection] = useState('');\r\n    const [attachment, setAttachment] = useState(null);\r\n\r\n    // VIEW HOMEWORK (Student/Teacher)\r\n    const [homeworkList, setHomeworkList] = useState([]);\r\n    const [submissions, setSubmissions] = useState({});\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // SUBMIT HOMEWORK (Student)\r\n    const [selectedHomework, setSelectedHomework] = useState(null);\r\n    const [submissionFile, setSubmissionFile] = useState(null);\r\n    const [submissionText, setSubmissionText] = useState('');\r\n\r\n    // VIEW SUBMISSIONS (Teacher)\r\n    const [viewSubmissionId, setViewSubmissionId] = useState(null);\r\n    const [submissionsData, setSubmissionsData] = useState([]);\r\n\r\n    useEffect(() => {\r\n        if (activeTab === 'view') {\r\n            fetchHomework();\r\n        }\r\n    }, [activeTab, userData]);\r\n\r\n    const fetchHomework = async () => {\r\n        setLoading(true);\r\n        try {\r\n            let q;\r\n            if (userData?.role === 'student') {\r\n                // Fetch homework for student's class\r\n                q = query(\r\n                    collection(db, \"homework\"),\r\n                    where(\"class\", \"==\", userData.class || userData.assignedClass),\r\n                    orderBy(\"createdAt\", \"desc\")\r\n                );\r\n            } else {\r\n                // Teacher sees all homework they created\r\n                q = query(\r\n                    collection(db, \"homework\"),\r\n                    where(\"teacherId\", \"==\", userData.uid),\r\n                    orderBy(\"createdAt\", \"desc\")\r\n                );\r\n            }\r\n\r\n            const snap = await getDocs(q);\r\n            const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n            setHomeworkList(list);\r\n\r\n            // If student, fetch their submissions\r\n            if (userData?.role === 'student') {\r\n                const subQuery = query(\r\n                    collection(db, \"homework_submissions\"),\r\n                    where(\"studentId\", \"==\", userData.uid)\r\n                );\r\n                const subSnap = await getDocs(subQuery);\r\n                const subs = {};\r\n                subSnap.docs.forEach(d => {\r\n                    subs[d.data().homeworkId] = { id: d.id, ...d.data() };\r\n                });\r\n                setSubmissions(subs);\r\n            }\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const fetchSubmissions = async (hwId) => {\r\n        if (viewSubmissionId === hwId) {\r\n            setViewSubmissionId(null);\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            const q = query(collection(db, \"homework_submissions\"), where(\"homeworkId\", \"==\", hwId), orderBy(\"submittedAt\", \"desc\"));\r\n            const snap = await getDocs(q);\r\n            setSubmissionsData(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n            setViewSubmissionId(hwId);\r\n        } catch (e) { console.error(e); } finally { setLoading(false); }\r\n    };\r\n\r\n    const handleCreateHomework = async () => {\r\n        if (!title || !description || !deadline || !selectedClass) {\r\n            alert(\"Please fill all required fields\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await addDoc(collection(db, \"homework\"), {\r\n                title,\r\n                description,\r\n                deadline: new Date(deadline),\r\n                class: selectedClass,\r\n                section: selectedSection || 'All',\r\n                subject: userData.subject || 'General',\r\n                teacherId: userData.uid,\r\n                teacherName: userData.name,\r\n                createdAt: serverTimestamp(),\r\n                institutionId: userData.institutionId || userData.createdBy || userData.uid\r\n            });\r\n\r\n            alert(\"Γ£à Homework posted successfully!\");\r\n            setTitle('');\r\n            setDescription('');\r\n            setDeadline('');\r\n            setSelectedClass('');\r\n            setSelectedSection('');\r\n            setActiveTab('view');\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error posting homework\");\r\n        }\r\n    };\r\n\r\n    const handleSubmitHomework = async () => {\r\n        if (!submissionText && !submissionFile) {\r\n            alert(\"Please add your submission (text or file)\");\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            let fileUrl = null;\r\n            if (submissionFile) {\r\n                const fileRef = ref(storage, `homework_submissions/${userData.uid}/${Date.now()}_${submissionFile.name}`);\r\n                await uploadBytes(fileRef, submissionFile);\r\n                fileUrl = await getDownloadURL(fileRef);\r\n            }\r\n\r\n            await addDoc(collection(db, \"homework_submissions\"), {\r\n                homeworkId: selectedHomework.id,\r\n                studentId: userData.uid,\r\n                studentName: userData.name,\r\n                class: userData.class || userData.assignedClass,\r\n                submissionText: submissionText,\r\n                fileUrl: fileUrl,\r\n                fileName: submissionFile ? submissionFile.name : null,\r\n                submittedAt: serverTimestamp(),\r\n                status: 'submitted'\r\n            });\r\n\r\n            alert(\"Γ£à Homework submitted successfully!\");\r\n            setSelectedHomework(null);\r\n            setSubmissionText('');\r\n            setSubmissionFile(null);\r\n            fetchHomework();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error submitting homework: \" + e.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const isLate = (deadline) => {\r\n        if (!deadline) return false;\r\n        const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);\r\n        return new Date() > deadlineDate;\r\n    };\r\n\r\n    const getDaysLeft = (deadline) => {\r\n        if (!deadline) return 'No deadline';\r\n        const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);\r\n        const diff = Math.ceil((deadlineDate - new Date()) / (1000 * 60 * 60 * 24));\r\n        if (diff < 0) return 'Overdue';\r\n        if (diff === 0) return 'Due today';\r\n        return `${diff} days left`;\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                    <h2>≡ƒôÜ Homework & Assignments</h2>\r\n                    <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                </div>\r\n\r\n                {/* Tabs */}\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', borderBottom: '2px solid #eee' }}>\r\n                    {userData?.role === 'teacher' && (\r\n                        <button\r\n                            onClick={() => setActiveTab('create')}\r\n                            style={{\r\n                                padding: '10px 20px', background: 'none', border: 'none',\r\n                                borderBottom: activeTab === 'create' ? '3px solid #0984e3' : 'none',\r\n                                fontWeight: activeTab === 'create' ? 'bold' : 'normal',\r\n                                cursor: 'pointer', color: activeTab === 'create' ? '#0984e3' : '#636e72'\r\n                            }}\r\n                        >\r\n                            Γ₧ò Create Homework\r\n                        </button>\r\n                    )}\r\n                    <button\r\n                        onClick={() => setActiveTab('view')}\r\n                        style={{\r\n                            padding: '10px 20px', background: 'none', border: 'none',\r\n                            borderBottom: activeTab === 'view' ? '3px solid #0984e3' : 'none',\r\n                            fontWeight: activeTab === 'view' ? 'bold' : 'normal',\r\n                            cursor: 'pointer', color: activeTab === 'view' ? '#0984e3' : '#636e72'\r\n                        }}\r\n                    >\r\n                        ≡ƒæü∩╕Å {userData?.role === 'teacher' ? 'My Homework' : 'View Homework'}\r\n                    </button>\r\n                </div>\r\n\r\n                {/* CREATE TAB (Teacher Only) */}\r\n                {activeTab === 'create' && userData?.role === 'teacher' && (\r\n                    <div className=\"card\">\r\n                        <h3>Create New Homework</h3>\r\n\r\n                        <div style={{ display: 'grid', gap: '15px' }}>\r\n                            <div>\r\n                                <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                    Title *\r\n                                </label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"input-field\"\r\n                                    value={title}\r\n                                    onChange={(e) => setTitle(e.target.value)}\r\n                                    placeholder=\"e.g., Chapter 5 Exercise\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div>\r\n                                <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                    Description *\r\n                                </label>\r\n                                <textarea\r\n                                    className=\"input-field\"\r\n                                    rows=\"4\"\r\n                                    value={description}\r\n                                    onChange={(e) => setDescription(e.target.value)}\r\n                                    placeholder=\"Detailed instructions for students...\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '10px' }}>\r\n                                <div>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Class *\r\n                                    </label>\r\n                                    <select className=\"input-field\" value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)}>\r\n                                        <option value=\"\">Select</option>\r\n                                        {[...Array(12)].map((_, i) => <option key={i} value={i + 1}>{i + 1}</option>)}\r\n                                    </select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Section\r\n                                    </label>\r\n                                    <select className=\"input-field\" value={selectedSection} onChange={(e) => setSelectedSection(e.target.value)}>\r\n                                        <option value=\"\">All Sections</option>\r\n                                        {['A', 'B', 'C', 'D'].map(s => <option key={s} value={s}>{s}</option>)}\r\n                                    </select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Deadline *\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        className=\"input-field\"\r\n                                        value={deadline}\r\n                                        onChange={(e) => setDeadline(e.target.value)}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <button onClick={handleCreateHomework} className=\"btn\" style={{ marginTop: '10px' }}>\r\n                                Γ£à Post Homework\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* VIEW TAB */}\r\n                {activeTab === 'view' && (\r\n                    <div>\r\n                        {loading ? (\r\n                            <div style={{ textAlign: 'center', padding: '40px' }}>Loading...</div>\r\n                        ) : homeworkList.length === 0 ? (\r\n                            <div className=\"card\" style={{ textAlign: 'center', padding: '60px' }}>\r\n                                <div style={{ fontSize: '64px', marginBottom: '20px' }}>≡ƒô¡</div>\r\n                                <h3>No Homework Yet</h3>\r\n                                <p style={{ color: '#999' }}>\r\n                                    {userData?.role === 'teacher'\r\n                                        ? \"You haven't created any homework yet.\"\r\n                                        : \"No homework assigned to your class.\"}\r\n                                </p>\r\n                            </div>\r\n                        ) : (\r\n                            <div style={{ display: 'grid', gap: '15px' }}>\r\n                                {homeworkList.map(hw => {\r\n                                    const submission = submissions[hw.id];\r\n                                    const daysLeft = getDaysLeft(hw.deadline);\r\n                                    const late = isLate(hw.deadline);\r\n\r\n                                    return (\r\n                                        <div key={hw.id} className=\"card\" style={{\r\n                                            borderLeft: `5px solid ${submission ? '#27ae60' : late ? '#e74c3c' : '#3498db'}`\r\n                                        }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>\r\n                                                <div>\r\n                                                    <h3 style={{ margin: '0 0 5px 0' }}>{hw.title}</h3>\r\n                                                    <div style={{ fontSize: '13px', color: '#636e72' }}>\r\n                                                        {hw.subject} ΓÇó Class {hw.class} {hw.section !== 'All' && `- ${hw.section}`}\r\n                                                    </div>\r\n                                                </div>\r\n                                                <div style={{\r\n                                                    background: submission ? '#d4edda' : late ? '#f8d7da' : '#d1ecf1',\r\n                                                    color: submission ? '#155724' : late ? '#721c24' : '#0c5460',\r\n                                                    padding: '4px 10px',\r\n                                                    borderRadius: '20px',\r\n                                                    fontSize: '12px',\r\n                                                    fontWeight: 'bold'\r\n                                                }}>\r\n                                                    {submission ? 'Γ£à Submitted' : daysLeft}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            <p style={{ margin: '10px 0', fontSize: '14px' }}>{hw.description}</p>\r\n\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '15px', paddingTop: '15px', borderTop: '1px solid #eee' }}>\r\n                                                <div style={{ fontSize: '12px', color: '#999' }}>\r\n                                                    Posted by {hw.teacherName} ΓÇó {hw.createdAt?.toDate?.()?.toLocaleDateString() || 'Recently'}\r\n                                                </div>\r\n\r\n                                                {userData?.role === 'teacher' && (\r\n                                                    <button\r\n                                                        onClick={() => fetchSubmissions(hw.id)}\r\n                                                        className=\"btn-outline\"\r\n                                                        style={{ fontSize: '13px', padding: '5px 10px' }}\r\n                                                    >\r\n                                                        {viewSubmissionId === hw.id ? 'Hide Submissions' : 'View Submissions'}\r\n                                                    </button>\r\n                                                )}\r\n\r\n                                                {userData?.role === 'student' && !submission && (\r\n                                                    <button\r\n                                                        onClick={() => setSelectedHomework(hw)}\r\n                                                        className=\"btn\"\r\n                                                        style={{ fontSize: '13px', padding: '6px 15px' }}\r\n                                                    >\r\n                                                        ≡ƒôñ Submit\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n\r\n                                            {/* Teacher Submission View */}\r\n                                            {viewSubmissionId === hw.id && (\r\n                                                <div style={{ marginTop: '15px', borderTop: '1px solid #eee', paddingTop: '15px' }}>\r\n                                                    <h4>Student Submissions ({submissionsData.length})</h4>\r\n                                                    {submissionsData.length === 0 ? (\r\n                                                        <div style={{ color: '#999', padding: '10px' }}>No submissions yet.</div>\r\n                                                    ) : (\r\n                                                        <div style={{ display: 'grid', gap: '10px' }}>\r\n                                                            {submissionsData.map(sub => (\r\n                                                                <div key={sub.id} style={{ background: '#f8f9fa', padding: '10px', borderRadius: '4px', border: '1px solid #eee' }}>\r\n                                                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}>\r\n                                                                        <strong>{sub.studentName} <span style={{ color: '#636e72', fontWeight: 'normal' }}>({sub.class})</span></strong>\r\n                                                                        <span style={{ fontSize: '12px', color: '#636e72' }}>\r\n                                                                            {sub.submittedAt?.toDate().toLocaleString()}\r\n                                                                        </span>\r\n                                                                    </div>\r\n                                                                    {sub.submissionText && (\r\n                                                                        <div style={{ fontSize: '14px', marginBottom: '5px', color: '#2d3436' }}>{sub.submissionText}</div>\r\n                                                                    )}\r\n                                                                    {sub.fileUrl && (\r\n                                                                        <a href={sub.fileUrl} target=\"_blank\" rel=\"noopener noreferrer\"\r\n                                                                            style={{ fontSize: '13px', color: '#0984e3', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '5px' }}>\r\n                                                                            ≡ƒôÄ View Attachment ({sub.fileName || 'File'})\r\n                                                                        </a>\r\n                                                                    )}\r\n                                                                </div>\r\n                                                            ))}\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* SUBMISSION MODAL (Student) */}\r\n                {selectedHomework && (\r\n                    <div style={{\r\n                        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                        background: 'rgba(0,0,0,0.8)', zIndex: 3000,\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                        padding: '20px'\r\n                    }}>\r\n                        <div className=\"card\" style={{ width: '100%', maxWidth: '500px', maxHeight: '90vh', overflowY: 'auto' }}>\r\n                            <h3>Submit: {selectedHomework.title}</h3>\r\n\r\n                            <div style={{ marginBottom: '15px', padding: '10px', background: '#f8f9fa', borderRadius: '4px' }}>\r\n                                <div style={{ fontSize: '13px', color: '#636e72', marginBottom: '5px' }}>Instructions:</div>\r\n                                <div style={{ fontSize: '14px' }}>{selectedHomework.description}</div>\r\n                            </div>\r\n\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                    Your Answer/Solution\r\n                                </label>\r\n                                <textarea\r\n                                    className=\"input-field\"\r\n                                    rows=\"6\"\r\n                                    value={submissionText}\r\n                                    onChange={(e) => setSubmissionText(e.target.value)}\r\n                                    placeholder=\"Type your answer here or describe what you've attached...\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                    Attach File (Image/PDF)\r\n                                </label>\r\n                                <input\r\n                                    type=\"file\"\r\n                                    className=\"input-field\"\r\n                                    onChange={(e) => setSubmissionFile(e.target.files[0])}\r\n                                    accept=\"image/*,application/pdf\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>\r\n                                <button\r\n                                    onClick={() => {\r\n                                        setSelectedHomework(null);\r\n                                        setSubmissionText('');\r\n                                    }}\r\n                                    className=\"btn-outline\"\r\n                                >\r\n                                    Cancel\r\n                                </button>\r\n                                <button onClick={handleSubmitHomework} className=\"btn\">\r\n                                    Γ£à Submit Homework\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\InspectionReadiness.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'collection' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"collection"},"fix":{"range":[197,208],"text":""},"desc":"Remove unused variable 'collection'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'category' is defined but never used.","line":109,"column":62,"nodeType":"Identifier","messageId":"unusedVar","endLine":109,"endColumn":70,"suggestions":[{"messageId":"removeVar","data":{"varName":"category"},"fix":{"range":[3967,3975],"text":""},"desc":"Remove unused variable 'category'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":233,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":233,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"_"},"fix":{"range":[8202,8203],"text":""},"desc":"Remove unused variable '_'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":239,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":239,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"_"},"fix":{"range":[8385,8386],"text":""},"desc":"Remove unused variable '_'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'firebase/firestore';\r\nimport jsPDF from 'jspdf';\r\nimport 'jspdf-autotable';\r\n\r\nexport default function InspectionReadiness() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [loading, setLoading] = useState(true);\r\n    const [checklist, setChecklist] = useState({});\r\n    const [complianceScore, setComplianceScore] = useState(0);\r\n    const [lastInspection, setLastInspection] = useState(null);\r\n\r\n    // Comprehensive document checklist (50+ items)\r\n    const documentCategories = {\r\n        \"Legal & Registration\": [\r\n            \"School Registration Certificate\",\r\n            \"Affiliation Certificate (CBSE/State Board)\",\r\n            \"Society Registration\",\r\n            \"Trust Deed\",\r\n            \"NOC from Local Authority\",\r\n            \"Building Safety Certificate\",\r\n            \"Fire Safety Certificate\",\r\n            \"Sanitation Certificate\"\r\n        ],\r\n        \"Infrastructure\": [\r\n            \"Building Plan Approval\",\r\n            \"Playground Certificate\",\r\n            \"Laboratory Equipment List\",\r\n            \"Library Catalog\",\r\n            \"Computer Lab Inventory\",\r\n            \"Furniture Inventory\",\r\n            \"Drinking Water Test Report\",\r\n            \"Electricity Safety Certificate\"\r\n        ],\r\n        \"Academic\": [\r\n            \"Curriculum Framework\",\r\n            \"Lesson Plans (All Subjects)\",\r\n            \"Examination Records\",\r\n            \"Student Progress Reports\",\r\n            \"Teacher Qualification Certificates\",\r\n            \"Teacher Training Certificates\",\r\n            \"Class Timetables\",\r\n            \"Academic Calendar\"\r\n        ],\r\n        \"Student Records\": [\r\n            \"Admission Register\",\r\n            \"Student Attendance Records\",\r\n            \"Transfer Certificates\",\r\n            \"Character Certificates\",\r\n            \"Medical Records\",\r\n            \"Fee Receipts\",\r\n            \"Scholarship Records\",\r\n            \"Student ID Cards\"\r\n        ],\r\n        \"Staff Records\": [\r\n            \"Teacher Appointment Letters\",\r\n            \"Staff Attendance Register\",\r\n            \"Salary Registers\",\r\n            \"PF/ESI Records\",\r\n            \"Police Verification Certificates\",\r\n            \"Medical Fitness Certificates\",\r\n            \"Staff ID Cards\",\r\n            \"Leave Records\"\r\n        ],\r\n        \"Financial\": [\r\n            \"Audited Financial Statements\",\r\n            \"Fee Structure Approval\",\r\n            \"Income Tax Returns\",\r\n            \"GST Registration\",\r\n            \"Bank Statements\",\r\n            \"Budget Documents\",\r\n            \"Donation Receipts\",\r\n            \"Expenditure Records\"\r\n        ],\r\n        \"Safety & Welfare\": [\r\n            \"CCTV Installation Certificate\",\r\n            \"First Aid Kit Inventory\",\r\n            \"Emergency Contact List\",\r\n            \"Disaster Management Plan\",\r\n            \"Anti-Ragging Policy\",\r\n            \"Child Protection Policy\",\r\n            \"Transport Safety Records\",\r\n            \"Insurance Policies\"\r\n        ]\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchInspectionData();\r\n    }, [userData]);\r\n\r\n    const fetchInspectionData = async () => {\r\n        try {\r\n            const docRef = doc(db, \"inspection_readiness\", userData.institutionId || userData.uid);\r\n            const docSnap = await getDoc(docRef);\r\n\r\n            if (docSnap.exists()) {\r\n                const data = docSnap.data();\r\n                setChecklist(data.checklist || {});\r\n                setLastInspection(data.lastInspection);\r\n                calculateCompliance(data.checklist || {});\r\n            } else {\r\n                // Initialize empty checklist\r\n                const emptyChecklist = {};\r\n                Object.entries(documentCategories).forEach(([category, items]) => {\r\n                    items.forEach(item => {\r\n                        emptyChecklist[item] = false;\r\n                    });\r\n                });\r\n                setChecklist(emptyChecklist);\r\n                calculateCompliance(emptyChecklist);\r\n            }\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const calculateCompliance = (checklistData) => {\r\n        const total = Object.keys(checklistData).length;\r\n        const completed = Object.values(checklistData).filter(v => v === true).length;\r\n        const score = total > 0 ? Math.round((completed / total) * 100) : 0;\r\n        setComplianceScore(score);\r\n    };\r\n\r\n    const toggleDocument = async (docName) => {\r\n        const newChecklist = { ...checklist, [docName]: !checklist[docName] };\r\n        setChecklist(newChecklist);\r\n        calculateCompliance(newChecklist);\r\n\r\n        // Save to database\r\n        try {\r\n            await setDoc(doc(db, \"inspection_readiness\", userData.institutionId || userData.uid), {\r\n                checklist: newChecklist,\r\n                lastUpdated: serverTimestamp(),\r\n                updatedBy: userData.uid\r\n            }, { merge: true });\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const recordInspection = async () => {\r\n        const score = prompt(\"Enter inspection score (0-100):\");\r\n        if (!score) return;\r\n\r\n        try {\r\n            await updateDoc(doc(db, \"inspection_readiness\", userData.institutionId || userData.uid), {\r\n                lastInspection: {\r\n                    date: new Date().toISOString(),\r\n                    score: parseInt(score),\r\n                    complianceAtTime: complianceScore\r\n                }\r\n            });\r\n            alert(\"Γ£à Inspection record saved!\");\r\n            fetchInspectionData();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error saving inspection record\");\r\n        }\r\n    };\r\n\r\n    const generateReport = () => {\r\n        const doc = new jsPDF();\r\n\r\n        // Header\r\n        doc.setFontSize(18);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text(userData?.institutionName || \"School Inspection Report\", 105, 20, { align: 'center' });\r\n\r\n        doc.setFontSize(14);\r\n        doc.text(\"INSPECTION READINESS REPORT\", 105, 30, { align: 'center' });\r\n\r\n        // Compliance Score\r\n        doc.setFontSize(12);\r\n        doc.setFont('helvetica', 'normal');\r\n        doc.text(`Compliance Score: ${complianceScore}%`, 20, 45);\r\n        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 52);\r\n\r\n        if (lastInspection) {\r\n            doc.text(`Last Inspection: ${new Date(lastInspection.date).toLocaleDateString()}`, 20, 59);\r\n            doc.text(`Last Score: ${lastInspection.score}%`, 20, 66);\r\n        }\r\n\r\n        let yPos = 80;\r\n\r\n        // Document Checklist by Category\r\n        Object.entries(documentCategories).forEach(([category, items]) => {\r\n            if (yPos > 250) {\r\n                doc.addPage();\r\n                yPos = 20;\r\n            }\r\n\r\n            doc.setFontSize(12);\r\n            doc.setFont('helvetica', 'bold');\r\n            doc.text(category, 20, yPos);\r\n            yPos += 10;\r\n\r\n            doc.setFont('helvetica', 'normal');\r\n            doc.setFontSize(10);\r\n\r\n            items.forEach(item => {\r\n                const status = checklist[item] ? 'Γ£ô' : 'Γ£ù';\r\n                const color = checklist[item] ? [39, 174, 96] : [231, 76, 60];\r\n                doc.setTextColor(...color);\r\n                doc.text(`${status} ${item}`, 25, yPos);\r\n                yPos += 7;\r\n\r\n                if (yPos > 270) {\r\n                    doc.addPage();\r\n                    yPos = 20;\r\n                }\r\n            });\r\n\r\n            doc.setTextColor(0, 0, 0);\r\n            yPos += 5;\r\n        });\r\n\r\n        // Footer\r\n        doc.setFontSize(9);\r\n        doc.text(\"Powered by Together To Refine\", 20, 285);\r\n\r\n        doc.save(`Inspection_Readiness_Report_${new Date().toISOString().split('T')[0]}.pdf`);\r\n    };\r\n\r\n    const getMissingDocuments = () => {\r\n        return Object.entries(checklist)\r\n            .filter(([_, completed]) => !completed)\r\n            .map(([doc]) => doc);\r\n    };\r\n\r\n    const getCompletedDocuments = () => {\r\n        return Object.entries(checklist)\r\n            .filter(([_, completed]) => completed)\r\n            .map(([doc]) => doc);\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"page-wrapper\" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>\r\n                <div style={{ textAlign: 'center' }}>\r\n                    <div style={{ fontSize: '48px', marginBottom: '10px' }}>≡ƒö┤</div>\r\n                    <div>Loading inspection data...</div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const missingDocs = getMissingDocuments();\r\n    const completedDocs = getCompletedDocuments();\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                    <h2>≡ƒö┤ Inspection Readiness</h2>\r\n                    <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                </div>\r\n\r\n                {/* Compliance Score Card */}\r\n                <div className=\"card\" style={{\r\n                    marginBottom: '20px',\r\n                    background: complianceScore >= 90 ? 'linear-gradient(135deg, #27ae60 0%, #229954 100%)' :\r\n                        complianceScore >= 75 ? 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)' :\r\n                            'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)',\r\n                    color: 'white'\r\n                }}>\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                        <div>\r\n                            <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>Compliance Score</h3>\r\n                            <div style={{ fontSize: '48px', fontWeight: 'bold' }}>{complianceScore}%</div>\r\n                            <div style={{ fontSize: '14px', opacity: 0.9 }}>\r\n                                {complianceScore >= 90 ? \"Γ£à Excellent! Ready for inspection\" :\r\n                                    complianceScore >= 75 ? \"ΓÜá∩╕Å Good, but needs improvement\" :\r\n                                        \"Γ¥î Critical! Immediate action required\"}\r\n                            </div>\r\n                        </div>\r\n                        <div style={{ textAlign: 'right' }}>\r\n                            <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>Documents</div>\r\n                            <div style={{ fontSize: '24px', fontWeight: 'bold' }}>\r\n                                {completedDocs.length} / {Object.keys(checklist).length}\r\n                            </div>\r\n                            <div style={{ fontSize: '12px', opacity: 0.8 }}>Completed</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Action Buttons */}\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', flexWrap: 'wrap' }}>\r\n                    <button onClick={generateReport} className=\"btn\" style={{ background: '#3498db' }}>\r\n                        ≡ƒôä Download Report\r\n                    </button>\r\n                    <button onClick={recordInspection} className=\"btn\" style={{ background: '#9b59b6' }}>\r\n                        ≡ƒô¥ Record Inspection\r\n                    </button>\r\n                    {lastInspection && (\r\n                        <div style={{\r\n                            padding: '10px 20px',\r\n                            background: '#ecf0f1',\r\n                            borderRadius: '8px',\r\n                            fontSize: '13px'\r\n                        }}>\r\n                            Last Inspection: {new Date(lastInspection.date).toLocaleDateString()} - Score: {lastInspection.score}%\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Missing Documents Alert */}\r\n                {missingDocs.length > 0 && (\r\n                    <div className=\"card\" style={{\r\n                        marginBottom: '20px',\r\n                        background: '#fff3cd',\r\n                        border: '1px solid #ffc107',\r\n                        borderLeft: '5px solid #ffc107'\r\n                    }}>\r\n                        <h4 style={{ margin: '0 0 10px 0', color: '#856404' }}>ΓÜá∩╕Å Missing Documents ({missingDocs.length})</h4>\r\n                        <div style={{ fontSize: '14px', color: '#856404' }}>\r\n                            Priority items to complete before next inspection:\r\n                            <ul style={{ marginTop: '10px', paddingLeft: '20px' }}>\r\n                                {missingDocs.slice(0, 5).map(doc => (\r\n                                    <li key={doc}>{doc}</li>\r\n                                ))}\r\n                                {missingDocs.length > 5 && <li>...and {missingDocs.length - 5} more</li>}\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Document Checklist by Category */}\r\n                <div className=\"card\">\r\n                    <h3>Document Checklist</h3>\r\n                    <p style={{ color: '#636e72', marginBottom: '20px' }}>\r\n                        Check off documents as you complete them. Click to toggle status.\r\n                    </p>\r\n\r\n                    {Object.entries(documentCategories).map(([category, items]) => {\r\n                        const categoryCompleted = items.filter(item => checklist[item]).length;\r\n                        const categoryTotal = items.length;\r\n                        const categoryPercent = Math.round((categoryCompleted / categoryTotal) * 100);\r\n\r\n                        return (\r\n                            <div key={category} style={{ marginBottom: '25px' }}>\r\n                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>\r\n                                    <h4 style={{ margin: 0 }}>{category}</h4>\r\n                                    <div style={{\r\n                                        background: categoryPercent === 100 ? '#27ae60' : categoryPercent >= 50 ? '#f39c12' : '#e74c3c',\r\n                                        color: 'white',\r\n                                        padding: '4px 12px',\r\n                                        borderRadius: '20px',\r\n                                        fontSize: '12px',\r\n                                        fontWeight: 'bold'\r\n                                    }}>\r\n                                        {categoryCompleted}/{categoryTotal} ({categoryPercent}%)\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div style={{ display: 'grid', gap: '8px' }}>\r\n                                    {items.map(item => (\r\n                                        <div\r\n                                            key={item}\r\n                                            onClick={() => toggleDocument(item)}\r\n                                            style={{\r\n                                                padding: '12px 15px',\r\n                                                background: checklist[item] ? '#d4edda' : '#f8d7da',\r\n                                                border: `1px solid ${checklist[item] ? '#c3e6cb' : '#f5c6cb'}`,\r\n                                                borderRadius: '6px',\r\n                                                cursor: 'pointer',\r\n                                                display: 'flex',\r\n                                                alignItems: 'center',\r\n                                                gap: '10px',\r\n                                                transition: 'all 0.2s'\r\n                                            }}\r\n                                            onMouseEnter={e => e.currentTarget.style.transform = 'translateX(5px)'}\r\n                                            onMouseLeave={e => e.currentTarget.style.transform = 'translateX(0)'}\r\n                                        >\r\n                                            <div style={{\r\n                                                width: '24px',\r\n                                                height: '24px',\r\n                                                borderRadius: '50%',\r\n                                                background: checklist[item] ? '#28a745' : '#dc3545',\r\n                                                color: 'white',\r\n                                                display: 'flex',\r\n                                                alignItems: 'center',\r\n                                                justifyContent: 'center',\r\n                                                fontSize: '14px',\r\n                                                fontWeight: 'bold'\r\n                                            }}>\r\n                                                {checklist[item] ? 'Γ£ô' : 'Γ£ù'}\r\n                                            </div>\r\n                                            <div style={{\r\n                                                flex: 1,\r\n                                                color: checklist[item] ? '#155724' : '#721c24',\r\n                                                fontWeight: checklist[item] ? 'normal' : 'bold'\r\n                                            }}>\r\n                                                {item}\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\InspectorMode.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Institution.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'setDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":66,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":72,"suggestions":[{"messageId":"removeVar","data":{"varName":"setDoc"},"fix":{"range":[124,132],"text":""},"desc":"Remove unused variable 'setDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'getAuth' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"getAuth"},"fix":{"range":[248,257],"text":""},"desc":"Remove unused variable 'getAuth'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useRef } from 'react';\r\nimport { collection, query, where, getDocs, doc, getDoc, addDoc, setDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { db, auth } from '../firebase';\r\nimport { onAuthStateChanged, getAuth } from 'firebase/auth';\r\nimport AIBadge from '../components/AIBadge';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport FeatureTour from '../components/FeatureTour';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport SmartAdmission from '../components/SmartAdmission';\r\n\r\nexport default function Institution() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n    const [submissions, setSubmissions] = useState([]);\r\n    const [profile, setProfile] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState(null);\r\n    const [showModal, setShowModal] = useState(false);\r\n    const [announcementText, setAnnouncementText] = useState('');\r\n    const [selectedClass, setSelectedClass] = useState('All');\r\n    const [selectedSection, setSelectedSection] = useState('All');\r\n    const [showSmartAdmission, setShowSmartAdmission] = useState(false);\r\n\r\n    const isNavigating = useRef(false);\r\n\r\n    // Feature Tour Steps\r\n    const tourSteps = [\r\n        {\r\n            target: 'tour-inst-smart',\r\n            title: '≡ƒô╕ AI Smart Admission',\r\n            content: 'Register hundreds of students instantly by scanning a roster image. Credentials will be generated automatically.'\r\n        },\r\n        {\r\n            target: 'tour-inst-announcement',\r\n            title: '≡ƒôó Announcements',\r\n            content: 'Broadcast messages to the entire institution or specific classes.'\r\n        },\r\n        {\r\n            target: 'tour-inst-allotment',\r\n            title: '≡ƒôÿ Teacher Allotments',\r\n            content: 'Assign teachers to classes and subjects here.'\r\n        },\r\n        {\r\n            target: 'tour-inst-admission',\r\n            title: '≡ƒô¥ New Admissions',\r\n            content: 'Manually register individual students.'\r\n        },\r\n        {\r\n            target: 'tour-inst-fees',\r\n            title: '≡ƒÆ░ Fee Management',\r\n            content: 'Track fee payments and manage dues.'\r\n        }\r\n    ];\r\n\r\n    const handleCardClick = (path) => {\r\n        if (isNavigating.current) return;\r\n        isNavigating.current = true;\r\n        navigate(path);\r\n        // Reset after delay\r\n        setTimeout(() => { isNavigating.current = false; }, 2000);\r\n    };\r\n\r\n    const handlePostAnnouncement = async () => {\r\n        if (!announcementText.trim()) return alert(\"Please enter some text.\");\r\n        try {\r\n            // Use userData from context instead of getAuth() directly for consistency\r\n            const uid = userData?.uid;\r\n            if (!uid) { alert(\"User not identified\"); return; }\r\n\r\n            await addDoc(collection(db, \"announcements\"), {\r\n                text: announcementText,\r\n                targetClass: selectedClass,\r\n                targetSection: selectedSection,\r\n                subject: 'General',\r\n                authorName: profile?.institutionName || 'Institution Admin',\r\n                authorId: uid,\r\n                institutionId: uid, // Added\r\n                role: 'institution',\r\n                createdAt: serverTimestamp()\r\n            });\r\n            setAnnouncementText('');\r\n            setSelectedClass('All');\r\n            setSelectedSection('All');\r\n            setShowModal(false);\r\n            alert(\"Announcement Posted Successfully! ≡ƒôó\");\r\n        } catch (e) {\r\n            console.error(\"Error posting announcement\", e);\r\n            alert(\"Failed to post announcement: \" + e.message);\r\n        }\r\n    };\r\n\r\n    const registerStudents = async (students) => {\r\n        if (students.length === 0) return;\r\n\r\n        const confirm = window.confirm(`Ready to import ${students.length} students?`);\r\n        if (!confirm) return;\r\n\r\n        setLoading(true);\r\n        try {\r\n            const token = await auth.currentUser.getIdToken();\r\n\r\n            // Use Vercel backend for API calls (Firebase Hosting is static-only)\r\n            const API_BASE = window.location.hostname === 'localhost'\r\n                ? ''  // dev proxy handles it\r\n                : 'https://together-to-refine.vercel.app';\r\n\r\n            const res = await fetch(`${API_BASE}/api/batch-register`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${token}`\r\n                },\r\n                body: JSON.stringify({ students })\r\n            });\r\n\r\n            const data = await res.json();\r\n            setLoading(false);\r\n\r\n            if (data.results) {\r\n                const successCount = data.results.success.length;\r\n                const failedCount = data.results.failed.length;\r\n\r\n                alert(`Import Complete!\\nSuccess: ${successCount}\\nFailed: ${failedCount}\\n\\nA credentials file will now download.`);\r\n\r\n                if (successCount > 0) {\r\n                    generateReport(data.results.success);\r\n                }\r\n            } else {\r\n                alert(\"Import failed: \" + (data.error || \"Unknown error\"));\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Batch register error:\", e);\r\n            alert(\"Error sending request: \" + e.message);\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const generateReport = (successList) => {\r\n        let reportContent = \"STUDENT CREDENTIALS REPORT\\n\" +\r\n            \"==================================\\n\" +\r\n            `Date: ${new Date().toLocaleString()}\\n` +\r\n            \"Note: Distribute these credentials securely to students.\\n\\n\";\r\n\r\n        successList.forEach(s => {\r\n            reportContent += `----------------------------------\\n`;\r\n            reportContent += `Name:     ${s.name}\\n`;\r\n            reportContent += `Class:    ${s.class}\\n`;\r\n            reportContent += `PID:      ${s.pid}\\n`;\r\n            reportContent += `Login ID: ${s.email}\\n`;\r\n            reportContent += `Password: ${s.password}\\n`;\r\n        });\r\n\r\n        const blob = new Blob([reportContent], { type: 'text/plain' });\r\n        const url = window.URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = `Student_Credentials_${new Date().toISOString().slice(0, 10)}.txt`;\r\n        document.body.appendChild(a);\r\n        a.click();\r\n        window.URL.revokeObjectURL(url);\r\n        document.body.removeChild(a);\r\n    };\r\n\r\n\r\n    const handleSmartImport = (scannedData) => {\r\n        setShowSmartAdmission(false);\r\n        registerStudents(scannedData);\r\n    };\r\n\r\n    useEffect(() => {\r\n        const unsubscribe = onAuthStateChanged(auth, async (user) => {\r\n            if (user) {\r\n                // Fetch Institution Profile\r\n                try {\r\n                    const docSnap = await getDoc(doc(db, \"institutions\", user.uid));\r\n                    if (docSnap.exists()) {\r\n                        const data = docSnap.data();\r\n                        setProfile(data);\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"Error fetching profile:\", e);\r\n                }\r\n\r\n                // Fetch submissions\r\n                try {\r\n                    const q = query(\r\n                        collection(db, \"submissions\"),\r\n                        where(\"institutionId\", \"==\", user.uid)\r\n                    );\r\n                    const snap = await getDocs(q);\r\n                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n                    setSubmissions(list);\r\n                } catch (e) {\r\n                    console.error(\"Error fetching submissions:\", e);\r\n                    if (e.code === 'permission-denied') {\r\n                        setError(\"Missing Permissions: Please update Firestore Security Rules in Firebase Console.\");\r\n                    } else {\r\n                        setError(\"Error fetching data. Check console.\");\r\n                    }\r\n                }\r\n            }\r\n            setLoading(false);\r\n        });\r\n        return () => unsubscribe();\r\n    }, []);\r\n\r\n    if (loading) return <div className=\"container\">Loading...</div>;\r\n\r\n    if (error) return (\r\n        <div style={{ padding: '20px', color: 'red', textAlign: 'center' }}>\r\n            <h2>ΓÜá∩╕Å Action Required</h2>\r\n            <p>{error}</p>\r\n            <p style={{ fontSize: '14px', color: '#555' }}>Go to Firebase Console &rarr; Firestore Database &rarr; Rules and set them to allow read/write.</p>\r\n        </div>\r\n    );\r\n\r\n    const handleGoToGroups = () => {\r\n        localStorage.removeItem(\"activeGroupId\");\r\n        handleCardClick('/group');\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <FeatureTour tourId=\"institution_dashboard_v1\" steps={tourSteps} userData={userData} />\r\n            <AIBadge />\r\n\r\n            <div className=\"container\">\r\n                {/* Clean Dashboard Greeting */}\r\n                <div className=\"dash-greeting-bar\">\r\n                    <div className=\"dash-greeting-left\">\r\n                        <div className=\"dash-avatar\" style={{ background: 'linear-gradient(135deg, #2c3e50 0%, #4a6080 100%)' }}>\r\n                            {(profile?.institutionName || 'I').charAt(0).toUpperCase()}\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"dash-welcome-label\">Institution Dashboard</p>\r\n                            <h1 className=\"dash-name\">{profile?.institutionName || 'Your Institution'}</h1>\r\n                            {profile?.principalName && (\r\n                                <p className=\"dash-meta\">Principal: {profile.principalName}{profile.estYear ? ` ┬╖ Est. ${profile.estYear}` : ''}</p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"dash-greeting-right\">\r\n                        <span className=\"dash-role-pill\">≡ƒÅ½ Admin</span>\r\n                        {profile?.pid && <span className=\"dash-id-pill\">ID: {profile.pid}</span>}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Administrative Fast Actions - Centered for Elite Balance */}\r\n                <div style={{\r\n                    marginBottom: '32px',\r\n                    display: 'flex',\r\n                    gap: '16px',\r\n                    flexWrap: 'wrap',\r\n                    justifyContent: 'center',\r\n                    alignItems: 'center'\r\n                }}>\r\n                    <button\r\n                        id=\"tour-inst-announcement\"\r\n                        onClick={() => setShowModal(true)}\r\n                        className=\"teacher-announcement-btn\"\r\n                        style={{\r\n                            background: 'var(--bg-surface)',\r\n                            color: 'var(--primary)',\r\n                            boxShadow: 'var(--shadow-sm)',\r\n                            width: '50px',\r\n                            height: '50px',\r\n                            fontSize: '24px'\r\n                        }}\r\n                        title=\"Broadcast Message\"\r\n                    >\r\n                        ≡ƒôó\r\n                    </button>\r\n                    <button\r\n                        id=\"tour-inst-smart\"\r\n                        onClick={() => setShowSmartAdmission(true)}\r\n                        className=\"btn\"\r\n                        style={{\r\n                            background: 'white',\r\n                            color: '#e056fd',\r\n                            border: '2px solid #e056fd',\r\n                            borderRadius: '30px',\r\n                            padding: '12px 28px',\r\n                            fontSize: '14px',\r\n                            fontWeight: '800'\r\n                        }}\r\n                    >\r\n                        ≡ƒô╕ AI Smart Admission\r\n                    </button>\r\n                </div>\r\n\r\n                {showSmartAdmission && (\r\n                    <SmartAdmission\r\n                        onClose={() => setShowSmartAdmission(false)}\r\n                        onScanComplete={handleSmartImport}\r\n                    />\r\n                )}\r\n\r\n                <div className=\"teacher-grid-system\" style={{ marginBottom: '32px' }}>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#6c5ce7' }} onClick={() => handleCardClick('/allotment')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒôÿ</span>\r\n                        <span className=\"teacher-vibe-label\">Allotments</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#0984e3' }} onClick={() => handleCardClick('/attendance')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒôà</span>\r\n                        <span className=\"teacher-vibe-label\">Attendance</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#00b894' }} onClick={handleGoToGroups}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒæÑ</span>\r\n                        <span className=\"teacher-vibe-label\">Groups</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#e84393' }} onClick={() => handleCardClick('/general-feedback')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒôè</span>\r\n                        <span className=\"teacher-vibe-label\">Feedback</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#ff7675' }} onClick={() => handleCardClick('/health')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒÅÑ</span>\r\n                        <span className=\"teacher-vibe-label\">Health</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#d63031' }} onClick={() => handleCardClick('/video-library')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒô║</span>\r\n                        <span className=\"teacher-vibe-label\">Video Lib</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#fdcb6e' }} onClick={() => handleCardClick('/timetable')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒùô∩╕Å</span>\r\n                        <span className=\"teacher-vibe-label\">Timetable</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#6c5ce7' }} onClick={() => handleCardClick('/faculty-feedback')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒæ¿ΓÇì≡ƒÅ½</span>\r\n                        <span className=\"teacher-vibe-label\">Faculty</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#2c3e50' }} onClick={() => handleCardClick('/fees/institution')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒÆ░</span>\r\n                        <span className=\"teacher-vibe-label\">Fee Mgmt</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#8e44ad' }} onClick={() => handleCardClick('/exam-seating')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒ¬æ</span>\r\n                        <span className=\"teacher-vibe-label\">Exam Seating</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#c0392b' }} onClick={() => handleCardClick('/library')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒôÜ</span>\r\n                        <span className=\"teacher-vibe-label\">Library</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#e74c3c' }} onClick={() => handleCardClick('/inspection-readiness')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒö┤</span>\r\n                        <span className=\"teacher-vibe-label\">Inspection</span>\r\n                    </div>\r\n                    <div className=\"teacher-vibe-card\" style={{ borderColor: '#16a085' }} onClick={() => handleCardClick('/student-promotion')}>\r\n                        <span className=\"teacher-vibe-icon\">≡ƒÄô</span>\r\n                        <span className=\"teacher-vibe-label\">Promotion</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"card\" style={{ padding: '20px', borderRadius: '15px' }}>\r\n                    <h3 className=\"text-center\" style={{ marginTop: 0 }}>Submissions</h3>\r\n                    <p className=\"text-center text-muted\" style={{ marginBottom: '20px' }}>Student & Teacher Excel View</p>\r\n\r\n                    {submissions.length === 0 ? (\r\n                        <p className=\"text-center\">No submissions yet.</p>\r\n                    ) : (\r\n                        <div style={{ overflowX: 'auto' }}>\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px', minWidth: '600px' }}>\r\n                                <thead>\r\n                                    <tr style={{ backgroundColor: '#f8f9fa', borderBottom: '2px solid #e9ecef' }}>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', color: '#495057' }}>Role</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', color: '#495057' }}>Name</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', color: '#495057' }}>Gender</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', color: '#495057' }}>Class/Exp</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', color: '#495057' }}>Sub. Date</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', color: '#495057' }}>Status</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {submissions.map(sub => (\r\n                                        <tr key={sub.id} style={{ borderBottom: '1px solid #f1f3f5' }}>\r\n                                            <td style={{ padding: '12px' }}>{sub.role}</td>\r\n                                            <td style={{ padding: '12px', fontWeight: '500' }}>{sub.firstName} {sub.secondName}</td>\r\n                                            <td style={{ padding: '12px' }}>{sub.gender}</td>\r\n                                            <td style={{ padding: '12px' }}>{sub.role === 'student' ? sub.class : `${sub.expYears || 0}y ${sub.expMonths || 0}m`}</td>\r\n                                            <td style={{ padding: '12px' }}>{sub.submittedAt ? new Date(sub.submittedAt.seconds * 1000).toLocaleDateString() : '-'}</td>\r\n                                            <td style={{ padding: '12px' }}>\r\n                                                <span style={{\r\n                                                    padding: '4px 10px',\r\n                                                    borderRadius: '12px',\r\n                                                    backgroundColor: sub.status === 'pending' ? '#fff3cd' : '#d4edda',\r\n                                                    color: sub.status === 'pending' ? '#856404' : '#155724',\r\n                                                    fontSize: '12px',\r\n                                                    fontWeight: '600'\r\n                                                }}>\r\n                                                    {sub.status}\r\n                                                </span>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Announcement Modal */}\r\n            {\r\n                showModal && (\r\n                    <div style={{\r\n                        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                        background: 'rgba(0,0,0,0.8)', zIndex: 3000,\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                    }}>\r\n                        <div className=\"card\" style={{ width: '90%', maxWidth: '500px' }}>\r\n                            <h3>≡ƒôó Make Institution Announcement</h3>\r\n                            <p className=\"text-muted\" style={{ fontSize: '12px' }}>This will be visible to all students and teachers.</p>\r\n\r\n                            <div style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>\r\n                                <div style={{ flex: 1 }}>\r\n                                    <label style={{ fontSize: '12px', color: '#666', display: 'block' }}>Class:</label>\r\n                                    <select\r\n                                        className=\"input-field\"\r\n                                        value={selectedClass}\r\n                                        onChange={(e) => setSelectedClass(e.target.value)}\r\n                                        style={{ margin: 0 }}\r\n                                    >\r\n                                        <option value=\"All\">All Classes</option>\r\n                                        <option value=\"Nursery\">Nursery</option>\r\n                                        <option value=\"LKG\">LKG</option>\r\n                                        <option value=\"UKG\">UKG</option>\r\n                                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(c => <option key={c} value={c.toString()}>Class {c}</option>)}\r\n                                    </select>\r\n                                </div>\r\n                                <div style={{ flex: 1 }}>\r\n                                    <label style={{ fontSize: '12px', color: '#666', display: 'block' }}>Section:</label>\r\n                                    <select\r\n                                        className=\"input-field\"\r\n                                        value={selectedSection}\r\n                                        onChange={(e) => setSelectedSection(e.target.value)}\r\n                                        style={{ margin: 0 }}\r\n                                    >\r\n                                        <option value=\"All\">All Sections</option>\r\n                                        <option value=\"A\">Section A</option>\r\n                                        <option value=\"B\">Section B</option>\r\n                                        <option value=\"C\">Section C</option>\r\n                                        <option value=\"D\">Section D</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <textarea\r\n                                className=\"input-field\"\r\n                                rows=\"4\"\r\n                                placeholder=\"Type your announcement here...\"\r\n                                value={announcementText}\r\n                                onChange={(e) => setAnnouncementText(e.target.value)}\r\n                            />\r\n                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px', marginTop: '10px' }}>\r\n                                <button className=\"btn-outline\" onClick={() => setShowModal(false)} style={{ padding: '8px 16px', border: '1px solid #ccc', background: 'transparent', borderRadius: '4px', cursor: 'pointer' }}>Cancel</button>\r\n                                <button className=\"btn\" onClick={handlePostAnnouncement}>Post</button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )\r\n            }\r\n\r\n            {/* End of Modals */}\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\InstitutionDetailsAdmin.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":65,"suggestions":[{"messageId":"removeVar","data":{"varName":"orderBy"},"fix":{"range":[143,152],"text":""},"desc":"Remove unused variable 'orderBy'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { db } from '../firebase';\r\nimport { doc, getDoc, collection, query, where, getDocs, orderBy } from 'firebase/firestore';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport AIBadge from '../components/AIBadge';\r\n\r\nexport default function InstitutionDetailsAdmin() {\r\n    const { id } = useParams();\r\n    const navigate = useNavigate();\r\n    const [instData, setInstData] = useState(null);\r\n    const [stats, setStats] = useState({\r\n        students: 0,\r\n        teachers: 0,\r\n        feedbacks: 0\r\n    });\r\n    const [loading, setLoading] = useState(true);\r\n    const [activeTab, setActiveTab] = useState('overview'); // overview, teachers, students, feedback\r\n\r\n    // Lists for drill-down\r\n    const [teacherList, setTeacherList] = useState([]);\r\n    const [studentList, setStudentList] = useState([]);\r\n    const [feedbackList, setFeedbackList] = useState([]);\r\n\r\n    useEffect(() => {\r\n        const fetchData = async () => {\r\n            try {\r\n                // 1. Fetch Institution Profile\r\n                console.log(\"Fetching Institution:\", id);\r\n                const instRef = doc(db, \"institutions\", id);\r\n                const instSnap = await getDoc(instRef);\r\n                if (!instSnap.exists()) {\r\n                    alert(\"Institution not found!\");\r\n                    navigate('/admin');\r\n                    return;\r\n                }\r\n                const iData = instSnap.data();\r\n                setInstData(iData);\r\n\r\n                // 2. Fetch Students\r\n                try {\r\n                    const studentsSnap = await getDocs(query(collection(db, \"users\"), where(\"institutionId\", \"==\", id)));\r\n                    setStats(prev => ({ ...prev, students: studentsSnap.size }));\r\n                    const sList = [];\r\n                    studentsSnap.forEach(d => sList.push({ id: d.id, ...d.data() }));\r\n                    sList.sort((a, b) => (a.name || \"\").localeCompare(b.name || \"\"));\r\n                    setStudentList(sList);\r\n                } catch (e) { console.error(\"Error fetching students:\", e); }\r\n\r\n                // 3. Fetch Teachers\r\n                try {\r\n                    const teachersSnap = await getDocs(query(collection(db, \"teachers\"), where(\"institutionId\", \"==\", id)));\r\n                    setStats(prev => ({ ...prev, teachers: teachersSnap.size }));\r\n                    const tList = [];\r\n                    teachersSnap.forEach(d => tList.push({ id: d.id, ...d.data() }));\r\n                    tList.sort((a, b) => (a.name || \"\").localeCompare(b.name || \"\"));\r\n                    setTeacherList(tList);\r\n                } catch (e) { console.error(\"Error fetching teachers:\", e); }\r\n\r\n                // 4. Fetch Feedbacks (Directly targeting this Institution) AND Emergency Reports\r\n                try {\r\n                    console.log(\"Fetching Feedback & Reports for Target ID:\", id);\r\n\r\n                    // Parallel Fetch\r\n                    const [feedbacksSnap, reportsSnap] = await Promise.all([\r\n                        getDocs(query(collection(db, \"general_feedback\"), where(\"targetId\", \"==\", id))),\r\n                        getDocs(query(collection(db, \"emergency_reports\"), where(\"institutionId\", \"==\", id)))\r\n                    ]);\r\n\r\n                    console.log(\"Feedback Count:\", feedbacksSnap.size, \"Reports Count:\", reportsSnap.size);\r\n\r\n                    let mergedList = [];\r\n\r\n                    // Standard Feedbacks\r\n                    feedbacksSnap.forEach(d => mergedList.push({ id: d.id, isReport: false, ...d.data() }));\r\n\r\n                    // Emergency Reports\r\n                    reportsSnap.forEach(d => mergedList.push({ id: d.id, isReport: true, ...d.data() }));\r\n\r\n                    // Update stats\r\n                    setStats(prev => ({ ...prev, feedbacks: mergedList.length }));\r\n\r\n                    // Sort: Newest First\r\n                    mergedList.sort((a, b) => {\r\n                        const tA = a.timestamp?.seconds || a.createdAt?.seconds || 0;\r\n                        const tB = b.timestamp?.seconds || b.createdAt?.seconds || 0;\r\n                        return tB - tA;\r\n                    });\r\n\r\n                    setFeedbackList(mergedList);\r\n\r\n                } catch (e) { console.error(\"Error fetching feedback/reports:\", e); }\r\n\r\n            } catch (e) {\r\n                console.error(\"Error in main fetch:\", e);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        if (id) fetchData();\r\n    }, [id, navigate]);\r\n\r\n    if (loading) return <div className=\"container\" style={{ textAlign: 'center', marginTop: '50px' }}>Loading Details...</div>;\r\n    if (!instData) return null;\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ background: '#f1f2f6', minHeight: '100vh', paddingBottom: '30px' }}>\r\n            <AIBadge />\r\n            <AnnouncementBar title=\"Institution Overview\" leftIcon={false} backPath=\"/admin\" />\r\n\r\n            <div className=\"container\" style={{ maxWidth: '1000px', margin: '30px auto' }}>\r\n\r\n                {/* Header Profile Card */}\r\n                <div className=\"card\" style={{ display: 'flex', alignItems: 'center', gap: '20px', padding: '30px', marginBottom: '20px' }}>\r\n                    <img\r\n                        src={instData.profileImageURL || \"https://via.placeholder.com/150?text=Inst\"}\r\n                        alt=\"Profile\"\r\n                        style={{ width: '100px', height: '100px', borderRadius: '50%', objectFit: 'cover', border: '4px solid #eee' }}\r\n                    />\r\n                    <div>\r\n                        <h1 style={{ margin: '0 0 5px 0', fontSize: '24px' }}>{instData.institutionName || instData.schoolName}</h1>\r\n                        <p style={{ margin: 0, color: '#636e72' }}>Established: {instData.estYear || 'N/A'} ΓÇó ID: {instData.pid || 'N/A'}</p>\r\n                        <div style={{ marginTop: '10px' }}>\r\n                            <span style={{ background: instData.approved ? '#d4edda' : '#fff3cd', color: instData.approved ? '#155724' : '#856404', padding: '4px 10px', borderRadius: '15px', fontSize: '12px' }}>\r\n                                {instData.approved ? 'Active' : 'Pending Approval'}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Navigation Tabs - Sticky */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    gap: '10px',\r\n                    marginBottom: '20px',\r\n                    overflowX: 'auto',\r\n                    position: 'sticky',\r\n                    top: '60px',\r\n                    zIndex: 10,\r\n                    background: '#f1f2f6',\r\n                    padding: '10px 0',\r\n                    borderBottom: '1px solid #dfe6e9'\r\n                }}>\r\n                    {['overview', 'teachers', 'students', 'feedback'].map(tab => (\r\n                        <button\r\n                            key={tab}\r\n                            onClick={() => setActiveTab(tab)}\r\n                            className=\"btn\"\r\n                            style={{\r\n                                flex: 1,\r\n                                background: activeTab === tab ? '#0984e3' : 'white',\r\n                                color: activeTab === tab ? 'white' : '#2d3436',\r\n                                border: '1px solid #dfe6e9',\r\n                                textTransform: 'capitalize',\r\n                                whiteSpace: 'nowrap',\r\n                                minWidth: '100px'\r\n                            }}\r\n                        >\r\n                            {tab}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Content Sections */}\r\n                {activeTab === 'overview' && (\r\n                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px' }}>\r\n                        <div className=\"card\">\r\n                            <h3>≡ƒÅ¢∩╕Å Administration</h3>\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <div style={{ fontSize: '12px', color: '#b2bec3' }}>Principal</div>\r\n                                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{instData.principalName}</div>\r\n                                <div style={{ fontSize: '14px' }}>\r\n                                    {instData.principalPhone || instData.phoneNumber || 'No Phone'}\r\n                                    {instData.principalLink && <a href={instData.principalLink} target=\"_blank\" rel=\"noreferrer\" style={{ display: 'block', fontSize: '12px' }}>View Profile</a>}\r\n                                </div>\r\n                            </div>\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <div style={{ fontSize: '12px', color: '#b2bec3' }}>Chairman</div>\r\n                                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{instData.chairmanName || 'N/A'}</div>\r\n                                <div style={{ fontSize: '14px' }}>\r\n                                    {instData.chairmanPhone || instData.phoneNumber || 'No Phone'}\r\n                                    {instData.chairmanLink && <a href={instData.chairmanLink} target=\"_blank\" rel=\"noreferrer\" style={{ display: 'block', fontSize: '12px' }}>View Profile</a>}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"card\">\r\n                            <h3>≡ƒôì Location & Safety</h3>\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <div style={{ fontSize: '12px', color: '#b2bec3' }}>Address</div>\r\n                                <div>{instData.address || 'Not Provided'}</div>\r\n                            </div>\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <div style={{ fontSize: '12px', color: '#b2bec3' }}>City/State</div>\r\n                                <div>{instData.city}, {instData.state}</div>\r\n                            </div>\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <div style={{ fontSize: '12px', color: '#b2bec3' }}>Nearest Police Station</div>\r\n                                <div>{instData.localPoliceName || instData.policeStation || 'Not Listed'}</div>\r\n                                <div>{instData.localPolicePhone}</div>\r\n                            </div>\r\n                            <div style={{ marginBottom: '15px' }}>\r\n                                <div style={{ fontSize: '12px', color: '#b2bec3' }}>Official Contact</div>\r\n                                <div>Ph: {instData.phoneNumber}</div>\r\n                                {instData.whatsappNumber && <div>WA: {instData.whatsappNumber}</div>}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"card\" onClick={() => setActiveTab('students')} style={{ cursor: 'pointer' }}>\r\n                            <h3>≡ƒôè Stats</h3>\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                <span>Total Students</span>\r\n                                <strong>{stats.students}</strong>\r\n                            </div>\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                <span>Total Teachers</span>\r\n                                <strong>{stats.teachers}</strong>\r\n                            </div>\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\r\n                                <span>Total Feedbacks</span>\r\n                                <strong>{stats.feedbacks}</strong>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* ... (Teachers & Students blocks remain same, skipping them in replacement if possible, but MultiReplace might need exact chunks) */}\r\n                {/* I will use the MultiReplace tool logic effectively or just replace the Overview and Feedback blocks separately if they were contiguous, but they are not. */}\r\n                {/* Actually, I handle 'overview' above. I'll handle 'feedback' in a separate chunk or same tool call. */}\r\n\r\n                {activeTab === 'teachers' && (\r\n                    <div className=\"card\">\r\n                        <h3>≡ƒæ¿ΓÇì≡ƒÅ½ Teachers List ({teacherList.length})</h3>\r\n                        {teacherList.length === 0 ? <p>No teachers found.</p> : (\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>\r\n                                <thead>\r\n                                    <tr style={{ textAlign: 'left', background: '#f8f9fa' }}><th style={{ padding: '10px', width: '40px' }}>#</th><th style={{ padding: '10px' }}>Name</th><th style={{ padding: '10px' }}>Phone</th><th style={{ padding: '10px' }}>Subject</th></tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {teacherList.map((t, index) => (\r\n                                        <tr key={t.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                            <td style={{ padding: '10px', color: '#636e72', fontWeight: 'bold' }}>{index + 1}</td>\r\n                                            <td style={{ padding: '10px' }}>{t.name || `${t.firstName || ''} ${t.secondName || ''}`.trim() || 'No Name'}</td>\r\n                                            <td style={{ padding: '10px' }}>{t.phone || t.phoneNumber || 'N/A'}</td>\r\n                                            <td style={{ padding: '10px' }}>{t.subject}</td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {activeTab === 'students' && (\r\n                    <div className=\"card\">\r\n                        <h3>≡ƒÄô Students List ({studentList.length})</h3>\r\n                        {studentList.length === 0 ? <p>No students found.</p> : (\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>\r\n                                <thead>\r\n                                    <tr style={{ textAlign: 'left', background: '#f8f9fa' }}><th style={{ padding: '10px', width: '40px' }}>#</th><th style={{ padding: '10px' }}>Name</th><th style={{ padding: '10px' }}>Class</th><th style={{ padding: '10px' }}>Roll No</th></tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {studentList.map((s, index) => (\r\n                                        <tr key={s.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                            <td style={{ padding: '10px', color: '#636e72', fontWeight: 'bold' }}>{index + 1}</td>\r\n                                            <td style={{ padding: '10px' }}>{s.name || `${s.firstName || ''} ${s.secondName || ''}`.trim() || 'No Name'}</td>\r\n                                            <td style={{ padding: '10px' }}>{s.assignedClass || s.class} {s.section}</td>\r\n                                            <td style={{ padding: '10px' }}>{s.rollNumber || 'N/A'}</td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {activeTab === 'feedback' && (\r\n                    <div className=\"card\">\r\n                        <h3>≡ƒÆ¼ Institution Feedback ({feedbackList.length})</h3>\r\n                        {feedbackList.length === 0 ? <p>No feedback received yet.</p> : (\r\n                            <div style={{ display: 'grid', gap: '15px' }}>\r\n                                {feedbackList.map(f => {\r\n                                    if (f.isReport) {\r\n                                        // RENDER RED REPORT CARD\r\n                                        return (\r\n                                            <div key={f.id} style={{ padding: '20px', border: '2px solid #ff7675', borderRadius: '12px', background: '#fff0f0' }}>\r\n                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                                    <div>\r\n                                                        <strong style={{ color: '#d63031', fontSize: '16px' }}>\r\n                                                            {f.type === 'sexual_harassment' ? '≡ƒÜ¿ SEXUAL HARASSMENT REPORT' : 'ΓÜá∩╕Å MISBEHAVIOR REPORT'}\r\n                                                        </strong>\r\n                                                        <span style={{ display: 'block', fontSize: '13px', color: '#636e72', marginTop: '4px' }}>\r\n                                                            From: {f.authorName || 'Anonymous'} ({f.authorRole})\r\n                                                        </span>\r\n                                                    </div>\r\n                                                    <span style={{ fontSize: '12px', color: '#b2bec3' }}>{f.createdAt?.seconds ? new Date(f.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span>\r\n                                                </div>\r\n\r\n                                                <div style={{ marginBottom: '10px', fontSize: '14px', color: '#2d3436' }}>\r\n                                                    <span style={{ fontWeight: 'bold' }}>Accused:</span> {f.accusedName}\r\n                                                </div>\r\n                                                <div style={{ marginBottom: '10px', fontSize: '14px', color: '#2d3436' }}>\r\n                                                    <span style={{ fontWeight: 'bold' }}>Location:</span> {f.location}\r\n                                                </div>\r\n                                                <div style={{ marginBottom: '10px', fontSize: '14px', color: '#2d3436' }}>\r\n                                                    <span style={{ fontWeight: 'bold' }}>Date/Time:</span> {new Date(f.incidentDate).toLocaleString()}\r\n                                                </div>\r\n\r\n                                                <p style={{ margin: '5px 0', background: 'white', padding: '10px', border: '1px solid #ffdcdc', borderRadius: '5px', color: '#d63031' }}>\r\n                                                    \"{f.description}\"\r\n                                                </p>\r\n\r\n                                                {f.evidence && (\r\n                                                    <div style={{ marginTop: '10px' }}>\r\n                                                        <a href={f.evidence} target=\"_blank\" rel=\"noreferrer\" style={{ color: '#0984e3', textDecoration: 'underline', fontSize: '14px' }}>View Evidence</a>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        );\r\n                                    } else {\r\n                                        // STANDARD FEEDBACK CARD\r\n                                        return (\r\n                                            <div key={f.id} style={{ padding: '20px', border: '1px solid #eee', borderRadius: '12px', background: '#fff' }}>\r\n                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>\r\n                                                    <div>\r\n                                                        <strong>{f.authorName || \"Anonymous\"}</strong> <span style={{ fontSize: '12px', color: '#636e72' }}>({f.authorRole || 'User'})</span>\r\n                                                    </div>\r\n                                                    <span style={{ fontSize: '12px', color: '#b2bec3' }}>{f.timestamp?.seconds ? new Date(f.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}</span>\r\n                                                </div>\r\n\r\n                                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '10px' }}>\r\n                                                    {['behavior', 'communication', 'bodyLanguage', 'hardworking'].map(cat => f[cat] ? (\r\n                                                        <span key={cat} style={{ fontSize: '12px', background: '#f1f2f6', padding: '5px 10px', borderRadius: '15px' }}>\r\n                                                            {cat.charAt(0).toUpperCase() + cat.slice(1)}: <strong>{f[cat].stars}Γÿà</strong>\r\n                                                        </span>\r\n                                                    ) : null)}\r\n                                                </div>\r\n\r\n                                                {f.comment && <p style={{ margin: '5px 0', fontStyle: 'italic', color: '#2d3436' }}>\"{f.comment}\"</p>}\r\n                                            </div>\r\n                                        );\r\n                                    }\r\n                                })}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\InstitutionFee.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  112 |     useEffect(() => {\n  113 |         if (!targetClass) {\n> 114 |             setPreviewList([]);\n      |             ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  115 |             setSchoolStats(prev => ({ ...prev, matchingNow: 0 }));\n  116 |             return;\n  117 |         }","line":114,"column":13,"nodeType":null,"endLine":114,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, serverTimestamp, writeBatch, doc } from 'firebase/firestore';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\nexport default function InstitutionFee() {\r\n    const { userData } = useUser();\r\n    const [targetClass, setTargetClass] = useState('');\r\n    const [targetSection, setTargetSection] = useState('All');\r\n    const [title, setTitle] = useState('');\r\n    const [amount, setAmount] = useState('');\r\n    const [dueDate, setDueDate] = useState('');\r\n    const [loading, setLoading] = useState(false);\r\n    const [recentFees, setRecentFees] = useState([]);\r\n\r\n    // Detailed stats\r\n    const [schoolStats, setSchoolStats] = useState({\r\n        total: 0,\r\n        approved: 0,\r\n        unlinked: 0,\r\n        matchingNow: 0\r\n    });\r\n    const [allStudentAllotments, setAllStudentAllotments] = useState([]);\r\n    const [previewList, setPreviewList] = useState([]);\r\n\r\n    const navigate = useNavigate();\r\n\r\n    const classOptions = [\r\n        { label: 'Nursery', value: 'Nursery' }, { label: 'LKG', value: 'LKG' }, { label: 'UKG', value: 'UKG' },\r\n        { label: '1', value: '1st' }, { label: '2', value: '2nd' }, { label: '3', value: '3rd' },\r\n        { label: '4', value: '4th' }, { label: '5', value: '5th' }, { label: '6', value: '6th' },\r\n        { label: '7', value: '7th' }, { label: '8', value: '8th' }, { label: '9', value: '9th' },\r\n        { label: '10', value: '10th' }\r\n    ];\r\n\r\n    const sectionOptions = ['All', 'A', 'B', 'C', 'D', 'E'];\r\n\r\n    const normalizeClass = (c) => {\r\n        if (!c) return '';\r\n        let s = String(c).trim().toLowerCase();\r\n        s = s.replace(/(st|nd|rd|th)$/, '');\r\n        if (s === '1') return '1st';\r\n        if (s === '2') return '2nd';\r\n        if (s === '3') return '3rd';\r\n        const num = parseInt(s);\r\n        if (!isNaN(num) && num >= 4 && num <= 12) return num + 'th';\r\n        return s.charAt(0).toUpperCase() + s.slice(1);\r\n    };\r\n\r\n    // Calculate Institution ID correctly (Owner vs Staff)\r\n    const instId = userData?.role === 'institution' ? userData?.uid : userData?.institutionId;\r\n\r\n    // 1. Initial Data Fetch (School Stats & Recent Activity)\r\n    useEffect(() => {\r\n        if (!instId) return;\r\n\r\n        const fetchData = async () => {\r\n            try {\r\n                // A. Fetch Recent Fees\r\n                const qFees = query(collection(db, \"fees\"), where(\"institutionId\", \"==\", instId));\r\n                const feeSnap = await getDocs(qFees);\r\n                const uniqueTitles = {};\r\n                feeSnap.docs.forEach(d => {\r\n                    const data = d.data();\r\n                    const key = `${data.title}-${data.class}-${data.section || 'All'}`;\r\n                    if (!uniqueTitles[key] || (data.createdAt?.seconds > uniqueTitles[key].createdAt?.seconds)) {\r\n                        uniqueTitles[key] = { id: d.id, ...data };\r\n                    }\r\n                });\r\n                const feeList = Object.values(uniqueTitles).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));\r\n                setRecentFees(feeList.slice(0, 5));\r\n\r\n                // B. Fetch FROM STUDENT_ALLOTMENTS (This is the 40+ list!)\r\n                // We check both 'createdBy' and 'institutionId' for maximum compatibility\r\n                const fetchProms = [\r\n                    getDocs(query(collection(db, \"student_allotments\"), where(\"institutionId\", \"==\", instId))),\r\n                    getDocs(query(collection(db, \"student_allotments\"), where(\"createdBy\", \"==\", instId)))\r\n                ];\r\n\r\n                const snaps = await Promise.all(fetchProms);\r\n                const mergedMap = new Map();\r\n                snaps.forEach(snap => {\r\n                    snap.forEach(d => {\r\n                        if (!mergedMap.has(d.id)) {\r\n                            mergedMap.set(d.id, { id: d.id, ...d.data() });\r\n                        }\r\n                    });\r\n                });\r\n\r\n                const allotments = Array.from(mergedMap.values());\r\n                console.log(`Found ${allotments.length} student allotments for school.`);\r\n                setAllStudentAllotments(allotments);\r\n\r\n                // Categorize for stats\r\n                setSchoolStats(prev => ({\r\n                    ...prev,\r\n                    total: allotments.length,\r\n                    approved: allotments.filter(s => s.userId).length, // If it has a userId, they have joined the app\r\n                    unlinked: allotments.filter(s => !s.userId).length\r\n                }));\r\n\r\n            } catch (e) {\r\n                console.error(\"Fetch Error:\", e);\r\n            }\r\n        };\r\n        fetchData();\r\n    }, [instId]);\r\n\r\n    // 2. Live Preview Filter\r\n    useEffect(() => {\r\n        if (!targetClass) {\r\n            setPreviewList([]);\r\n            setSchoolStats(prev => ({ ...prev, matchingNow: 0 }));\r\n            return;\r\n        }\r\n\r\n        const normalizedTarget = normalizeClass(targetClass);\r\n        const filtered = allStudentAllotments.filter(s => {\r\n            // Allotments use 'classAssigned' field\r\n            const matchesClass = normalizeClass(s.classAssigned) === normalizedTarget;\r\n            const matchesSection = targetSection === 'All' || s.section === targetSection;\r\n            return matchesClass && matchesSection;\r\n        });\r\n\r\n        setPreviewList(filtered.slice(0, 10)); // Show top 10 names\r\n        setSchoolStats(prev => ({ ...prev, matchingNow: filtered.length }));\r\n    }, [targetClass, targetSection, allStudentAllotments]);\r\n\r\n    const handleAssignFee = async (e) => {\r\n        if (e) e.preventDefault();\r\n\r\n        if (!instId) {\r\n            window.alert(\"Session Error: Please log in again.\");\r\n            return;\r\n        }\r\n\r\n        if (!targetClass || !title || !amount || !dueDate) {\r\n            window.alert(\"Please complete the form.\");\r\n            return;\r\n        }\r\n\r\n        const normalizedTarget = normalizeClass(targetClass);\r\n        const finalStudents = allStudentAllotments.filter(s => {\r\n            const matchesClass = normalizeClass(s.classAssigned) === normalizedTarget;\r\n            const matchesSection = targetSection === 'All' || s.section === targetSection;\r\n            return matchesClass && matchesSection;\r\n        });\r\n\r\n        if (finalStudents.length === 0) {\r\n            window.alert(`No students found for ${targetClass} ${targetSection}.`);\r\n            return;\r\n        }\r\n\r\n        const totalValue = finalStudents.length * Number(amount);\r\n        if (!window.confirm(`Assign fee to ALL ${finalStudents.length} students in this class roster?\\n\\n(Includes both registered and pending students)\\n\\nTotal Billing: Γé╣${totalValue.toLocaleString()}`)) {\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n\r\n        try {\r\n            const batch = writeBatch(db);\r\n            const processedIds = new Set();\r\n\r\n            finalStudents.forEach(sDoc => {\r\n                // KEY FIX: Use userId if they have joined, otherwise use the Allotment ID!\r\n                const studentIdToUse = sDoc.userId || sDoc.id;\r\n\r\n                // DEDUPLICATION: Prevent double-billing if student appears twice in roster\r\n                if (processedIds.has(studentIdToUse)) return;\r\n                processedIds.add(studentIdToUse);\r\n\r\n                const feeRef = doc(collection(db, \"fees\"));\r\n\r\n                batch.set(feeRef, {\r\n                    studentId: studentIdToUse,\r\n                    allotmentId: sDoc.id, // Keep a reference to the school's record\r\n                    studentName: sDoc.name || sDoc.studentName || \"Student\",\r\n                    institutionId: instId,\r\n                    institutionName: userData.schoolName || userData.name || \"School\",\r\n                    title,\r\n                    amount: Number(amount),\r\n                    dueDate,\r\n                    class: normalizedTarget,\r\n                    section: sDoc.section || 'All',\r\n                    status: 'pending',\r\n                    createdAt: serverTimestamp()\r\n                });\r\n            });\r\n\r\n            await batch.commit();\r\n            window.alert(`Γ£à Success!\\n\\nFee assigned to all ${finalStudents.length} students correctly.`);\r\n\r\n            setTitle('');\r\n            setAmount('');\r\n            setDueDate('');\r\n            setLoading(false);\r\n\r\n            // Update local recent list\r\n            setRecentFees(prev => [{\r\n                id: 'new-' + Date.now(),\r\n                title,\r\n                amount,\r\n                class: normalizedTarget,\r\n                section: targetSection,\r\n                createdAt: { seconds: Date.now() / 1000 }\r\n            }, ...prev].slice(0, 5));\r\n\r\n        } catch (err) {\r\n            console.error(\"Assignment Error:\", err);\r\n            window.alert(\"Error: \" + err.message);\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ padding: '20px', maxWidth: '1000px', margin: '0 auto' }}>\r\n            {/* TOP STATS BAR */}\r\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>\r\n                <button className=\"btn\" onClick={() => navigate(-1)} style={{ background: '#f1f2f6', color: '#2f3542', border: 'none', borderRadius: '12px', padding: '10px 20px' }}>\r\n                    ΓåÉ Dashboard\r\n                </button>\r\n                <div style={{ display: 'flex', gap: '10px' }}>\r\n                    <div className=\"stat-pill\" style={{ background: '#e1f5fe', color: '#01579b', padding: '8px 15px', borderRadius: '20px', fontSize: '0.8rem', fontWeight: 'bold' }}>\r\n                        ≡ƒôï {schoolStats.total} Total Students (Roster)\r\n                    </div>\r\n                    <div className=\"stat-pill\" style={{ background: '#e8f5e9', color: '#2e7d32', padding: '8px 15px', borderRadius: '20px', fontSize: '0.8rem', fontWeight: 'bold' }}>\r\n                        ≡ƒô▒ {schoolStats.approved} Registered on App\r\n                    </div>\r\n                    {schoolStats.unlinked > 0 && (\r\n                        <div className=\"stat-pill\" style={{ background: '#fff3e0', color: '#ef6c00', padding: '8px 15px', borderRadius: '20px', fontSize: '0.8rem', fontWeight: 'bold' }}>\r\n                            Γ£ë∩╕Å {schoolStats.unlinked} Invitation Sent\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            <h1 style={{ textAlign: 'center', fontWeight: '900', color: '#2d3436', marginBottom: '40px' }}>Fee Administration</h1>\r\n\r\n            <div style={{ display: 'grid', gridTemplateColumns: '1.2fr 0.8fr', gap: '30px' }}>\r\n\r\n                <div className=\"card\" style={{ padding: '40px', borderRadius: '30px', boxShadow: '0 15px 35px rgba(0,0,0,0.05)', background: 'white' }}>\r\n                    <h3 style={{ marginBottom: '25px', color: '#2d3436' }}>New Assignment</h3>\r\n\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>\r\n                        <div>\r\n                            <label style={{ display: 'block', fontWeight: '700', fontSize: '0.85rem', marginBottom: '8px' }}>Fee Title</label>\r\n                            <input className=\"input-field\" placeholder=\"Tuition Fee Term 1\" value={title} onChange={e => setTitle(e.target.value)} style={{ padding: '15px', borderRadius: '15px' }} />\r\n                        </div>\r\n\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>\r\n                            <div>\r\n                                <label style={{ display: 'block', fontWeight: '700', fontSize: '0.85rem', marginBottom: '8px' }}>Amount (Γé╣)</label>\r\n                                <input type=\"number\" className=\"input-field\" placeholder=\"1000\" value={amount} onChange={e => setAmount(e.target.value)} style={{ padding: '15px', borderRadius: '15px' }} />\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ display: 'block', fontWeight: '700', fontSize: '0.85rem', marginBottom: '8px' }}>Due Date</label>\r\n                                <input type=\"date\" className=\"input-field\" value={dueDate} onChange={e => setDueDate(e.target.value)} style={{ padding: '15px', borderRadius: '15px' }} />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>\r\n                            <div>\r\n                                <label style={{ display: 'block', fontWeight: '700', fontSize: '0.85rem', marginBottom: '8px' }}>Class</label>\r\n                                <select className=\"input-field\" value={targetClass} onChange={e => setTargetClass(e.target.value)} style={{ padding: '15px', borderRadius: '15px' }}>\r\n                                    <option value=\"\">-- Select --</option>\r\n                                    {classOptions.map(opt => <option key={opt.value} value={opt.value}>Class {opt.label}</option>)}\r\n                                </select>\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ display: 'block', fontWeight: '700', fontSize: '0.85rem', marginBottom: '8px' }}>Section</label>\r\n                                <select className=\"input-field\" value={targetSection} onChange={e => setTargetSection(e.target.value)} style={{ padding: '15px', borderRadius: '15px' }}>\r\n                                    {sectionOptions.map(s => <option key={s} value={s}>{s === 'All' ? 'All Sections' : `Section ${s}`}</option>)}\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {targetClass && (\r\n                            <div style={{ background: '#f8f9fa', padding: '20px', borderRadius: '20px', border: '1px solid #e9ecef' }}>\r\n                                <div style={{ fontWeight: 'bold', color: '#0fb9b1', display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                    ≡ƒÄ» Targeting {schoolStats.matchingNow} Total Students\r\n                                </div>\r\n                                {previewList.length > 0 && (\r\n                                    <div style={{ marginTop: '10px', fontSize: '0.8rem', color: '#636e72' }}>\r\n                                        Roster Preview: {previewList.map(s => s.name || s.studentName).join(', ')} {schoolStats.matchingNow > 10 ? '...' : ''}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        <button\r\n                            onClick={handleAssignFee}\r\n                            disabled={loading}\r\n                            className=\"btn\"\r\n                            style={{\r\n                                background: loading ? '#ccc' : '#2d3436',\r\n                                color: 'white',\r\n                                padding: '20px',\r\n                                borderRadius: '20px',\r\n                                fontWeight: '800',\r\n                                fontSize: '1.1rem',\r\n                                marginTop: '10px',\r\n                                textTransform: 'uppercase',\r\n                                letterSpacing: '1px'\r\n                            }}\r\n                        >\r\n                            {loading ? 'Batch Saving...' : 'Confirm Assignment'}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>\r\n                    <div className=\"card\" style={{ padding: '25px', borderRadius: '24px', background: '#f8f9fa', border: 'none' }}>\r\n                        <h4 style={{ marginBottom: '15px', color: '#636e72' }}>≡ƒòÆ Recent Activity</h4>\r\n                        <p style={{ fontSize: '0.75rem', color: '#999', marginBottom: '10px' }}>Click to view payment status</p>\r\n                        {recentFees.length === 0 ? <p className=\"text-muted\" style={{ fontSize: '0.9rem' }}>No recent records.</p> : (\r\n                            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                                {recentFees.map(f => (\r\n                                    <div\r\n                                        key={f.id}\r\n                                        onClick={() => navigate(`/fee-details/${f.id}?class=${f.class}&section=${f.section}&title=${encodeURIComponent(f.title)}`)}\r\n                                        style={{\r\n                                            background: 'white',\r\n                                            padding: '15px',\r\n                                            borderRadius: '12px',\r\n                                            display: 'flex',\r\n                                            justifyContent: 'space-between',\r\n                                            fontSize: '0.85rem',\r\n                                            boxShadow: '0 2px 5px rgba(0,0,0,0.02)',\r\n                                            cursor: 'pointer',\r\n                                            transition: 'all 0.2s'\r\n                                        }}\r\n                                        onMouseEnter={(e) => {\r\n                                            e.currentTarget.style.transform = 'translateY(-2px)';\r\n                                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';\r\n                                        }}\r\n                                        onMouseLeave={(e) => {\r\n                                            e.currentTarget.style.transform = 'translateY(0)';\r\n                                            e.currentTarget.style.boxShadow = '0 2px 5px rgba(0,0,0,0.02)';\r\n                                        }}\r\n                                    >\r\n                                        <span><strong>{f.title}</strong><br /><small>{f.class} - {f.section}</small></span>\r\n                                        <span style={{ fontWeight: 'bold', color: '#2ecc71' }}>Γé╣{f.amount}</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <style>{`\r\n                .btn:active { transform: scale(0.98); }\r\n                .input-field:focus { outline: none; border-color: #2d3436; box-shadow: 0 0 0 4px rgba(0,0,0,0.05); }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\LibraryManagement.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'issueDate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":40,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"issueDate"},"fix":{"range":[1881,1890],"text":""},"desc":"Remove unused variable 'issueDate'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setIssueDate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":40,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"setIssueDate"},"fix":{"range":[1890,1904],"text":""},"desc":"Remove unused variable 'setIssueDate'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setMyStats' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":44,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"setMyStats"},"fix":{"range":[2054,2066],"text":""},"desc":"Remove unused variable 'setMyStats'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'handleReserve' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":377,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":377,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleReserve"},"fix":{"range":[15452,16260],"text":""},"desc":"Remove unused variable 'handleReserve'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'bookRef' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1122,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":1122,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"bookRef"},"fix":{"range":[64905,64962],"text":""},"desc":"Remove unused variable 'bookRef'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { useLanguage } from '../context/LanguageContext';\r\nimport { db, auth } from '../firebase';\r\nimport { collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, doc, serverTimestamp, orderBy } from 'firebase/firestore';\r\n\r\nexport default function LibraryManagement() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n    const { t } = useLanguage();\r\n\r\n    const isStudent = userData?.role === 'student';\r\n    const isTeacher = userData?.role === 'teacher';\r\n    const isAdmin = userData?.role === 'admin' || userData?.role === 'institution';\r\n\r\n    const [activeTab, setActiveTab] = useState(isStudent || isTeacher ? 'dashboard' : 'books'); // 'books', 'issue', 'return', 'dashboard'\r\n\r\n    // Books State\r\n    const [books, setBooks] = useState([]);\r\n    const [bookTitle, setBookTitle] = useState('');\r\n    const [bookAuthor, setBookAuthor] = useState('');\r\n    const [bookISBN, setBookISBN] = useState('');\r\n    const [bookCategory, setBookCategory] = useState('');\r\n    const [bookCopies, setBookCopies] = useState('');\r\n    const [bookPrice, setBookPrice] = useState('');\r\n    const [bookSubject, setBookSubject] = useState('');\r\n    const [rowNumber, setRowNumber] = useState('');\r\n    const [shelfNumber, setShelfNumber] = useState('');\r\n\r\n    // AI Scanning state\r\n    const [isScanning, setIsScanning] = useState(false);\r\n    const [auditResults, setAuditResults] = useState(null); // For bulk scan results\r\n\r\n    // Issue/Return State\r\n    const [issuedBooks, setIssuedBooks] = useState([]);\r\n    const [selectedBook, setSelectedBook] = useState('');\r\n    const [studentName, setStudentName] = useState('');\r\n    const [studentRoll, setStudentRoll] = useState('');\r\n    const [issueDate, setIssueDate] = useState(new Date().toISOString().split('T')[0]);\r\n    const [returnDate, setReturnDate] = useState('');\r\n\r\n    // Stats State\r\n    const [myStats, setMyStats] = useState({ read: 0, current: [] });\r\n    const [libStats, setLibStats] = useState({ totalBooks: 0, totalIssued: 0, outOfStock: 0 }); // For Librarians\r\n    const [classStats, setClassStats] = useState({ overdue: [], totalActive: 0, leaderboard: [] }); // For Teachers\r\n    const [reservations, setReservations] = useState([]);\r\n\r\n    const [loading, setLoading] = useState(false);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n\r\n    const categories = ['Fiction', 'Non-Fiction', 'Science', 'Mathematics', 'History', 'Literature', 'Reference', 'Comics'];\r\n\r\n    useEffect(() => {\r\n        fetchBooks();\r\n        if (isStudent || isTeacher) {\r\n            fetchMyStats();\r\n            fetchReservations();\r\n            if (isTeacher) fetchClassLibraryStats();\r\n        } else {\r\n            fetchIssuedBooks();\r\n            fetchReservations();\r\n            fetchLibrarianStats();\r\n        }\r\n    }, [userData]);\r\n\r\n    const fetchLibrarianStats = async () => {\r\n        try {\r\n            const bSnap = await getDocs(collection(db, \"library_books\"));\r\n            const iSnap = await getDocs(query(collection(db, \"library_issued\"), where(\"status\", \"==\", \"issued\")));\r\n\r\n            const booksArr = bSnap.docs.map(d => d.data());\r\n            const totalBooks = booksArr.reduce((acc, b) => acc + (Number(b.totalCopies) || 0), 0);\r\n            const outOfStock = booksArr.filter(b => (Number(b.availableCopies) || 0) <= 0).length;\r\n\r\n            setLibStats({\r\n                totalBooks,\r\n                totalIssued: iSnap.size,\r\n                outOfStock\r\n            });\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const fetchBooks = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const q = query(collection(db, \"library_books\"), orderBy(\"addedAt\", \"desc\"));\r\n            const snap = await getDocs(q);\r\n            setBooks(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleAIScan = async (e, mode = 'single') => {\r\n        const file = e.target.files[0];\r\n        if (!file) return;\r\n\r\n        setIsScanning(true);\r\n        setAuditResults(null);\r\n        try {\r\n            const reader = new FileReader();\r\n            const base64Promise = new Promise((resolve) => {\r\n                reader.onloadend = () => resolve(reader.result.split(',')[1]);\r\n                reader.readAsDataURL(file);\r\n            });\r\n            const base64Img = await base64Promise;\r\n\r\n            const token = await auth.currentUser?.getIdToken();\r\n\r\n            let prompt = \"\";\r\n            if (mode === 'bulk') {\r\n                prompt = \"Look at this library shelf. Identify ALL books visible. For each book, extract Title and Author. Return a JSON array: { books: [{title, author}] }. Only return the JSON.\";\r\n            } else if (mode === 'issue') {\r\n                prompt = \"This photo contains a Book cover and a Student ID Card. Identify the Book Title AND the Student Name and Roll/ID Number from the card. Return JSON: { bookTitle, studentName, studentRoll }. Only return the JSON.\";\r\n            } else {\r\n                prompt = \"Explain what is this book. Extract Title, Author, Price (just number), and Subject. Format as JSON: {title, author, price, subject}.\";\r\n            }\r\n\r\n            const response = await fetch('https://together-to-refine.vercel.app/api/chat', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${token}`\r\n                },\r\n                body: JSON.stringify({\r\n                    message: prompt,\r\n                    image: base64Img,\r\n                    mimeType: file.type,\r\n                    userContext: userData\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            const aiText = data.text;\r\n            const jsonMatch = aiText.match(/\\{[\\s\\S]*\\}|\\[[\\s\\S]*\\]/);\r\n\r\n            if (jsonMatch) {\r\n                const parsed = JSON.parse(jsonMatch[0]);\r\n                if (mode === 'bulk') {\r\n                    setAuditResults(parsed.books || []);\r\n                    alert(`≡ƒöì Audit Complete: Detected ${parsed.books?.length} books.`);\r\n                } else if (mode === 'issue') {\r\n                    setStudentName(parsed.studentName || '');\r\n                    setStudentRoll(parsed.studentRoll || '');\r\n                    // Auto-find book in our local list\r\n                    const found = books.find(b => b.title.toLowerCase().includes(parsed.bookTitle?.toLowerCase()) || parsed.bookTitle?.toLowerCase().includes(b.title.toLowerCase()));\r\n                    if (found) setSelectedBook(found.id);\r\n                    alert(\"≡ƒôç Smart Detect: Linked Student '\" + parsed.studentName + \"' to Book '\" + parsed.bookTitle + \"'\");\r\n                } else {\r\n                    setBookTitle(parsed.title || '');\r\n                    setBookAuthor(parsed.author || '');\r\n                    setBookPrice(parsed.price || '');\r\n                    setBookSubject(parsed.subject || '');\r\n                    alert(\"Γ£¿ AI successfully detected book details.\");\r\n                }\r\n            } else {\r\n                alert(\"AI couldn't extract data clearly.\");\r\n            }\r\n        } catch (err) {\r\n            console.error(\"AI Scan Error:\", err);\r\n            alert(\"Error scanning. Try again.\");\r\n        } finally {\r\n            setIsScanning(false);\r\n        }\r\n    };\r\n\r\n    const fetchIssuedBooks = async () => {\r\n        try {\r\n            const q = query(\r\n                collection(db, \"library_issued\"),\r\n                where(\"status\", \"==\", \"issued\"),\r\n                orderBy(\"issueDate\", \"desc\")\r\n            );\r\n            const snap = await getDocs(q);\r\n            setIssuedBooks(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const addBook = async () => {\r\n        if (!bookTitle || !bookAuthor || !bookCopies) {\r\n            alert(\"Please fill required fields\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await addDoc(collection(db, \"library_books\"), {\r\n                title: bookTitle,\r\n                author: bookAuthor,\r\n                isbn: bookISBN,\r\n                category: bookCategory,\r\n                totalCopies: parseInt(bookCopies),\r\n                availableCopies: parseInt(bookCopies),\r\n                price: bookPrice,\r\n                subject: bookSubject,\r\n                rowNumber: rowNumber,\r\n                shelfNumber: shelfNumber,\r\n                addedBy: userData.uid,\r\n                addedAt: serverTimestamp()\r\n            });\r\n\r\n            alert(\"Γ£à Book added successfully!\");\r\n            setBookTitle('');\r\n            setBookAuthor('');\r\n            setBookISBN('');\r\n            setBookCategory('');\r\n            setBookCopies('');\r\n            setBookPrice('');\r\n            setBookSubject('');\r\n            setRowNumber('');\r\n            setShelfNumber('');\r\n            fetchBooks();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error adding book\");\r\n        }\r\n    };\r\n\r\n    const issueBook = async () => {\r\n        try {\r\n            // 1. Basic Validation\r\n            if (!selectedBook || !studentName || !studentRoll || !returnDate) {\r\n                alert(\"ΓÜá∩╕Å Please fill all required fields: Book, Student Name, Roll Number, and Return Date.\");\r\n                return;\r\n            }\r\n\r\n            // 2. Auth Check\r\n            const currentUid = auth.currentUser?.uid || userData?.uid;\r\n            if (!currentUid) {\r\n                alert(\"Γ¥î Authentication error. Please log out and log in again.\");\r\n                return;\r\n            }\r\n\r\n            // 3. Book Availability Check\r\n            const book = books.find(b => b.id === selectedBook);\r\n            if (!book) {\r\n                alert(\"Γ¥î Selected book not found in the catalog.\");\r\n                return;\r\n            }\r\n\r\n            if (Number(book.availableCopies) <= 0) {\r\n                alert(\"Γ¥î This book is currently out of stock (0 copies available).\");\r\n                return;\r\n            }\r\n\r\n            // 4. Date Formatting (Bulletproof)\r\n            const dIssue = new Date(); // Use actual current time for issue\r\n            const dReturn = new Date(returnDate);\r\n\r\n            if (isNaN(dReturn.getTime())) {\r\n                alert(\"ΓÜá∩╕Å The Return Date you selected is invalid. Please pick a proper date.\");\r\n                return;\r\n            }\r\n\r\n            // 5. Data Object for Firestore\r\n            const issueData = {\r\n                bookId: String(book.id),\r\n                bookTitle: String(book.title),\r\n                studentName: String(studentName).trim(),\r\n                studentRoll: String(studentRoll).trim(),\r\n                studentClass: userData?.class || '', // Important for teacher tracking\r\n                studentSection: userData?.section || '',\r\n                issueDate: dIssue,\r\n                expectedReturnDate: dReturn,\r\n                status: 'issued',\r\n                issuedBy: currentUid,\r\n                issuedAt: serverTimestamp()\r\n            };\r\n\r\n            // 6. DB Operations\r\n            // Add issue record\r\n            await addDoc(collection(db, \"library_issued\"), issueData);\r\n\r\n            // Update book availability\r\n            await updateDoc(doc(db, \"library_books\", book.id), {\r\n                availableCopies: Number(book.availableCopies) - 1\r\n            });\r\n\r\n            // 7. Success & UI Reset\r\n            alert(\"≡ƒÄë Book issued successfully!\");\r\n            setSelectedBook('');\r\n            setStudentName('');\r\n            setStudentRoll('');\r\n            setReturnDate('');\r\n\r\n            // Refresh counts\r\n            fetchBooks();\r\n            fetchIssuedBooks();\r\n            if (isTeacher) fetchClassLibraryStats();\r\n        } catch (e) {\r\n            console.error(\"Critical Issue Error:\", e);\r\n            alert(\"Error: \" + (e.message || \"Failed to issue book. Check your internet connection.\"));\r\n        }\r\n    };\r\n\r\n    const returnBook = async (issueRecord) => {\r\n        try {\r\n            // Update issue record\r\n            await updateDoc(doc(db, \"library_issued\", issueRecord.id), {\r\n                status: 'returned',\r\n                actualReturnDate: new Date(),\r\n                returnedAt: serverTimestamp()\r\n            });\r\n\r\n            // Update book availability\r\n            const book = books.find(b => b.id === issueRecord.bookId);\r\n            if (book) {\r\n                await updateDoc(doc(db, \"library_books\", book.id), {\r\n                    availableCopies: book.availableCopies + 1\r\n                });\r\n            }\r\n\r\n            alert(\"Γ£à Book returned successfully!\");\r\n            fetchBooks();\r\n            fetchIssuedBooks();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error returning book\");\r\n        }\r\n    };\r\n\r\n    const fetchClassLibraryStats = async () => {\r\n        if (!userData?.class) return;\r\n        try {\r\n            // Find all books issued to students in this teacher's class/section\r\n            // Note: We might need to match by student rolls if cross-referenced, \r\n            // but for simplicity we'll assume the 'issue' record might have glass/section or we fetch all and check.\r\n            const q = query(collection(db, \"library_issued\"), where(\"status\", \"==\", \"issued\"));\r\n            const snap = await getDocs(q);\r\n            const allIssued = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n\r\n            // If we have student records, we'd filter here. \r\n            // For now, let's assume 'library_issued' records include studentClass if we update the issue logic later.\r\n            // Simplified: Filter by comparing against current year/class patterns or teacher's overseen students.\r\n            const myClassIssued = allIssued.filter(rec => rec.studentClass === userData.class && rec.studentSection === userData.section);\r\n\r\n            const overdue = myClassIssued.filter(rec => {\r\n                const due = new Date(rec.expectedReturnDate.toDate ? rec.expectedReturnDate.toDate() : rec.expectedReturnDate);\r\n                return due < new Date();\r\n            });\r\n\r\n            setClassStats({\r\n                overdue,\r\n                totalActive: myClassIssued.length\r\n            });\r\n        } catch (e) {\r\n            console.error(\"Teacher stats error:\", e);\r\n        }\r\n    };\r\n\r\n    const fetchReservations = async () => {\r\n        try {\r\n            let q;\r\n            if (isStudent) {\r\n                q = query(collection(db, \"library_reservations\"), where(\"studentId\", \"==\", userData.uid));\r\n            } else {\r\n                q = query(collection(db, \"library_reservations\"), orderBy(\"reservedAt\", \"desc\"));\r\n            }\r\n            const snap = await getDocs(q);\r\n            setReservations(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n        } catch (e) { console.error(e); }\r\n    };\r\n\r\n    const deleteReservation = async (id) => {\r\n        try {\r\n            await deleteDoc(doc(db, \"library_reservations\", id));\r\n            fetchReservations();\r\n        } catch (e) { console.error(e); }\r\n    };\r\n\r\n    const handleReserve = async (book) => {\r\n        if (reservations.some(r => r.bookId === book.id && r.status === 'pending')) {\r\n            alert(\"You have already reserved this book.\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await addDoc(collection(db, \"library_reservations\"), {\r\n                bookId: book.id,\r\n                bookTitle: book.title,\r\n                studentId: userData.uid,\r\n                studentName: userData.name,\r\n                reservedAt: serverTimestamp(),\r\n                status: 'pending'\r\n            });\r\n            alert(\"Γ£à Book reserved successfully! We will notify you when it's available.\");\r\n            fetchReservations();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error reserving book\");\r\n        }\r\n    };\r\n\r\n    const calculateFine = (expectedReturnDate) => {\r\n        const expected = new Date(expectedReturnDate.toDate ? expectedReturnDate.toDate() : expectedReturnDate);\r\n        const today = new Date();\r\n        const diffDays = Math.ceil((today - expected) / (1000 * 60 * 60 * 24));\r\n\r\n        if (diffDays <= 0) return 0;\r\n        return diffDays * 5; // Γé╣5 per day\r\n    };\r\n\r\n    const filteredBooks = books.filter(book =>\r\n        book.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        book.author.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        book.subject?.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        book.isbn?.toLowerCase().includes(searchQuery.toLowerCase())\r\n    );\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                    <h2>≡ƒôÜ {t('library')}</h2>\r\n                    <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                </div>\r\n\r\n                {/* Tabs */}\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', borderBottom: '2px solid #eee', overflowX: 'auto' }}>\r\n                    {(isStudent || isTeacher) && (\r\n                        <button\r\n                            onClick={() => setActiveTab('dashboard')}\r\n                            style={{\r\n                                padding: '10px 20px', background: 'none', border: 'none',\r\n                                borderBottom: activeTab === 'dashboard' ? '3px solid #0984e3' : 'none',\r\n                                fontWeight: activeTab === 'dashboard' ? 'bold' : 'normal',\r\n                                cursor: 'pointer', color: activeTab === 'dashboard' ? '#0984e3' : '#636e72'\r\n                            }}\r\n                        >\r\n                            ≡ƒôè {isTeacher ? \"Class Dashboard\" : t('lib_dashboard')}\r\n                        </button>\r\n                    )}\r\n                    {isAdmin && (\r\n                        <button\r\n                            onClick={() => setActiveTab('lib_dashboard')}\r\n                            style={{\r\n                                padding: '10px 20px', background: 'none', border: 'none',\r\n                                borderBottom: activeTab === 'lib_dashboard' ? '3px solid #0984e3' : 'none',\r\n                                fontWeight: activeTab === 'lib_dashboard' ? 'bold' : 'normal',\r\n                                cursor: 'pointer', color: activeTab === 'lib_dashboard' ? '#0984e3' : '#636e72'\r\n                            }}\r\n                        >\r\n                            ≡ƒÅó Management Dashboard\r\n                        </button>\r\n                    )}\r\n                    <button\r\n                        onClick={() => setActiveTab('books')}\r\n                        style={{\r\n                            padding: '10px 20px', background: 'none', border: 'none',\r\n                            borderBottom: activeTab === 'books' ? '3px solid #0984e3' : 'none',\r\n                            fontWeight: activeTab === 'books' ? 'bold' : 'normal',\r\n                            cursor: 'pointer', color: activeTab === 'books' ? '#0984e3' : '#636e72'\r\n                        }}\r\n                    >\r\n                        ≡ƒôû {isStudent ? t('lib_browse') : t('lib_catalog')}\r\n                    </button>\r\n                    {!isStudent && (\r\n                        <>\r\n                            <button\r\n                                onClick={() => setActiveTab('issue')}\r\n                                style={{\r\n                                    padding: '10px 20px', background: 'none', border: 'none',\r\n                                    borderBottom: activeTab === 'issue' ? '3px solid #0984e3' : 'none',\r\n                                    fontWeight: activeTab === 'issue' ? 'bold' : 'normal',\r\n                                    cursor: 'pointer', color: activeTab === 'issue' ? '#0984e3' : '#636e72'\r\n                                }}\r\n                            >\r\n                                Γ₧ò {t('lib_issue')}\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setActiveTab('return')}\r\n                                style={{\r\n                                    padding: '10px 20px', background: 'none', border: 'none',\r\n                                    borderBottom: activeTab === 'return' ? '3px solid #0984e3' : 'none',\r\n                                    fontWeight: activeTab === 'return' ? 'bold' : 'normal',\r\n                                    cursor: 'pointer', color: activeTab === 'return' ? '#0984e3' : '#636e72'\r\n                                }}\r\n                            >\r\n                                Γå⌐∩╕Å {t('lib_return')}\r\n                            </button>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                {/* LIBRARIAN (MANAGEMENT) DASHBOARD TAB */}\r\n                {activeTab === 'lib_dashboard' && isAdmin && (\r\n                    <div style={{ display: 'grid', gap: '20px' }}>\r\n                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px' }}>\r\n                            <div className=\"card\" style={{ background: '#0984e3', color: 'white' }}>\r\n                                <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>Total Books</h3>\r\n                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{libStats.totalBooks}</div>\r\n                                <div style={{ opacity: 0.8 }}>Across all subjects</div>\r\n                            </div>\r\n                            <div className=\"card\" style={{ background: '#6c5ce7', color: 'white' }}>\r\n                                <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>Active Issues</h3>\r\n                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{libStats.totalIssued}</div>\r\n                                <div style={{ opacity: 0.8 }}>Currently with students/staff</div>\r\n                            </div>\r\n                            <div className=\"card\" style={{ background: libStats.outOfStock > 0 ? '#e17055' : '#00b894', color: 'white' }}>\r\n                                <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>Out of Stock</h3>\r\n                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{libStats.outOfStock}</div>\r\n                                <div style={{ opacity: 0.8 }}>Books needing restock</div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"card\" style={{ borderTop: '4px solid #f39c12' }}>\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                                <h3>≡ƒôª AI Shelf Auditor (Librarian Tool)</h3>\r\n                                <div>\r\n                                    <input\r\n                                        type=\"file\"\r\n                                        accept=\"image/*\"\r\n                                        capture=\"environment\"\r\n                                        id=\"bulk-scanner\"\r\n                                        hidden\r\n                                        onChange={(e) => handleAIScan(e, 'bulk')}\r\n                                        disabled={isScanning}\r\n                                    />\r\n                                    <label\r\n                                        htmlFor=\"bulk-scanner\"\r\n                                        style={{\r\n                                            padding: '10px 20px',\r\n                                            background: isScanning ? '#7f8c8d' : '#f39c12',\r\n                                            color: 'white',\r\n                                            borderRadius: '8px',\r\n                                            cursor: isScanning ? 'not-allowed' : 'pointer',\r\n                                            fontWeight: 'bold',\r\n                                            boxShadow: '0 4px 15px rgba(243, 156, 18, 0.3)'\r\n                                        }}\r\n                                    >\r\n                                        {isScanning ? 'ΓÅ│ Analyzing...' : '≡ƒô╕ Scan Shelf Now'}\r\n                                    </label>\r\n                                </div>\r\n                            </div>\r\n                            <p style={{ color: '#636e72', fontSize: '13px' }}>\r\n                                Use this to verify that all books listed in the system are physically present on the shelves.\r\n                            </p>\r\n\r\n                            {auditResults && (\r\n                                <div style={{ marginTop: '15px', padding: '15px', background: '#f8f9fa', borderRadius: '10px' }}>\r\n                                    <h4 style={{ margin: '0 0 10px 0' }}>Γ£à Audit Result: Found {auditResults.length} Books</h4>\r\n                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '10px' }}>\r\n                                        {auditResults.map((b, i) => (\r\n                                            <div key={i} style={{ fontSize: '12px', background: 'white', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}>\r\n                                                ≡ƒôû <strong>{b.title}</strong>\r\n                                                <div style={{ color: '#999' }}>{b.author}</div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* TEACHER DASHBOARD TAB */}\r\n                {activeTab === 'dashboard' && isTeacher && (\r\n                    <div style={{ display: 'grid', gap: '20px' }}>\r\n                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px' }}>\r\n                            <div className=\"card\" style={{ background: 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)', color: 'white' }}>\r\n                                <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>≡ƒæñ My Reading Progress</h3>\r\n                                <div style={{ fontSize: '28px', fontWeight: 'bold' }}>{myStats.read} Books Finished</div>\r\n                                <div style={{ opacity: 0.9 }}>Currently Reading: {myStats.current.length}</div>\r\n                            </div>\r\n                            <div className=\"card\" style={{ background: 'linear-gradient(135deg, #00b894 0%, #55efc4 100%)', color: 'white' }}>\r\n                                <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>≡ƒÅó Class {userData.class}-{userData.section} Overview</h3>\r\n                                <div style={{ fontSize: '28px', fontWeight: 'bold' }}>{classStats.totalActive} Active Issues</div>\r\n                                <div style={{ color: classStats.overdue.length > 0 ? '#ff7675' : 'white', fontWeight: 'bold' }}>\r\n                                    {classStats.overdue.length} Overdue Now\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"card\" style={{ borderTop: '4px solid #d63031' }}>\r\n                            <h3 style={{ color: '#d63031' }}>≡ƒòÆ Overdue Books Tracker (My Class)</h3>\r\n                            {classStats.overdue.length === 0 ? (\r\n                                <div style={{ textAlign: 'center', padding: '20px', color: '#27ae60' }}>\r\n                                    Γ£à Great! No student in your class has overdue books.\r\n                                </div>\r\n                            ) : (\r\n                                <div style={{ overflowX: 'auto' }}>\r\n                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>\r\n                                        <thead>\r\n                                            <tr style={{ textAlign: 'left', borderBottom: '2px solid #eee' }}>\r\n                                                <th style={{ padding: '10px' }}>Student</th>\r\n                                                <th style={{ padding: '10px' }}>Book Title</th>\r\n                                                <th style={{ padding: '10px' }}>Due Date</th>\r\n                                                <th style={{ padding: '10px' }}>Action</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {classStats.overdue.map(rec => (\r\n                                                <tr key={rec.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                                    <td style={{ padding: '10px' }}>\r\n                                                        <div style={{ fontWeight: 'bold' }}>{rec.studentName}</div>\r\n                                                        <div style={{ fontSize: '11px', color: '#636e72' }}>Roll: {rec.studentRoll}</div>\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px' }}>{rec.bookTitle}</td>\r\n                                                    <td style={{ padding: '10px', color: '#d63031', fontWeight: 'bold' }}>\r\n                                                        {new Date(rec.expectedReturnDate.toDate?.() || rec.expectedReturnDate).toLocaleDateString()}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px' }}>\r\n                                                        <button\r\n                                                            onClick={() => setActiveTab('return')}\r\n                                                            className=\"btn-outline\"\r\n                                                            style={{ fontSize: '11px', padding: '4px 8px' }}\r\n                                                        >\r\n                                                            Go to Return\r\n                                                        </button>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* STUDENT DASHBOARD TAB */}\r\n                {activeTab === 'dashboard' && isStudent && (\r\n                    <div style={{ display: 'grid', gap: '20px' }}>\r\n                        {/* Reading Stats Card */}\r\n                        <div className=\"card\" style={{\r\n                            background: 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)',\r\n                            color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'space-between'\r\n                        }}>\r\n                            <div>\r\n                                <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>Reading Milestones</h3>\r\n                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>You've read {myStats.read} books!</div>\r\n                                <div style={{ opacity: 0.9, marginTop: '5px' }}>\r\n                                    {myStats.read >= 20 ? \"≡ƒÅå Book Worm Status Achieved!\" :\r\n                                        myStats.read >= 10 ? \"≡ƒÑê Amazing Reader!\" :\r\n                                            \"≡ƒÑë Keep reading to unlock badges!\"}\r\n                                </div>\r\n                            </div>\r\n                            <div style={{ fontSize: '64px' }}>≡ƒôÜ</div>\r\n                        </div>\r\n\r\n                        {/* Currently Borrowed */}\r\n                        <div className=\"card\">\r\n                            <h3>Currently Borrowed</h3>\r\n                            {myStats.current.length === 0 ? (\r\n                                <p style={{ color: '#999' }}>You have no books currently issued.</p>\r\n                            ) : (\r\n                                <ul style={{ paddingLeft: '20px' }}>\r\n                                    {myStats.current.map(b => (\r\n                                        <li key={b.id} style={{ marginBottom: '10px' }}>\r\n                                            <strong>{b.bookTitle}</strong> - Due: {b.expectedReturnDate?.toDate?.()?.toLocaleDateString()}\r\n                                        </li>\r\n                                    ))}\r\n                                </ul>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* My Reservations */}\r\n                        <div className=\"card\">\r\n                            <h3>My Reservations</h3>\r\n                            {reservations.length === 0 ? (\r\n                                <p style={{ color: '#999' }}>No active reservations.</p>\r\n                            ) : (\r\n                                <ul style={{ paddingLeft: '20px' }}>\r\n                                    {reservations.map(r => (\r\n                                        <li key={r.id} style={{ marginBottom: '10px' }}>\r\n                                            <strong>{r.bookTitle}</strong> - Status: <span style={{ color: '#f39c12' }}>{r.status}</span>\r\n                                        </li>\r\n                                    ))}\r\n                                </ul>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* BOOKS CATALOG TAB */}\r\n                {activeTab === 'books' && (\r\n                    <>\r\n                        {/* Librarian Tools (Admin Only) */}\r\n                        {!isStudent && (\r\n                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px', marginBottom: '20px' }}>\r\n                                {/* Add Book Form */}\r\n                                <div className=\"card\" style={{ borderTop: '4px solid #0984e3' }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>\r\n                                        <h3 style={{ margin: 0 }}>Add New Book</h3>\r\n                                        <div>\r\n                                            <input\r\n                                                type=\"file\"\r\n                                                accept=\"image/*\"\r\n                                                capture=\"environment\"\r\n                                                id=\"ai-scanner\"\r\n                                                hidden\r\n                                                onChange={(e) => handleAIScan(e, 'single')}\r\n                                                disabled={isScanning}\r\n                                            />\r\n                                            <label\r\n                                                htmlFor=\"ai-scanner\"\r\n                                                style={{\r\n                                                    padding: '8px 15px',\r\n                                                    background: isScanning ? '#7f8c8d' : 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)',\r\n                                                    color: 'white',\r\n                                                    borderRadius: '8px',\r\n                                                    cursor: isScanning ? 'not-allowed' : 'pointer',\r\n                                                    fontSize: '14px',\r\n                                                    display: 'flex',\r\n                                                    alignItems: 'center',\r\n                                                    gap: '8px',\r\n                                                    boxShadow: '0 4px 10px rgba(108, 92, 231, 0.3)'\r\n                                                }}\r\n                                            >\r\n                                                {isScanning ? 'ΓÅ│ Detection...' : '≡ƒô╕ Scan Cover'}\r\n                                            </label>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div style={{ display: 'grid', gap: '20px' }}>\r\n                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>\r\n                                            <input type=\"text\" className=\"input-field\" placeholder=\"Title\" value={bookTitle} onChange={(e) => setBookTitle(e.target.value)} />\r\n                                            <input type=\"text\" className=\"input-field\" placeholder=\"Author\" value={bookAuthor} onChange={(e) => setBookAuthor(e.target.value)} />\r\n                                        </div>\r\n                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>\r\n                                            <input type=\"text\" className=\"input-field\" placeholder=\"Subject\" value={bookSubject} onChange={(e) => setBookSubject(e.target.value)} />\r\n                                            <input type=\"number\" className=\"input-field\" placeholder=\"Price\" value={bookPrice} onChange={(e) => setBookPrice(e.target.value)} />\r\n                                        </div>\r\n                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>\r\n                                            <input type=\"text\" className=\"input-field\" placeholder=\"Row\" value={rowNumber} onChange={(e) => setRowNumber(e.target.value)} />\r\n                                            <input type=\"text\" className=\"input-field\" placeholder=\"Shelf\" value={shelfNumber} onChange={(e) => setShelfNumber(e.target.value)} />\r\n                                        </div>\r\n                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>\r\n                                            <select className=\"input-field\" value={bookCategory} onChange={(e) => setBookCategory(e.target.value)}>\r\n                                                <option value=\"\">Category</option>\r\n                                                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}\r\n                                            </select>\r\n                                            <input type=\"number\" className=\"input-field\" placeholder=\"Copies\" value={bookCopies} onChange={(e) => setBookCopies(e.target.value)} />\r\n                                        </div>\r\n                                        <button onClick={addBook} className=\"btn\" style={{ height: '40px' }}>Γ₧ò Save Book</button>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Bulk Shelf Audit Tool */}\r\n                                <div className=\"card\" style={{ borderTop: '4px solid #f39c12' }}>\r\n                                    <h3 style={{ margin: '0 0 10px 0' }}>≡ƒôª Bulk Shelf Audit</h3>\r\n                                    <p style={{ fontSize: '12px', color: '#636e72', marginBottom: '15px' }}>\r\n                                        Take one photo of multiple books. AI will identify them and check against your database.\r\n                                    </p>\r\n\r\n                                    <input\r\n                                        type=\"file\"\r\n                                        accept=\"image/*\"\r\n                                        capture=\"environment\"\r\n                                        id=\"bulk-scanner\"\r\n                                        hidden\r\n                                        onChange={(e) => handleAIScan(e, 'bulk')}\r\n                                        disabled={isScanning}\r\n                                    />\r\n                                    <label\r\n                                        htmlFor=\"bulk-scanner\"\r\n                                        style={{\r\n                                            padding: '12px',\r\n                                            background: isScanning ? '#7f8c8d' : '#f39c12',\r\n                                            color: 'white',\r\n                                            borderRadius: '8px',\r\n                                            cursor: isScanning ? 'not-allowed' : 'pointer',\r\n                                            display: 'block',\r\n                                            textAlign: 'center',\r\n                                            fontWeight: 'bold'\r\n                                        }}\r\n                                    >\r\n                                        {isScanning ? 'ΓÅ│ Analyzing Shelf...' : '≡ƒô╕ Audit Whole Shelf'}\r\n                                    </label>\r\n\r\n                                    {auditResults && (\r\n                                        <div style={{ marginTop: '15px', maxHeight: '200px', overflowY: 'auto', background: '#f8f9fa', padding: '10px', borderRadius: '8px' }}>\r\n                                            <div style={{ fontSize: '13px', fontWeight: 'bold', marginBottom: '8px', color: '#2ecc71' }}>\r\n                                                Γ£à Found {auditResults.length} Books:\r\n                                            </div>\r\n                                            {auditResults.map((b, i) => (\r\n                                                <div key={i} style={{ fontSize: '12px', padding: '5px 0', borderBottom: '1px solid #ddd' }}>\r\n                                                    ΓÇó <strong>{b.title}</strong> by {b.author}\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Quick Approval View (Librarian Burden Reducer) */}\r\n                        {!isStudent && activeTab === 'books' && (\r\n                            <PendingRequests fetchIssuedBooks={fetchIssuedBooks} />\r\n                        )}\r\n\r\n                        {/* Books List */}\r\n                        <div className=\"card\">\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px', flexWrap: 'wrap', gap: '10px' }}>\r\n                                <h3 style={{ margin: 0 }}>Books Catalog ({books.length})</h3>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"input-field\"\r\n                                    placeholder=\"≡ƒöì Search by Title, Author, or Subject...\"\r\n                                    value={searchQuery}\r\n                                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                                    style={{ maxWidth: '400px' }}\r\n                                />\r\n                            </div>\r\n\r\n                            {loading ? (\r\n                                <div style={{ textAlign: 'center', padding: '40px' }}>Loading...</div>\r\n                            ) : filteredBooks.length === 0 ? (\r\n                                <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>\r\n                                    No books found\r\n                                </div>\r\n                            ) : (\r\n                                <div style={{ overflowX: 'auto' }}>\r\n                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>\r\n                                        <thead style={{ background: '#f8f9fa' }}>\r\n                                            <tr>\r\n                                                <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Title & Author</th>\r\n                                                <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Location</th>\r\n                                                <th style={{ padding: '12px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Status</th>\r\n                                                <th style={{ padding: '12px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Action</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {filteredBooks.map(book => (\r\n                                                <tr key={book.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                                    <td style={{ padding: '12px' }}>\r\n                                                        <div style={{ fontWeight: 'bold' }}>{book.title}</div>\r\n                                                        <div style={{ fontSize: '12px', color: '#636e72' }}>by {book.author} | {book.subject}</div>\r\n                                                    </td>\r\n                                                    <td style={{ padding: '12px' }}>\r\n                                                        <div style={{ background: '#f1f2f6', padding: '4px 8px', borderRadius: '4px', display: 'inline-block', fontSize: '12px' }}>\r\n                                                            Row {book.rowNumber || '?'}, Shelf {book.shelfNumber || '?'}\r\n                                                        </div>\r\n                                                    </td>\r\n                                                    <td style={{\r\n                                                        padding: '12px',\r\n                                                        textAlign: 'center',\r\n                                                        color: book.availableCopies > 0 ? '#27ae60' : '#e74c3c',\r\n                                                        fontWeight: 'bold'\r\n                                                    }}>\r\n                                                        {book.availableCopies > 0 ? 'AVAILABLE' : 'OUT'}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '12px', textAlign: 'center' }}>\r\n                                                        {isStudent && book.availableCopies > 0 && (\r\n                                                            <button\r\n                                                                onClick={() => handleStudentSelfIssue(book)}\r\n                                                                className=\"btn\"\r\n                                                                style={{ padding: '6px 12px', fontSize: '12px', background: '#0984e3' }}\r\n                                                            >\r\n                                                                ≡ƒôÑ Scan to Issue\r\n                                                            </button>\r\n                                                        )}\r\n                                                        {!isStudent && (\r\n                                                            <span style={{ fontSize: '12px', color: '#999' }}>\r\n                                                                {book.availableCopies}/{book.totalCopies}\r\n                                                            </span>\r\n                                                        )}\r\n                                                    </td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </>\r\n                )}\r\n\r\n                {/* ISSUE BOOK TAB */}\r\n                {activeTab === 'issue' && (\r\n                    <div className=\"card\" style={{ borderTop: '4px solid #6c5ce7' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                            <h3 style={{ margin: 0 }}>Issue Book to Student</h3>\r\n                            <div>\r\n                                <input\r\n                                    type=\"file\"\r\n                                    accept=\"image/*\"\r\n                                    capture=\"environment\"\r\n                                    id=\"issue-scanner\"\r\n                                    hidden\r\n                                    onChange={(e) => handleAIScan(e, 'issue')}\r\n                                    disabled={isScanning}\r\n                                />\r\n                                <label\r\n                                    htmlFor=\"issue-scanner\"\r\n                                    style={{\r\n                                        padding: '10px 18px',\r\n                                        background: isScanning ? '#7f8c8d' : 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)',\r\n                                        color: 'white',\r\n                                        borderRadius: '8px',\r\n                                        cursor: isScanning ? 'not-allowed' : 'pointer',\r\n                                        fontSize: '14px',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '8px',\r\n                                        fontWeight: 'bold',\r\n                                        boxShadow: '0 4px 15px rgba(108, 92, 231, 0.4)'\r\n                                    }}\r\n                                >\r\n                                    {isScanning ? 'ΓÅ│ Reading ID & Book...' : '≡ƒô╕ Smart Scan (Book + ID Card)'}\r\n                                </label>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div style={{ background: '#f8f9fa', padding: '15px', borderRadius: '10px', marginBottom: '20px', border: '1px dashed #dcdde1' }}>\r\n                            <p style={{ margin: 0, fontSize: '13px', color: '#636e72' }}>\r\n                                ≡ƒÆí <strong>Pro Tip:</strong> Use \"Smart Scan\" to take one photo of the book cover and student's ID card together. AI will fill the details for you!\r\n                            </p>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'grid', gap: '15px' }}>\r\n                            <div>\r\n                                <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                    Select Book *\r\n                                </label>\r\n                                <select className=\"input-field\" value={selectedBook} onChange={(e) => setSelectedBook(e.target.value)}>\r\n                                    <option value=\"\">{isScanning ? 'Detecting book...' : 'Choose a book'}</option>\r\n                                    {books.filter(b => b.availableCopies > 0).map(book => (\r\n                                        <option key={book.id} value={book.id}>\r\n                                            {book.title} ({book.availableCopies} left)\r\n                                        </option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n\r\n                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>\r\n                                <div>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Student Name *\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        className=\"input-field\"\r\n                                        value={studentName}\r\n                                        onChange={(e) => setStudentName(e.target.value)}\r\n                                        placeholder=\"Auto-detected from ID Card\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Roll Number / ID *\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        className=\"input-field\"\r\n                                        value={studentRoll}\r\n                                        onChange={(e) => setStudentRoll(e.target.value)}\r\n                                        placeholder=\"Auto-detected from ID Card\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Due Date (Select) *\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"date\"\r\n                                        className=\"input-field\"\r\n                                        value={returnDate}\r\n                                        onChange={(e) => setReturnDate(e.target.value)}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <button onClick={issueBook} className=\"btn\" style={{ height: '45px', fontSize: '16px' }}>Γ£à Confirm & Issue Book</button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* RETURN BOOK TAB */}\r\n                {activeTab === 'return' && (\r\n                    <div className=\"card\">\r\n                        <h3>Issued Books ({issuedBooks.length})</h3>\r\n\r\n                        {issuedBooks.length === 0 ? (\r\n                            <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>\r\n                                No books currently issued\r\n                            </div>\r\n                        ) : (\r\n                            <div style={{ overflowX: 'auto' }}>\r\n                                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>\r\n                                    <thead style={{ background: '#f8f9fa' }}>\r\n                                        <tr>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Book</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Student</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Issue Date</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Due Date</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Fine</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Action</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {issuedBooks.map(record => {\r\n                                            const fine = calculateFine(record.expectedReturnDate);\r\n                                            const isOverdue = fine > 0;\r\n\r\n                                            return (\r\n                                                <tr key={record.id} style={{\r\n                                                    borderBottom: '1px solid #eee',\r\n                                                    background: isOverdue ? '#fff5f5' : 'white'\r\n                                                }}>\r\n                                                    <td style={{ padding: '10px' }}>{record.bookTitle}</td>\r\n                                                    <td style={{ padding: '10px' }}>\r\n                                                        {record.studentName}\r\n                                                        <div style={{ fontSize: '12px', color: '#999' }}>Roll: {record.studentRoll}</div>\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px' }}>\r\n                                                        {record.issueDate?.toDate?.()?.toLocaleDateString() || 'N/A'}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center', fontSize: '13px' }}>\r\n                                                        {record.expectedReturnDate?.toDate?.()?.toLocaleDateString() || 'N/A'}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                        {isOverdue ? (\r\n                                                            <span style={{ color: '#e74c3c', fontWeight: 'bold' }}>\r\n                                                                Γé╣{fine}\r\n                                                            </span>\r\n                                                        ) : (\r\n                                                            <span style={{ color: '#27ae60' }}>Γé╣0</span>\r\n                                                        )}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                        <button\r\n                                                            onClick={() => returnBook(record)}\r\n                                                            style={{\r\n                                                                background: '#27ae60', color: 'white',\r\n                                                                border: 'none', padding: '5px 12px',\r\n                                                                borderRadius: '4px', cursor: 'pointer',\r\n                                                                fontSize: '13px'\r\n                                                            }}\r\n                                                        >\r\n                                                            Γ£à Return\r\n                                                        </button>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            );\r\n                                        })}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* RESERVATIONS TAB (Admin) */}\r\n                {activeTab === 'reservations' && !isStudent && (\r\n                    <div className=\"card\">\r\n                        <h3>Reservations Queue ({reservations.length})</h3>\r\n                        {reservations.length === 0 ? (\r\n                            <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>No active reservations</div>\r\n                        ) : (\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>\r\n                                <thead style={{ background: '#f8f9fa' }}>\r\n                                    <tr>\r\n                                        <th style={{ padding: '10px', textAlign: 'left' }}>Book</th>\r\n                                        <th style={{ padding: '10px', textAlign: 'left' }}>Student</th>\r\n                                        <th style={{ padding: '10px', textAlign: 'center' }}>Reserved At</th>\r\n                                        <th style={{ padding: '10px', textAlign: 'center' }}>Action</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {reservations.map(res => (\r\n                                        <tr key={res.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                            <td style={{ padding: '10px' }}>{res.bookTitle}</td>\r\n                                            <td style={{ padding: '10px' }}>{res.studentName}</td>\r\n                                            <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                {res.reservedAt?.toDate?.()?.toLocaleDateString() || 'Recently'}\r\n                                            </td>\r\n                                            <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                <button\r\n                                                    onClick={() => deleteReservation(res.id)}\r\n                                                    style={{\r\n                                                        background: '#e74c3c', color: 'white',\r\n                                                        border: 'none', padding: '5px 12px',\r\n                                                        borderRadius: '4px', cursor: 'pointer',\r\n                                                        fontSize: '12px'\r\n                                                    }}\r\n                                                >\r\n                                                    Γ¥î Remove\r\n                                                </button>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n// Burden Reducer Component: Handles Quick Approvals\r\nfunction PendingRequests({ fetchIssuedBooks }) {\r\n    const [requests, setRequests] = useState([]);\r\n\r\n    useEffect(() => {\r\n        const fetchRequests = async () => {\r\n            const q = query(\r\n                collection(db, \"library_issue_requests\"),\r\n                where(\"status\", \"==\", \"pending\"),\r\n                orderBy(\"requestedAt\", \"desc\")\r\n            );\r\n            const snap = await getDocs(q);\r\n            setRequests(snap.docs.map(d => ({ id: d.id, ...d.data() })));\r\n        };\r\n        fetchRequests();\r\n    }, []);\r\n\r\n    const handleAction = async (request, action) => {\r\n        try {\r\n            if (action === 'approve') {\r\n                const bookRef = doc(db, \"library_books\", request.bookId);\r\n                const bookSnap = await getDocs(query(collection(db, \"library_books\"), where(\"__name__\", \"==\", request.bookId)));\r\n                const bookData = bookSnap.docs[0]?.data();\r\n\r\n                if (!bookData || bookData.availableCopies <= 0) {\r\n                    alert(\"Book no longer available!\");\r\n                    return;\r\n                }\r\n\r\n                // 1. Create Issue Record\r\n                const returnDate = new Date();\r\n                returnDate.setDate(returnDate.getDate() + 14); // Default 14 days\r\n\r\n                await addDoc(collection(db, \"library_issued\"), {\r\n                    bookId: request.bookId,\r\n                    bookTitle: request.bookTitle,\r\n                    studentName: request.studentName,\r\n                    studentRoll: request.studentRoll,\r\n                    issueDate: new Date(),\r\n                    expectedReturnDate: returnDate,\r\n                    status: 'issued',\r\n                    issuedBy: 'auto-self-service',\r\n                    issuedAt: serverTimestamp()\r\n                });\r\n\r\n                // 2. Update Book\r\n                await updateDoc(doc(db, \"library_books\", request.bookId), {\r\n                    availableCopies: bookData.availableCopies - 1\r\n                });\r\n            }\r\n\r\n            // 3. Update Request Status\r\n            await updateDoc(doc(db, \"library_issue_requests\", request.id), {\r\n                status: action === 'approve' ? 'approved' : 'declined',\r\n                processedAt: serverTimestamp()\r\n            });\r\n\r\n            alert(`Γ£à Request ${action === 'approve' ? 'Approved' : 'Declined'}`);\r\n            setRequests(prev => prev.filter(r => r.id !== request.id));\r\n            fetchIssuedBooks();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error processing request.\");\r\n        }\r\n    };\r\n\r\n    if (requests.length === 0) return null;\r\n\r\n    return (\r\n        <div className=\"card\" style={{ background: '#e3f2fd', borderLeft: '5px solid #0984e3', marginBottom: '20px' }}>\r\n            <h3 style={{ margin: '0 0 10px 0', color: '#0984e3' }}>≡ƒöö Quick Approval Queue ({requests.length})</h3>\r\n            <p style={{ fontSize: '12px', color: '#636e72', marginBottom: '15px' }}>\r\n                Students have scanned these books. Verify the student is standing in front of you and click Approve.\r\n            </p>\r\n            <div style={{ display: 'grid', gap: '10px' }}>\r\n                {requests.map(r => (\r\n                    <div key={r.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: 'white', padding: '12px', borderRadius: '8px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)' }}>\r\n                        <div>\r\n                            <div style={{ fontWeight: 'bold', fontSize: '14px' }}>{r.bookTitle}</div>\r\n                            <div style={{ fontSize: '12px', color: '#636e72' }}>Requested by: <strong>{r.studentName}</strong> ({r.studentRoll})</div>\r\n                        </div>\r\n                        <div style={{ display: 'flex', gap: '8px' }}>\r\n                            <button\r\n                                onClick={() => handleAction(r, 'approve')}\r\n                                style={{ background: '#2ecc71', color: 'white', border: 'none', padding: '6px 12px', borderRadius: '4px', cursor: 'pointer', fontWeight: 'bold', fontSize: '12px' }}\r\n                            >\r\n                                Approve\r\n                            </button>\r\n                            <button\r\n                                onClick={() => handleAction(r, 'decline')}\r\n                                style={{ background: '#e74c3c', color: 'white', border: 'none', padding: '6px 12px', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}\r\n                            >\r\n                                Decline\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Login.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'language' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":64,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"language"},"fix":{"range":[2586,2596],"text":""},"desc":"Remove unused variable 'language'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'toggleLanguage' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":64,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"toggleLanguage"},"fix":{"range":[2596,2612],"text":""},"desc":"Remove unused variable 'toggleLanguage'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":78,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":78,"endColumn":27},{"ruleId":"no-unused-vars","severity":1,"message":"'uid' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":289,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":289,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useUser } from '../context/UserContext';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useLanguage } from '../context/LanguageContext';\r\nimport {\r\n    createUserWithEmailAndPassword,\r\n    signInWithEmailAndPassword,\r\n    GoogleAuthProvider,\r\n    signInWithPopup,\r\n    signInWithRedirect,\r\n    getRedirectResult\r\n} from 'firebase/auth';\r\nimport { doc, getDoc, setDoc } from 'firebase/firestore';\r\nimport { auth, db } from '../firebase';\r\nimport logo from '../assets/logo.png';\r\nimport LanguageSelector from '../components/LanguageSelector';\r\n\r\n\r\n\r\n// ΓöÇΓöÇΓöÇ ADMIN GUARD ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\n// Only this Google account is auto-promoted to Admin. No role selector shown.\r\nconst ADMIN_EMAIL = 'koteshbitra789@gmail.com';\r\n// ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\n\r\nexport default function Login() {\r\n    // -------------------------------------------------------------------------\r\n    // 1. ALL HOOK DECLARATIONS (Must be at top, unconditional)\r\n    // -------------------------------------------------------------------------\r\n    const [configError, setConfigError] = useState(window.FIREBASE_CONFIG_ERROR || null);\r\n    const [isLogin, setIsLogin] = useState(true);\r\n    const [email, setEmail] = useState('');\r\n    const [password, setPassword] = useState('');\r\n    const [showPassword, setShowPassword] = useState(false);\r\n    const [role, setRole] = useState('student');\r\n    const [error, setError] = useState('');\r\n    const [loading, setLoading] = useState(false);\r\n    const [name, setName] = useState('');\r\n    const [gender, setGender] = useState('');\r\n    const [installPrompt, setInstallPrompt] = useState(null);\r\n\r\n    // PWA Install Logic\r\n    useEffect(() => {\r\n        const handler = (e) => {\r\n            e.preventDefault();\r\n            setInstallPrompt(e);\r\n        };\r\n        window.addEventListener('beforeinstallprompt', handler);\r\n        return () => window.removeEventListener('beforeinstallprompt', handler);\r\n    }, []);\r\n\r\n    const handleInstallClick = () => {\r\n        if (!installPrompt) return;\r\n        installPrompt.prompt();\r\n        installPrompt.userChoice.then((choiceResult) => {\r\n            if (choiceResult.outcome === 'accepted') {\r\n                console.log('User accepted the A2HS prompt');\r\n            }\r\n            setInstallPrompt(null);\r\n        });\r\n    };\r\n\r\n    const navigate = useNavigate();\r\n    const { user, userData, loading: userLoading } = useUser();\r\n    const { t, language, toggleLanguage } = useLanguage();\r\n\r\n    // Helper functions (safe to be here)\r\n    const toggleMode = () => {\r\n        setIsLogin(!isLogin);\r\n        setError('');\r\n    };\r\n\r\n    const checkUserExists = async (uid) => {\r\n        try {\r\n            const safeGet = async (col, id) => {\r\n                try {\r\n                    const s = await getDoc(doc(db, col, id));\r\n                    return s.exists() ? s : null;\r\n                } catch (e) {\r\n                    return null;\r\n                }\r\n            };\r\n\r\n            const instSnap = await safeGet(\"institutions\", uid);\r\n            if (instSnap) {\r\n                const data = instSnap.data();\r\n                return { role: (data.role || 'institution').toLowerCase(), isNew: false, approved: true };\r\n            }\r\n\r\n            const teachSnap = await safeGet(\"teachers\", uid);\r\n            if (teachSnap) {\r\n                const data = teachSnap.data();\r\n                return { role: (data.role || 'teacher').toLowerCase(), isNew: !data.profileCompleted, approved: data.approved };\r\n            }\r\n\r\n            const userSnap = await safeGet(\"users\", uid);\r\n            if (userSnap) {\r\n                const data = userSnap.data();\r\n                const normalizedRole = (data.role || 'student').toLowerCase();\r\n                return { role: normalizedRole, isNew: !data.profileCompleted, approved: data.approved };\r\n            }\r\n\r\n            return { role: null, isNew: true };\r\n        } catch (e) {\r\n            console.error(\"Error checking user existence:\", e);\r\n            throw e;\r\n        }\r\n    };\r\n\r\n    const redirectToRolePage = (role) => {\r\n        const r = (role || '').toLowerCase();\r\n        switch (r) {\r\n            case 'student': navigate('/student'); break;\r\n            case 'teacher': navigate('/teacher'); break;\r\n            case 'institution': navigate('/institution'); break;\r\n            case 'admin': navigate('/admin'); break;\r\n            case 'parent': navigate('/parent'); break;\r\n            default: navigate('/admission');\r\n        }\r\n    };\r\n\r\n    // -------------------------------------------------------------------------\r\n    // 2. USE EFFECTS (Unconditional)\r\n    // -------------------------------------------------------------------------\r\n\r\n    // Effect 1: Redirect logic for logged-in users\r\n    useEffect(() => {\r\n        if (userLoading) return; // Wait for initial load\r\n\r\n        if (user) {\r\n            if (userData && userData.role) {\r\n                const isStudentIncomplete = userData.role === 'student' && (!userData.class || !userData.institutionId);\r\n                const isTeacherIncomplete = userData.role === 'teacher' && (!userData.subject || !userData.institutionId);\r\n                const isInstitutionIncomplete = userData.role === 'institution' && (!userData.schoolName);\r\n\r\n                if (!userData.profileCompleted || isStudentIncomplete || isTeacherIncomplete || isInstitutionIncomplete) {\r\n                    navigate('/details');\r\n                    return;\r\n                }\r\n\r\n                if (userData.approved === false) {\r\n                    navigate('/pending-approval', { replace: true });\r\n                } else if (!userData.onboardingCompleted) {\r\n                    navigate('/onboarding', { replace: true });\r\n                } else {\r\n                    switch (userData.role) {\r\n                        case 'student': navigate('/student', { replace: true }); break;\r\n                        case 'teacher': navigate('/teacher', { replace: true }); break;\r\n                        case 'institution': navigate('/institution', { replace: true }); break;\r\n                        case 'admin': navigate('/admin', { replace: true }); break;\r\n                        case 'parent': navigate('/parent', { replace: true }); break;\r\n                        default: navigate('/admission', { replace: true });\r\n                    }\r\n                }\r\n            } else {\r\n                if (!userData) {\r\n                    navigate('/details');\r\n                }\r\n            }\r\n        }\r\n    }, [user, userData, userLoading, navigate]);\r\n\r\n    // Effect 2: Config Error Check\r\n    useEffect(() => {\r\n        if (window.FIREBASE_CONFIG_ERROR) {\r\n            setConfigError(window.FIREBASE_CONFIG_ERROR);\r\n        }\r\n    }, []);\r\n\r\n    // Effect 3: Redirect Result Handler\r\n    useEffect(() => {\r\n        let isMounted = true;\r\n        const checkRedirect = async () => {\r\n            if (!auth) return;\r\n            try {\r\n                const result = await getRedirectResult(auth);\r\n                if (result && isMounted) {\r\n                    setLoading(true);\r\n                    const user = result.user;\r\n\r\n                    // ΓöÇΓöÇ ADMIN BYPASS (Redirect flow) ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\n                    if (user.email === ADMIN_EMAIL) {\r\n                        await setDoc(doc(db, 'users', user.uid), {\r\n                            name: user.displayName || 'Admin',\r\n                            email: user.email,\r\n                            role: 'admin',\r\n                            approved: true,\r\n                            profileCompleted: true,\r\n                            onboardingCompleted: true,\r\n                        }, { merge: true });\r\n                        if (isMounted) navigate('/admin', { replace: true });\r\n                        return;\r\n                    }\r\n                    // ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\n\r\n                    const { role, isNew, approved } = await checkUserExists(user.uid);\r\n\r\n                    if (isMounted) {\r\n                        if (role && !isNew) {\r\n                            if (approved === false) navigate('/pending-approval');\r\n                            else redirectToRolePage(role);\r\n                        } else {\r\n                            navigate('/details');\r\n                        }\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Redirect Login Failed:\", err);\r\n                if (isMounted) {\r\n                    let msg = err.message;\r\n                    if (err.code === 'auth/unauthorized-domain') {\r\n                        msg = `DOMAIN ERROR: ${window.location.hostname} is not whitelisted in Firebase Console.`;\r\n                        alert(msg);\r\n                    }\r\n                    setError(msg);\r\n                    setLoading(false);\r\n                }\r\n            }\r\n        };\r\n        checkRedirect();\r\n        return () => { isMounted = false; };\r\n    }, [navigate]);\r\n\r\n    // -------------------------------------------------------------------------\r\n    // 3. HANDLERS\r\n    // -------------------------------------------------------------------------\r\n    const handleAuth = async (e) => {\r\n        e.preventDefault();\r\n        setError('');\r\n\r\n        if (isLogin) {\r\n            if (!email || !password) {\r\n                setError('All fields are required!');\r\n                return;\r\n            }\r\n        } else {\r\n            if (!email || !password || !role || !name) {\r\n                setError('Please fill in all required fields.');\r\n                return;\r\n            }\r\n            if (role !== 'institution' && role !== 'admin' && role !== 'parent' && !gender) {\r\n                setError('Gender is required.');\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Password Strength Validation (VULN-011)\r\n        if (!isLogin) {\r\n            if (password.length < 8) {\r\n                setError('Password must be at least 8 characters long.');\r\n                return;\r\n            }\r\n            if (!/[A-Z]/.test(password)) {\r\n                setError('Password must contain at least one uppercase letter.');\r\n                return;\r\n            }\r\n            if (!/[0-9]/.test(password)) {\r\n                setError('Password must contain at least one number.');\r\n                return;\r\n            }\r\n        }\r\n\r\n        setLoading(true);\r\n\r\n        try {\r\n            if (isLogin) {\r\n                const userCredential = await signInWithEmailAndPassword(auth, email, password);\r\n                const uid = userCredential.user.uid;\r\n                const { role: dbRole, isNew, approved } = await checkUserExists(uid);\r\n\r\n                if (dbRole) {\r\n                    if (isNew) {\r\n                        navigate('/details');\r\n                        return;\r\n                    } else {\r\n                        if (approved === false) navigate('/pending-approval');\r\n                        else redirectToRolePage(dbRole);\r\n                    }\r\n                } else {\r\n                    // Fallback if role not found automatically - maybe direct to details to picking one?\r\n                    // Or just default to details\r\n                    navigate('/details');\r\n                }\r\n            } else {\r\n                let uid;\r\n                if (auth.currentUser) {\r\n                    uid = auth.currentUser.uid;\r\n                } else {\r\n                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);\r\n                    uid = userCredential.user.uid;\r\n                }\r\n\r\n                // Two-step registration: account created, now collect profile details\r\n                navigate('/details', { state: { role } });\r\n                return;\r\n            }\r\n        } catch (err) {\r\n            console.error(err);\r\n            setError(err.message.replace('Firebase: ', ''));\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleGoogleSignIn = async () => {\r\n        setLoading(true);\r\n        setError('');\r\n        const provider = new GoogleAuthProvider();\r\n        provider.addScope('profile');\r\n        provider.addScope('email');\r\n        provider.setCustomParameters({ prompt: 'select_account' });\r\n\r\n        try {\r\n            const result = await signInWithPopup(auth, provider);\r\n            const user = result.user;\r\n\r\n            // ΓöÇΓöÇ ADMIN BYPASS (Popup flow) ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\n            if (user.email === ADMIN_EMAIL) {\r\n                await setDoc(doc(db, 'users', user.uid), {\r\n                    name: user.displayName || 'Admin',\r\n                    email: user.email,\r\n                    role: 'admin',\r\n                    approved: true,\r\n                    profileCompleted: true,\r\n                    onboardingCompleted: true,\r\n                }, { merge: true });\r\n                navigate('/admin', { replace: true });\r\n                return;\r\n            }\r\n            // ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ\r\n\r\n            const { role: dbRole, isNew, approved } = await checkUserExists(user.uid);\r\n\r\n            if (dbRole && !isNew) {\r\n                if (approved === false) navigate('/pending-approval');\r\n                else redirectToRolePage(dbRole);\r\n            } else {\r\n                navigate('/details', { state: { role: role } });\r\n                return;\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Popup Error:\", err);\r\n            if (['auth/popup-blocked', 'auth/cancelled-popup-request', 'auth/popup-closed-by-user'].includes(err.code)) {\r\n                console.log(\"Popup blocked/closed. Trying Redirect...\");\r\n                try {\r\n                    await signInWithRedirect(auth, provider);\r\n                } catch (redirErr) {\r\n                    setError(\"Redirect Failed: \" + redirErr.message);\r\n                    setLoading(false);\r\n                }\r\n            } else if (err.code === 'auth/unauthorized-domain') {\r\n                const msg = `SETUP ERROR: Domain '${window.location.hostname}' is not authorized in Firebase.`;\r\n                setError(msg);\r\n                alert(msg);\r\n                setLoading(false);\r\n            } else {\r\n                setError(\"Login Error: \" + err.message);\r\n                setLoading(false);\r\n            }\r\n        }\r\n    };\r\n\r\n    // -------------------------------------------------------------------------\r\n    // 4. CONDITIONAL RENDERS (Must be at the very end)\r\n    // -------------------------------------------------------------------------\r\n\r\n    if (configError) {\r\n        return (\r\n            <div className=\"login-container\">\r\n                <div className=\"card login-card\" style={{ textAlign: 'center', borderTop: '5px solid red' }}>\r\n                    <h2 style={{ color: '#d63031' }}>ΓÜá∩╕Å Configuration Error</h2>\r\n                    <p>The application could not start because some environment variables are missing.</p>\r\n                    <div style={{ background: '#ffeaa7', padding: '10px', borderRadius: '5px', margin: '20px 0', textAlign: 'left', fontSize: '12px', overflow: 'auto' }}>\r\n                        <strong>Missing Keys / Error:</strong>\r\n                        <pre>{JSON.stringify(configError, null, 2)}</pre>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (userLoading || user) {\r\n        return (\r\n            <div style={{ height: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '20px' }}>\r\n                <div className=\"spinner\" style={{ width: '40px', height: '40px', borderRadius: '50%', border: '4px solid #f3f3f3', borderTop: '4px solid #3498db', animation: 'spin 1s linear infinite' }}></div>\r\n                <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>\r\n                <p>{user ? \"Redirecting...\" : \"Verifying Session...\"}</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!auth) return <div className=\"login-container\"><div className=\"card\">Error: Firebase Auth not initialized.</div></div>;\r\n\r\n    return (\r\n        <div className=\"auth-page-wrapper\">\r\n            <div className=\"auth-card card shadow-lg\">\r\n                <div className=\"auth-header\">\r\n                    <LanguageSelector />\r\n                </div>\r\n\r\n                <div className=\"auth-logo-section\">\r\n                    <img src={logo} alt=\"Together To Refine\" className=\"auth-logo\" />\r\n                </div>\r\n\r\n                <h2 className=\"auth-title\">{isLogin ? t('login') : t('signup')}</h2>\r\n                {error && <div className=\"error-banner\">{error}</div>}\r\n\r\n                <form onSubmit={handleAuth} className=\"auth-form\">\r\n                    {!isLogin && (\r\n                        <div className=\"form-group\">\r\n                            <label className=\"form-label\">Role</label>\r\n                            <select\r\n                                className=\"input-field\"\r\n                                value={role}\r\n                                onChange={(e) => setRole(e.target.value)}\r\n                                required\r\n                            >\r\n                                <option value=\"\" disabled>Select Role</option>\r\n                                <option value=\"student\">Student</option>\r\n                                <option value=\"teacher\">Teacher</option>\r\n                                <option value=\"institution\">Institution</option>\r\n                                <option value=\"parent\">Parent</option>\r\n                            </select>\r\n                        </div>\r\n                    )}\r\n\r\n                    {!isLogin && (\r\n                        <>\r\n                            <input\r\n                                type=\"text\"\r\n                                className=\"input-field\"\r\n                                placeholder={role === 'institution' ? \"Institution Name\" : \"Your Name\"}\r\n                                value={name}\r\n                                onChange={(e) => setName(e.target.value)}\r\n                                autoComplete=\"off\"\r\n                                autoCorrect=\"off\"\r\n                                spellCheck=\"false\"\r\n                                required\r\n                            />\r\n\r\n                            {role !== 'institution' && role !== 'admin' && role !== 'parent' && (\r\n                                <select\r\n                                    className=\"input-field\"\r\n                                    value={gender}\r\n                                    onChange={(e) => setGender(e.target.value)}\r\n                                    required\r\n                                >\r\n                                    <option value=\"\" disabled>Select Gender</option>\r\n                                    <option value=\"Male\">Male</option>\r\n                                    <option value=\"Female\">Female</option>\r\n                                    <option value=\"Other\">Other</option>\r\n                                </select>\r\n                            )}\r\n                        </>\r\n                    )}\r\n\r\n                    <input\r\n                        type=\"email\"\r\n                        className=\"input-field\"\r\n                        placeholder={t('email_placeholder')}\r\n                        value={email}\r\n                        onChange={(e) => setEmail(e.target.value)}\r\n                        autoComplete=\"off\"\r\n                        autoCorrect=\"off\"\r\n                        required\r\n                    />\r\n\r\n                    <div className=\"password-wrapper\">\r\n                        <input\r\n                            type={showPassword ? \"text\" : \"password\"}\r\n                            className=\"input-field\"\r\n                            placeholder={t('password_placeholder')}\r\n                            value={password}\r\n                            onChange={(e) => setPassword(e.target.value)}\r\n                            autoComplete=\"new-password\"\r\n                            required\r\n                        />\r\n                        <button\r\n                            type=\"button\"\r\n                            className=\"password-toggle\"\r\n                            onClick={() => setShowPassword(!showPassword)}\r\n                        >\r\n                            {showPassword ? \"≡ƒÖê\" : \"≡ƒæü∩╕Å\"}\r\n                        </button>\r\n                    </div>\r\n\r\n                    <button type=\"submit\" className=\"btn btn-primary full-width\" disabled={loading}>\r\n                        {loading ? <div className=\"spinner-sm\" /> : (isLogin ? t('login') : t('signup'))}\r\n                    </button>\r\n                </form>\r\n\r\n                <div className=\"auth-divider\">\r\n                    <div className=\"divider-line\" />\r\n                    <span className=\"divider-text\">OR</span>\r\n                    <div className=\"divider-line\" />\r\n                </div>\r\n\r\n                <button\r\n                    type=\"button\"\r\n                    className=\"btn btn-outline full-width google-btn\"\r\n                    onClick={handleGoogleSignIn}\r\n                    disabled={loading}\r\n                >\r\n                    Log in with Google\r\n                </button>\r\n\r\n                <div className=\"auth-footer\">\r\n                    <span onClick={toggleMode} className=\"auth-toggle-link\">\r\n                        {isLogin ? t('no_account') : t('have_account')}\r\n                    </span>\r\n                </div>\r\n\r\n                {installPrompt && (\r\n                    <button\r\n                        onClick={handleInstallClick}\r\n                        className=\"btn btn-success pwa-install-btn\"\r\n                    >\r\n                        ≡ƒô▓ Install App\r\n                    </button>\r\n                )}\r\n\r\n                <div style={{ marginTop: '24px', textAlign: 'center', color: '#636e72', fontSize: '11px', borderTop: '1px solid #eee', paddingTop: '16px' }}>\r\n                    <strong>We do not sell student data. Period.</strong>\r\n                    <br />\r\n                    TTR follows the strict Anonymizer Privacy Protocol. Your personal interactions learning with the AI are totally private and never used against you.\r\n                </div>\r\n            </div>\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\MarksManagement.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'addDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"addDoc"},"fix":{"range":[207,215],"text":""},"desc":"Remove unused variable 'addDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":77,"suggestions":[{"messageId":"removeVar","data":{"varName":"orderBy"},"fix":{"range":[255,264],"text":""},"desc":"Remove unused variable 'orderBy'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'writeBatch' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":89,"suggestions":[{"messageId":"removeVar","data":{"varName":"writeBatch"},"fix":{"range":[264,276],"text":""},"desc":"Remove unused variable 'writeBatch'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":190,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":190,"endColumn":61,"suggestions":[{"messageId":"removeVar","data":{"varName":"_"},"fix":{"range":[7718,7719],"text":""},"desc":"Remove unused variable '_'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":198,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":198,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"_"},"fix":{"range":[7951,7952],"text":""},"desc":"Remove unused variable '_'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, addDoc, query, where, getDocs, serverTimestamp, orderBy, writeBatch, doc, setDoc } from 'firebase/firestore';\r\nimport SmartMarksScan from '../components/SmartMarksScan';\r\n\r\nexport default function MarksManagement() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    // View Toggle\r\n    const [activeTab, setActiveTab] = useState('add'); // 'add' or 'view'\r\n\r\n    // ADD MARKS STATE\r\n    const [selectedClass, setSelectedClass] = useState('');\r\n    const [selectedSection, setSelectedSection] = useState('');\r\n    const [examType, setExamType] = useState(''); // Assignment 1, Mid-1, Final\r\n    const [students, setStudents] = useState([]);\r\n    const [marksData, setMarksData] = useState({}); // { studentId: marks }\r\n\r\n    // VIEW MARKS STATE\r\n    const [allMarks, setAllMarks] = useState([]);\r\n    const [filterClass, setFilterClass] = useState('');\r\n    const [filterSection, setFilterSection] = useState('');\r\n    const [filterExamType, setFilterExamType] = useState(''); // NEW: Filter by exam type\r\n    const [loading, setLoading] = useState(false);\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [showSmartMarks, setShowSmartMarks] = useState(false);\r\n\r\n    // Fetch students when class/section selected\r\n    useEffect(() => {\r\n        if (selectedClass && selectedSection && activeTab === 'add') {\r\n            fetchStudents();\r\n        }\r\n    }, [selectedClass, selectedSection, activeTab]);\r\n\r\n    const handleSmartComplete = async (parsed) => {\r\n        setShowSmartMarks(false);\r\n        if (!parsed) return;\r\n\r\n        // 1. Update Metadata\r\n        if (parsed.class) setSelectedClass(String(parsed.class));\r\n        if (parsed.section) setSelectedSection(String(parsed.section).toUpperCase());\r\n\r\n        // Match exam type to available options\r\n        const validExams = [\"Assignment 1\", \"Assignment 2\", \"Mid-Term 1\", \"Mid-Term 2\", \"Final Exam\"];\r\n        const matchedExam = validExams.find(ve => parsed.examType?.includes(ve)) || parsed.examType;\r\n        if (matchedExam) setExamType(matchedExam);\r\n\r\n        // 2. Fetch Students for the detected class/section immediately to sync\r\n        try {\r\n            const q = query(\r\n                collection(db, \"student_allotments\"),\r\n                where(\"classAssigned\", \"==\", String(parsed.class)),\r\n                where(\"section\", \"==\", String(parsed.section).toUpperCase())\r\n            );\r\n            const snap = await getDocs(q);\r\n            const studentList = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n\r\n            if (studentList.length === 0) {\r\n                alert(`Detected Class ${parsed.class}-${parsed.section}, but no students were found for this selection in the database.`);\r\n                setStudents([]);\r\n                return;\r\n            }\r\n\r\n            setStudents(studentList);\r\n\r\n            // 3. Smart Matching with extracted data\r\n            const newMarks = {};\r\n            let matchedCount = 0;\r\n\r\n            studentList.forEach(s => {\r\n                const sId = s.studentId || s.id;\r\n                const dbName = (s.studentName || s.name || \"\").toLowerCase().trim();\r\n\r\n                // Fuzzy matching against every extracted name\r\n                // Also match first parts of name if no exact match\r\n                const extractionMatch = parsed.data?.find(m => {\r\n                    if (!m.nameKey) return false;\r\n                    const extName = String(m.nameKey).toLowerCase().trim();\r\n                    return extName === dbName || extName.includes(dbName) || dbName.includes(extName);\r\n                });\r\n\r\n                if (extractionMatch) {\r\n                    newMarks[sId] = extractionMatch.marks;\r\n                    matchedCount++;\r\n                } else {\r\n                    newMarks[sId] = ''; // Keep empty if no match\r\n                }\r\n            });\r\n\r\n            setMarksData(newMarks);\r\n            alert(`Γ£¿ AI Smart Scan complete!\\n- Detected: Class ${parsed.class}-${parsed.section}\\n- Exam: ${matchedExam}\\n- Auto-filled marks for ${matchedCount} out of ${studentList.length} students.`);\r\n        } catch (err) {\r\n            console.error(\"AI Scan Error:\", err);\r\n            alert(\"Scan Error: \" + err.message);\r\n        }\r\n    };\r\n\r\n    // Fetch all marks when viewing\r\n    useEffect(() => {\r\n        if (activeTab === 'view') {\r\n            fetchAllMarks();\r\n        }\r\n    }, [activeTab, filterClass, filterSection, filterExamType]);\r\n\r\n    const fetchStudents = async () => {\r\n        try {\r\n            const q = query(\r\n                collection(db, \"student_allotments\"),\r\n                where(\"classAssigned\", \"==\", selectedClass),\r\n                where(\"section\", \"==\", selectedSection)\r\n            );\r\n            const snap = await getDocs(q);\r\n            const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n            setStudents(list);\r\n\r\n            // Initialize marks object\r\n            const initial = {};\r\n            list.forEach(s => initial[s.studentId || s.id] = '');\r\n            setMarksData(initial);\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const fetchAllMarks = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // Fetch ALL marks and filter client-side for maximum robustness\r\n            // This bypasses Firestore index requirements and type mismatches (string vs number)\r\n            const q = query(collection(db, \"marks\"));\r\n\r\n            const snap = await getDocs(q);\r\n            let list = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n\r\n            // ENFORCE STUDENT PRIVACY: If role is student, only show their own marks\r\n            if (userData?.role === 'student') {\r\n                const myPid = (userData.pid || userData.rollNo || userData.rollNumber || '').toString().trim();\r\n                const myUid = userData.uid;\r\n\r\n                list = list.filter(m =>\r\n                    (m.studentId === myUid) ||\r\n                    (myPid !== '' && m.rollNo?.toString().trim() === myPid)\r\n                );\r\n            }\r\n\r\n            // Filter logic\r\n            if (filterClass) {\r\n                list = list.filter(m => String(m.class) === String(filterClass));\r\n            }\r\n            if (filterSection) {\r\n                list = list.filter(m => String(m.section).toUpperCase() === String(filterSection).toUpperCase());\r\n            }\r\n            if (filterExamType) {\r\n                list = list.filter(m => m.examType === filterExamType);\r\n            }\r\n\r\n            // Client-side Sort (Newest First)\r\n            list.sort((a, b) => {\r\n                const tA = a.createdAt?.seconds || 0;\r\n                const tB = b.createdAt?.seconds || 0;\r\n                return tB - tA;\r\n            });\r\n\r\n            setAllMarks(list);\r\n        } catch (e) {\r\n            console.error(\"Error fetching marks:\", e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleMarkChange = (studentId, value) => {\r\n        setMarksData(prev => ({ ...prev, [studentId]: value }));\r\n    };\r\n\r\n    const handleSubmitMarks = async () => {\r\n        if (!examType || !selectedClass || !selectedSection) {\r\n            alert(\"Please select exam type, class, and section.\");\r\n            return;\r\n        }\r\n\r\n        if (!userData || !userData.uid) {\r\n            alert(\"User session not found. Please login again.\");\r\n            return;\r\n        }\r\n\r\n        const entries = Object.entries(marksData).filter(([_, marks]) => marks !== '');\r\n\r\n        if (entries.length === 0) {\r\n            alert(\"Please enter at least one mark.\");\r\n            return;\r\n        }\r\n\r\n        // Validate marks\r\n        const invalidEntries = entries.filter(([_, marks]) => {\r\n            const m = parseFloat(marks);\r\n            return isNaN(m) || m < 0 || m > 100;\r\n        });\r\n\r\n        if (invalidEntries.length > 0) {\r\n            alert(\"Some marks are invalid. Please ensure all marks are numbers between 0 and 100.\");\r\n            return;\r\n        }\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            console.log(`Starting submission for ${entries.length} students...`);\r\n\r\n            // Use Parallel Requests (Robustness against single failures)\r\n            const promises = entries.map(async ([studentId, marks]) => {\r\n                // Find student by matching ID (handling potential type mismatch)\r\n                const student = students.find(s => String(s.studentId || s.id) === String(studentId));\r\n\r\n                // Construct Deterministic ID for Upsert (prevents duplicates)\r\n                const safeSubject = (userData.subject || \"General\").replace(/[^a-zA-Z0-9]/g, \"_\");\r\n                const safeExam = examType.replace(/[^a-zA-Z0-9]/g, \"_\");\r\n                const docId = `MARK_${studentId}_${safeSubject}_${safeExam}`;\r\n\r\n                const docRef = doc(db, \"marks\", docId);\r\n\r\n                await setDoc(docRef, {\r\n                    studentId: studentId,\r\n                    studentName: student?.studentName || student?.name || \"Unknown\",\r\n                    class: selectedClass,\r\n                    section: selectedSection,\r\n                    subject: userData.subject || \"General\",\r\n                    examType: examType,\r\n                    marks: parseFloat(marks),\r\n                    maxMarks: 100,\r\n                    teacherId: userData.uid,\r\n                    teacherName: userData.name || \"Teacher\",\r\n                    createdAt: serverTimestamp(), // Acts as 'Last Updated'\r\n                    institutionId: userData.institutionId || userData.createdBy || userData.uid || \"unknown\"\r\n                }, { merge: true });\r\n            });\r\n\r\n            const results = await Promise.allSettled(promises);\r\n            const successCount = results.filter(r => r.status === 'fulfilled').length;\r\n            const failCount = results.length - successCount;\r\n\r\n            if (failCount > 0) {\r\n                console.error(\"Some submissions failed:\", results.filter(r => r.status === 'rejected'));\r\n                alert(`ΓÜá∩╕Å Submitted ${successCount} marks, but ${failCount} failed. Check console for details.`);\r\n            } else {\r\n                console.log(\"All marks submitted successfully!\");\r\n                alert(`Γ£à Successfully submitted all ${successCount} marks!`);\r\n                setMarksData({});\r\n                setExamType('');\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error submitting marks:\", e);\r\n            alert(\"Error submitting marks: \" + e.message);\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    // TAB TOGGLE: Forced 'view' for students\r\n    useEffect(() => {\r\n        if (userData?.role === 'student' && activeTab === 'add') {\r\n            setActiveTab('view');\r\n        }\r\n    }, [userData, activeTab]);\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                    <h2>≡ƒôè {userData?.role === 'student' ? 'My Academic Progress' : 'Marks Management'}</h2>\r\n                    <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                </div>\r\n\r\n                {/* Tab Toggle - Only for Teachers/Admins */}\r\n                {userData?.role !== 'student' && (\r\n                    <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', borderBottom: '2px solid #eee' }}>\r\n                        <button\r\n                            onClick={() => setActiveTab('add')}\r\n                            style={{\r\n                                padding: '10px 20px', background: 'none', border: 'none',\r\n                                borderBottom: activeTab === 'add' ? '3px solid #0984e3' : 'none',\r\n                                fontWeight: activeTab === 'add' ? 'bold' : 'normal',\r\n                                cursor: 'pointer', color: activeTab === 'add' ? '#0984e3' : '#636e72'\r\n                            }}\r\n                        >\r\n                            Γ₧ò Add Marks\r\n                        </button>\r\n                        <button\r\n                            onClick={() => setActiveTab('view')}\r\n                            style={{\r\n                                padding: '10px 20px', background: 'none', border: 'none',\r\n                                borderBottom: activeTab === 'view' ? '3px solid #0984e3' : 'none',\r\n                                fontWeight: activeTab === 'view' ? 'bold' : 'normal',\r\n                                cursor: 'pointer', color: activeTab === 'view' ? '#0984e3' : '#636e72'\r\n                            }}\r\n                        >\r\n                            ≡ƒæü∩╕Å View All Marks\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n                {/* ADD MARKS TAB */}\r\n                {activeTab === 'add' && (\r\n                    <div className=\"card\">\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>\r\n                            <h3 style={{ margin: 0 }}>Enter Marks</h3>\r\n                            <div>\r\n                                <button\r\n                                    onClick={() => setShowSmartMarks(true)}\r\n                                    style={{\r\n                                        padding: '10px 20px',\r\n                                        background: 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)',\r\n                                        color: 'white',\r\n                                        border: 'none',\r\n                                        borderRadius: '30px',\r\n                                        cursor: 'pointer',\r\n                                        fontSize: '14px',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '8px',\r\n                                        fontWeight: 'bold',\r\n                                        boxShadow: '0 4px 15px rgba(108, 92, 231, 0.3)',\r\n                                        transition: 'transform 0.2s'\r\n                                    }}\r\n                                    onMouseOver={(e) => (e.currentTarget.style.transform = 'scale(1.05)')}\r\n                                    onMouseOut={(e) => (e.currentTarget.style.transform = 'scale(1)')}\r\n                                >\r\n                                    ≡ƒô╕ AI Smart Scan\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <p style={{ fontSize: '12px', color: '#636e72', marginBottom: '20px' }}>\r\n                            Tip: You can <b>Smart Scan</b> your paper marksheet using the button above to auto-fill everything!\r\n                        </p>\r\n\r\n                        {/* Selection Row */}\r\n                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '10px', marginBottom: '20px' }}>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#636e72' }}>Class</label>\r\n                                <select className=\"input-field\" value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)}>\r\n                                    <option value=\"\">Select</option>\r\n                                    {[...Array(12)].map((_, i) => <option key={i} value={i + 1}>{i + 1}</option>)}\r\n                                </select>\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#636e72' }}>Section</label>\r\n                                <select className=\"input-field\" value={selectedSection} onChange={(e) => setSelectedSection(e.target.value)}>\r\n                                    <option value=\"\">Select</option>\r\n                                    {['A', 'B', 'C', 'D'].map(s => <option key={s} value={s}>{s}</option>)}\r\n                                </select>\r\n                            </div>\r\n                            <div>\r\n                                <label style={{ fontSize: '12px', color: '#636e72' }}>Exam Type</label>\r\n                                <select className=\"input-field\" value={examType} onChange={(e) => setExamType(e.target.value)}>\r\n                                    <option value=\"\">Select</option>\r\n                                    <option value=\"Assignment 1\">Assignment 1</option>\r\n                                    <option value=\"Assignment 2\">Assignment 2</option>\r\n                                    <option value=\"Mid-Term 1\">Mid-Term 1</option>\r\n                                    <option value=\"Mid-Term 2\">Mid-Term 2</option>\r\n                                    <option value=\"Final Exam\">Final Exam</option>\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Student List */}\r\n                        {students.length > 0 ? (\r\n                            <>\r\n                                <div style={{ maxHeight: '400px', overflowY: 'auto', border: '1px solid #eee', borderRadius: '8px' }}>\r\n                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>\r\n                                        <thead style={{ background: '#f8f9fa', position: 'sticky', top: 0 }}>\r\n                                            <tr>\r\n                                                <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Roll No</th>\r\n                                                <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Student Name</th>\r\n                                                <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Marks (out of 100)</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {students.map((student, idx) => {\r\n                                                const studentId = student.studentId || student.id;\r\n                                                return (\r\n                                                    <tr key={studentId} style={{ borderBottom: '1px solid #eee' }}>\r\n                                                        <td style={{ padding: '10px' }}>{idx + 1}</td>\r\n                                                        <td style={{ padding: '10px' }}>{student.studentName || student.name}</td>\r\n                                                        <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                            <input\r\n                                                                type=\"number\"\r\n                                                                min=\"0\"\r\n                                                                max=\"100\"\r\n                                                                value={marksData[studentId] || ''}\r\n                                                                onChange={(e) => handleMarkChange(studentId, e.target.value)}\r\n                                                                style={{\r\n                                                                    width: '80px', padding: '5px', textAlign: 'center',\r\n                                                                    border: '1px solid #ddd', borderRadius: '4px'\r\n                                                                }}\r\n                                                                placeholder=\"--\"\r\n                                                            />\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                );\r\n                                            })}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                                <button onClick={handleSubmitMarks} className=\"btn\" style={{ marginTop: '15px', width: '100%' }} disabled={isSubmitting}>\r\n                                    {isSubmitting ? 'ΓÅ│ Submitting...' : 'Γ£à Submit All Marks'}\r\n                                </button>\r\n                            </>\r\n                        ) : (\r\n                            <p style={{ textAlign: 'center', color: '#999', padding: '40px' }}>\r\n                                Select class, section to load students\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* VIEW MARKS TAB */}\r\n                {activeTab === 'view' && (\r\n                    <div className=\"card\">\r\n                        <div style={{ display: 'flex', gap: '10px', alignItems: 'center', marginBottom: '15px', flexWrap: 'wrap' }}>\r\n                            <h3 style={{ margin: 0, flex: 1 }}>All Marks</h3>\r\n\r\n                            <select className=\"input-field\" value={filterClass} onChange={(e) => setFilterClass(e.target.value)} style={{ width: '140px' }}>\r\n                                <option value=\"\">All Classes</option>\r\n                                {[...Array(12)].map((_, i) => <option key={i} value={i + 1}>Class {i + 1}</option>)}\r\n                            </select>\r\n\r\n                            <select className=\"input-field\" value={filterSection} onChange={(e) => setFilterSection(e.target.value)} style={{ width: '120px' }}>\r\n                                <option value=\"\">All Sections</option>\r\n                                {['A', 'B', 'C', 'D'].map(s => <option key={s} value={s}>Section {s}</option>)}\r\n                            </select>\r\n\r\n                            <select className=\"input-field\" value={filterExamType} onChange={(e) => setFilterExamType(e.target.value)} style={{ width: '150px' }}>\r\n                                <option value=\"\">All Exam Types</option>\r\n                                <option value=\"Assignment 1\">Assignment 1</option>\r\n                                <option value=\"Assignment 2\">Assignment 2</option>\r\n                                <option value=\"Mid-Term 1\">Mid-Term 1</option>\r\n                                <option value=\"Mid-Term 2\">Mid-Term 2</option>\r\n                                <option value=\"Final Exam\">Final Exam</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        {loading ? (\r\n                            <p style={{ textAlign: 'center', padding: '40px' }}>Loading...</p>\r\n                        ) : allMarks.length === 0 ? (\r\n                            <p style={{ textAlign: 'center', color: '#999', padding: '40px' }}>No marks entered yet.</p>\r\n                        ) : (\r\n                            <div style={{ overflowX: 'auto' }}>\r\n                                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>\r\n                                    <thead style={{ background: '#f8f9fa' }}>\r\n                                        <tr>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Student</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Class</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Subject</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Exam</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Marks</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Teacher</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {allMarks.map((mark) => {\r\n                                            const percentage = (mark.marks / mark.maxMarks) * 100;\r\n                                            const isLow = percentage < 40;\r\n\r\n                                            return (\r\n                                                <tr key={mark.id} style={{\r\n                                                    borderBottom: '1px solid #eee',\r\n                                                    background: isLow ? '#fff5f5' : 'white'\r\n                                                }}>\r\n                                                    <td style={{ padding: '10px' }}>\r\n                                                        {mark.studentName}\r\n                                                        {isLow && <span style={{ marginLeft: '5px', color: '#e74c3c', fontSize: '12px' }}>ΓÜá∩╕Å Low</span>}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center' }}>{mark.class}-{mark.section}</td>\r\n                                                    <td style={{ padding: '10px' }}>{mark.subject}</td>\r\n                                                    <td style={{ padding: '10px' }}>{mark.examType}</td>\r\n                                                    <td style={{\r\n                                                        padding: '10px',\r\n                                                        textAlign: 'center',\r\n                                                        fontWeight: 'bold',\r\n                                                        color: isLow ? '#e74c3c' : percentage >= 75 ? '#27ae60' : '#f39c12'\r\n                                                    }}>\r\n                                                        {mark.marks}/{mark.maxMarks}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', fontSize: '12px', color: '#636e72' }}>{mark.teacherName}</td>\r\n                                                </tr>\r\n                                            );\r\n                                        })}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n                {showSmartMarks && (\r\n                    <SmartMarksScan\r\n                        onClose={() => setShowSmartMarks(false)}\r\n                        onScanComplete={handleSmartComplete}\r\n                    />\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\MessagingSystem.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":91,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[288,299],"text":""},"desc":"Remove unused variable 'updateDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":93,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":96,"suggestions":[{"messageId":"removeVar","data":{"varName":"doc"},"fix":{"range":[299,304],"text":""},"desc":"Remove unused variable 'doc'."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`validateAccess` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  30 |\n  31 |         // Validate access control\n> 32 |         const isAllowed = validateAccess();\n     |                           ^^^^^^^^^^^^^^ `validateAccess` accessed before it is declared\n  33 |         if (!isAllowed) {\n  34 |             alert(\"You don't have permission to message this user\");\n  35 |             navigate(-1);\n\n  55 |     }, [recipientInfo, userData]);\n  56 |\n> 57 |     const validateAccess = () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 58 |         const myRole = userData.role;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 59 |         const theirRole = recipientInfo.role;\n     ΓÇª\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 75 |         return false;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 76 |     };\n     | ^^^^^^^ `validateAccess` is declared here\n  77 |\n  78 |     const getConversationId = (uid1, uid2) => {\n  79 |         // Create consistent conversation ID regardless of who initiates","line":32,"column":27,"nodeType":null,"endLine":32,"endColumn":41},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`getConversationId` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  38 |\n  39 |         // Subscribe to messages\n> 40 |         const conversationId = getConversationId(userData.uid, recipientInfo.uid);\n     |                                ^^^^^^^^^^^^^^^^^ `getConversationId` accessed before it is declared\n  41 |         const q = query(\n  42 |             collection(db, \"messages\"),\n  43 |             where(\"conversationId\", \"==\", conversationId),\n\n  76 |     };\n  77 |\n> 78 |     const getConversationId = (uid1, uid2) => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 79 |         // Create consistent conversation ID regardless of who initiates\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 80 |         return [uid1, uid2].sort().join('_');\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 81 |     };\n     | ^^^^^^^ `getConversationId` is declared here\n  82 |\n  83 |     const sendMessage = async () => {\n  84 |         if (!newMessage.trim()) return;","line":40,"column":32,"nodeType":null,"endLine":40,"endColumn":49}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, updateDoc, doc } from 'firebase/firestore';\r\n\r\nexport default function MessagingSystem() {\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n    const { userData } = useUser();\r\n\r\n    // Get recipient info from navigation state\r\n    const recipientInfo = location.state?.recipient;\r\n\r\n    const [messages, setMessages] = useState([]);\r\n    const [newMessage, setNewMessage] = useState('');\r\n    const [loading, setLoading] = useState(true);\r\n    const messagesEndRef = useRef(null);\r\n\r\n    const scrollToBottom = () => {\r\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (!recipientInfo) {\r\n            alert(\"No recipient selected\");\r\n            navigate(-1);\r\n            return;\r\n        }\r\n\r\n        // Validate access control\r\n        const isAllowed = validateAccess();\r\n        if (!isAllowed) {\r\n            alert(\"You don't have permission to message this user\");\r\n            navigate(-1);\r\n            return;\r\n        }\r\n\r\n        // Subscribe to messages\r\n        const conversationId = getConversationId(userData.uid, recipientInfo.uid);\r\n        const q = query(\r\n            collection(db, \"messages\"),\r\n            where(\"conversationId\", \"==\", conversationId),\r\n            orderBy(\"timestamp\", \"asc\")\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const msgs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));\r\n            setMessages(msgs);\r\n            setLoading(false);\r\n            setTimeout(scrollToBottom, 100);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [recipientInfo, userData]);\r\n\r\n    const validateAccess = () => {\r\n        const myRole = userData.role;\r\n        const theirRole = recipientInfo.role;\r\n\r\n        // Teacher ΓåÆ Parent\r\n        if (myRole === 'teacher' && theirRole === 'parent') return true;\r\n\r\n        // Institution ΓåÆ Parent\r\n        if (myRole === 'institution' && theirRole === 'parent') return true;\r\n\r\n        // Institution ΓåÆ Teacher\r\n        if (myRole === 'institution' && theirRole === 'teacher') return true;\r\n\r\n        // Reverse directions (Parent ΓåÆ Teacher, etc.)\r\n        if (myRole === 'parent' && theirRole === 'teacher') return true;\r\n        if (myRole === 'parent' && theirRole === 'institution') return true;\r\n        if (myRole === 'teacher' && theirRole === 'institution') return true;\r\n\r\n        return false;\r\n    };\r\n\r\n    const getConversationId = (uid1, uid2) => {\r\n        // Create consistent conversation ID regardless of who initiates\r\n        return [uid1, uid2].sort().join('_');\r\n    };\r\n\r\n    const sendMessage = async () => {\r\n        if (!newMessage.trim()) return;\r\n\r\n        const conversationId = getConversationId(userData.uid, recipientInfo.uid);\r\n\r\n        try {\r\n            await addDoc(collection(db, \"messages\"), {\r\n                conversationId,\r\n                senderId: userData.uid,\r\n                senderName: userData.name || userData.firstName || 'Unknown',\r\n                senderRole: userData.role,\r\n                receiverId: recipientInfo.uid,\r\n                receiverName: recipientInfo.name,\r\n                receiverRole: recipientInfo.role,\r\n                message: newMessage,\r\n                timestamp: serverTimestamp(),\r\n                read: false\r\n            });\r\n\r\n            setNewMessage('');\r\n            scrollToBottom();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error sending message\");\r\n        }\r\n    };\r\n\r\n    const handleKeyPress = (e) => {\r\n        if (e.key === 'Enter' && !e.shiftKey) {\r\n            e.preventDefault();\r\n            sendMessage();\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"page-wrapper\">\r\n                <div className=\"container\" style={{ textAlign: 'center', padding: '60px' }}>\r\n                    Loading messages...\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>\r\n            <div className=\"container\" style={{ flex: 1, display: 'flex', flexDirection: 'column', maxHeight: '100vh' }}>\r\n                {/* Header */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    justifyContent: 'space-between',\r\n                    alignItems: 'center',\r\n                    padding: '15px 20px',\r\n                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n                    color: 'white',\r\n                    borderRadius: '8px 8px 0 0',\r\n                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)'\r\n                }}>\r\n                    <div>\r\n                        <h3 style={{ margin: 0, fontSize: '18px' }}>\r\n                            ≡ƒÆ¼ {recipientInfo.name}\r\n                        </h3>\r\n                        <div style={{ fontSize: '13px', opacity: 0.9, marginTop: '3px' }}>\r\n                            {recipientInfo.role === 'parent' ? '≡ƒæ¿ΓÇì≡ƒæ⌐ΓÇì≡ƒæº Parent' :\r\n                                recipientInfo.role === 'teacher' ? '≡ƒæ¿ΓÇì≡ƒÅ½ Teacher' :\r\n                                    '≡ƒÅó Institution'}\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => navigate(-1)}\r\n                        style={{\r\n                            background: 'rgba(255,255,255,0.2)',\r\n                            border: 'none',\r\n                            color: 'white',\r\n                            padding: '8px 16px',\r\n                            borderRadius: '6px',\r\n                            cursor: 'pointer',\r\n                            fontSize: '14px'\r\n                        }}\r\n                    >\r\n                        ΓåÉ Back\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Messages Area */}\r\n                <div style={{\r\n                    flex: 1,\r\n                    overflowY: 'auto',\r\n                    padding: '20px',\r\n                    background: '#f5f5f5',\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    gap: '10px'\r\n                }}>\r\n                    {messages.length === 0 ? (\r\n                        <div style={{\r\n                            textAlign: 'center',\r\n                            padding: '60px 20px',\r\n                            color: '#999'\r\n                        }}>\r\n                            <div style={{ fontSize: '48px', marginBottom: '10px' }}>≡ƒÆ¼</div>\r\n                            <div>No messages yet. Start the conversation!</div>\r\n                        </div>\r\n                    ) : (\r\n                        messages.map(msg => {\r\n                            const isMine = msg.senderId === userData.uid;\r\n                            return (\r\n                                <div key={msg.id} style={{\r\n                                    display: 'flex',\r\n                                    justifyContent: isMine ? 'flex-end' : 'flex-start',\r\n                                    marginBottom: '5px'\r\n                                }}>\r\n                                    <div style={{\r\n                                        maxWidth: '70%',\r\n                                        padding: '10px 15px',\r\n                                        borderRadius: isMine ? '18px 18px 4px 18px' : '18px 18px 18px 4px',\r\n                                        background: isMine ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',\r\n                                        color: isMine ? 'white' : '#2c3e50',\r\n                                        boxShadow: '0 2px 5px rgba(0,0,0,0.1)',\r\n                                        wordBreak: 'break-word'\r\n                                    }}>\r\n                                        {!isMine && (\r\n                                            <div style={{\r\n                                                fontSize: '11px',\r\n                                                opacity: 0.8,\r\n                                                marginBottom: '5px',\r\n                                                fontWeight: 'bold'\r\n                                            }}>\r\n                                                {msg.senderName}\r\n                                            </div>\r\n                                        )}\r\n                                        <div style={{ fontSize: '14px', lineHeight: '1.4' }}>\r\n                                            {msg.message}\r\n                                        </div>\r\n                                        <div style={{\r\n                                            fontSize: '10px',\r\n                                            opacity: 0.7,\r\n                                            marginTop: '5px',\r\n                                            textAlign: 'right'\r\n                                        }}>\r\n                                            {msg.timestamp?.toDate?.()?.toLocaleTimeString([], {\r\n                                                hour: '2-digit',\r\n                                                minute: '2-digit'\r\n                                            }) || 'Sending...'}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })\r\n                    )}\r\n                    <div ref={messagesEndRef} />\r\n                </div>\r\n\r\n                {/* Input Area */}\r\n                <div style={{\r\n                    padding: '15px 20px',\r\n                    background: 'white',\r\n                    borderTop: '1px solid #e0e0e0',\r\n                    borderRadius: '0 0 8px 8px',\r\n                    boxShadow: '0 -2px 10px rgba(0,0,0,0.05)'\r\n                }}>\r\n                    <div style={{ display: 'flex', gap: '10px', alignItems: 'flex-end' }}>\r\n                        <textarea\r\n                            className=\"input-field\"\r\n                            value={newMessage}\r\n                            onChange={(e) => setNewMessage(e.target.value)}\r\n                            onKeyPress={handleKeyPress}\r\n                            placeholder=\"Type a message...\"\r\n                            rows=\"2\"\r\n                            style={{\r\n                                flex: 1,\r\n                                resize: 'none',\r\n                                fontSize: '14px',\r\n                                padding: '10px',\r\n                                borderRadius: '20px',\r\n                                border: '1px solid #ddd'\r\n                            }}\r\n                        />\r\n                        <button\r\n                            onClick={sendMessage}\r\n                            disabled={!newMessage.trim()}\r\n                            style={{\r\n                                background: newMessage.trim() ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#ccc',\r\n                                color: 'white',\r\n                                border: 'none',\r\n                                padding: '12px 24px',\r\n                                borderRadius: '20px',\r\n                                cursor: newMessage.trim() ? 'pointer' : 'not-allowed',\r\n                                fontSize: '14px',\r\n                                fontWeight: 'bold',\r\n                                transition: 'all 0.3s'\r\n                            }}\r\n                        >\r\n                            Send ≡ƒôñ\r\n                        </button>\r\n                    </div>\r\n                    <div style={{ fontSize: '11px', color: '#999', marginTop: '8px' }}>\r\n                        Press Enter to send ΓÇó Shift+Enter for new line\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Notification.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Onboarding.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":27,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":35,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":19},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":35,"column":21,"nodeType":"BlockStatement","messageId":"unexpected","endLine":35,"endColumn":24,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[1204,1205],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":58,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { doc, updateDoc } from 'firebase/firestore';\r\n\r\nexport default function Onboarding() {\r\n    const navigate = useNavigate();\r\n    const { userData, updateUserData } = useUser();\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const [perms, setPerms] = useState({\r\n        mic: 'prompt', // prompt, granted, denied\r\n        camera: 'prompt',\r\n        notification: 'prompt'\r\n    });\r\n\r\n    useEffect(() => {\r\n        checkPermissions();\r\n    }, []);\r\n\r\n    const checkPermissions = async () => {\r\n        // Check Mic\r\n        try {\r\n            const micStatus = await navigator.permissions.query({ name: 'microphone' });\r\n            setPerms(p => ({ ...p, mic: micStatus.state }));\r\n        } catch (e) {\r\n            // Firefox/Safari might not support query for mic\r\n        }\r\n\r\n        // Check Camera\r\n        try {\r\n            const camStatus = await navigator.permissions.query({ name: 'camera' });\r\n            setPerms(p => ({ ...p, camera: camStatus.state }));\r\n        } catch (e) { }\r\n\r\n        // Check Notifications\r\n        if ('Notification' in window) {\r\n            setPerms(p => ({ ...p, notification: Notification.permission === 'default' ? 'prompt' : Notification.permission }));\r\n        }\r\n    };\r\n\r\n    const requestMic = async () => {\r\n        try {\r\n            await navigator.mediaDevices.getUserMedia({ audio: true });\r\n            setPerms(p => ({ ...p, mic: 'granted' }));\r\n        } catch (e) {\r\n            console.error(e);\r\n            setPerms(p => ({ ...p, mic: 'denied' }));\r\n            alert(\"Microphone access denied. Please enable it in browser settings.\");\r\n        }\r\n    };\r\n\r\n    const requestCam = async () => {\r\n        try {\r\n            await navigator.mediaDevices.getUserMedia({ video: true });\r\n            setPerms(p => ({ ...p, camera: 'granted' }));\r\n        } catch (e) {\r\n            setPerms(p => ({ ...p, camera: 'denied' }));\r\n            alert(\"Camera access denied. Please enable it in browser settings.\");\r\n        }\r\n    };\r\n\r\n    const requestNotif = async () => {\r\n        if (!('Notification' in window)) return;\r\n        const result = await Notification.requestPermission();\r\n        setPerms(p => ({ ...p, notification: result }));\r\n    };\r\n\r\n    const handleContinue = async () => {\r\n        console.log(\"Onboarding: handleContinue initiated\", { uid: userData?.uid, role: userData?.role });\r\n\r\n        if (isSaving) return;\r\n        if (!userData || !userData.uid) {\r\n            alert(\"App is still loading your profile. Please wait a second and try again.\");\r\n            return;\r\n        }\r\n\r\n        setIsSaving(true);\r\n\r\n        try {\r\n            // Determine collection accurately\r\n            let collectionName = 'users';\r\n            const role = userData.role?.toLowerCase();\r\n\r\n            if (role === 'teacher') collectionName = 'teachers';\r\n            else if (role === 'institution') collectionName = 'institutions';\r\n\r\n            console.log(`Onboarding: Saving completion to ${collectionName}/${userData.uid}`);\r\n\r\n            const userRef = doc(db, collectionName, userData.uid);\r\n            await updateDoc(userRef, {\r\n                onboardingCompleted: true\r\n            });\r\n\r\n            // Update local context for instant UI switch\r\n            if (updateUserData) {\r\n                updateUserData({ ...userData, onboardingCompleted: true });\r\n            }\r\n\r\n            console.log(\"Onboarding: Success. Redirecting...\");\r\n\r\n            // Use simple navigation - snapshot in UserContext will handle the rest if needed\r\n            if (role === 'admin') navigate('/admin');\r\n            else if (role === 'teacher') navigate('/teacher');\r\n            else if (role === 'institution') navigate('/institution');\r\n            else if (role === 'student') navigate('/student');\r\n            else navigate('/details');\r\n\r\n        } catch (e) {\r\n            console.error(\"Onboarding Fatal Error:\", e);\r\n            alert(\"Connection error while saving settings. Please try again.\");\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    // LOADING GUARD: Prevent clicking buttons before userData is ready\r\n    if (!userData) {\r\n        return (\r\n            <div style={{\r\n                height: '100dvh', display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                background: '#6c5ce7', color: 'white', fontFamily: 'sans-serif'\r\n            }}>\r\n                <div style={{ textAlign: 'center' }}>\r\n                    <div className=\"loader-mini\" style={{ marginBottom: '15px', fontSize: '30px' }}>ΓÅ│</div>\r\n                    <p>Preparing your experience...</p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div style={{\r\n            minHeight: '100dvh', // Modern dynamic viewport\r\n            display: 'flex', flexDirection: 'column',\r\n            alignItems: 'center', justifyContent: 'center',\r\n            background: 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)',\r\n            padding: '20px', fontFamily: \"'Segoe UI', sans-serif\"\r\n        }}>\r\n            <div style={{\r\n                background: 'white', padding: '30px 24px', borderRadius: '24px',\r\n                boxShadow: '0 15px 45px rgba(0,0,0,0.25)', maxWidth: '450px', width: '100%',\r\n                textAlign: 'center'\r\n            }}>\r\n                <div style={{ fontSize: '50px', marginBottom: '20px' }}>≡ƒæï</div>\r\n                <h1 style={{ color: '#2d3436', marginBottom: '10px' }}>Welcome to TTR!</h1>\r\n                <p style={{ color: '#636e72', marginBottom: '30px', lineHeight: '1.6' }}>\r\n                    To give you the full <b>AI Tutor</b> experience, we need a few permissions.\r\n                    This allows you to talk to the AI and receive important updates.\r\n                </p>\r\n\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px', marginBottom: '30px' }}>\r\n                    {/* MIC */}\r\n                    <div className=\"perm-row\" style={rowStyle}>\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                            <span style={{ fontSize: '24px' }}>≡ƒÄÖ∩╕Å</span>\r\n                            <div style={{ textAlign: 'left' }}>\r\n                                <div style={{ fontWeight: 'bold', color: '#333' }}>Microphone</div>\r\n                                <div style={{ fontSize: '12px', color: '#888' }}>For Voice AI Chat</div>\r\n                            </div>\r\n                        </div>\r\n                        {perms.mic === 'granted' ? <span style={grantedStyle}>Allowed Γ£à</span> :\r\n                            <button onClick={requestMic} style={btnStyle}>Allow</button>}\r\n                    </div>\r\n\r\n                    {/* CAMERA */}\r\n                    <div className=\"perm-row\" style={rowStyle}>\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                            <span style={{ fontSize: '24px' }}>≡ƒô╖</span>\r\n                            <div style={{ textAlign: 'left' }}>\r\n                                <div style={{ fontWeight: 'bold', color: '#333' }}>Camera</div>\r\n                                <div style={{ fontSize: '12px', color: '#888' }}>For Image Analysis</div>\r\n                            </div>\r\n                        </div>\r\n                        {perms.camera === 'granted' ? <span style={grantedStyle}>Allowed Γ£à</span> :\r\n                            <button onClick={requestCam} style={btnStyle}>Allow</button>}\r\n                    </div>\r\n\r\n                    {/* NOTIFICATIONS */}\r\n                    <div className=\"perm-row\" style={rowStyle}>\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                            <span style={{ fontSize: '24px' }}>≡ƒöö</span>\r\n                            <div style={{ textAlign: 'left' }}>\r\n                                <div style={{ fontWeight: 'bold', color: '#333' }}>Notifications</div>\r\n                                <div style={{ fontSize: '12px', color: '#888' }}>For Important Updates</div>\r\n                            </div>\r\n                        </div>\r\n                        {perms.notification === 'granted' ? <span style={grantedStyle}>Allowed Γ£à</span> :\r\n                            <button onClick={requestNotif} style={btnStyle}>Allow</button>}\r\n                    </div>\r\n                </div>\r\n\r\n                <button onClick={handleContinue} style={{\r\n                    width: '100%', padding: '15px', borderRadius: '12px', border: 'none',\r\n                    background: '#6c5ce7', color: 'white', fontSize: '16px', fontWeight: 'bold',\r\n                    cursor: 'pointer', transition: 'transform 0.2s'\r\n                }}>\r\n                    Continue to App Γ₧ñ\r\n                </button>\r\n                <div style={{ marginTop: '15px', fontSize: '12px', color: '#b2bec3', cursor: 'pointer' }} onClick={handleContinue}>\r\n                    Skip for now\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nconst rowStyle = {\r\n    display: 'flex', alignItems: 'center', justifyContent: 'space-between',\r\n    padding: '15px', background: '#f8f9fa', borderRadius: '12px', border: '1px solid #eee'\r\n};\r\n\r\nconst btnStyle = {\r\n    padding: '8px 20px', borderRadius: '20px', border: 'none',\r\n    background: '#0984e3', color: 'white', cursor: 'pointer', fontSize: '14px'\r\n};\r\n\r\nconst grantedStyle = {\r\n    color: '#00b894', fontWeight: 'bold', fontSize: '14px'\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\ParentDashboard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\PendingApproval.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'onAuthStateChanged' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"onAuthStateChanged"},"fix":{"range":[118,138],"text":""},"desc":"Remove unused variable 'onAuthStateChanged'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { getAuth, onAuthStateChanged } from 'firebase/auth';\r\nimport { doc, getDoc, collection, query, where, getDocs, setDoc } from 'firebase/firestore';\r\nimport { db } from '../firebase';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nexport default function PendingApproval() {\r\n    const navigate = useNavigate();\r\n    const [loading, setLoading] = useState(false);\r\n    const [statusMsg, setStatusMsg] = useState('');\r\n\r\n    const { user, loading: userLoading } = useUser();\r\n\r\n    // Auto-check on mount\r\n    useEffect(() => {\r\n        if (!userLoading) {\r\n            checkStatus();\r\n        }\r\n    }, [userLoading, user]);\r\n\r\n    const checkStatus = async () => {\r\n        if (!user) {\r\n            if (!userLoading) navigate('/');\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setStatusMsg('Checking logic...');\r\n        // user is already available from context scope, but for function scope we can use 'user' from closure or context\r\n\r\n\r\n\r\n\r\n        try {\r\n            console.log(\"Checking status for:\", user.uid);\r\n\r\n            // 1. Check User Profile directly first\r\n            let role = 'student';\r\n            let userDoc = await getDoc(doc(db, \"users\", user.uid));\r\n            if (!userDoc.exists()) {\r\n                userDoc = await getDoc(doc(db, \"teachers\", user.uid));\r\n                role = 'teacher';\r\n            }\r\n            if (!userDoc.exists()) {\r\n                userDoc = await getDoc(doc(db, \"institutions\", user.uid));\r\n                role = 'institution';\r\n            }\r\n\r\n            if (userDoc.exists()) {\r\n                const userData = userDoc.data();\r\n                if (userData.approved === true) {\r\n                    console.log(\"User is already approved! Redirecting...\");\r\n                    setStatusMsg('Approved! Redirecting...');\r\n                    let path = '/student';\r\n                    if (role === 'teacher') path = '/teacher';\r\n                    if (role === 'institution') path = '/institution';\r\n                    setTimeout(() => navigate(path), 1000);\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // 2. SELF-REPAIR: Check 'admissions' collection\r\n            // Did the institution approve them in 'admissions' but the 'user' doc update failed?\r\n            const q = query(collection(db, \"admissions\"), where(\"userId\", \"==\", user.uid));\r\n            const querySnapshot = await getDocs(q);\r\n\r\n            let isAllotted = false;\r\n            let admissionData = null;\r\n\r\n            querySnapshot.forEach((doc) => {\r\n                const data = doc.data();\r\n                if (data.status === 'allotted') {\r\n                    isAllotted = true;\r\n                    admissionData = data;\r\n                }\r\n            });\r\n\r\n            if (isAllotted && admissionData) {\r\n                console.log(\"Found ALLOTTED Admission record! Repairing user profile...\");\r\n                setStatusMsg('Admission found! Finalizing setup...');\r\n\r\n                // FORCE UPDATE user profile\r\n                const collectionName = role === 'teacher' ? 'teachers' : 'users';\r\n                await setDoc(doc(db, collectionName, user.uid), {\r\n                    approved: true,\r\n                    assignedClass: admissionData.assignedClass || '',\r\n                    assignedSection: admissionData.assignedSection || '',\r\n                    // Ensure class/section are set for students\r\n                    class: admissionData.assignedClass || '',\r\n                    section: admissionData.assignedSection || ''\r\n                }, { merge: true });\r\n\r\n                alert(\"Γ£à Approval Confirmed! You are now being redirected.\");\r\n                window.location.reload(); // Reload to refresh context\r\n            } else {\r\n                console.log(\"Still waiting. Admission status:\", isAllotted ? \"Allotted\" : \"Pending/Waiting\");\r\n                setStatusMsg('Still waiting for institution approval.');\r\n            }\r\n\r\n        } catch (e) {\r\n            console.error(\"Error checking status:\", e);\r\n            setStatusMsg('Error checking status. Please try again.');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleLogout = () => {\r\n        const auth = getAuth();\r\n        auth.signOut().then(() => {\r\n            navigate('/');\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"container\" style={{ textAlign: 'center', marginTop: '100px', paddingBottom: '50px' }}>\r\n            <div className=\"card\" style={{ maxWidth: '600px', margin: '0 auto', padding: '40px' }}>\r\n                <div style={{ fontSize: '60px', marginBottom: '20px' }}>ΓÅ│</div>\r\n                <h2 style={{ color: '#0984e3' }}>Application Pending</h2>\r\n                <p style={{ fontSize: '16px', color: '#555', lineHeight: '1.6' }}>\r\n                    Your admission request has been sent to the institution.\r\n                    <br /><br />\r\n                    Please wait for the administrator to approve your request and allot you a class.\r\n                </p>\r\n\r\n                {statusMsg && <p style={{ color: '#d63031', fontWeight: 'bold' }}>{statusMsg}</p>}\r\n\r\n                <div style={{ marginTop: '30px', display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'center' }}>\r\n                    <button className=\"btn\" onClick={checkStatus} disabled={loading} style={{ width: '200px' }}>\r\n                        {loading ? 'Checking...' : 'Check Status Γƒ│'}\r\n                    </button>\r\n\r\n                    <button className=\"btn\" onClick={() => navigate('/details')} style={{ backgroundColor: '#6c5ce7', width: '200px' }}>\r\n                        Γ£Å∩╕Å Edit Details\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Debug Info */}\r\n                <div style={{ marginTop: '30px', fontSize: '12px', color: '#aaa' }}>\r\n                    UID: {getAuth().currentUser?.uid || 'Not Logged In'}\r\n                </div>\r\n                <div style={{ marginTop: '15px' }}>\r\n                    <button onClick={handleLogout} style={{ background: 'none', border: 'none', color: '#e74c3c', cursor: 'pointer', textDecoration: 'underline', fontSize: '14px' }}>\r\n                        Logout\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\PerformanceAnalytics.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'classRank' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":16,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"classRank"},"fix":{"range":[633,642],"text":""},"desc":"Remove unused variable 'classRank'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'totalStudents' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":17,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"totalStudents"},"fix":{"range":[688,701],"text":""},"desc":"Remove unused variable 'totalStudents'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":353,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":353,"endColumn":52,"suggestions":[{"messageId":"removeVar","data":{"varName":"_"},"fix":{"range":[16654,16655],"text":""},"desc":"Remove unused variable '_'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":357,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":357,"endColumn":52,"suggestions":[{"messageId":"removeVar","data":{"varName":"_"},"fix":{"range":[16910,16911],"text":""},"desc":"Remove unused variable '_'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, orderBy } from 'firebase/firestore';\r\nimport jsPDF from 'jspdf';\r\nimport 'jspdf-autotable';\r\n\r\nexport default function PerformanceAnalytics() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [loading, setLoading] = useState(true);\r\n    const [studentMarks, setStudentMarks] = useState([]);\r\n    const [subjectStats, setSubjectStats] = useState({});\r\n    const [classRank, setClassRank] = useState(null);\r\n    const [totalStudents, setTotalStudents] = useState(0);\r\n\r\n    // For Teachers: Select student to view\r\n    const [selectedStudent, setSelectedStudent] = useState(null);\r\n    const [studentsList, setStudentsList] = useState([]);\r\n\r\n    useEffect(() => {\r\n        if (userData?.role === 'student') {\r\n            fetchStudentData(userData.uid);\r\n        } else if (userData?.role === 'teacher' || userData?.role === 'institution') {\r\n            fetchStudentsList();\r\n        }\r\n    }, [userData]);\r\n\r\n    const fetchStudentsList = async () => {\r\n        try {\r\n            const q = query(\r\n                collection(db, \"student_allotments\"),\r\n                where(\"createdBy\", \"==\", userData.institutionId || userData.uid)\r\n            );\r\n            const snap = await getDocs(q);\r\n            const list = snap.docs.map(d => ({\r\n                id: d.data().studentId || d.id,\r\n                name: d.data().studentName || d.data().name,\r\n                class: d.data().classAssigned,\r\n                section: d.data().section\r\n            }));\r\n            setStudentsList(list);\r\n            setLoading(false);\r\n        } catch (e) {\r\n            console.error(e);\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const fetchStudentData = async (studentId) => {\r\n        setLoading(true);\r\n        try {\r\n            // Fetch all marks for this student\r\n            const q = query(\r\n                collection(db, \"marks\"),\r\n                where(\"studentId\", \"==\", studentId),\r\n                orderBy(\"createdAt\", \"asc\")\r\n            );\r\n            const snap = await getDocs(q);\r\n            const marks = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n            setStudentMarks(marks);\r\n\r\n            // Calculate subject-wise stats\r\n            const stats = {};\r\n            marks.forEach(mark => {\r\n                if (!stats[mark.subject]) {\r\n                    stats[mark.subject] = { total: 0, count: 0, marks: [] };\r\n                }\r\n                stats[mark.subject].total += mark.marks;\r\n                stats[mark.subject].count += 1;\r\n                stats[mark.subject].marks.push({ exam: mark.examType, marks: mark.marks, max: mark.maxMarks });\r\n            });\r\n\r\n            // Calculate averages\r\n            Object.keys(stats).forEach(subject => {\r\n                stats[subject].average = (stats[subject].total / stats[subject].count).toFixed(1);\r\n            });\r\n\r\n            setSubjectStats(stats);\r\n\r\n            // Calculate class rank (simplified - based on total marks)\r\n            if (marks.length > 0) {\r\n                const studentTotal = marks.reduce((sum, m) => sum + m.marks, 0);\r\n                const classId = marks[0].class;\r\n                const sectionId = marks[0].section;\r\n\r\n                // Fetch all students' marks in same class\r\n                const classQuery = query(\r\n                    collection(db, \"marks\"),\r\n                    where(\"class\", \"==\", classId),\r\n                    where(\"section\", \"==\", sectionId)\r\n                );\r\n                const classSnap = await getDocs(classQuery);\r\n\r\n                // Group by student and calculate totals\r\n                const studentTotals = {};\r\n                classSnap.docs.forEach(doc => {\r\n                    const data = doc.data();\r\n                    if (!studentTotals[data.studentId]) {\r\n                        studentTotals[data.studentId] = 0;\r\n                    }\r\n                    studentTotals[data.studentId] += data.marks;\r\n                });\r\n\r\n                const totalsArray = Object.values(studentTotals).sort((a, b) => b - a);\r\n                const rank = totalsArray.findIndex(total => total <= studentTotal) + 1;\r\n\r\n                setClassRank(rank);\r\n                setTotalStudents(totalsArray.length);\r\n            }\r\n\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const generateReportCard = () => {\r\n        const doc = new jsPDF();\r\n\r\n        // Header\r\n        doc.setFontSize(18);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text(userData?.institutionName || \"Together To Refine\", 105, 20, { align: 'center' });\r\n\r\n        doc.setFontSize(14);\r\n        doc.text(\"STUDENT REPORT CARD\", 105, 30, { align: 'center' });\r\n\r\n        // Student Info\r\n        doc.setFontSize(12);\r\n        doc.setFont('helvetica', 'normal');\r\n        const studentName = selectedStudent?.name || userData?.name || \"Student\";\r\n        const studentClass = studentMarks[0]?.class || \"N/A\";\r\n        const studentSection = studentMarks[0]?.section || \"N/A\";\r\n\r\n        doc.text(`Name: ${studentName}`, 20, 45);\r\n        doc.text(`Class: ${studentClass} - ${studentSection}`, 20, 52);\r\n        doc.text(`Academic Year: 2025-26`, 20, 59);\r\n\r\n        // Marks Table\r\n        const tableData = [];\r\n        Object.entries(subjectStats).forEach(([subject, stats]) => {\r\n            tableData.push([\r\n                subject,\r\n                stats.count,\r\n                stats.total,\r\n                stats.average,\r\n                stats.average >= 75 ? 'A+' : stats.average >= 60 ? 'A' : stats.average >= 45 ? 'B' : 'C'\r\n            ]);\r\n        });\r\n\r\n        doc.autoTable({\r\n            startY: 70,\r\n            head: [['Subject', 'Tests Taken', 'Total Marks', 'Average', 'Grade']],\r\n            body: tableData,\r\n            theme: 'striped',\r\n            headStyles: { fillColor: [41, 128, 185] },\r\n        });\r\n\r\n        // Performance Summary\r\n        const finalY = doc.lastAutoTable.finalY + 15;\r\n        doc.setFontSize(11);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text(\"Performance Summary:\", 20, finalY);\r\n\r\n        doc.setFont('helvetica', 'normal');\r\n        const overallAvg = (Object.values(subjectStats).reduce((sum, s) => sum + parseFloat(s.average), 0) / Object.keys(subjectStats).length).toFixed(1);\r\n        doc.text(`Overall Average: ${overallAvg}%`, 20, finalY + 7);\r\n        doc.text(`Learning Progress: ${overallAvg >= 75 ? 'Excellent' : overallAvg >= 60 ? 'Good' : 'Needs Focus'}`, 20, finalY + 14);\r\n\r\n        // Footer\r\n        doc.setFontSize(9);\r\n        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 280);\r\n        doc.text(\"Powered by Together To Refine\", 150, 280);\r\n\r\n        doc.save(`Report_Card_${studentName.replace(/\\s/g, '_')}.pdf`);\r\n    };\r\n\r\n    // UI Helper Components\r\n    const StatCard = ({ title, value, subtitle, color, icon }) => (\r\n        <div style={{\r\n            background: 'white', borderRadius: '12px', padding: '20px',\r\n            boxShadow: '0 2px 8px rgba(0,0,0,0.08)', flex: '1 1 200px',\r\n            borderTop: `4px solid ${color}`\r\n        }}>\r\n            <div style={{ fontSize: '32px', marginBottom: '10px' }}>{icon}</div>\r\n            <div style={{ fontSize: '13px', color: '#636e72', textTransform: 'uppercase', marginBottom: '5px' }}>{title}</div>\r\n            <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#2d3436' }}>{value}</div>\r\n            {subtitle && <div style={{ fontSize: '12px', color: color, marginTop: '5px' }}>{subtitle}</div>}\r\n        </div>\r\n    );\r\n\r\n    const SubjectCard = ({ subject, stats }) => {\r\n        const percentage = parseFloat(stats.average);\r\n        const color = percentage >= 75 ? '#27ae60' : percentage >= 60 ? '#f39c12' : percentage >= 45 ? '#e67e22' : '#e74c3c';\r\n\r\n        return (\r\n            <div style={{ background: 'white', borderRadius: '8px', padding: '15px', marginBottom: '10px', boxShadow: '0 2px 5px rgba(0,0,0,0.05)' }}>\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>\r\n                    <h4 style={{ margin: 0 }}>{subject}</h4>\r\n                    <div style={{\r\n                        background: `${color}20`,\r\n                        color: color,\r\n                        padding: '4px 12px',\r\n                        borderRadius: '20px',\r\n                        fontSize: '14px',\r\n                        fontWeight: 'bold'\r\n                    }}>\r\n                        {stats.average}%\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Mini bar chart */}\r\n                <div style={{ display: 'flex', gap: '5px', height: '60px', alignItems: 'flex-end' }}>\r\n                    {stats.marks.map((m, i) => (\r\n                        <div key={i} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>\r\n                            <div style={{\r\n                                width: '100%',\r\n                                background: color,\r\n                                height: `${(m.marks / m.max) * 100}%`,\r\n                                borderRadius: '4px 4px 0 0',\r\n                                minHeight: '5px'\r\n                            }}></div>\r\n                            <div style={{ fontSize: '9px', color: '#999', marginTop: '3px' }}>{m.exam.split(' ')[0]}</div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"page-wrapper\" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>\r\n                <div style={{ textAlign: 'center' }}>\r\n                    <div style={{ fontSize: '48px', marginBottom: '10px' }}>≡ƒôè</div>\r\n                    <div>Loading analytics...</div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Teacher/Institution View: Select Student\r\n    if ((userData?.role === 'teacher' || userData?.role === 'institution') && !selectedStudent) {\r\n        return (\r\n            <div className=\"page-wrapper\">\r\n                <div className=\"container\">\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                        <h2>≡ƒôè Performance Analytics</h2>\r\n                        <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                    </div>\r\n\r\n                    <div className=\"card\">\r\n                        <h3>Select a Student</h3>\r\n                        <p style={{ color: '#636e72', marginBottom: '20px' }}>Choose a student to view their detailed performance report</p>\r\n\r\n                        <div style={{ display: 'grid', gap: '10px' }}>\r\n                            {studentsList.map(student => (\r\n                                <div\r\n                                    key={student.id}\r\n                                    onClick={() => {\r\n                                        setSelectedStudent(student);\r\n                                        fetchStudentData(student.id);\r\n                                    }}\r\n                                    style={{\r\n                                        padding: '15px', border: '1px solid #eee', borderRadius: '8px',\r\n                                        cursor: 'pointer', display: 'flex', justifyContent: 'space-between',\r\n                                        alignItems: 'center', transition: 'all 0.2s'\r\n                                    }}\r\n                                    onMouseEnter={e => e.currentTarget.style.background = '#f8f9fa'}\r\n                                    onMouseLeave={e => e.currentTarget.style.background = 'white'}\r\n                                >\r\n                                    <div>\r\n                                        <div style={{ fontWeight: 'bold' }}>{student.name}</div>\r\n                                        <div style={{ fontSize: '12px', color: '#999' }}>Class {student.class} - {student.section}</div>\r\n                                    </div>\r\n                                    <div style={{ color: '#0984e3' }}>ΓåÆ</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Main Analytics View\r\n    const overallAvg = Object.keys(subjectStats).length > 0\r\n        ? (Object.values(subjectStats).reduce((sum, s) => sum + parseFloat(s.average), 0) / Object.keys(subjectStats).length).toFixed(1)\r\n        : 0;\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ background: '#f5f6fa', minHeight: '100vh' }}>\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', paddingTop: '20px' }}>\r\n                    <div>\r\n                        <h2 style={{ margin: 0 }}>≡ƒôè Performance Analytics</h2>\r\n                        {selectedStudent && (\r\n                            <p style={{ margin: '5px 0 0 0', color: '#636e72' }}>{selectedStudent.name} - Class {selectedStudent.class}</p>\r\n                        )}\r\n                    </div>\r\n                    <div style={{ display: 'flex', gap: '10px' }}>\r\n                        {selectedStudent && (\r\n                            <button onClick={() => setSelectedStudent(null)} className=\"btn-outline\">ΓåÉ Change Student</button>\r\n                        )}\r\n                        <button onClick={() => navigate(-1)} className=\"btn-outline\">Γ£ò Close</button>\r\n                    </div>\r\n                </div>\r\n\r\n                {studentMarks.length === 0 ? (\r\n                    <div className=\"card\" style={{ textAlign: 'center', padding: '60px' }}>\r\n                        <div style={{ fontSize: '64px', marginBottom: '20px' }}>≡ƒô¡</div>\r\n                        <h3>No Performance Data Yet</h3>\r\n                        <p style={{ color: '#999' }}>Marks will appear here once teachers enter them.</p>\r\n                    </div>\r\n                ) : (\r\n                    <>\r\n                        {/* Stats Overview */}\r\n                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '15px', marginBottom: '20px' }}>\r\n                            <StatCard\r\n                                title=\"Overall Progress\"\r\n                                value={`${overallAvg}%`}\r\n                                subtitle={overallAvg >= 75 ? \"Excellent Growth!\" : overallAvg >= 60 ? \"Good Progress\" : \"Keep Learning\"}\r\n                                color={overallAvg >= 75 ? '#27ae60' : overallAvg >= 60 ? '#f39c12' : '#e74c3c'}\r\n                                icon=\"≡ƒôê\"\r\n                            />\r\n                            <StatCard\r\n                                title=\"Learning Velocity\"\r\n                                value={`${Math.min(Math.round((studentMarks.length / 30) * 100), 100)}%`}\r\n                                subtitle={`${studentMarks.length} concepts tested`}\r\n                                color=\"#3498db\"\r\n                                icon=\"≡ƒÜÇ\"\r\n                            />\r\n                            <StatCard\r\n                                title=\"Subjects Mastered\"\r\n                                value={Object.values(subjectStats).filter(s => parseFloat(s.average) >= 70).length}\r\n                                subtitle={`Out of ${Object.keys(subjectStats).length} subjects`}\r\n                                color=\"#9b59b6\"\r\n                                icon=\"≡ƒÄ»\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* AI Knowledge Insights */}\r\n                        <div className=\"card\" style={{ marginBottom: '20px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' }}>\r\n                            <h3 style={{ margin: '0 0 15px 0', color: 'white' }}>≡ƒñû AI Learning Insights</h3>\r\n                            <div style={{ display: 'grid', gap: '10px' }}>\r\n                                {(() => {\r\n                                    const strengths = Object.entries(subjectStats)\r\n                                        .filter(([_, stats]) => parseFloat(stats.average) >= 75)\r\n                                        .map(([subject]) => subject);\r\n\r\n                                    const weaknesses = Object.entries(subjectStats)\r\n                                        .filter(([_, stats]) => parseFloat(stats.average) < 60)\r\n                                        .map(([subject]) => subject);\r\n\r\n                                    return (\r\n                                        <>\r\n                                            {strengths.length > 0 && (\r\n                                                <div style={{ background: 'rgba(255,255,255,0.1)', padding: '12px', borderRadius: '8px' }}>\r\n                                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>Γ£à Strengths:</div>\r\n                                                    <div style={{ fontSize: '15px', fontWeight: 'bold' }}>\r\n                                                        Strong grasp of {strengths.join(', ')} - Excellent foundation!\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                            {weaknesses.length > 0 && (\r\n                                                <div style={{ background: 'rgba(255,255,255,0.1)', padding: '12px', borderRadius: '8px' }}>\r\n                                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>≡ƒÆí Focus Areas:</div>\r\n                                                    <div style={{ fontSize: '15px', fontWeight: 'bold' }}>\r\n                                                        {weaknesses.join(', ')} need more practice - Recommended: 30 mins daily\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                            <div style={{ background: 'rgba(255,255,255,0.1)', padding: '12px', borderRadius: '8px' }}>\r\n                                                <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '5px' }}>≡ƒÄ» Prediction:</div>\r\n                                                <div style={{ fontSize: '15px', fontWeight: 'bold' }}>\r\n                                                    At current pace, projected exam score: {Math.round(overallAvg * 1.1)}%\r\n                                                    {overallAvg >= 70 ? \" - On track for excellent results!\" : \" - Increase practice to improve\"}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {Object.entries(subjectStats).filter(([, s]) => Number(s.average) >= 90).length > 0 && (\r\n                                                <div style={{ marginTop: '15px' }}>\r\n                                                    <div style={{ fontSize: '14px', opacity: 0.9, marginBottom: '8px' }}>≡ƒÅà Achievements:</div>\r\n                                                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>\r\n                                                        {Object.entries(subjectStats)\r\n                                                            .filter(([, s]) => Number(s.average) >= 90)\r\n                                                            .map(([subj]) => (\r\n                                                                <div key={subj} style={{\r\n                                                                    background: 'rgba(255,255,255,0.2)', padding: '5px 12px',\r\n                                                                    borderRadius: '20px', fontSize: '13px', fontWeight: 'bold'\r\n                                                                }}>\r\n                                                                    ≡ƒÅå {subj} Master\r\n                                                                </div>\r\n                                                            ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                        </>\r\n                                    );\r\n                                })()}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Subject-wise Performance */}\r\n                        <div className=\"card\" style={{ marginBottom: '20px' }}>\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                                <h3 style={{ margin: 0 }}>Subject-wise Performance</h3>\r\n                                <button onClick={generateReportCard} className=\"btn\" style={{ background: '#e74c3c' }}>\r\n                                    ≡ƒôä Download Report Card\r\n                                </button>\r\n                            </div>\r\n\r\n                            {Object.entries(subjectStats).map(([subject, stats]) => (\r\n                                <SubjectCard key={subject} subject={subject} stats={stats} />\r\n                            ))}\r\n                        </div>\r\n\r\n                        {/* Recent Tests */}\r\n                        <div className=\"card\">\r\n                            <h3>Recent Test Results</h3>\r\n                            <div style={{ overflowX: 'auto' }}>\r\n                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>\r\n                                    <thead style={{ background: '#f8f9fa' }}>\r\n                                        <tr>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Date</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Subject</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: '2px solid #dee2e6' }}>Exam</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>Marks</th>\r\n                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: '2px solid #dee2e6' }}>%</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {studentMarks.slice().reverse().map(mark => {\r\n                                            const percentage = (mark.marks / mark.maxMarks) * 100;\r\n                                            const color = percentage >= 75 ? '#27ae60' : percentage >= 60 ? '#f39c12' : '#e74c3c';\r\n\r\n                                            return (\r\n                                                <tr key={mark.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                                    <td style={{ padding: '10px', fontSize: '13px' }}>\r\n                                                        {mark.createdAt?.toDate?.()?.toLocaleDateString() || 'N/A'}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px' }}>{mark.subject}</td>\r\n                                                    <td style={{ padding: '10px', fontSize: '13px', color: '#636e72' }}>{mark.examType}</td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center', fontWeight: 'bold' }}>\r\n                                                        {mark.marks}/{mark.maxMarks}\r\n                                                    </td>\r\n                                                    <td style={{ padding: '10px', textAlign: 'center' }}>\r\n                                                        <span style={{\r\n                                                            background: `${color}20`,\r\n                                                            color: color,\r\n                                                            padding: '4px 8px',\r\n                                                            borderRadius: '4px',\r\n                                                            fontSize: '12px',\r\n                                                            fontWeight: 'bold'\r\n                                                        }}>\r\n                                                            {percentage.toFixed(0)}%\r\n                                                        </span>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            );\r\n                                        })}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Profile.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\ProfileView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Report.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\SelectFeedbackTarget.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Settings.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Student.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"doc"},"fix":{"range":[154,158],"text":""},"desc":"Remove unused variable 'doc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[157,165],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'loadingGroups' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":32,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"loadingGroups"},"fix":{"range":[1332,1345],"text":""},"desc":"Remove unused variable 'loadingGroups'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { db } from '../firebase';\r\nimport { doc, getDoc, collection, query, where, getDocs } from 'firebase/firestore';\r\nimport AIBadge from '../components/AIBadge';\r\nimport FeatureTour from '../components/FeatureTour';\r\nimport { useUser } from '../context/UserContext';\r\nimport { useLanguage } from '../context/LanguageContext';\r\nimport GurukullPathSelector, { GURUKUL_HEROES } from '../components/GurukullPathSelector';\r\n\r\n// Cache object outside component to persist across unmounts/remounts (Back button navigation)\r\nconst GROUP_CACHE = {\r\n    data: {},\r\n    timestamp: 0\r\n};\r\n\r\nexport default function Student() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser(); // Global context\r\n    const { t } = useLanguage();\r\n    const [showDropdown, setShowDropdown] = useState(false);\r\n    const [selectedPerson, setSelectedPerson] = useState(null);\r\n    const [selectedGroup, setSelectedGroup] = useState(null);\r\n\r\n    // ΓöÇΓöÇ Gurukul Path ΓöÇΓöÇ\r\n    const [showGurukul, setShowGurukul] = useState(false);\r\n    const gurukulPath = userData?.gurukul_path\r\n        ? GURUKUL_HEROES.find(h => h.id === userData.gurukul_path)\r\n        : null;\r\n\r\n    const [myGroups, setMyGroups] = useState([]);\r\n    const [loadingGroups, setLoadingGroups] = useState(false);\r\n    const [examResults, setExamResults] = useState([]);\r\n\r\n    const isNavigating = useRef(false);\r\n\r\n    // Feature Tour Steps\r\n    const tourSteps = [\r\n        {\r\n            target: 'tour-card-ai',\r\n            title: '≡ƒñû Your AI Teacher',\r\n            content: 'Meet your personal AI tutor! Ask doubts, get explanations, and practice concepts anytime, 24/7.'\r\n        },\r\n        {\r\n            target: 'tour-card-attendance',\r\n            title: '≡ƒôà Track Attendance',\r\n            content: 'Check your daily attendance records here. Stay consistent to maintain your streak!'\r\n        },\r\n        {\r\n            target: 'tour-card-4way',\r\n            title: '≡ƒºá 4-Way Learning',\r\n            content: 'Explore topics through 4 lenses: Conceptual, Mythological, Story-based, and Dialogue-based learning.'\r\n        },\r\n        {\r\n            target: 'tour-card-video',\r\n            title: '≡ƒÄ¼ Video Library',\r\n            content: 'Missed a class? Watch recorded sessions and curated educational videos here.'\r\n        },\r\n        {\r\n            target: 'tour-exam-results',\r\n            title: '≡ƒô¥ Exam Results',\r\n            content: 'View your performance in recent exams and track your academic progress.'\r\n        }\r\n    ];\r\n\r\n    const handleCardClick = (path, state = null) => {\r\n        if (isNavigating.current) return;\r\n        isNavigating.current = true;\r\n        navigate(path, { state });\r\n        // Reset after a delay (e.g., if navigation is cancelled or to allow re-clicking later)\r\n        setTimeout(() => { isNavigating.current = false; }, 2000);\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (userData) {\r\n            const fetchResults = async () => {\r\n                try {\r\n                    const snap = await getDocs(collection(db, \"results\"));\r\n                    const list = snap.docs.map(d => d.data());\r\n                    const myName = userData.name ? userData.name.toLowerCase() : '';\r\n                    if (myName) {\r\n                        const myRes = list.filter(r => r.studentName && r.studentName.toLowerCase().includes(myName));\r\n                        setExamResults(myRes);\r\n                    }\r\n                } catch (e) { console.error(\"Error loading results\", e); }\r\n            };\r\n            fetchResults();\r\n        }\r\n    }, [userData]);\r\n\r\n    useEffect(() => {\r\n        const fetchRealGroups = async () => {\r\n            // If user hasn't set class yet, we can't show specific groups\r\n            // We fallback to showing 'Public' groups or nothing\r\n            const userClass = userData?.class || userData?.assignedClass;\r\n            const userSection = userData?.section || userData?.assignedSection;\r\n\r\n            if (!userClass) return;\r\n\r\n            try {\r\n                setLoadingGroups(true);\r\n\r\n                // Normalization for robust matching\r\n                const rawCls = userClass.toString().toLocaleLowerCase().trim();\r\n                const baseVal = rawCls.replace(/[^0-9]/g, '');\r\n\r\n                const variants = new Set([rawCls, baseVal]);\r\n                if (baseVal) {\r\n                    variants.add(`${baseVal}th`);\r\n                    variants.add(`${baseVal}st`);\r\n                    variants.add(`${baseVal}nd`);\r\n                    variants.add(`${baseVal}rd`);\r\n                    variants.add(parseInt(baseVal));\r\n                    variants.add(`class ${baseVal}`);\r\n                    variants.add(`class ${baseVal}th`);\r\n                }\r\n                const uniqueVariants = Array.from(variants).filter(v => v !== '');\r\n\r\n                const instId = userData.institutionId;\r\n                let rawGroups = [];\r\n\r\n                if (instId) {\r\n                    // Strategy: Query by Institution (Satisfies Security Rules)\r\n                    const q1 = query(collection(db, \"groups\"), where(\"institutionId\", \"==\", instId));\r\n                    const q2 = query(collection(db, \"groups\"), where(\"createdBy\", \"==\", instId));\r\n\r\n                    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);\r\n                    const merged = new Map();\r\n                    snap1.forEach(d => merged.set(d.id, { id: d.id, ...d.data() }));\r\n                    snap2.forEach(d => merged.set(d.id, { id: d.id, ...d.data() }));\r\n                    rawGroups = Array.from(merged.values());\r\n                } else {\r\n                    // Fallback to class query if profile is incomplete\r\n                    const qFallback = query(collection(db, \"groups\"), where(\"className\", \"in\", uniqueVariants.slice(0, 10)));\r\n                    const snapFallback = await getDocs(qFallback);\r\n                    snapFallback.forEach(d => rawGroups.push({ id: d.id, ...d.data() }));\r\n                }\r\n\r\n                const list = [];\r\n                rawGroups.forEach(data => {\r\n                    // 1. CLASS MATCHING (Memory-based, very flexible)\r\n                    const gCls = (data.className || '').toString().toLocaleLowerCase().trim();\r\n                    const gBase = gCls.replace(/[^0-9]/g, '');\r\n\r\n                    const classMatches = uniqueVariants.some(v => v.toString().toLocaleLowerCase() === gCls) ||\r\n                        (baseVal && baseVal === gBase);\r\n\r\n                    if (!classMatches) return;\r\n\r\n                    // 2. SECTION MATCHING\r\n                    const gSec = (data.section || 'All').toString().toUpperCase();\r\n                    const uSec = (userSection || 'All').toString().toUpperCase();\r\n\r\n                    if (!userSection || gSec === 'ALL' || gSec === uSec) {\r\n                        list.push(data);\r\n                    }\r\n                });\r\n                setMyGroups(list);\r\n            } catch (e) {\r\n                console.error(\"Error fetching groups:\", e);\r\n            } finally {\r\n                setLoadingGroups(false);\r\n            }\r\n        };\r\n\r\n        if (userData) {\r\n            fetchRealGroups();\r\n        }\r\n    }, [userData]);\r\n\r\n    const handleSelect = (group) => {\r\n        const val = group.groupName;\r\n        setSelectedPerson(val);\r\n        setSelectedGroup(group);\r\n        localStorage.setItem(\"selectedPerson\", val);\r\n        setShowDropdown(false);\r\n    };\r\n\r\n    const goToGroup = (e, group) => {\r\n        e.stopPropagation();\r\n        localStorage.setItem(\"activeGroupId\", group.id);\r\n        navigate('/group');\r\n    };\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ animation: 'fadeIn 0.5s ease-out' }}>\r\n            <FeatureTour tourId=\"student_dashboard_v1\" steps={tourSteps} userData={userData} />\r\n            <AIBadge />\r\n\r\n            {/* Gurukul Path Selector Modal */}\r\n            {showGurukul && (\r\n                <GurukullPathSelector\r\n                    onClose={() => setShowGurukul(false)}\r\n                    onSelect={() => setShowGurukul(false)}\r\n                />\r\n            )}\r\n\r\n            {/* Clean Dashboard Greeting */}\r\n            <div className=\"dash-greeting-bar\">\r\n                <div className=\"dash-greeting-left\">\r\n                    <div\r\n                        className=\"dash-avatar\"\r\n                        style={gurukulPath ? { background: gurukulPath.gradient, boxShadow: `0 4px 15px ${gurukulPath.shadow}` } : {}}\r\n                    >\r\n                        {gurukulPath ? gurukulPath.emoji : (userData?.name?.charAt(0).toUpperCase() || 'S')}\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"dash-welcome-label\">{t('student_welcome') || 'Welcome back'}</p>\r\n                        <h1 className=\"dash-name\">{userData?.name || 'Student'}</h1>\r\n\r\n                        {gurukulPath && (\r\n                            <div style={{\r\n                                display: 'inline-flex', alignItems: 'center', gap: '6px',\r\n                                padding: '4px 10px', borderRadius: '12px', marginTop: '4px',\r\n                                fontSize: '10px', fontWeight: '700',\r\n                                boxShadow: '0 2px 10px rgba(0,0,0,0.1)',\r\n                                color: gurukulPath.color\r\n                            }}>\r\n                                {gurukulPath.emoji} {gurukulPath.title}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n                <div className=\"dash-greeting-right\" style={{ display: 'flex', flexDirection: 'column', gap: '8px', alignItems: 'flex-end' }}>\r\n                    <span className=\"dash-role-pill\">≡ƒôÜ {userData?.class || 'Class'} | {userData?.section || 'Sec'}</span>\r\n\r\n                    <div\r\n                        onClick={() => setShowGurukul(true)}\r\n                        title=\"Change Learning Path\"\r\n                        style={{\r\n                            display: 'flex', alignItems: 'center', gap: '6px',\r\n                            background: gurukulPath ? gurukulPath.gradient : 'linear-gradient(135deg, #667eea, #764ba2)',\r\n                            color: '#fff', padding: '6px 12px', borderRadius: '20px',\r\n                            fontSize: '11px', fontWeight: '800', cursor: 'pointer',\r\n                            boxShadow: gurukulPath ? `0 3px 12px ${gurukulPath.shadow}` : 'none'\r\n                        }}\r\n                    >\r\n                        {gurukulPath ? `${gurukulPath.emoji} Path` : '≡ƒÅ¢∩╕Å Choose Path'}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"container\">\r\n                {/* Person Selection Dropdown Refined */}\r\n                <div className=\"dropdown-container\" style={{ marginBottom: '24px' }}>\r\n                    <div className=\"dropdown-toggle card\" style={{ borderRadius: '15px', border: '1px solid var(--divider)' }} onClick={() => setShowDropdown(!showDropdown)}>\r\n                        {selectedPerson || t('select_person')}\r\n                    </div>\r\n                    {showDropdown && (\r\n                        <div className=\"dropdown-list card fade-in\">\r\n                            {myGroups.length === 0 ? <div style={{ padding: '20px', textAlign: 'center', color: 'var(--text-muted)' }}>No classes found.</div> :\r\n                                myGroups.map((g, i) => (\r\n                                    <div key={i} className=\"dropdown-item\" onClick={() => handleSelect(g)}>\r\n                                        <div className=\"t-info\">\r\n                                            <div className=\"profile-avatar-mini\" style={{ background: 'var(--primary)', color: 'white' }}>\r\n                                                {g.subject?.[0] || \"C\"}\r\n                                            </div>\r\n                                            <span>{g.subject} - {g.teacherName || \"No Teacher\"}</span>\r\n                                        </div>\r\n                                        <button className=\"group-indicator\" onClick={(e) => goToGroup(e, g)}></button>\r\n                                    </div>\r\n                                ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {selectedPerson && (\r\n                    <div className=\"card text-center mt-4 fade-in\" style={{ padding: '30px', border: '1px solid var(--primary-light)' }}>\r\n                        <h2 style={{ marginBottom: '15px' }}>{selectedPerson}</h2>\r\n                        <button className=\"btn pulse-btn\" onClick={() => handleCardClick('/profile-view', { target: { id: selectedGroup?.teacherId, name: selectedGroup?.teacherName, type: 'Teacher' } })}>{t('proceed')}</button>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Gurukul Invite Banner ΓÇö shown only if no path chosen */}\r\n                {!gurukulPath && (\r\n                    <div\r\n                        onClick={() => setShowGurukul(true)}\r\n                        style={{\r\n                            background: 'linear-gradient(135deg, #667eea22, #764ba222)',\r\n                            border: '1px dashed rgba(102, 126, 234, 0.5)',\r\n                            borderRadius: '16px', padding: '18px 20px',\r\n                            marginBottom: '20px', cursor: 'pointer',\r\n                            display: 'flex', alignItems: 'center', gap: '14px',\r\n                            transition: 'all 0.2s ease'\r\n                        }}\r\n                    >\r\n                        <span style={{ fontSize: '32px' }}>≡ƒÅ¢∩╕Å</span>\r\n                        <div style={{ flex: 1 }}>\r\n                            <h3 style={{ margin: '0 0 6px 0', fontSize: '18px', fontWeight: '800', color: '#fff' }}>\r\n                                Choose Your Gurukul Path\r\n                            </h3>\r\n                            <p style={{ margin: 0, fontSize: '12px', color: 'rgba(255,255,255,0.7)', lineHeight: '1.4' }}>\r\n                                Select an ancient hero's philosophy for how the AI will teach you.\r\n                            </p>\r\n                        </div>\r\n                        <span style={{ marginLeft: 'auto', fontSize: '18px' }}>ΓåÆ</span>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Gurukul Active Banner ΓÇö shown when path is chosen */}\r\n                {gurukulPath && (\r\n                    <div\r\n                        style={{\r\n                            background: gurukulPath.gradient,\r\n                            borderRadius: '16px', padding: '14px 18px',\r\n                            marginBottom: '20px',\r\n                            display: 'flex', alignItems: 'center', gap: '12px',\r\n                            boxShadow: `0 6px 20px ${gurukulPath.shadow}`\r\n                        }}\r\n                    >\r\n                        <span style={{ fontSize: '28px' }}>{gurukulPath.emoji}</span>\r\n                        <div style={{ padding: '0 16px', flex: 1 }}>\r\n                            <div style={{ color: '#fff', fontWeight: '900', fontSize: '15px' }}>\r\n                                {`${gurukulPath.name} Path`} Active\r\n                            </div>\r\n                            <div style={{ color: 'rgba(255,255,255,0.8)', fontSize: '11px', fontStyle: 'italic' }}>\r\n                                {gurukulPath.quote}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => setShowGurukul(true)}\r\n                            style={{\r\n                                background: 'rgba(255,255,255,0.2)', border: 'none',\r\n                                borderRadius: '8px', color: '#fff',\r\n                                fontSize: '10px', padding: '4px 8px', cursor: 'pointer'\r\n                            }}\r\n                        >Change</button>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Main Action Grid */}\r\n                <div className=\"student-grid mt-4\">\r\n                    <div id=\"tour-card-ai\" className=\"student-action-card\" onClick={() => handleCardClick('/ttr-ai')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒñû</span>\r\n                        <h3 className=\"card-vibe-title\">{t('ai_chat')}</h3>\r\n                        <p className=\"card-vibe-desc\">{t('ai_chat_desc')}</p>\r\n                    </div>\r\n\r\n                    <div id=\"tour-card-4way\" className=\"student-action-card\" onClick={() => handleCardClick('/4-way-learning')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒºá</span>\r\n                        <h3 className=\"card-vibe-title\">{t('four_way')}</h3>\r\n                        <p className=\"card-vibe-desc\">{t('four_way_desc')}</p>\r\n                    </div>\r\n\r\n                    <div className=\"student-action-card\" onClick={() => {\r\n                        localStorage.removeItem(\"activeGroupId\"); // Force generic selector view\r\n                        handleCardClick('/group');\r\n                    }}>\r\n                        <span className=\"card-vibe-icon\">≡ƒæÑ</span>\r\n                        <h3 className=\"card-vibe-title\">{t('groups') || 'Groups'}</h3>\r\n                        <p className=\"card-vibe-desc\">Class Discussions</p>\r\n                    </div>\r\n\r\n                    <div id=\"tour-card-attendance\" className=\"student-action-card\" onClick={() => handleCardClick('/attendance')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒôà</span>\r\n                        <h3 className=\"card-vibe-title\">{t('attendance')}</h3>\r\n                        <p className=\"card-vibe-desc\">{t('attendance_desc')}</p>\r\n                    </div>\r\n\r\n                    <div id=\"tour-card-video\" className=\"student-action-card\" onClick={() => handleCardClick('/video-library')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒÄ¼</span>\r\n                        <h3 className=\"card-vibe-title\">{t('video_library')}</h3>\r\n                        <p className=\"card-vibe-desc\">{t('video_lib_desc')}</p>\r\n                    </div>\r\n\r\n                    <div className=\"student-action-card\" onClick={() => handleCardClick('/homework')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒôÜ</span>\r\n                        <h3 className=\"card-vibe-title\">{t('homework')}</h3>\r\n                        <p className=\"card-vibe-desc\">Assignments & Homework</p>\r\n                    </div>\r\n\r\n                    <div className=\"student-action-card\" onClick={() => handleCardClick('/analytics')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒôè</span>\r\n                        <h3 className=\"card-vibe-title\">{t('performance')}</h3>\r\n                        <p className=\"card-vibe-desc\">Track progress</p>\r\n                    </div>\r\n\r\n                    <div className=\"student-action-card\" onClick={() => handleCardClick('/timetable')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒùô∩╕Å</span>\r\n                        <h3 className=\"card-vibe-title\">{t('timetable')}</h3>\r\n                        <p className=\"card-vibe-desc\">Class Schedule</p>\r\n                    </div>\r\n\r\n                    <div className=\"student-action-card\" onClick={() => handleCardClick('/select-feedback-target')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒÆ¼</span>\r\n                        <h3 className=\"card-vibe-title\">{t('feedback')}</h3>\r\n                        <p className=\"card-vibe-desc\">Share thoughts</p>\r\n                    </div>\r\n\r\n                    <div className=\"student-action-card\" onClick={() => handleCardClick('/view-exam-seating')}>\r\n                        <span className=\"card-vibe-icon\">≡ƒ¬æ</span>\r\n                        <h3 className=\"card-vibe-title\">Exam Seats</h3>\r\n                        <p className=\"card-vibe-desc\">View your room/seat</p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Exam Results Module */}\r\n                <div id=\"tour-exam-results\" className=\"results-glass-wrapper\">\r\n                    <h3 style={{ margin: '0 0 20px 0', fontSize: '18px', fontWeight: '800' }}>\r\n                        ≡ƒô¥ {t('recent_results') || 'Recent Exam Results'}\r\n                    </h3>\r\n                    <div style={{ overflowX: 'auto' }}>\r\n                        <table className=\"results-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Exam</th>\r\n                                    <th>Subject</th>\r\n                                    <th>Marks</th>\r\n                                    <th>Status</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {examResults.length === 0 ? (\r\n                                    <tr><td colSpan=\"4\" style={{ padding: '30px', textAlign: 'center', color: 'var(--text-muted)' }}>No results found yet.</td></tr>\r\n                                ) : (\r\n                                    examResults.map((res, i) => (\r\n                                        <tr key={i} className=\"fade-in\" style={{ animationDelay: `${i * 0.1}s` }}>\r\n                                            <td><strong>{res.exam}</strong></td>\r\n                                            <td>{res.subject}</td>\r\n                                            <td>{res.marks} / {res.total}</td>\r\n                                            <td>\r\n                                                <span className={`status-pill ${(res.marks / res.total) >= 0.35 ? 'status-pass' : 'status-fail'}`}>\r\n                                                    {(res.marks / res.total) >= 0.35 ? 'Pass' : 'Fail'}\r\n                                                </span>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))\r\n                                )}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\StudentFee.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'addDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":67,"suggestions":[{"messageId":"removeVar","data":{"varName":"addDoc"},"fix":{"range":[199,207],"text":""},"desc":"Remove unused variable 'addDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":93,"suggestions":[{"messageId":"removeVar","data":{"varName":"orderBy"},"fix":{"range":[224,233],"text":""},"desc":"Remove unused variable 'orderBy'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'limit' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":95,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":100,"suggestions":[{"messageId":"removeVar","data":{"varName":"limit"},"fix":{"range":[233,240],"text":""},"desc":"Remove unused variable 'limit'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, doc, updateDoc, addDoc, serverTimestamp, orderBy, limit } from 'firebase/firestore';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { jsPDF } from 'jspdf';\r\nimport 'jspdf-autotable';\r\n\r\nexport default function StudentFee() {\r\n    const { userData } = useUser();\r\n    const [fees, setFees] = useState([]);\r\n    const [history, setHistory] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const navigate = useNavigate();\r\n\r\n    useEffect(() => {\r\n        if (!userData || !userData.uid) return;\r\n\r\n        const fetchFees = async () => {\r\n            try {\r\n                // 1. Find all allotments linked to this student\r\n                // Query by userId - single field, no index needed\r\n                const allotQ = query(collection(db, \"student_allotments\"), where(\"userId\", \"==\", userData.uid));\r\n                const allotSnap = await getDocs(allotQ);\r\n                const myAllotmentIds = allotSnap.docs.map(d => d.id);\r\n\r\n                // 2. Fetch ALL Fees (Pending + Paid)\r\n                // We avoid composite index (where ... AND where ...)\r\n                // Instead, we just fetch by studentId IN [...] and filter the rest in JS.\r\n                const studentIdsToSearch = [userData.uid, ...myAllotmentIds];\r\n\r\n                // Firestore 'in' operator supports up to 10 IDs.\r\n                const qFees = query(\r\n                    collection(db, \"fees\"),\r\n                    where(\"studentId\", \"in\", studentIdsToSearch)\r\n                );\r\n\r\n                const feeSnap = await getDocs(qFees);\r\n                const allFees = feeSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n\r\n                // Client-side filtering\r\n                const pendingList = allFees.filter(f => f.status === 'pending');\r\n                const paidList = allFees.filter(f => f.status === 'paid');\r\n\r\n                // Sort\r\n                paidList.sort((a, b) => (b.paidAt?.seconds || 0) - (a.paidAt?.seconds || 0));\r\n\r\n                // Cleanup: Deduplicate\r\n                const uniquePending = Array.from(new Map(pendingList.map(item => [item.id, item])).values());\r\n                const uniquePaid = Array.from(new Map(paidList.map(item => [item.id, item])).values());\r\n\r\n                setFees(uniquePending);\r\n                setHistory(uniquePaid);\r\n\r\n            } catch (error) {\r\n                console.error(\"Error fetching fees:\", error);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchFees();\r\n    }, [userData]);\r\n\r\n    const handlePay = async (feeId, amount) => {\r\n        if (!window.confirm(`Proceed to pay Γé╣${amount}?`)) return;\r\n\r\n        try {\r\n            const feeRef = doc(db, \"fees\", feeId);\r\n            await updateDoc(feeRef, {\r\n                status: 'paid',\r\n                paidAt: serverTimestamp(),\r\n                transactionId: `TXN-${Date.now()}`,\r\n                // Link payment to the actual User UID so history stays with the account\r\n                studentId: userData.uid\r\n            });\r\n\r\n            alert(\"Payment Successful! Γ£à\");\r\n\r\n            // Refresh UI locally\r\n            const paidFee = fees.find(f => f.id === feeId);\r\n            if (paidFee) {\r\n                const updatedFee = {\r\n                    ...paidFee,\r\n                    status: 'paid',\r\n                    paidAt: { seconds: Date.now() / 1000 },\r\n                    transactionId: `TXN-${Date.now()}`\r\n                };\r\n\r\n                setFees(prev => prev.filter(f => f.id !== feeId));\r\n                setHistory(prev => [updatedFee, ...prev]);\r\n            }\r\n\r\n        } catch (e) {\r\n            console.error(\"Payment Error:\", e);\r\n            alert(\"Payment Failed. Please try again.\");\r\n        }\r\n    };\r\n\r\n    const downloadReceipt = (rec) => {\r\n        const doc = new jsPDF();\r\n\r\n        // Header\r\n        doc.setFontSize(22);\r\n        doc.setTextColor(44, 62, 80);\r\n        doc.text(\"FEE RECEIPT\", 105, 20, null, null, \"center\");\r\n\r\n        doc.setFontSize(12);\r\n        doc.setTextColor(100);\r\n        doc.text(\"Together To Refine Platform\", 105, 28, null, null, \"center\");\r\n\r\n        doc.setLineWidth(0.5);\r\n        doc.line(20, 35, 190, 35);\r\n\r\n        doc.setFontSize(10);\r\n        doc.setTextColor(0);\r\n\r\n        const details = [\r\n            [\"Transaction ID\", rec.transactionId || \"N/A\"],\r\n            [\"Date\", rec.paidAt?.seconds ? new Date(rec.paidAt.seconds * 1000).toLocaleDateString() : new Date().toLocaleDateString()],\r\n            [\"Student Name\", userData.name || `${userData.firstName || ''} ${userData.secondName || ''}`.trim()],\r\n            [\"Institution\", rec.institutionName || \"School\"],\r\n            [\"Fee Type\", rec.title],\r\n            [\"Status\", \"PAID\"]\r\n        ];\r\n\r\n        let y = 45;\r\n        details.forEach(([label, value]) => {\r\n            doc.setFont(\"helvetica\", \"bold\");\r\n            doc.text(`${label}:`, 20, y);\r\n            doc.setFont(\"helvetica\", \"normal\");\r\n            doc.text(`${value}`, 60, y);\r\n            y += 8;\r\n        });\r\n\r\n        doc.setFillColor(241, 242, 246);\r\n        doc.rect(120, 40, 70, 30, \"F\");\r\n        doc.setFontSize(14);\r\n        doc.setTextColor(46, 204, 113);\r\n        doc.setFont(\"helvetica\", \"bold\");\r\n        doc.text(`AMOUNT PAID`, 155, 50, null, null, \"center\");\r\n        doc.setFontSize(20);\r\n        doc.text(`Γé╣${rec.amount}`, 155, 62, null, null, \"center\");\r\n\r\n        doc.setFontSize(9);\r\n        doc.setTextColor(150);\r\n        doc.text(\"This is a computer generated receipt.\", 105, 280, null, null, \"center\");\r\n\r\n        doc.save(`Receipt_${rec.transactionId}.pdf`);\r\n    };\r\n\r\n    if (loading) return (\r\n        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', background: '#f8f9fa' }}>\r\n            <div className=\"spinner\" style={{ width: '40px', height: '40px', borderRadius: '50%', border: '3px solid #eee', borderTop: '3px solid #3498db', animation: 'spin 1s linear infinite' }}></div>\r\n            <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"page-wrapper\" style={{ padding: '20px', maxWidth: '800px', margin: '0 auto', background: '#f8f9fa', minHeight: '100vh' }}>\r\n            <button className=\"btn\" onClick={() => navigate(-1)} style={{ marginBottom: '20px', background: 'white', border: '1px solid #ddd', padding: '10px 20px', borderRadius: '12px' }}>ΓåÉ Back</button>\r\n            <h2 style={{ textAlign: 'center', marginBottom: '30px', fontWeight: '800', color: '#2d3436' }}>≡ƒÄô Student Fee Portal</h2>\r\n\r\n            <div className=\"card\" style={{ marginBottom: '30px', padding: '30px', borderRadius: '24px', borderLeft: '6px solid #e74c3c' }}>\r\n                <h3 style={{ marginBottom: '20px', color: '#2d3436' }}>≡ƒö┤ Pending Payments</h3>\r\n                {fees.length === 0 ? (\r\n                    <div style={{ textAlign: 'center', padding: '20px' }}>\r\n                        <span style={{ fontSize: '3rem' }}>≡ƒÄë</span>\r\n                        <p style={{ color: '#27ae60', fontWeight: '700', marginTop: '10px' }}>No pending dues! You're all caught up.</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"fee-list\" style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>\r\n                        {fees.map(fee => (\r\n                            <div key={fee.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px', background: 'white', borderRadius: '16px', boxShadow: '0 4px 10px rgba(0,0,0,0.02)' }}>\r\n                                <div>\r\n                                    <h4 style={{ margin: 0, fontSize: '1.1rem' }}>{fee.title}</h4>\r\n                                    <p style={{ margin: '5px 0', fontSize: '13px', color: '#7f8c8d' }}>Due: {new Date(fee.dueDate).toLocaleDateString()}</p>\r\n                                </div>\r\n                                <div style={{ textAlign: 'right' }}>\r\n                                    <div style={{ fontSize: '1.4rem', fontWeight: '900', color: '#e74c3c' }}>Γé╣{fee.amount}</div>\r\n                                    <button\r\n                                        onClick={() => handlePay(fee.id, fee.amount)}\r\n                                        style={{ background: '#2d3436', color: 'white', border: 'none', padding: '8px 20px', borderRadius: '10px', fontWeight: '700', fontSize: '0.85rem', marginTop: '8px', cursor: 'pointer' }}\r\n                                    >\r\n                                        Pay Now\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"card\" style={{ padding: '30px', borderRadius: '24px', borderLeft: '6px solid #27ae60' }}>\r\n                <h3 style={{ marginBottom: '20px', color: '#2d3436' }}>≡ƒô£ Payment History</h3>\r\n                {history.length === 0 ? (\r\n                    <p style={{ color: '#95a5a6', textAlign: 'center' }}>No payment history found.</p>\r\n                ) : (\r\n                    <div className=\"history-list\" style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>\r\n                        {history.map(rec => (\r\n                            <div key={rec.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '15px', background: 'white', borderRadius: '16px', opacity: 0.9 }}>\r\n                                <div>\r\n                                    <h4 style={{ margin: 0, color: '#34495e' }}>{rec.title}</h4>\r\n                                    <p style={{ margin: '4px 0', fontSize: '12px', color: '#7f8c8d' }}>\r\n                                        Paid: {rec.paidAt?.seconds ? new Date(rec.paidAt.seconds * 1000).toLocaleDateString() : 'Recent'}\r\n                                    </p>\r\n                                </div>\r\n                                <div style={{ textAlign: 'right' }}>\r\n                                    <div style={{ fontSize: '1.1rem', fontWeight: '800', color: '#27ae60' }}>Γé╣{rec.amount}</div>\r\n                                    <button onClick={() => downloadReceipt(rec)} style={{ background: '#f1f2f6', border: 'none', padding: '5px 10px', borderRadius: '8px', fontSize: '14px', marginTop: '5px', cursor: 'pointer' }}>\r\n                                        Receipt ≡ƒôÑ\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\StudentPromotion.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":59,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[135,146],"text":""},"desc":"Remove unused variable 'updateDoc'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, doc, updateDoc, writeBatch } from 'firebase/firestore';\r\nimport { useUser } from '../context/UserContext';\r\n\r\nconst StudentPromotion = () => {\r\n    const { userData } = useUser();\r\n    const [loading, setLoading] = useState(false);\r\n    const [students, setStudents] = useState([]);\r\n    const [selectedClass, setSelectedClass] = useState('');\r\n    const [selectedSection, setSelectedSection] = useState('');\r\n    const [promotionData, setPromotionData] = useState({});\r\n    const [currentYear, setCurrentYear] = useState('2025-2026');\r\n    const [newYear, setNewYear] = useState('2026-2027');\r\n\r\n    const classes = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];\r\n    const sections = ['A', 'B', 'C', 'D', 'E'];\r\n\r\n    // Fetch students from selected class\r\n    const fetchStudents = async () => {\r\n        if (!selectedClass || !selectedSection || !userData?.uid) return;\r\n\r\n        setLoading(true);\r\n        try {\r\n            console.log('Fetching ALL students for institution to ensure no misses...');\r\n\r\n            // 1. Fetch ALL students for this institution (bypasses specific class/section query issues)\r\n            const studentsRef = collection(db, 'users');\r\n            const q = query(\r\n                studentsRef,\r\n                where('role', '==', 'student'),\r\n                where('institutionId', '==', userData.uid)\r\n            );\r\n\r\n            const snapshot = await getDocs(q);\r\n            const allStudents = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }));\r\n\r\n            console.log(`Total students in institution: ${allStudents.length}`);\r\n\r\n            // 2. Client-side filtering with ROBUST normalization\r\n            // This handles: \"9\" vs 9 (number), \" 9 \" (spaces), \"9th\", \"A\" vs \"a\", etc.\r\n            const targetClassNorm = String(selectedClass).trim().toLowerCase().replace(/(st|nd|rd|th)$/, '');\r\n            const targetSectionNorm = String(selectedSection).trim().toLowerCase();\r\n\r\n            const filteredStudents = allStudents.filter(student => {\r\n                // Safety check for missing fields\r\n                if (!student.class || !student.section) return false;\r\n\r\n                // Normalize student data\r\n                // Handle complex cases like \"Class 10\" or \"10th Grade\" if necessary, but stripping suffixes usually works\r\n                const sClass = String(student.class).trim().toLowerCase().replace(/(class\\s*|grade\\s*|st|nd|rd|th)/g, '').trim();\r\n                const sSection = String(student.section).trim().toLowerCase();\r\n\r\n                // Debug specific mismatches if needed\r\n                // if (sClass.includes('9')) console.log(`Checking ${student.name}: DB[${sClass}-${sSection}] vs Target[${targetClassNorm}-${targetSectionNorm}]`);\r\n\r\n                return sClass === targetClassNorm && sSection === targetSectionNorm;\r\n            });\r\n\r\n            console.log(`Matched ${filteredStudents.length} students for Class ${selectedClass}-${selectedSection}`);\r\n\r\n            setStudents(filteredStudents);\r\n\r\n            // Initialize promotion data\r\n            const defaultPromotion = {};\r\n            const nextClass = selectedClass === '10' ? 'Graduated' : String(parseInt(selectedClass) + 1);\r\n\r\n            filteredStudents.forEach(student => {\r\n                defaultPromotion[student.id] = {\r\n                    status: selectedClass === '10' ? 'graduated' : 'promoted',\r\n                    toClass: nextClass,\r\n                    toSection: selectedSection\r\n                };\r\n            });\r\n\r\n            setPromotionData(defaultPromotion);\r\n\r\n            if (filteredStudents.length === 0) {\r\n                // Debug: Show a few examples of what classes DO exist to help the user\r\n                const existingClasses = [...new Set(allStudents.map(s => `${s.class}-${s.section}`))].slice(0, 5);\r\n                alert(`ΓÜá∩╕Å No students found for Class ${selectedClass}-${selectedSection}\\n\\nExisting classes sample:\\n${existingClasses.join('\\n')}\\n\\nCheck if your data matches exactly.`);\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error('Error fetching students:', error);\r\n            alert('Failed to fetch students: ' + error.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n\r\n    useEffect(() => {\r\n        if (selectedClass && selectedSection) {\r\n            fetchStudents();\r\n        }\r\n    }, [selectedClass, selectedSection]);\r\n\r\n    // Update individual student promotion\r\n    const updatePromotion = (studentId, field, value) => {\r\n        setPromotionData(prev => ({\r\n            ...prev,\r\n            [studentId]: {\r\n                ...prev[studentId],\r\n                [field]: value\r\n            }\r\n        }));\r\n    };\r\n\r\n    // Execute bulk promotion\r\n    const executePromotion = async () => {\r\n        if (students.length === 0) {\r\n            alert('No students to promote!');\r\n            return;\r\n        }\r\n\r\n        const confirmMsg = `Are you sure you want to promote ${students.length} students from Class ${selectedClass}-${selectedSection}?\\n\\nThis action will:\\n- Update student class/section\\n- Archive current year data\\n- This cannot be easily undone!`;\r\n\r\n        if (!window.confirm(confirmMsg)) return;\r\n\r\n        setLoading(true);\r\n        try {\r\n            const batch = writeBatch(db);\r\n            let promotedCount = 0;\r\n            let graduatedCount = 0;\r\n            let detainedCount = 0;\r\n\r\n            for (const student of students) {\r\n                const promotion = promotionData[student.id];\r\n                const studentRef = doc(db, 'users', student.id);\r\n\r\n                if (promotion.status === 'promoted') {\r\n                    batch.update(studentRef, {\r\n                        class: promotion.toClass,\r\n                        section: promotion.toSection,\r\n                        academicYear: newYear,\r\n                        [`academicHistory.${currentYear}`]: {\r\n                            class: selectedClass,\r\n                            section: selectedSection,\r\n                            promotionStatus: 'promoted',\r\n                            promotedOn: new Date().toISOString()\r\n                        }\r\n                    });\r\n                    promotedCount++;\r\n                } else if (promotion.status === 'graduated') {\r\n                    batch.update(studentRef, {\r\n                        role: 'alumni',\r\n                        graduationYear: currentYear,\r\n                        lastClass: selectedClass,\r\n                        lastSection: selectedSection,\r\n                        graduatedOn: new Date().toISOString(),\r\n                        [`academicHistory.${currentYear}`]: {\r\n                            class: selectedClass,\r\n                            section: selectedSection,\r\n                            promotionStatus: 'graduated',\r\n                            graduatedOn: new Date().toISOString()\r\n                        }\r\n                    });\r\n                    graduatedCount++;\r\n                } else if (promotion.status === 'detained') {\r\n                    batch.update(studentRef, {\r\n                        academicYear: newYear,\r\n                        // Class remains same\r\n                        [`academicHistory.${currentYear}`]: {\r\n                            class: selectedClass,\r\n                            section: selectedSection,\r\n                            promotionStatus: 'detained',\r\n                            detainedOn: new Date().toISOString()\r\n                        }\r\n                    });\r\n                    detainedCount++;\r\n                }\r\n            }\r\n\r\n            await batch.commit();\r\n\r\n            alert(`Γ£à Promotion Successful!\\n\\n` +\r\n                `Promoted: ${promotedCount}\\n` +\r\n                `Graduated: ${graduatedCount}\\n` +\r\n                `Detained: ${detainedCount}\\n\\n` +\r\n                `Academic Year: ${currentYear} ΓåÆ ${newYear}`);\r\n\r\n            // Refresh the list\r\n            setStudents([]);\r\n            setSelectedClass('');\r\n            setSelectedSection('');\r\n        } catch (error) {\r\n            console.error('Error promoting students:', error);\r\n            alert('Failed to promote students. Please try again.');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    if (userData?.role !== 'institution') {\r\n        return (\r\n            <div className=\"p-8 text-center\">\r\n                <h2 className=\"text-2xl font-bold text-red-600\">Access Denied</h2>\r\n                <p className=\"mt-4\">Only institutions can access student promotion.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div style={{\r\n            minHeight: '100vh',\r\n            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n            padding: '20px',\r\n            paddingBottom: '100px'\r\n        }}>\r\n            <div style={{ maxWidth: '1200px', margin: '0 auto' }}>\r\n                {/* Header */}\r\n                <div style={{\r\n                    background: 'white',\r\n                    borderRadius: '15px',\r\n                    padding: '30px',\r\n                    marginBottom: '20px',\r\n                    boxShadow: '0 10px 30px rgba(0,0,0,0.2)'\r\n                }}>\r\n                    <h1 style={{\r\n                        fontSize: '32px',\r\n                        fontWeight: 'bold',\r\n                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n                        WebkitBackgroundClip: 'text',\r\n                        WebkitTextFillColor: 'transparent',\r\n                        marginBottom: '10px'\r\n                    }}>\r\n                        ≡ƒÄô Student Promotion\r\n                    </h1>\r\n                    <p style={{ color: '#666', fontSize: '16px' }}>\r\n                        Promote students to the next academic year\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Academic Year Settings */}\r\n                <div style={{\r\n                    background: 'white',\r\n                    borderRadius: '15px',\r\n                    padding: '25px',\r\n                    marginBottom: '20px',\r\n                    boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                }}>\r\n                    <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '15px' }}>\r\n                        ≡ƒôà Academic Year Transition\r\n                    </h3>\r\n                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\r\n                        <div>\r\n                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600' }}>\r\n                                Current Year\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={currentYear}\r\n                                onChange={(e) => setCurrentYear(e.target.value)}\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '12px',\r\n                                    border: '2px solid #e0e0e0',\r\n                                    borderRadius: '8px',\r\n                                    fontSize: '16px'\r\n                                }}\r\n                                placeholder=\"2025-2026\"\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600' }}>\r\n                                New Year\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={newYear}\r\n                                onChange={(e) => setNewYear(e.target.value)}\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '12px',\r\n                                    border: '2px solid #e0e0e0',\r\n                                    borderRadius: '8px',\r\n                                    fontSize: '16px'\r\n                                }}\r\n                                placeholder=\"2026-2027\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Class Selection */}\r\n                <div style={{\r\n                    background: 'white',\r\n                    borderRadius: '15px',\r\n                    padding: '25px',\r\n                    marginBottom: '20px',\r\n                    boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                }}>\r\n                    <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '15px' }}>\r\n                        ≡ƒôÜ Select Class to Promote\r\n                    </h3>\r\n                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\r\n                        <div>\r\n                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600' }}>\r\n                                Class\r\n                            </label>\r\n                            <select\r\n                                value={selectedClass}\r\n                                onChange={(e) => setSelectedClass(e.target.value)}\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '12px',\r\n                                    border: '2px solid #e0e0e0',\r\n                                    borderRadius: '8px',\r\n                                    fontSize: '16px'\r\n                                }}\r\n                            >\r\n                                <option value=\"\">Select Class</option>\r\n                                {classes.map(cls => (\r\n                                    <option key={cls} value={cls}>Class {cls}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600' }}>\r\n                                Section\r\n                            </label>\r\n                            <select\r\n                                value={selectedSection}\r\n                                onChange={(e) => setSelectedSection(e.target.value)}\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '12px',\r\n                                    border: '2px solid #e0e0e0',\r\n                                    borderRadius: '8px',\r\n                                    fontSize: '16px'\r\n                                }}\r\n                            >\r\n                                <option value=\"\">Select Section</option>\r\n                                {sections.map(sec => (\r\n                                    <option key={sec} value={sec}>Section {sec}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Students List */}\r\n                {students.length > 0 && (\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '15px',\r\n                        padding: '25px',\r\n                        marginBottom: '20px',\r\n                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)'\r\n                    }}>\r\n                        <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '15px' }}>\r\n                            ≡ƒæÑ Students in Class {selectedClass}-{selectedSection} ({students.length})\r\n                        </h3>\r\n\r\n                        <div style={{ overflowX: 'auto' }}>\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>\r\n                                <thead>\r\n                                    <tr style={{ background: '#f5f5f5' }}>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #ddd' }}>Roll No</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #ddd' }}>Name</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #ddd' }}>Status</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #ddd' }}>To Class</th>\r\n                                        <th style={{ padding: '12px', textAlign: 'left', borderBottom: '2px solid #ddd' }}>To Section</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {students.map(student => (\r\n                                        <tr key={student.id} style={{ borderBottom: '1px solid #eee' }}>\r\n                                            <td style={{ padding: '12px' }}>{student.rollNumber || '-'}</td>\r\n                                            <td style={{ padding: '12px', fontWeight: '600' }}>{student.name}</td>\r\n                                            <td style={{ padding: '12px' }}>\r\n                                                <select\r\n                                                    value={promotionData[student.id]?.status || 'promoted'}\r\n                                                    onChange={(e) => updatePromotion(student.id, 'status', e.target.value)}\r\n                                                    style={{\r\n                                                        padding: '8px',\r\n                                                        border: '1px solid #ddd',\r\n                                                        borderRadius: '6px',\r\n                                                        fontSize: '14px'\r\n                                                    }}\r\n                                                >\r\n                                                    <option value=\"promoted\">Γ£à Promoted</option>\r\n                                                    <option value=\"detained\">ΓÅ╕∩╕Å Detained</option>\r\n                                                    {selectedClass === '10' && <option value=\"graduated\">≡ƒÄô Graduated</option>}\r\n                                                </select>\r\n                                            </td>\r\n                                            <td style={{ padding: '12px' }}>\r\n                                                {promotionData[student.id]?.status === 'graduated' ? (\r\n                                                    <span style={{ color: '#666', fontStyle: 'italic' }}>Alumni</span>\r\n                                                ) : promotionData[student.id]?.status === 'detained' ? (\r\n                                                    <span style={{ color: '#666', fontStyle: 'italic' }}>Same ({selectedClass})</span>\r\n                                                ) : (\r\n                                                    <select\r\n                                                        value={promotionData[student.id]?.toClass || ''}\r\n                                                        onChange={(e) => updatePromotion(student.id, 'toClass', e.target.value)}\r\n                                                        style={{\r\n                                                            padding: '8px',\r\n                                                            border: '1px solid #ddd',\r\n                                                            borderRadius: '6px',\r\n                                                            fontSize: '14px'\r\n                                                        }}\r\n                                                    >\r\n                                                        {classes.map(cls => (\r\n                                                            <option key={cls} value={cls}>Class {cls}</option>\r\n                                                        ))}\r\n                                                    </select>\r\n                                                )}\r\n                                            </td>\r\n                                            <td style={{ padding: '12px' }}>\r\n                                                {promotionData[student.id]?.status === 'graduated' ? (\r\n                                                    <span style={{ color: '#666', fontStyle: 'italic' }}>-</span>\r\n                                                ) : promotionData[student.id]?.status === 'detained' ? (\r\n                                                    <span style={{ color: '#666', fontStyle: 'italic' }}>Same ({selectedSection})</span>\r\n                                                ) : (\r\n                                                    <select\r\n                                                        value={promotionData[student.id]?.toSection || ''}\r\n                                                        onChange={(e) => updatePromotion(student.id, 'toSection', e.target.value)}\r\n                                                        style={{\r\n                                                            padding: '8px',\r\n                                                            border: '1px solid #ddd',\r\n                                                            borderRadius: '6px',\r\n                                                            fontSize: '14px'\r\n                                                        }}\r\n                                                    >\r\n                                                        {sections.map(sec => (\r\n                                                            <option key={sec} value={sec}>Section {sec}</option>\r\n                                                        ))}\r\n                                                    </select>\r\n                                                )}\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n\r\n                        {/* Execute Button */}\r\n                        <div style={{ marginTop: '25px', textAlign: 'center' }}>\r\n                            <button\r\n                                onClick={executePromotion}\r\n                                disabled={loading}\r\n                                style={{\r\n                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n                                    color: 'white',\r\n                                    padding: '15px 40px',\r\n                                    fontSize: '18px',\r\n                                    fontWeight: 'bold',\r\n                                    border: 'none',\r\n                                    borderRadius: '10px',\r\n                                    cursor: loading ? 'not-allowed' : 'pointer',\r\n                                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)',\r\n                                    opacity: loading ? 0.6 : 1\r\n                                }}\r\n                            >\r\n                                {loading ? 'ΓÅ│ Processing...' : '≡ƒÜÇ Execute Promotion'}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {loading && students.length === 0 && (\r\n                    <div style={{ textAlign: 'center', padding: '40px', color: 'white' }}>\r\n                        <p style={{ fontSize: '18px' }}>ΓÅ│ Loading students...</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default StudentPromotion;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\TTRAI.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  16 |     useEffect(() => {\n  17 |         indexRef.current = 0;\n> 18 |         setDisplayedText('');\n     |         ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |\n  20 |         const interval = setInterval(() => {\n  21 |             setDisplayedText((prev) => {","line":18,"column":9,"nodeType":null,"endLine":18,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":41,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"navigate"},"fix":{"range":[1492,1523],"text":""},"desc":"Remove unused variable 'navigate'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'statusLog' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":49,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"statusLog"},"fix":{"range":[1805,1814],"text":""},"desc":"Remove unused variable 'statusLog'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'permissionModal' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":60,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"permissionModal"},"fix":{"range":[2169,2184],"text":""},"desc":"Remove unused variable 'permissionModal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setPermissionModal' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":60,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setPermissionModal"},"fix":{"range":[2184,2204],"text":""},"desc":"Remove unused variable 'setPermissionModal'."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":156,"column":42,"nodeType":"BlockStatement","messageId":"unexpected","endLine":157,"endColumn":14,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[7005,7019],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { db } from '../firebase';\r\nimport { doc, collection, getDocs, addDoc, updateDoc, query, orderBy, onSnapshot, limit, where } from 'firebase/firestore';\r\nimport Header from '../components/Header';\r\nimport { useSpeech } from '../hooks/useSpeech';\r\nimport { useUser } from '../context/UserContext';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport BottomNav from '../components/BottomNav';\r\n\r\n// Helper Component for Typewriter Effect\r\nconst TypewriterMessage = ({ text, onComplete }) => {\r\n    const [displayedText, setDisplayedText] = useState('');\r\n    const indexRef = useRef(0);\r\n\r\n    useEffect(() => {\r\n        indexRef.current = 0;\r\n        setDisplayedText('');\r\n\r\n        const interval = setInterval(() => {\r\n            setDisplayedText((prev) => {\r\n                if (indexRef.current < text.length) {\r\n                    const char = text.charAt(indexRef.current);\r\n                    indexRef.current++;\r\n                    return prev + char;\r\n                } else {\r\n                    clearInterval(interval);\r\n                    if (onComplete) onComplete();\r\n                    return prev;\r\n                }\r\n            });\r\n        }, 5); // Fast Speed: 5ms per char\r\n\r\n        return () => clearInterval(interval);\r\n    }, [text]);\r\n\r\n    return <ReactMarkdown>{displayedText}</ReactMarkdown>;\r\n};\r\n\r\nexport default function TTRAI() {\r\n    const navigate = useNavigate();\r\n    const { user: authUser, userData } = useUser();\r\n\r\n    // Core Chat State\r\n    const [messages, setMessages] = useState([]);\r\n    const [input, setInput] = useState('');\r\n    const [loading, setLoading] = useState(false);\r\n    const messagesEndRef = useRef(null);\r\n    const [statusLog, setStatusLog] = useState(\"Ready\");\r\n\r\n    // AI & UI State\r\n    const MODEL_NAME = \"gemini-2.0-flash\";\r\n    const [selectedImage, setSelectedImage] = useState(null);\r\n    const [showSidebar, setShowSidebar] = useState(false);\r\n\r\n    // Speech Hook\r\n    const { speak, listen, isListening, speakingText } = useSpeech();\r\n\r\n    // Permissions\r\n    const [permissionModal, setPermissionModal] = useState(null);\r\n    const fileInputRef = useRef(null);\r\n\r\n    // Context Loading\r\n    const [userContext, setUserContext] = useState(null);\r\n    const [currentUser, setCurrentUser] = useState(null);\r\n\r\n    // Session State\r\n    const [sessions, setSessions] = useState([]);\r\n    const [currentSessionId, setCurrentSessionId] = useState(null);\r\n\r\n    // 1. Auth & Context Loading\r\n    useEffect(() => {\r\n        if (!authUser) return;\r\n        setCurrentUser(authUser);\r\n\r\n        let context = {\r\n            role: userData?.role || 'User',\r\n            name: userData?.name || 'User',\r\n            class: userData?.class || 'N/A',\r\n            gender: userData?.gender || 'N/A',\r\n            gurukul_path: userData?.gurukul_path || null,   // ΓåÉ Gurukul Hero Path\r\n            upcomingEvents: [],\r\n            adminData: null\r\n        };\r\n\r\n        if (userData?.role === 'admin' || authUser.email === 'admin@ttr.com') {\r\n            context.role = 'System Admin';\r\n            context.name = 'Admin';\r\n        }\r\n\r\n        const fetchContext = async () => {\r\n            try {\r\n                // LEVEL 1: Advanced Real-time Context Injection\r\n                // Fetch dynamic data about the current user specifically for the AI\r\n                if (context.role === 'System Admin') {\r\n                    const feedSnap = await getDocs(query(collection(db, \"general_feedback\"), orderBy(\"timestamp\", \"desc\"), limit(5)));\r\n                    const repSnap = await getDocs(query(collection(db, \"emergency_reports\"), orderBy(\"createdAt\", \"desc\"), limit(5)));\r\n                    context.adminData = {\r\n                        recentActivity: [\r\n                            ...feedSnap.docs.map(d => `- Feedback: ${d.data().comment} (${d.data().authorRole})`),\r\n                            ...repSnap.docs.map(d => `- REPORT: ${d.data().description}`)\r\n                        ]\r\n                    };\r\n                } else if (context.role === 'institution') {\r\n                    // Give Institution AI context about their school size\r\n                    const tSnap = await getDocs(query(collection(db, \"teachers\"), where(\"institutionId\", \"==\", authUser.uid)));\r\n                    const sSnap = await getDocs(query(collection(db, \"users\"), where(\"institutionId\", \"==\", authUser.uid), where(\"role\", \"==\", \"student\")));\r\n                    context.schoolData = {\r\n                        totalTeachers: tSnap.docs.length,\r\n                        totalStudents: sSnap.docs.length\r\n                    };\r\n                } else if (context.role === 'teacher') {\r\n                    // Give Teacher AI context about the groups/classes they teach\r\n                    const gSnap = await getDocs(query(collection(db, \"groups\"), where(\"teacherId\", \"==\", authUser.uid)));\r\n                    context.teacherData = {\r\n                        classesTeaching: gSnap.docs.map(d => d.data().className).join(\", \") || \"None assigned yet\"\r\n                    };\r\n                } else if (context.role === 'student') {\r\n                    // Give Student AI context about their current workload\r\n                    const hwSnap = await getDocs(query(collection(db, \"homework\"), where(\"targetClass\", \"==\", context.class || \"Unknown\"), limit(3)));\r\n                    context.studentData = {\r\n                        recentHomework: hwSnap.docs.map(d => `${d.data().subject}: ${d.data().title}`).join(\" | \") || \"No recent homework\"\r\n                    };\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Error fetching AI context:\", e);\r\n            }\r\n            setUserContext(context);\r\n        };\r\n        fetchContext();\r\n    }, [authUser, userData]);\r\n\r\n    // 2. Fetch Sessions List (History)\r\n    useEffect(() => {\r\n        if (!currentUser) return;\r\n        const q = query(collection(db, 'ai_chats', currentUser.uid, 'sessions'), orderBy('updatedAt', 'desc'), limit(20));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            setSessions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));\r\n        });\r\n        return () => unsubscribe();\r\n    }, [currentUser]);\r\n\r\n    // 3. Chat Messages Listener (Dependent on Session)\r\n    useEffect(() => {\r\n        if (!currentUser) return;\r\n\r\n        // If no session is selected, clear messages or show welcome\r\n        if (!currentSessionId) {\r\n            setMessages([{ text: \"Hello! I am TTR AI. Ask me anything!\", sender: 'ai' }]);\r\n            return;\r\n        }\r\n\r\n        const q = query(collection(db, 'ai_chats', currentUser.uid, 'sessions', currentSessionId, 'messages'), orderBy('createdAt', 'asc'));\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const loadedMsgs = snapshot.docs.map(doc => doc.data());\r\n            if (loadedMsgs.length === 0) {\r\n            } else {\r\n                setMessages(loadedMsgs);\r\n            }\r\n        });\r\n        return () => unsubscribe();\r\n    }, [currentUser, currentSessionId]);\r\n\r\n    const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n    useEffect(() => scrollToBottom(), [messages]);\r\n\r\n    // System Prompt Generator\r\n    // System Prompt Logic Moved to Backend (Server-Side) for Security & IP Protection.\r\n    // The server now handles the \"TTR-X1 Hyper-Algorithm\" generation.\r\n\r\n    const saveMessage = async (msgObj, sessionId) => {\r\n        if (!currentUser || !sessionId) return;\r\n        try {\r\n            await addDoc(collection(db, 'ai_chats', currentUser.uid, 'sessions', sessionId, 'messages'), { ...msgObj, createdAt: new Date() });\r\n            await updateDoc(doc(db, 'ai_chats', currentUser.uid, 'sessions', sessionId), {\r\n                updatedAt: new Date()\r\n            });\r\n        } catch (e) { console.error(\"Error saving message\", e); }\r\n    };\r\n\r\n    const startNewChat = () => {\r\n        setCurrentSessionId(null);\r\n        setMessages([{ text: \"Hello! I am TTR AI. Ask me anything!\", sender: 'ai' }]);\r\n        setInput('');\r\n        setShowSidebar(false);\r\n    };\r\n\r\n    const handleCameraClick = () => { fileInputRef.current?.click(); };\r\n\r\n    const handleImageChange = (e) => {\r\n        const file = e.target.files[0];\r\n        if (file) {\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => { setSelectedImage(reader.result); };\r\n            reader.readAsDataURL(file);\r\n        }\r\n    };\r\n\r\n    const handleSend = async () => {\r\n        const text = input.trim();\r\n        if (!text && !selectedImage) return;\r\n\r\n        setInput('');\r\n        setSelectedImage(null);\r\n        setLoading(true);\r\n        setStatusLog(\"Processing...\");\r\n\r\n        const userMsg = { text: text || \"Image Uploaded\", image: selectedImage, sender: 'user', createdAt: new Date() };\r\n        setMessages(prev => [...prev, userMsg]);\r\n\r\n        try {\r\n            if (!currentUser) throw new Error(\"User not found\");\r\n\r\n            let activeSessionId = currentSessionId;\r\n            if (!activeSessionId) {\r\n                const sessionRef = await addDoc(collection(db, 'ai_chats', currentUser.uid, 'sessions'), {\r\n                    title: text.substring(0, 30) || \"New Chat\",\r\n                    createdAt: new Date(),\r\n                    updatedAt: new Date()\r\n                });\r\n                activeSessionId = sessionRef.id;\r\n                setCurrentSessionId(activeSessionId);\r\n            }\r\n\r\n            await saveMessage(userMsg, activeSessionId);\r\n\r\n            let responseText = \"\";\r\n\r\n            try {\r\n                // Limit history to 6 to speed up processing\r\n                let historyForApi = messages.slice(-10).map(m => ({\r\n                    role: m.sender === 'user' ? 'user' : 'model',\r\n                    parts: [{ text: m.text || \"\" }]\r\n                }));\r\n                while (historyForApi.length > 0 && historyForApi[0].role !== 'user') historyForApi.shift();\r\n\r\n                const payload = {\r\n                    history: historyForApi,\r\n                    message: text,\r\n                    // Security Upgrade: System Prompt logic is now handled server-side\r\n                    userContext: userContext,\r\n                    image: selectedImage ? selectedImage.split(',')[1] : null,\r\n                    mimeType: selectedImage ? selectedImage.match(/:(.*?);/)?.[1] : null\r\n                };\r\n\r\n                const API_URL = window.location.hostname === 'localhost'\r\n                    ? 'http://localhost:5000/api/chat'\r\n                    : 'https://together-to-refine.vercel.app/api/chat';\r\n\r\n                const res = await fetch(API_URL, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify(payload)\r\n                });\r\n\r\n                if (!res.ok) {\r\n                    const d = await res.json();\r\n                    throw new Error(d.error || \"Backend Error\");\r\n                }\r\n\r\n                const data = await res.json();\r\n                responseText = data.text;\r\n\r\n            } catch (e) {\r\n                console.error(\"AI Generation Error\", e);\r\n                throw e;\r\n            }\r\n\r\n            const aiMsg = { text: responseText, sender: 'ai', createdAt: new Date() };\r\n            if (!currentSessionId) {\r\n                setMessages(prev => [...prev, aiMsg]);\r\n            }\r\n            await saveMessage(aiMsg, activeSessionId);\r\n\r\n        } catch (error) {\r\n            console.error(error);\r\n            let errorMsg = error.message;\r\n            let isConfigError = false;\r\n            // Enhanced error detection for API key issues\r\n            if (errorMsg.includes(\"API key\") || errorMsg.includes(\"403\") || errorMsg.includes(\"key not valid\") || errorMsg.includes(\"expired\")) {\r\n                errorMsg = \"System Configuration Error: API Key is invalid or expired.\";\r\n                isConfigError = true;\r\n            }\r\n            setMessages(prev => [...prev, {\r\n                text: \"ΓÜá∩╕Å **\" + (isConfigError ? \"Service Update\" : \"Error\") + \"**: \" + errorMsg,\r\n                sender: 'ai',\r\n                isError: true\r\n            }]);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"ttr-ai-container\">\r\n\r\n            {/* 1. TOP CONTROL BAR */}\r\n            <div style={{ padding: '10px 15px', display: 'flex', justifyContent: 'flex-end', background: 'var(--bg-surface)', borderBottom: '1px solid var(--divider)' }}>\r\n                <button\r\n                    onClick={() => setShowSidebar(true)}\r\n                    style={{\r\n                        background: '#333', color: 'white', border: 'none',\r\n                        borderRadius: '4px', padding: '4px 8px', fontSize: '10px', cursor: 'pointer'\r\n                    }}\r\n                >\r\n                    ≡ƒô£ History\r\n                </button>\r\n            </div>\r\n\r\n            {/* 2. MAIN CHAT AREA */}\r\n            <div className=\"chat-area\">\r\n                {messages.length === 0 && (\r\n                    <div style={{ textAlign: 'center', color: '#b2bec3', marginTop: '50px' }}>\r\n                        <div style={{ fontSize: '40px', marginBottom: '10px' }}>≡ƒñû</div>\r\n                        <p>I am TTR AI, your personal academic assistant.</p>\r\n                        <p style={{ fontSize: '13px' }}>How can I help you today?</p>\r\n                    </div>\r\n                )}\r\n\r\n                {messages.map((msg, idx) => (\r\n                    <div key={idx} className={`message-bubble ${msg.sender === 'user' ? 'message-user' : 'message-ai'}`}>\r\n                        {msg.image && <img src={msg.image} alt=\"User Upload\" style={{ maxWidth: '100%', borderRadius: '8px', marginBottom: '10px' }} />}\r\n                        <div className=\"markdown-content\">\r\n                            {msg.sender === 'ai' && idx === messages.length - 1 && !msg.isError ? (\r\n                                <TypewriterMessage text={msg.text} />\r\n                            ) : (\r\n                                <ReactMarkdown>{msg.text}</ReactMarkdown>\r\n                            )}\r\n                        </div>\r\n                        {msg.sender === 'ai' && (\r\n                            <button onClick={() => speak(msg.text)} className=\"speak-button\">\r\n                                {speakingText === msg.text ? '≡ƒöç' : '≡ƒöè'}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                ))}\r\n                {loading && <div style={{ alignSelf: 'flex-start', background: 'var(--bg-surface)', padding: '10px 20px', borderRadius: '20px', color: 'var(--text-muted)' }}>AI is thinking...</div>}\r\n                <div ref={messagesEndRef} />\r\n            </div>\r\n\r\n            {/* 3. INPUT AREA */}\r\n            <div className=\"input-area\">\r\n                {selectedImage && (\r\n                    <div className=\"image-preview-container\">\r\n                        <img src={selectedImage} alt=\"Preview\" className=\"image-preview\" />\r\n                        <button onClick={() => setSelectedImage(null)} className=\"remove-image-button\">Γ£ò</button>\r\n                    </div>\r\n                )}\r\n                <div className=\"input-controls\">\r\n                    <div style={{\r\n                        position: 'absolute', top: '-18px', right: '20px',\r\n                        fontSize: '9px', color: '#138808', fontWeight: 'bold',\r\n                        display: 'flex', alignItems: 'center', gap: '3px', opacity: 0.7\r\n                    }}>\r\n                        <span style={{ width: '5px', height: '5px', borderRadius: '50%', background: '#138808', display: 'inline-block' }}></span>\r\n                        TTR Core\r\n                    </div>\r\n                    <button className=\"icon-button\" onClick={handleCameraClick} title=\"Upload\">≡ƒô╖</button>\r\n                    <input type=\"file\" accept=\"image/*\" ref={fileInputRef} onChange={handleImageChange} style={{ display: 'none' }} />\r\n                    <button onClick={() => listen((val) => setInput(prev => prev + ' ' + val))} className={`voice-button ${isListening ? 'listening' : ''}`} title=\"Voice\">\r\n                        {isListening ? '≡ƒ¢æ' : '≡ƒÄÖ∩╕Å'}\r\n                    </button>\r\n                    <input\r\n                        type=\"text\"\r\n                        value={input}\r\n                        onChange={(e) => setInput(e.target.value)}\r\n                        onKeyPress={(e) => e.key === 'Enter' && handleSend()}\r\n                        placeholder={selectedImage ? \"Add topic...\" : \"Ask TTR AI anything...\"}\r\n                        className=\"chat-input\"\r\n                        autoComplete=\"off\"\r\n                        spellCheck=\"false\"\r\n                        autoCorrect=\"off\"\r\n                        autoCapitalize=\"none\"\r\n                    />\r\n                    <button onClick={handleSend} disabled={loading} className=\"send-button\">Γ₧ñ</button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 4. SIDEBAR OVERLAY (History) */}\r\n            {showSidebar && (\r\n                <div className=\"sidebar-overlay\">\r\n                    <div className=\"sidebar-backdrop\" onClick={() => setShowSidebar(false)} />\r\n                    <div className=\"sidebar-content\">\r\n                        <h2>History</h2>\r\n                        <button onClick={startNewChat} className=\"btn\" style={{ width: '100%', marginBottom: '15px', background: '#333' }}>+ New AI Chat</button>\r\n\r\n                        <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                            {sessions.length === 0 && <p style={{ color: '#666', fontStyle: 'italic' }}>No chat history yet.</p>}\r\n                            {sessions.map(s => (\r\n                                <div key={s.id} onClick={() => { setCurrentSessionId(s.id); setShowSidebar(false); }}\r\n                                    style={{\r\n                                        padding: '10px',\r\n                                        background: currentSessionId === s.id ? '#e3f2fd' : '#f5f5f5',\r\n                                        borderRadius: '8px', cursor: 'pointer', fontSize: '14px', borderLeft: '4px solid var(--primary)'\r\n                                    }}>\r\n                                    <div style={{ fontWeight: 'bold' }}>{s.title || \"Untitled Chat\"}</div>\r\n                                    <div style={{ fontSize: '10px', color: '#999', marginTop: '4px' }}>\r\n                                        {s.updatedAt?.toDate ? s.updatedAt.toDate().toLocaleDateString() : 'Just now'}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* 5. API KEY ERROR MODAL */}\r\n            {messages.some(m => m.isError && (m.text.includes(\"API Key Missing\") || m.text.includes(\"System Configuration Error\"))) && (\r\n                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.8)', zIndex: 4000, display: 'flex', alignItems: 'center', justifyContent: 'center', flexDirection: 'column' }}>\r\n                    <div style={{ background: 'white', padding: '30px', borderRadius: '15px', maxWidth: '400px', textAlign: 'center', border: '2px solid red' }}>\r\n                        <h2 style={{ color: 'red' }}>ΓÜá∩╕Å AI Service Maintenance</h2>\r\n                        <p style={{ fontSize: '14px', marginBottom: '15px' }}>The AI Brain is updating its credentials.</p>\r\n                        <button onClick={() => setMessages(prev => prev.filter(m => !m.isError))} className=\"btn\" style={{ background: '#333' }}>Close</button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Teacher.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\Timetable.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[100,108],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'oldTeacherId' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":582,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":582,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"oldTeacherId"},"fix":{"range":[23677,23721],"text":""},"desc":"Remove unused variable 'oldTeacherId'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'cleanedMembers' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":589,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":589,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"cleanedMembers"},"fix":{"range":[24092,24494],"text":""},"desc":"Remove unused variable 'cleanedMembers'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'subject' is defined but never used.","line":681,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":681,"endColumn":94,"suggestions":[{"messageId":"removeVar","data":{"varName":"subject"},"fix":{"range":[28279,28286],"text":""},"desc":"Remove unused variable 'subject'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'periodsPerSubject' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":715,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":715,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"periodsPerSubject"},"fix":{"range":[30152,30235],"text":""},"desc":"Remove unused variable 'periodsPerSubject'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../firebase';\r\nimport { doc, getDoc, setDoc, query, collection, where, getDocs, addDoc } from 'firebase/firestore';\r\nimport { useUser } from '../context/UserContext';\r\nimport AIBadge from '../components/AIBadge';\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport TimetableAIModal from './TimetableAIModal';\r\n\r\nconst defaultPeriodConfig = [\r\n    { id: 'p1', name: '1', type: 'class' },\r\n    { id: 'p2', name: '2', type: 'class' },\r\n    { id: 'p3', name: '3', type: 'class' },\r\n    { id: 'break1', name: 'Lunch', type: 'break' },\r\n    { id: 'p4', name: '4', type: 'class' },\r\n    { id: 'p5', name: '5', type: 'class' },\r\n    { id: 'p6', name: '6', type: 'class' },\r\n    { id: 'p7', name: '7', type: 'class' },\r\n    { id: 'p8', name: '8', type: 'class' }\r\n];\r\n\r\nexport default function Timetable() {\r\n    const { userData } = useUser();\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Selection State\r\n    const [selectedClass, setSelectedClass] = useState(userData?.class || userData?.assignedClass || '10');\r\n    const [selectedSection, setSelectedSection] = useState(userData?.section || userData?.assignedSection || 'A');\r\n\r\n    // Data State\r\n    const [timetable, setTimetable] = useState({});\r\n    const [periodConfig, setPeriodConfig] = useState(defaultPeriodConfig);\r\n\r\n    const [allottedTeachers, setAllottedTeachers] = useState([]);\r\n\r\n    // Modes\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [structureMode, setStructureMode] = useState(false);\r\n    const [viewMode, setViewMode] = useState('class'); // 'class' or 'personal' (for teachers)\r\n    const [mySchedule, setMySchedule] = useState({});\r\n    const [allotmentCount, setAllotmentCount] = useState(0); // Restore\r\n    const [overviewData, setOverviewData] = useState([]);\r\n\r\n    // AI Generator Configuration Modal State\r\n    const [showAIModal, setShowAIModal] = useState(false);\r\n    const [aiConfig, setAiConfig] = useState({\r\n        subjects: [],\r\n        teacherAssignments: {}, // { subject: teacherId }\r\n        periodsPerDay: 7,\r\n        lunchBreakAfterPeriod: 3\r\n    });\r\n    const [availableTeachers, setAvailableTeachers] = useState([]);\r\n\r\n\r\n    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; // Restore\r\n\r\n    useEffect(() => {\r\n        if (userData?.role === 'student') {\r\n            if (userData.class) setSelectedClass(userData.class);\r\n            if (userData.section) setSelectedSection(userData.section);\r\n            fetchTimetable();\r\n        } else if (userData?.role === 'teacher') {\r\n            if (viewMode === 'personal') {\r\n                setPeriodConfig(defaultPeriodConfig);\r\n                fetchMyTimetable();\r\n            } else {\r\n                fetchTimetable();\r\n                fetchAllotments();\r\n            }\r\n        } else {\r\n            // Institution\r\n            if (viewMode === 'overview') {\r\n                fetchAllTimetables();\r\n            } else {\r\n                fetchTimetable();\r\n                fetchAllotments();\r\n            }\r\n        }\r\n    }, [selectedClass, selectedSection, userData, viewMode]);\r\n\r\n    // Helper ID - MUST be declared before useEffect that uses it\r\n    const instId = userData?.role === 'institution' ? userData.uid : userData?.institutionId;\r\n\r\n    // Fetch available teachers for AI modal\r\n    useEffect(() => {\r\n        if (userData?.role === 'institution' && instId) {\r\n            fetchAvailableTeachers();\r\n        }\r\n    }, [userData, instId]);\r\n\r\n    if (!userData) return <div className=\"p-4 text-center\">Loading User Data...</div>;\r\n\r\n    const fetchAllTimetables = async () => {\r\n        if (!instId) return; // Guard against crash\r\n        setLoading(true);\r\n        try {\r\n            // Query 1: New Schema (institutionId)\r\n            const q1 = query(collection(db, \"timetables\"), where(\"institutionId\", \"==\", instId));\r\n\r\n            // Query 2: Legacy Schema (createdBy)\r\n            const q2 = query(collection(db, \"timetables\"), where(\"createdBy\", \"==\", instId));\r\n\r\n            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);\r\n\r\n            // Merge & Dedupe\r\n            const map = new Map();\r\n            snap1.docs.forEach(d => map.set(d.id, { id: d.id, ...d.data() }));\r\n            snap2.docs.forEach(d => {\r\n                if (!map.has(d.id)) map.set(d.id, { id: d.id, ...d.data() });\r\n            });\r\n\r\n            const list = Array.from(map.values());\r\n\r\n            // Sort: Nursery->LKG..->1->10\r\n            const classOrder = ['Nursery', 'LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];\r\n            list.sort((a, b) => {\r\n                const idxA = classOrder.indexOf(a.class || '');\r\n                const idxB = classOrder.indexOf(b.class || '');\r\n                if (idxA !== -1 && idxB !== -1) return idxA - idxB;\r\n                return (a.class || '').localeCompare(b.class || '');\r\n            });\r\n\r\n            setOverviewData(list);\r\n        } catch (e) { console.error(e); }\r\n        finally { setLoading(false); }\r\n    };\r\n\r\n    const fetchMyTimetable = async () => {\r\n        setLoading(true);\r\n\r\n        try {\r\n            // 1. Robust Allotment Fetching\r\n            let allotments = [];\r\n\r\n            // Query 1: userId (Standard)\r\n            let q = query(collection(db, \"teacher_allotments\"), where(\"userId\", \"==\", userData.uid));\r\n            let snap = await getDocs(q);\r\n            const r1 = snap.docs.map(d => d.data());\r\n\r\n            allotments = [...allotments, ...r1];\r\n\r\n            // FIX: ID should be \"INST_ID_10_A\". \r\n            // For now, let's keep logic but filter the DOC results.\r\n\r\n            if (allotments.length === 0) {\r\n                // Try legacy name match logic or return...\r\n            }\r\n\r\n            // ... [Rest of allotment fetching logic] ...\r\n\r\n            setAllotmentCount(allotments.length);\r\n            if (allotments.length === 0) {\r\n                setMySchedule({});\r\n                setLoading(false);\r\n                return;\r\n            }\r\n\r\n            // 2. Fetch Timetables from Targets\r\n            const scheduleMap = {};\r\n            days.forEach(d => scheduleMap[d] = {});\r\n\r\n            // Group allotments by class/section\r\n            const targets = [];\r\n            allotments.forEach(a => {\r\n                if (a.classAssigned && a.section) {\r\n                    const raw = String(a.classAssigned);\r\n                    const cls = raw.replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n                    const sec = String(a.section).trim();\r\n                    targets.push({ cls, sec, raw, subject: a.subject });\r\n                }\r\n            });\r\n            const uniqueTargets = [...new Set(targets.map(t => `${t.cls}_${t.sec}`))];\r\n\r\n            // Query Logic\r\n            const promises = uniqueTargets.map(async (key) => {\r\n                const [cls, sec] = key.split('_');\r\n                // Query by InstID + Section strictly first\r\n                const qT = query(collection(db, \"timetables\"), where(\"institutionId\", \"==\", instId), where(\"section\", \"==\", sec));\r\n                const snapT = await getDocs(qT);\r\n\r\n                // Client-side filter for Class (handling 10 vs 10th)\r\n                const doc = snapT.docs.find(d => {\r\n                    const dCls = String(d.data().class).replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n                    return dCls === cls;\r\n                });\r\n                return doc;\r\n            });\r\n\r\n            const results = await Promise.all(promises);\r\n\r\n            let configSet = false;\r\n\r\n            // 3. Merge Logic\r\n            results.forEach(docSnap => {\r\n                if (!docSnap || !docSnap.exists()) return;\r\n                const data = docSnap.data();\r\n\r\n                // Set the Period Interval Config from the first valid timetable found\r\n                // This ensures the columns match the data keys (p1 vs period_1 etc)\r\n                if (!configSet && data.periods) {\r\n                    setPeriodConfig(data.periods);\r\n                    configSet = true;\r\n                }\r\n\r\n                const tSchedule = data.schedule || {};\r\n                const tClass = data.class;\r\n                const tSection = data.section;\r\n\r\n                days.forEach(day => {\r\n                    if (!tSchedule[day]) return;\r\n                    Object.keys(tSchedule[day]).forEach(pId => {\r\n                        const cell = tSchedule[day][pId];\r\n                        const val = typeof cell === 'object' ? (cell.subject || '') : cell;\r\n\r\n                        // MATCH LOGIC: Check Subject OR Name\r\n                        const mySubject = (userData.subject || '').toLowerCase().trim();\r\n                        const myName = (userData.name || '').toLowerCase().trim();\r\n                        const cellText = String(val).toLowerCase().trim();\r\n\r\n                        const subjectFound = mySubject && cellText.includes(mySubject);\r\n                        const nameFound = myName && cellText.includes(myName);\r\n                        // Check for any grouping symbols that imply a specific person is assigned\r\n                        const hasParentheses = /[(){}[\\]]/.test(cellText);\r\n\r\n                        // Strict Filter Logic\r\n                        let isMySlot = false;\r\n                        if (nameFound) {\r\n                            isMySlot = true; // Name matched explicitly -> Definitely Me\r\n                        } else if (subjectFound) {\r\n                            // Subject matched, but Name did not match. \r\n                            // If there are parentheses '(', it likely implies another teacher's name is there (e.g., \"Maths (Alice)\")\r\n                            // Since nameFound is false, that name is NOT me. So ignore it.\r\n                            if (hasParentheses) {\r\n                                isMySlot = false;\r\n                            } else {\r\n                                isMySlot = true; // \"Maths\" or \"Maths II\" -> Likely Me\r\n                            }\r\n                        }\r\n\r\n                        if (isMySlot) {\r\n                            // Found a slot!\r\n                            scheduleMap[day][pId] = {\r\n                                subject: `${val} (${tClass}-${tSection})`,\r\n                                span: cell.span || 1\r\n                            };\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n\r\n            setMySchedule(scheduleMap);\r\n        } catch (e) {\r\n            console.error(e);\r\n            setMySchedule({});\r\n        }\r\n        setLoading(false);\r\n    };\r\n\r\n    const fetchTimetable = async () => {\r\n        if (!instId) return;\r\n        setLoading(true);\r\n        try {\r\n            // Normalize class: \"10th\" -> \"10\", \"1st\" -> \"1\"\r\n            const rawCls = selectedClass || '';\r\n            const normalizedCls = rawCls.replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n\r\n            // Normalize: Trim inputs\r\n            const safeSec = (selectedSection || '').trim();\r\n\r\n            const q1 = query(\r\n                collection(db, \"timetables\"),\r\n                where(\"institutionId\", \"==\", instId),\r\n                where(\"class\", \"in\", [rawCls, normalizedCls]),\r\n                where(\"section\", \"==\", safeSec)\r\n            );\r\n\r\n            // Legacy Query\r\n            const q2 = query(\r\n                collection(db, \"timetables\"),\r\n                where(\"createdBy\", \"==\", instId),\r\n                where(\"class\", \"in\", [rawCls, normalizedCls]),\r\n                where(\"section\", \"==\", safeSec)\r\n            );\r\n\r\n            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);\r\n\r\n            // Prioritize Q1, fall back to Q2\r\n            let data = null;\r\n            if (!snap1.empty) data = snap1.docs[0].data();\r\n            else if (!snap2.empty) data = snap2.docs[0].data();\r\n\r\n            if (data) {\r\n                setTimetable(data.schedule || {});\r\n                if (data.periods) setPeriodConfig(data.periods);\r\n                else setPeriodConfig(defaultPeriodConfig);\r\n            } else {\r\n                setTimetable({});\r\n                setPeriodConfig(defaultPeriodConfig);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error fetching timetable:\", e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // ... (rest) ...\r\n\r\n    const saveTimetable = async () => {\r\n        if (userData?.role !== 'institution') return;\r\n        setLoading(true);\r\n        try {\r\n            // Use a composite ID that includes ID to prevent collisions?\r\n            // Existing data uses \"10_A\". If we change this, we break old data links.\r\n            // BUT we must fix it. \r\n            // Proposal: User \"INST_ID_10_A\" as Doc ID.\r\n\r\n            const cleanClass = (selectedClass || '').trim();\r\n            const cleanSection = (selectedSection || '').trim();\r\n            const docId = `${userData.uid}_${cleanClass}_${cleanSection}`;\r\n\r\n            await setDoc(doc(db, \"timetables\", docId), {\r\n                class: cleanClass,\r\n                section: cleanSection,\r\n                schedule: JSON.parse(JSON.stringify(timetable)),\r\n                periods: JSON.parse(JSON.stringify(periodConfig)),\r\n                updatedBy: userData.uid,\r\n                institutionId: userData.uid, // CRITICAL\r\n                updatedAt: new Date()\r\n            });\r\n\r\n            // Clean up old insecure doc if exists? (Optional)\r\n\r\n            alert(\"Timetable & Structure Saved! Γ£à\");\r\n            setIsEditing(false);\r\n            setStructureMode(false);\r\n        } catch (e) {\r\n            console.error(\"Error saving:\", e);\r\n            alert(\"Failed to save.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const isInstitution = userData?.role === 'institution';\r\n\r\n    const updateSubject = async () => {\r\n        const newSub = prompt(\"Enter your main Subject (e.g. Maths, Science):\");\r\n        if (!newSub) return;\r\n        try {\r\n            await setDoc(doc(db, \"teachers\", userData.uid), { subject: newSub }, { merge: true });\r\n            alert(\"Subject Updated! Period matching will retry on reload.\");\r\n            window.location.reload();\r\n        } catch (e) {\r\n            console.error(\"Error updating subject:\", e);\r\n            alert(\"Failed to update subject.\");\r\n        }\r\n    };\r\n\r\n\r\n    // Zoom State\r\n    const [zoom, setZoom] = useState(1);\r\n    const tableContainerRef = React.useRef(null);\r\n\r\n    // Auto-Fit on Load (Mobile)\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            // Only auto-scale if we haven't manually zoomed? \r\n            // Or just set initial zoom.\r\n            const w = window.innerWidth;\r\n            if (w < 800) {\r\n                // Fit 900px table into 'w'\r\n                const scale = (w - 40) / 900;\r\n                setZoom(scale);\r\n            } else {\r\n                setZoom(1);\r\n            }\r\n        };\r\n\r\n        handleResize();\r\n        // window.addEventListener('resize', handleResize); // Optional: dynamic resize\r\n        // return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n    // --- State Handler Functions (Fixing Reference Errors) ---\r\n\r\n    // 1. Fetch Teacher Allotments (for Suggestions)\r\n    const fetchAllotments = async () => {\r\n        if (!instId) return;\r\n        try {\r\n            // New Schema\r\n            const q1 = query(collection(db, \"teacher_allotments\"), where(\"institutionId\", \"==\", instId));\r\n            const snap1 = await getDocs(q1);\r\n\r\n            // Legacy\r\n            const q2 = query(collection(db, \"teacher_allotments\"), where(\"createdBy\", \"==\", instId));\r\n            const snap2 = await getDocs(q2);\r\n\r\n            // Merge\r\n            const unique = new Set();\r\n            const process = (docs) => {\r\n                docs.forEach(d => {\r\n                    const data = d.data();\r\n                    const label = `${data.subject || 'General'} (${data.name || data.teacherName})`;\r\n                    unique.add(label);\r\n                    // Also just Name?\r\n                    if (data.name) unique.add(data.name);\r\n                });\r\n            };\r\n            process(snap1.docs);\r\n            process(snap2.docs);\r\n\r\n            setAllottedTeachers(Array.from(unique));\r\n        } catch (e) { console.error(e); }\r\n    };\r\n\r\n    // 2. Period Config Handlers\r\n    const updatePeriod = (index, field, value) => {\r\n        const newConfig = [...periodConfig];\r\n        newConfig[index] = { ...newConfig[index], [field]: value };\r\n        setPeriodConfig(newConfig);\r\n    };\r\n\r\n    const movePeriod = (index, direction) => {\r\n        if (index + direction < 0 || index + direction >= periodConfig.length) return;\r\n        const newConfig = [...periodConfig];\r\n        const temp = newConfig[index];\r\n        newConfig[index] = newConfig[index + direction];\r\n        newConfig[index + direction] = temp;\r\n        setPeriodConfig(newConfig);\r\n    };\r\n\r\n    const removePeriod = (index) => {\r\n        if (!window.confirm(\"Delete this period column? Data will be lost.\")) return;\r\n        const newConfig = periodConfig.filter((_, i) => i !== index);\r\n        setPeriodConfig(newConfig);\r\n    };\r\n\r\n    const addPeriod = () => {\r\n        const newId = `p_custom_${Date.now()}`;\r\n        setPeriodConfig([...periodConfig, { id: newId, name: 'New Period', type: 'class' }]);\r\n    };\r\n\r\n    // 3. Timetable Cell Handler\r\n    const handleCellChange = (day, pId, field, value) => {\r\n        setTimetable(prev => {\r\n            const daySchedule = prev[day] || {};\r\n            const cell = daySchedule[pId] || {};\r\n\r\n            // If field is 'subject' (the text value) or 'span'\r\n            // We store objects now: { subject: \"Maths\", span: 1 }\r\n            // Legacy might be string. We convert to object.\r\n\r\n            const newCell = typeof cell === 'object' ? { ...cell } : { subject: cell, span: 1 };\r\n\r\n            if (field === 'subject') newCell.subject = value;\r\n            else if (field === 'span') newCell.span = value;\r\n\r\n            return {\r\n                ...prev,\r\n                [day]: {\r\n                    ...daySchedule,\r\n                    [pId]: newCell\r\n                }\r\n            };\r\n        });\r\n    };\r\n\r\n    // Fetch Available Teachers for AI Modal\r\n    const fetchAvailableTeachers = async () => {\r\n        if (!instId) return;\r\n        try {\r\n            const q1 = query(collection(db, \"teacher_allotments\"), where(\"institutionId\", \"==\", instId));\r\n            const q2 = query(collection(db, \"teacher_allotments\"), where(\"createdBy\", \"==\", instId));\r\n\r\n            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);\r\n\r\n            const teacherMap = new Map();\r\n            const process = (docs) => {\r\n                docs.forEach(d => {\r\n                    const data = d.data();\r\n                    const teacherId = data.teacherId || data.userId;\r\n                    if (teacherId && !teacherMap.has(teacherId)) {\r\n                        teacherMap.set(teacherId, {\r\n                            id: teacherId,\r\n                            name: data.teacherName || data.name || 'Unknown',\r\n                            subject: data.subject || 'General'\r\n                        });\r\n                    }\r\n                });\r\n            };\r\n\r\n            process(snap1.docs);\r\n            process(snap2.docs);\r\n\r\n            setAvailableTeachers(Array.from(teacherMap.values()));\r\n        } catch (e) {\r\n            console.error('Error fetching teachers:', e);\r\n        }\r\n    };\r\n\r\n    // Create Subject-Specific Groups\r\n    const createSubjectGroups = async (timetableData) => {\r\n        if (!instId) return;\r\n\r\n        try {\r\n            // Extract unique subject-teacher pairs from timetable\r\n            const subjectTeacherPairs = new Map(); // { subject: teacherId }\r\n\r\n            Object.values(timetableData).forEach(daySchedule => {\r\n                Object.values(daySchedule).forEach(cell => {\r\n                    if (cell.subject && !cell.subject.includes('Break') && !cell.subject.includes('Conflict')) {\r\n                        // Extract subject and teacher name\r\n                        const match = cell.subject.match(/^(.+?)\\s*\\(([^)]+)\\)$/);\r\n                        if (match) {\r\n                            const subject = match[1].trim();\r\n                            const teacherName = match[2].trim();\r\n\r\n                            // Find teacher ID\r\n                            const teacher = availableTeachers.find(t => t.name === teacherName);\r\n                            if (teacher && !subjectTeacherPairs.has(subject)) {\r\n                                subjectTeacherPairs.set(subject, teacher.id);\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n            // Fetch all students from this class\r\n            const studentsRef = collection(db, 'users');\r\n            const studentsQuery = query(\r\n                studentsRef,\r\n                where('role', '==', 'student'),\r\n                where('institutionId', '==', instId),\r\n                where('class', '==', selectedClass),\r\n                where('section', '==', selectedSection)\r\n            );\r\n            const studentsSnapshot = await getDocs(studentsQuery);\r\n            const studentIds = studentsSnapshot.docs.map(doc => doc.id);\r\n\r\n            // Create or update a group for each subject\r\n            for (const [subject, teacherId] of subjectTeacherPairs) {\r\n                const groupName = `${subject} (${selectedClass}-${selectedSection})`;\r\n\r\n                // Check if group already exists\r\n                const groupsRef = collection(db, 'groups');\r\n                const existingGroupQuery = query(\r\n                    groupsRef,\r\n                    where('name', '==', groupName),\r\n                    where('institutionId', '==', instId)\r\n                );\r\n                const existingSnapshot = await getDocs(existingGroupQuery);\r\n\r\n                if (existingSnapshot.empty) {\r\n                    // Create new group\r\n                    const groupMembers = [\r\n                        instId,           // Institution\r\n                        teacherId,        // Subject teacher\r\n                        ...studentIds     // All students from this class\r\n                    ].filter(Boolean);  // Remove any undefined values\r\n\r\n                    const newGroup = {\r\n                        name: groupName,\r\n                        description: `${subject} class group for ${selectedClass}-${selectedSection}`,\r\n                        institutionId: instId,\r\n                        createdBy: instId,\r\n                        members: groupMembers,\r\n                        class: selectedClass,\r\n                        section: selectedSection,\r\n                        subject: subject,\r\n                        teacherId: teacherId,\r\n                        createdAt: new Date().toISOString(),\r\n                        updatedAt: new Date().toISOString(),\r\n                        type: 'subject-class' // Mark as auto-created subject group\r\n                    };\r\n\r\n                    await addDoc(groupsRef, newGroup);\r\n                    console.log(`Created group: ${groupName}`);\r\n                } else {\r\n                    // Update existing group with new teacher\r\n                    const existingGroup = existingSnapshot.docs[0];\r\n                    const existingData = existingGroup.data();\r\n                    const oldTeacherId = existingData.teacherId;\r\n\r\n                    // Start with fresh members list\r\n                    let updatedMembers = existingData.members || [];\r\n\r\n                    // IMPORTANT: Remove ALL teachers first (to clean up any old groups with multiple teachers)\r\n                    // We'll identify teachers by checking if they're NOT students and NOT the institution\r\n                    const cleanedMembers = updatedMembers.filter(memberId => {\r\n                        // Keep institution\r\n                        if (memberId === instId) return true;\r\n                        // Keep students\r\n                        if (studentIds.includes(memberId)) return true;\r\n                        // Remove all others (teachers)\r\n                        return false;\r\n                    });\r\n\r\n                    // Now add ONLY the correct subject teacher\r\n                    updatedMembers = [\r\n                        instId,           // Institution\r\n                        teacherId,        // ONLY this subject's teacher\r\n                        ...studentIds     // All students\r\n                    ].filter(Boolean);\r\n\r\n                    // Update the group\r\n                    const groupDocRef = doc(db, 'groups', existingGroup.id);\r\n                    await setDoc(groupDocRef, {\r\n                        ...existingData,\r\n                        members: updatedMembers,\r\n                        teacherId: teacherId,\r\n                        updatedAt: new Date().toISOString()\r\n                    }, { merge: true });\r\n\r\n                    console.log(`Updated group: ${groupName} (cleaned up, only ${teacherId} teacher)`);\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error('Error creating subject groups:', e);\r\n            // Don't fail the timetable generation if group creation fails\r\n        }\r\n    };\r\n\r\n\r\n    // 4. AI Timetable Generator (Enhanced with Cross-Class Conflict Detection)\r\n    const generateAITimetable = async () => {\r\n        // Validate configuration\r\n        if (aiConfig.subjects.length === 0) {\r\n            alert('Please select at least one subject!');\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n\r\n        try {\r\n            // STEP 1: Fetch ALL existing timetables to check teacher availability\r\n            const allExistingTimetables = {};\r\n\r\n            if (instId) {\r\n                const timetablesRef = collection(db, 'timetables');\r\n                const q = query(timetablesRef, where('institutionId', '==', instId));\r\n                const snapshot = await getDocs(q);\r\n\r\n                snapshot.forEach(doc => {\r\n                    const data = doc.data();\r\n                    // Store timetables by class-section key\r\n                    const key = `${data.class}-${data.section}`;\r\n                    allExistingTimetables[key] = data.schedule || {};\r\n                });\r\n            }\r\n\r\n            // STEP 2: Build teacher schedule from ALL existing timetables\r\n            const teacherSchedule = {}; // { teacherId: { day: [periodIds] } }\r\n\r\n            // Initialize teacher schedule for all assigned teachers\r\n            Object.values(aiConfig.teacherAssignments).forEach(teacherId => {\r\n                if (teacherId) {\r\n                    teacherSchedule[teacherId] = {};\r\n                    days.forEach(day => {\r\n                        teacherSchedule[teacherId][day] = [];\r\n                    });\r\n                }\r\n            });\r\n\r\n            // STEP 3: Populate teacher schedule from existing timetables\r\n            Object.entries(allExistingTimetables).forEach(([classKey, schedule]) => {\r\n                // Skip the current class we're generating for\r\n                const currentKey = `${selectedClass}-${selectedSection}`;\r\n                if (classKey === currentKey) return;\r\n\r\n                // Parse each day and period\r\n                Object.entries(schedule).forEach(([day, periods]) => {\r\n                    Object.entries(periods).forEach(([periodId, cell]) => {\r\n                        if (cell && cell.subject) {\r\n                            // Extract teacher ID or name from the cell\r\n                            // Format: \"Subject (TeacherName)\" or just \"Subject\"\r\n                            const match = cell.subject.match(/\\(([^)]+)\\)/);\r\n                            if (match) {\r\n                                const teacherNameInCell = match[1];\r\n\r\n                                // Find matching teacher ID\r\n                                Object.entries(aiConfig.teacherAssignments).forEach(([subject, teacherId]) => {\r\n                                    if (teacherId) {\r\n                                        const teacher = availableTeachers.find(t => t.id === teacherId);\r\n                                        if (teacher && teacher.name === teacherNameInCell) {\r\n                                            // Mark this teacher as busy at this time\r\n                                            if (teacherSchedule[teacherId] && teacherSchedule[teacherId][day]) {\r\n                                                if (!teacherSchedule[teacherId][day].includes(periodId)) {\r\n                                                    teacherSchedule[teacherId][day].push(periodId);\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                });\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n\r\n            // STEP 4: Create new period configuration based on user input\r\n            const newPeriodConfig = [];\r\n            for (let i = 0; i < aiConfig.periodsPerDay; i++) {\r\n                if (i === aiConfig.lunchBreakAfterPeriod) {\r\n                    newPeriodConfig.push({ id: `break_lunch`, name: 'Lunch Break', type: 'break' });\r\n                }\r\n                newPeriodConfig.push({ id: `p${i + 1}`, name: `Period ${i + 1}`, type: 'class' });\r\n            }\r\n            setPeriodConfig(newPeriodConfig);\r\n\r\n            // STEP 5: Intelligent Scheduling with Constraint Satisfaction\r\n            const newTimetable = {};\r\n\r\n            // Calculate how many periods each subject needs across the week\r\n            const totalClassPeriods = newPeriodConfig.filter(p => p.type === 'class').length * days.length;\r\n            const periodsPerSubject = Math.floor(totalClassPeriods / aiConfig.subjects.length);\r\n\r\n            // Track subject usage to ensure even distribution\r\n            const subjectUsageCount = {};\r\n            aiConfig.subjects.forEach(subject => {\r\n                subjectUsageCount[subject] = 0;\r\n            });\r\n\r\n            days.forEach(day => {\r\n                newTimetable[day] = {};\r\n\r\n                newPeriodConfig.forEach((period, periodIdx) => {\r\n                    // Skip break periods\r\n                    if (period.type === 'break') {\r\n                        newTimetable[day][period.id] = { subject: period.name, span: 1 };\r\n                        return;\r\n                    }\r\n\r\n                    // SMART ALGORITHM: Find best subject-teacher combination for this slot\r\n                    let bestMatch = null;\r\n                    let attemptedSubjects = [];\r\n\r\n                    // Sort subjects by usage (least used first) for even distribution\r\n                    const sortedSubjects = [...aiConfig.subjects].sort((a, b) =>\r\n                        subjectUsageCount[a] - subjectUsageCount[b]\r\n                    );\r\n\r\n                    for (const subject of sortedSubjects) {\r\n                        // Skip if we've tried this subject already\r\n                        if (attemptedSubjects.includes(subject)) continue;\r\n                        attemptedSubjects.push(subject);\r\n\r\n                        // Check if this subject was used in previous period (avoid consecutive)\r\n                        const prevPeriods = newPeriodConfig.slice(0, periodIdx).filter(p => p.type !== 'break');\r\n                        let isConsecutive = false;\r\n\r\n                        if (prevPeriods.length > 0) {\r\n                            const lastPeriod = prevPeriods[prevPeriods.length - 1];\r\n                            const prevSubject = newTimetable[day][lastPeriod.id]?.subject;\r\n                            if (prevSubject && prevSubject.includes(subject)) {\r\n                                isConsecutive = true;\r\n                            }\r\n                        }\r\n\r\n                        // Skip if consecutive (unless no other option)\r\n                        if (isConsecutive && attemptedSubjects.length < aiConfig.subjects.length) {\r\n                            continue;\r\n                        }\r\n\r\n                        // Check if assigned teacher is available\r\n                        const teacherId = aiConfig.teacherAssignments[subject];\r\n                        if (teacherId) {\r\n                            const teacher = availableTeachers.find(t => t.id === teacherId);\r\n                            if (teacher) {\r\n                                const isTeacherBusy = teacherSchedule[teacherId][day].includes(period.id);\r\n\r\n                                if (!isTeacherBusy) {\r\n                                    // PERFECT MATCH: Subject needed + Teacher available\r\n                                    bestMatch = {\r\n                                        subject: subject,\r\n                                        teacher: teacher,\r\n                                        teacherId: teacherId\r\n                                    };\r\n                                    break; // Found optimal match, stop searching\r\n                                }\r\n                            }\r\n                        } else {\r\n                            // No teacher assigned, but subject can still be scheduled\r\n                            if (!bestMatch) {\r\n                                bestMatch = {\r\n                                    subject: subject,\r\n                                    teacher: null,\r\n                                    teacherId: null\r\n                                };\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Assign the best match found\r\n                    if (bestMatch) {\r\n                        let cellValue;\r\n                        if (bestMatch.teacher) {\r\n                            cellValue = `${bestMatch.subject} (${bestMatch.teacher.name})`;\r\n                            // Mark teacher as busy\r\n                            teacherSchedule[bestMatch.teacherId][day].push(period.id);\r\n                        } else {\r\n                            cellValue = bestMatch.subject;\r\n                        }\r\n\r\n                        newTimetable[day][period.id] = { subject: cellValue, span: 1 };\r\n                        subjectUsageCount[bestMatch.subject]++;\r\n                    } else {\r\n                        // Fallback: No perfect match found (rare case)\r\n                        const fallbackSubject = sortedSubjects[0];\r\n                        newTimetable[day][period.id] = { subject: fallbackSubject, span: 1 };\r\n                        subjectUsageCount[fallbackSubject]++;\r\n                    }\r\n                });\r\n            });\r\n\r\n            // Count conflicts for user feedback\r\n            let conflictCount = 0;\r\n            Object.values(newTimetable).forEach(daySchedule => {\r\n                Object.values(daySchedule).forEach(cell => {\r\n                    if (cell.subject && cell.subject.includes('ΓÜá∩╕Å Conflict')) {\r\n                        conflictCount++;\r\n                    }\r\n                });\r\n            });\r\n\r\n            setTimetable(newTimetable);\r\n            setIsEditing(true);\r\n            setShowAIModal(false);\r\n\r\n            // STEP 6: Auto-create subject-specific groups\r\n            await createSubjectGroups(newTimetable);\r\n\r\n            // Inform user about conflicts\r\n            if (conflictCount > 0) {\r\n                alert(`Γ£à Timetable generated!\\n\\nΓÜá∩╕Å Warning: ${conflictCount} period(s) have teacher conflicts (teacher is busy in another class at that time).\\n\\nPlease review and manually assign available teachers for conflicting periods.`);\r\n            } else {\r\n                alert('Γ£à AI Timetable generated successfully! No conflicts detected.\\n\\n≡ƒôÜ Subject-specific groups have been created automatically for communication.');\r\n            }\r\n        } catch (e) {\r\n            console.error('Error generating timetable:', e);\r\n            alert('Failed to generate timetable. Please try again.');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n\r\n    const finalTimetable = viewMode === 'personal' ? mySchedule : timetable;\r\n\r\n    return (\r\n        <div style={{ minHeight: '100%', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)', paddingBottom: '120px' }}>\r\n            <AIBadge />\r\n\r\n\r\n            <div className=\"container\" style={{ width: '100%', maxWidth: '1400px', margin: '0 auto', padding: '20px 10px' }}>\r\n\r\n                {/* Controls */}\r\n                <div className=\"card\" style={{ marginBottom: '20px', display: 'flex', gap: '15px', alignItems: 'center', flexWrap: 'wrap', justifyContent: 'space-between' }}>\r\n\r\n                    {/* DEBUG PANEL FOR INSTITUTION */}\r\n                    {userData?.role === 'institution' && (\r\n                        <div style={{ width: '100%', padding: '10px', background: '#fff3cd', border: '1px solid #ffeeba', color: '#856404', fontSize: '11px', marginBottom: '10px' }}>\r\n                            <strong>≡ƒöº Diagnostic Info (Visible only to you):</strong><br />\r\n                            <strong>My Inst ID:</strong> {instId} <br />\r\n                            <strong>Records Found:</strong> {overviewData.length} (Overview) / {Object.keys(timetable).length > 0 ? 'Found' : '0'} (Single)<br />\r\n                            <strong>View Mode:</strong> {viewMode} | <strong>Selected Class:</strong> {selectedClass}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* ...Existing Controls... */}\r\n                    <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>\r\n                        <h3 style={{ margin: 0, color: '#2d3436' }}>≡ƒôà Schedule</h3>\r\n\r\n                        {(userData?.role === 'teacher') && (\r\n                            <div style={{ display: 'flex', background: '#dfe6e9', borderRadius: '20px', padding: '3px', marginLeft: '15px' }}>\r\n                                <button\r\n                                    onClick={() => setViewMode('class')}\r\n                                    style={{\r\n                                        border: 'none', background: viewMode === 'class' ? '#0984e3' : 'transparent',\r\n                                        color: viewMode === 'class' ? 'white' : '#636e72', borderRadius: '18px',\r\n                                        padding: '5px 15px', cursor: 'pointer', fontWeight: 'bold'\r\n                                    }}\r\n                                >\r\n                                    Class\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => { setViewMode('personal'); setIsEditing(false); setStructureMode(false); }}\r\n                                    style={{\r\n                                        border: 'none', background: viewMode === 'personal' ? '#0984e3' : 'transparent',\r\n                                        color: viewMode === 'personal' ? 'white' : '#636e72', borderRadius: '18px',\r\n                                        padding: '5px 15px', cursor: 'pointer', fontWeight: 'bold'\r\n                                    }}\r\n                                >\r\n                                    My View\r\n                                </button>\r\n                            </div>\r\n                        )}\r\n\r\n                        {isInstitution && (\r\n                            <div style={{ display: 'flex', background: '#dfe6e9', borderRadius: '20px', padding: '3px', marginLeft: '15px' }}>\r\n                                <button\r\n                                    onClick={() => setViewMode('class')}\r\n                                    style={{\r\n                                        border: 'none', background: viewMode !== 'overview' ? '#0984e3' : 'transparent',\r\n                                        color: viewMode !== 'overview' ? 'white' : '#636e72', borderRadius: '18px',\r\n                                        padding: '5px 15px', cursor: 'pointer', fontWeight: 'bold'\r\n                                    }}\r\n                                >\r\n                                    One\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => setViewMode('overview')}\r\n                                    style={{\r\n                                        border: 'none', background: viewMode === 'overview' ? '#0984e3' : 'transparent',\r\n                                        color: viewMode === 'overview' ? 'white' : '#636e72', borderRadius: '18px',\r\n                                        padding: '5px 15px', cursor: 'pointer', fontWeight: 'bold'\r\n                                    }}\r\n                                >\r\n                                    All\r\n                                </button>\r\n                            </div>\r\n                        )}\r\n\r\n                        {(viewMode !== 'overview') && (isInstitution || (userData?.role === 'teacher' && viewMode === 'class')) && (\r\n                            <>\r\n                                <select\r\n                                    value={selectedClass}\r\n                                    onChange={(e) => setSelectedClass(e.target.value)}\r\n                                    className=\"input-field\"\r\n                                    style={{ width: 'auto', margin: 0, padding: '8px' }}\r\n                                    disabled={loading}\r\n                                >\r\n                                    {['Nursery', 'LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                                </select>\r\n                                <select\r\n                                    value={selectedSection}\r\n                                    onChange={(e) => setSelectedSection(e.target.value)}\r\n                                    className=\"input-field\"\r\n                                    style={{ width: 'auto', margin: 0, padding: '8px' }}\r\n                                    disabled={loading}\r\n                                >\r\n                                    {['A', 'B', 'C', 'D'].map(s => <option key={s} value={s}>{s}</option>)}\r\n                                </select>\r\n                            </>\r\n                        )}\r\n                        {userData?.role === 'student' && (\r\n                            <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#0984e3', whiteSpace: 'nowrap' }}>\r\n                                {selectedClass} - {selectedSection}\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Institution Controls */}\r\n                    {isInstitution && viewMode !== 'overview' && (\r\n                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>\r\n                            {!isEditing ? (\r\n                                <>\r\n                                    <button\r\n                                        onClick={() => setIsEditing(true)}\r\n                                        style={{\r\n                                            background: '#0984e3', color: 'white', border: 'none', padding: '10px 20px',\r\n                                            borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold', fontSize: '14px',\r\n                                            boxShadow: '0 4px 6px rgba(9, 132, 227, 0.2)'\r\n                                        }}\r\n                                    >\r\n                                        Γ£Å∩╕Å Edit Schedule\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => setShowAIModal(true)}\r\n                                        style={{\r\n                                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\r\n                                            color: 'white', border: 'none', padding: '10px 20px',\r\n                                            borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold', fontSize: '14px',\r\n                                            boxShadow: '0 4px 6px rgba(102, 126, 234, 0.4)'\r\n                                        }}\r\n                                    >\r\n                                        ≡ƒñû AI Generate\r\n                                    </button>\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <button\r\n                                        onClick={() => setStructureMode(!structureMode)}\r\n                                        style={{\r\n                                            background: structureMode ? '#e17055' : '#6c5ce7', color: 'white', border: 'none',\r\n                                            padding: '8px 15px', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold'\r\n                                        }}\r\n                                    >\r\n                                        {structureMode ? 'Done Structure' : 'ΓÜÖ∩╕Å Structure'}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={saveTimetable}\r\n                                        style={{\r\n                                            background: '#00b894', color: 'white', border: 'none', padding: '8px 20px',\r\n                                            borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold',\r\n                                            boxShadow: '0 4px 6px rgba(0, 184, 148, 0.2)'\r\n                                        }}\r\n                                    >\r\n                                        ≡ƒÆ╛ Save\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => { setIsEditing(false); setStructureMode(false); }}\r\n                                        style={{\r\n                                            background: '#d63031', color: 'white', border: 'none', padding: '8px 15px',\r\n                                            borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold'\r\n                                        }}\r\n                                    >\r\n                                        Cancel\r\n                                    </button>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* ZOOM CONTROLS (Floating or Inline) */}\r\n                {viewMode !== 'overview' && (\r\n                    <div style={{ textAlign: 'center', marginBottom: '10px' }}>\r\n                        <div style={{ display: 'inline-flex', alignItems: 'center', gap: '10px', background: 'white', padding: '5px 15px', borderRadius: '20px', boxShadow: '0 2px 5px rgba(0,0,0,0.1)' }}>\r\n                            <span style={{ fontSize: '12px', color: '#666' }}>≡ƒöÄ View:</span>\r\n                            <button onClick={() => setZoom(z => Math.max(0.3, z - 0.1))} style={{ cursor: 'pointer', border: 'none', background: '#f1f2f6', borderRadius: '50%', width: '25px', height: '25px' }}>-</button>\r\n                            <span style={{ fontSize: '13px', fontWeight: 'bold', minWidth: '40px' }}>{Math.round(zoom * 100)}%</span>\r\n                            <button onClick={() => setZoom(z => Math.min(2, z + 0.1))} style={{ cursor: 'pointer', border: 'none', background: '#f1f2f6', borderRadius: '50%', width: '25px', height: '25px' }}>+</button>\r\n                            <button\r\n                                onClick={() => {\r\n                                    const w = window.innerWidth;\r\n                                    setZoom(w < 800 ? (w - 40) / 900 : 1);\r\n                                }}\r\n                                style={{ marginLeft: '10px', fontSize: '12px', cursor: 'pointer', border: '1px solid #ddd', background: 'white', borderRadius: '12px', padding: '2px 8px' }}\r\n                            >\r\n                                Fit Screen\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n\r\n                {/* OVERVIEW MODE (ALL CLASSES) */}\r\n                {viewMode === 'overview' && (\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '40px' }}>\r\n                        {overviewData.length === 0 && !loading && <p className=\"text-center\">No timetables found.</p>}\r\n\r\n                        {overviewData.map((data) => {\r\n                            if (!data) return null;\r\n                            const periods = data.periods || defaultPeriodConfig;\r\n                            const schedule = data.schedule || {};\r\n                            return (\r\n                                <div key={data.id} className=\"card\">\r\n                                    <h3 style={{ borderBottom: '2px solid #eee', paddingBottom: '10px', color: '#0984e3' }}>\r\n                                        Class {data.class} - {data.section}\r\n                                    </h3>\r\n                                    <div style={{ overflowX: 'auto' }}>\r\n                                        <table style={{ width: '100%', borderCollapse: 'collapse', background: 'white', minWidth: '800px' }}>\r\n                                            <thead>\r\n                                                <tr style={{ background: '#6c5ce7', color: 'white' }}>\r\n                                                    <th style={{ padding: '10px', width: '80px' }}>Day</th>\r\n                                                    {periods.map(p => (\r\n                                                        <th key={p.id} style={{ padding: '8px', background: p.type === 'break' ? '#fdcb6e' : 'transparent', minWidth: '100px', fontSize: '13px' }}>\r\n                                                            {p.type === 'break' ? '≡ƒì╜∩╕Å' : ''} {p.name}\r\n                                                        </th>\r\n                                                    ))}\r\n                                                </tr>\r\n                                            </thead>\r\n                                            <tbody>\r\n                                                {days.map(day => (\r\n                                                    <tr key={day}>\r\n                                                        <td style={{ padding: '10px', fontWeight: 'bold', background: '#f5f6fa', fontSize: '13px' }}>{day}</td>\r\n                                                        {periods.map((p, index) => {\r\n                                                            const cellData = schedule?.[day]?.[p.id] || {};\r\n                                                            let skip = false;\r\n                                                            for (let k = 1; k <= index; k++) {\r\n                                                                const prevP = periods[index - k];\r\n                                                                const prevData = schedule?.[day]?.[prevP.id] || {};\r\n                                                                const prevSpan = parseInt(prevData.span || 1);\r\n                                                                if (prevSpan > k) { skip = true; break; }\r\n                                                            }\r\n\r\n                                                            if (skip) return null;\r\n                                                            const span = parseInt(cellData.span || 1);\r\n                                                            const val = typeof cellData === 'object' ? (cellData.subject || '') : cellData;\r\n\r\n                                                            if (p.type === 'break') {\r\n                                                                return <td key={p.id} style={{ background: '#ffeaa7' }}></td>;\r\n                                                            }\r\n\r\n                                                            return (\r\n                                                                <td key={p.id} colSpan={span} style={{ border: '1px solid #eee', padding: '10px', fontSize: '13px', textAlign: 'center' }}>\r\n                                                                    {val || '-'}\r\n                                                                </td>\r\n                                                            );\r\n                                                        })}\r\n                                                    </tr>\r\n                                                ))}\r\n                                            </tbody>\r\n                                        </table>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                )}\r\n\r\n\r\n                {/* STANDARD SINGLE VIEW Mode */}\r\n                {viewMode !== 'overview' && (\r\n                    <>\r\n                        <div\r\n                            ref={tableContainerRef}\r\n                            style={{\r\n                                width: '100%',\r\n                                overflow: 'hidden', // Hide scroll since we scale\r\n                                borderRadius: '16px',\r\n                                boxShadow: '0 10px 30px rgba(0,0,0,0.1)',\r\n                                transition: 'height 0.3s'\r\n                            }}\r\n                        >\r\n                            <div style={{\r\n                                width: '900px', // Fixed base width for calculation\r\n                                transform: `scale(${zoom})`,\r\n                                transformOrigin: 'top left',\r\n                            }}>\r\n                                <table style={{ width: '100%', borderCollapse: 'collapse', background: 'white' }}>\r\n                                    <thead>\r\n                                        <tr style={{ background: '#6c5ce7', color: 'white' }}>\r\n                                            <th style={{ padding: '15px', border: '1px solid rgba(255,255,255,0.2)', width: '100px' }}>Day</th>\r\n                                            {periodConfig.map((p, index) => (\r\n                                                <th key={p.id} style={{ padding: '10px', border: '1px solid rgba(255,255,255,0.2)', background: p.type === 'break' ? '#fdcb6e' : 'transparent', minWidth: '100px' }}>\r\n                                                    {structureMode ? (\r\n                                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '5px' }}>\r\n                                                            <input\r\n                                                                value={p.name}\r\n                                                                onChange={(e) => updatePeriod(index, 'name', e.target.value)}\r\n                                                                style={{ width: '100%', color: 'black', padding: '5px' }}\r\n                                                                placeholder=\"Name/Time\"\r\n                                                            />\r\n                                                            <select\r\n                                                                value={p.type}\r\n                                                                onChange={(e) => updatePeriod(index, 'type', e.target.value)}\r\n                                                                style={{ color: 'black', padding: '2px' }}\r\n                                                            >\r\n                                                                <option value=\"class\">Class</option>\r\n                                                                <option value=\"break\">Break</option>\r\n                                                            </select>\r\n                                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\r\n                                                                <button onClick={() => movePeriod(index, -1)} style={{ cursor: 'pointer', padding: '2px' }}>Γ¼à∩╕Å</button>\r\n                                                                <button onClick={() => removePeriod(index)} style={{ cursor: 'pointer', color: 'red', fontWeight: 'bold' }}>Γ¥î</button>\r\n                                                                <button onClick={() => movePeriod(index, 1)} style={{ cursor: 'pointer', padding: '2px' }}>Γ₧í∩╕Å</button>\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    ) : (\r\n                                                        <div>\r\n                                                            {p.type === 'break' ? '≡ƒì╜∩╕Å' : ''} {p.name}\r\n                                                        </div>\r\n                                                    )}\r\n                                                </th>\r\n                                            ))}\r\n                                            {structureMode && (\r\n                                                <th style={{ padding: '10px', background: 'rgba(0,0,0,0.1)' }}>\r\n                                                    <button onClick={addPeriod} style={{ width: '100%', height: '100%', fontSize: '20px', cursor: 'pointer', background: 'transparent', border: 'none', color: 'white' }}>Γ₧ò Add</button>\r\n                                                </th>\r\n                                            )}\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {days.map(day => (\r\n                                            <tr key={day}>\r\n                                                <td style={{ padding: '15px', fontWeight: 'bold', background: '#f0f3f7', borderBottom: '1px solid #dfe6e9' }}>{day}</td>\r\n\r\n                                                {periodConfig.map((p, index) => {\r\n                                                    // Merge Handling\r\n                                                    const cellData = finalTimetable?.[day]?.[p.id] || {};\r\n\r\n                                                    let skip = false;\r\n                                                    for (let k = 1; k <= index; k++) {\r\n                                                        const prevP = periodConfig[index - k];\r\n                                                        const prevData = finalTimetable?.[day]?.[prevP.id] || {};\r\n                                                        const prevSpan = parseInt(prevData.span || 1);\r\n                                                        if (prevSpan > k) {\r\n                                                            skip = true;\r\n                                                            break;\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    if (skip) return null;\r\n\r\n                                                    const span = parseInt(cellData.span || 1);\r\n                                                    // Handle Object (Non-Legacy) or String (Legacy)\r\n                                                    const val = typeof cellData === 'object' ? (cellData.subject || '') : cellData;\r\n\r\n                                                    if (p.type === 'break') {\r\n                                                        return (\r\n                                                            <td key={p.id} style={{ background: '#ffeaa7', textAlign: 'center', fontWeight: 'bold', border: '1px solid #dfe6e9', color: '#b7791f' }}>\r\n                                                                {p.name}\r\n                                                            </td>\r\n                                                        );\r\n                                                    }\r\n\r\n                                                    return (\r\n                                                        <td key={p.id} colSpan={span} style={{ border: '1px solid #dfe6e9', padding: '0', minWidth: '100px' }}>\r\n                                                            {isEditing && !structureMode ? (\r\n                                                                <div style={{ display: 'flex', flexDirection: 'column', height: '100%', minHeight: '80px' }}>\r\n                                                                    <input\r\n                                                                        list=\"allotted-teachers\"\r\n                                                                        value={val}\r\n                                                                        onChange={(e) => handleCellChange(day, p.id, 'subject', e.target.value)}\r\n                                                                        placeholder=\"Subject\"\r\n                                                                        style={{\r\n                                                                            width: '100%', flex: 1, border: 'none', padding: '10px',\r\n                                                                            fontSize: '14px', outline: 'none', background: 'transparent'\r\n                                                                        }}\r\n                                                                    />\r\n\r\n                                                                    {/* Merge Control */}\r\n                                                                    <div style={{ background: '#f1f2f6', padding: '2px 5px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', fontSize: '11px', color: '#636e72' }}>\r\n                                                                        <span>Span:</span>\r\n                                                                        <input\r\n                                                                            type=\"number\"\r\n                                                                            min=\"1\" max=\"8\"\r\n                                                                            value={span}\r\n                                                                            onChange={(e) => handleCellChange(day, p.id, 'span', e.target.value)}\r\n                                                                            style={{ width: '35px', border: '1px solid #ccc', borderRadius: '3px', padding: '2px' }}\r\n                                                                        />\r\n                                                                    </div>\r\n                                                                </div>\r\n                                                            ) : (\r\n                                                                <div style={{ padding: '15px', minHeight: '50px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', color: val ? '#2d3436' : '#b2bec3', whiteSpace: 'pre-wrap', textAlign: 'center' }}>\r\n                                                                    {val || '-'}\r\n                                                                </div>\r\n                                                            )}\r\n                                                        </td>\r\n                                                    );\r\n                                                })}\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {!isEditing && finalTimetable && Object.keys(finalTimetable).length === 0 && (\r\n                            <div style={{ textAlign: 'center', marginTop: '50px', color: '#636e72', background: '#fff3cd', padding: '20px', borderRadius: '10px', border: '1px solid #ffeeba' }}>\r\n                                {viewMode === 'personal' ? (\r\n                                    <>\r\n                                        <h3 style={{ color: '#856404' }}>No Periods Matched ≡ƒñ╖ΓÇìΓÖé∩╕Å</h3>\r\n                                        <p>We found <b>{allotmentCount}</b> classes allotted to you.</p>\r\n                                        <p>However, we couldn't match any specific periods.</p>\r\n                                        <div style={{ textAlign: 'left', margin: '15px auto', maxWidth: '400px', fontSize: '13px', background: 'white', padding: '15px', borderRadius: '8px' }}>\r\n                                            <b>How to Fix:</b>\r\n                                            <ul style={{ paddingLeft: '20px', marginTop: '5px' }}>\r\n                                                <li>\r\n                                                    Update Profile Subject:\r\n                                                    {!userData.subject ? (\r\n                                                        <button onClick={updateSubject} style={{ marginLeft: '10px', cursor: 'pointer', border: '1px solid #0984e3', color: '#0984e3', background: 'white', borderRadius: '4px', padding: '2px 8px' }}>\r\n                                                            Set Subject Now\r\n                                                        </button>\r\n                                                    ) : (\r\n                                                        <span> (Current: <b>{userData.subject}</b>)</span>\r\n                                                    )}\r\n                                                </li>\r\n                                                <li>Or ensure the Timetable cells contain your <b>Name</b> (e.g. \"Maths ({userData.name})\").</li>\r\n                                            </ul>\r\n                                        </div>\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <h3>No Timetable Found ≡ƒô¡</h3>\r\n                                        <p>Ask your institution to upload the schedule.</p>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </>\r\n                )}\r\n                {/* Datalist for Auto-Suggest */}\r\n                <datalist id=\"allotted-teachers\">\r\n                    {allottedTeachers.map((t, i) => <option key={i} value={t} />)}\r\n                </datalist>\r\n\r\n                {/* AI Configuration Modal */}\r\n                <TimetableAIModal\r\n                    show={showAIModal}\r\n                    onClose={() => setShowAIModal(false)}\r\n                    aiConfig={aiConfig}\r\n                    setAiConfig={setAiConfig}\r\n                    availableTeachers={availableTeachers}\r\n                    onGenerate={generateAITimetable}\r\n                />\r\n\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\TimetableAIModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\TimetableGenerator.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'setSubjects' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSubjects"},"fix":{"range":[777,790],"text":""},"desc":"Remove unused variable 'setSubjects'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'teacherLoad' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":94,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":94,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"teacherLoad"},"fix":{"range":[3424,3447],"text":""},"desc":"Remove unused variable 'teacherLoad'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useUser } from '../context/UserContext';\r\nimport { db } from '../firebase';\r\nimport { collection, addDoc, query, where, getDocs, serverTimestamp, deleteDoc, doc } from 'firebase/firestore';\r\nimport jsPDF from 'jspdf';\r\nimport 'jspdf-autotable';\r\n\r\nexport default function TimetableGenerator() {\r\n    const navigate = useNavigate();\r\n    const { userData } = useUser();\r\n\r\n    const [mode, setMode] = useState('view'); // 'view' or 'generate'\r\n    const [selectedClass, setSelectedClass] = useState('');\r\n    const [selectedSection, setSelectedSection] = useState('');\r\n\r\n    // Generation State\r\n    const [teachers, setTeachers] = useState([]);\r\n    const [subjects, setSubjects] = useState(['Mathematics', 'Science', 'English', 'Hindi', 'Social Studies', 'Computer', 'Physical Education']);\r\n    const [periodsPerDay, setPeriodsPerDay] = useState(7);\r\n    const [generatedTimetable, setGeneratedTimetable] = useState(null);\r\n\r\n    // View State\r\n    const [existingTimetable, setExistingTimetable] = useState(null);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n    const periodTimes = [\r\n        '8:00-8:45', '8:45-9:30', '9:30-10:15', '10:15-11:00',\r\n        '11:15-12:00', '12:00-12:45', '12:45-1:30'\r\n    ];\r\n\r\n    useEffect(() => {\r\n        if (userData?.role === 'institution' || userData?.role === 'teacher') {\r\n            fetchTeachers();\r\n        }\r\n    }, [userData]);\r\n\r\n    useEffect(() => {\r\n        if (selectedClass && selectedSection && mode === 'view') {\r\n            fetchExistingTimetable();\r\n        }\r\n    }, [selectedClass, selectedSection, mode]);\r\n\r\n    const fetchTeachers = async () => {\r\n        try {\r\n            const q = query(\r\n                collection(db, \"teacher_allotments\"),\r\n                where(\"createdBy\", \"==\", userData.institutionId || userData.uid)\r\n            );\r\n            const snap = await getDocs(q);\r\n            const list = snap.docs.map(d => ({\r\n                id: d.id,\r\n                name: d.data().teacherName,\r\n                subject: d.data().subject,\r\n                teacherId: d.data().teacherId\r\n            }));\r\n            setTeachers(list);\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    };\r\n\r\n    const fetchExistingTimetable = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const q = query(\r\n                collection(db, \"timetables\"),\r\n                where(\"class\", \"==\", selectedClass),\r\n                where(\"section\", \"==\", selectedSection)\r\n            );\r\n            const snap = await getDocs(q);\r\n            if (!snap.empty) {\r\n                const data = snap.docs[0].data();\r\n                setExistingTimetable({ id: snap.docs[0].id, ...data });\r\n            } else {\r\n                setExistingTimetable(null);\r\n            }\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const generateSmartTimetable = () => {\r\n        if (!selectedClass || !selectedSection) {\r\n            alert(\"Please select class and section\");\r\n            return;\r\n        }\r\n\r\n        // AI-like algorithm: Distribute subjects evenly, avoid consecutive same subjects\r\n        const timetable = {};\r\n        const teacherLoad = {}; // Track teacher's periods per day\r\n\r\n        days.forEach(day => {\r\n            timetable[day] = [];\r\n            const daySubjects = [...subjects].sort(() => Math.random() - 0.5); // Shuffle\r\n\r\n            for (let period = 0; period < periodsPerDay; period++) {\r\n                // Break time after 3rd period\r\n                if (period === 3) {\r\n                    timetable[day].push({ subject: 'BREAK', teacher: '-', time: '10:15-11:15' });\r\n                    continue;\r\n                }\r\n\r\n                // Select subject ensuring variety\r\n                let selectedSubject = daySubjects[period % daySubjects.length];\r\n\r\n                // Avoid same subject consecutively\r\n                if (period > 0 && timetable[day][period - 1]?.subject === selectedSubject) {\r\n                    selectedSubject = daySubjects[(period + 1) % daySubjects.length];\r\n                }\r\n\r\n                // Find teacher for this subject\r\n                const availableTeachers = teachers.filter(t => t.subject === selectedSubject);\r\n                const teacher = availableTeachers.length > 0\r\n                    ? availableTeachers[Math.floor(Math.random() * availableTeachers.length)]\r\n                    : { name: 'TBD', teacherId: null };\r\n\r\n                timetable[day].push({\r\n                    subject: selectedSubject,\r\n                    teacher: teacher.name,\r\n                    teacherId: teacher.teacherId,\r\n                    time: periodTimes[period]\r\n                });\r\n            }\r\n        });\r\n\r\n        setGeneratedTimetable(timetable);\r\n    };\r\n\r\n    const saveTimetable = async () => {\r\n        if (!generatedTimetable) return;\r\n\r\n        try {\r\n            // Delete existing timetable if any\r\n            if (existingTimetable?.id) {\r\n                await deleteDoc(doc(db, \"timetables\", existingTimetable.id));\r\n            }\r\n\r\n            // Save new timetable\r\n            await addDoc(collection(db, \"timetables\"), {\r\n                class: selectedClass,\r\n                section: selectedSection,\r\n                schedule: generatedTimetable,\r\n                createdBy: userData.uid,\r\n                createdAt: serverTimestamp(),\r\n                institutionId: userData.institutionId || userData.uid\r\n            });\r\n\r\n            alert(\"Γ£à Timetable saved successfully!\");\r\n            setMode('view');\r\n            fetchExistingTimetable();\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error saving timetable\");\r\n        }\r\n    };\r\n\r\n    const downloadPDF = () => {\r\n        const tt = existingTimetable?.schedule || generatedTimetable;\r\n        if (!tt) return;\r\n\r\n        const doc = new jsPDF('landscape');\r\n\r\n        // Header\r\n        doc.setFontSize(18);\r\n        doc.setFont('helvetica', 'bold');\r\n        doc.text(userData?.institutionName || \"School Timetable\", 148, 15, { align: 'center' });\r\n\r\n        doc.setFontSize(12);\r\n        doc.setFont('helvetica', 'normal');\r\n        doc.text(`Class ${selectedClass} - Section ${selectedSection}`, 148, 22, { align: 'center' });\r\n        doc.text(`Academic Year: 2025-26`, 148, 28, { align: 'center' });\r\n\r\n        // Prepare table data\r\n        const tableData = [];\r\n        const maxPeriods = Math.max(...days.map(day => tt[day]?.length || 0));\r\n\r\n        for (let period = 0; period < maxPeriods; period++) {\r\n            const row = [periodTimes[period] || '-'];\r\n            days.forEach(day => {\r\n                const slot = tt[day]?.[period];\r\n                if (slot) {\r\n                    row.push(slot.subject === 'BREAK' ? 'BREAK' : `${slot.subject}\\n(${slot.teacher})`);\r\n                } else {\r\n                    row.push('-');\r\n                }\r\n            });\r\n            tableData.push(row);\r\n        }\r\n\r\n        doc.autoTable({\r\n            startY: 35,\r\n            head: [['Time', ...days]],\r\n            body: tableData,\r\n            theme: 'grid',\r\n            headStyles: { fillColor: [41, 128, 185], fontSize: 10 },\r\n            bodyStyles: { fontSize: 9 },\r\n            styles: { cellPadding: 3, overflow: 'linebreak' },\r\n            columnStyles: {\r\n                0: { cellWidth: 25, fontStyle: 'bold' }\r\n            }\r\n        });\r\n\r\n        // Footer\r\n        doc.setFontSize(9);\r\n        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 15, doc.internal.pageSize.height - 10);\r\n        doc.text(\"Powered by Together To Refine\", 230, doc.internal.pageSize.height - 10);\r\n\r\n        doc.save(`Timetable_Class${selectedClass}_${selectedSection}.pdf`);\r\n    };\r\n\r\n    const TimetableView = ({ schedule }) => (\r\n        <div style={{ overflowX: 'auto' }}>\r\n            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>\r\n                <thead style={{ background: '#3498db', color: 'white' }}>\r\n                    <tr>\r\n                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Time</th>\r\n                        {days.map(day => (\r\n                            <th key={day} style={{ padding: '10px', border: '1px solid #ddd' }}>{day}</th>\r\n                        ))}\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    {Array.from({ length: periodsPerDay }).map((_, periodIndex) => (\r\n                        <tr key={periodIndex}>\r\n                            <td style={{ padding: '8px', border: '1px solid #ddd', fontWeight: 'bold', background: '#f8f9fa' }}>\r\n                                {periodTimes[periodIndex]}\r\n                            </td>\r\n                            {days.map(day => {\r\n                                const slot = schedule[day]?.[periodIndex];\r\n                                const isBreak = slot?.subject === 'BREAK';\r\n\r\n                                return (\r\n                                    <td key={day} style={{\r\n                                        padding: '8px',\r\n                                        border: '1px solid #ddd',\r\n                                        background: isBreak ? '#fff3cd' : 'white',\r\n                                        textAlign: 'center'\r\n                                    }}>\r\n                                        {slot ? (\r\n                                            <>\r\n                                                <div style={{ fontWeight: 'bold', color: isBreak ? '#856404' : '#2c3e50' }}>\r\n                                                    {slot.subject}\r\n                                                </div>\r\n                                                {!isBreak && (\r\n                                                    <div style={{ fontSize: '11px', color: '#636e72', marginTop: '3px' }}>\r\n                                                        {slot.teacher}\r\n                                                    </div>\r\n                                                )}\r\n                                            </>\r\n                                        ) : '-'}\r\n                                    </td>\r\n                                );\r\n                            })}\r\n                        </tr>\r\n                    ))}\r\n                </tbody>\r\n            </table>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <div className=\"container\">\r\n                {/* Header */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                    <h2>≡ƒùô∩╕Å Smart Timetable Generator</h2>\r\n                    <button onClick={() => navigate(-1)} className=\"btn-outline\">ΓåÉ Back</button>\r\n                </div>\r\n\r\n                {/* Mode Toggle */}\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', borderBottom: '2px solid #eee' }}>\r\n                    <button\r\n                        onClick={() => setMode('view')}\r\n                        style={{\r\n                            padding: '10px 20px', background: 'none', border: 'none',\r\n                            borderBottom: mode === 'view' ? '3px solid #0984e3' : 'none',\r\n                            fontWeight: mode === 'view' ? 'bold' : 'normal',\r\n                            cursor: 'pointer', color: mode === 'view' ? '#0984e3' : '#636e72'\r\n                        }}\r\n                    >\r\n                        ≡ƒæü∩╕Å View Timetable\r\n                    </button>\r\n                    {(userData?.role === 'institution' || userData?.role === 'teacher') && (\r\n                        <button\r\n                            onClick={() => setMode('generate')}\r\n                            style={{\r\n                                padding: '10px 20px', background: 'none', border: 'none',\r\n                                borderBottom: mode === 'generate' ? '3px solid #0984e3' : 'none',\r\n                                fontWeight: mode === 'generate' ? 'bold' : 'normal',\r\n                                cursor: 'pointer', color: mode === 'generate' ? '#0984e3' : '#636e72'\r\n                            }}\r\n                        >\r\n                            ΓÜí Generate New\r\n                        </button>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Class Selector */}\r\n                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>\r\n                    <select className=\"input-field\" value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)} style={{ maxWidth: '150px' }}>\r\n                        <option value=\"\">Select Class</option>\r\n                        {[...Array(12)].map((_, i) => <option key={i} value={i + 1}>{i + 1}</option>)}\r\n                    </select>\r\n                    <select className=\"input-field\" value={selectedSection} onChange={(e) => setSelectedSection(e.target.value)} style={{ maxWidth: '150px' }}>\r\n                        <option value=\"\">Select Section</option>\r\n                        {['A', 'B', 'C', 'D'].map(s => <option key={s} value={s}>{s}</option>)}\r\n                    </select>\r\n                </div>\r\n\r\n                {/* VIEW MODE */}\r\n                {mode === 'view' && (\r\n                    <div className=\"card\">\r\n                        {loading ? (\r\n                            <div style={{ textAlign: 'center', padding: '40px' }}>Loading...</div>\r\n                        ) : !selectedClass || !selectedSection ? (\r\n                            <div style={{ textAlign: 'center', padding: '60px', color: '#999' }}>\r\n                                <div style={{ fontSize: '64px', marginBottom: '20px' }}>≡ƒôà</div>\r\n                                <h3>Select Class & Section</h3>\r\n                            </div>\r\n                        ) : existingTimetable ? (\r\n                            <>\r\n                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                                    <h3 style={{ margin: 0 }}>Class {selectedClass} - Section {selectedSection}</h3>\r\n                                    <button onClick={downloadPDF} className=\"btn\" style={{ background: '#e74c3c' }}>\r\n                                        ≡ƒôä Download PDF\r\n                                    </button>\r\n                                </div>\r\n                                <TimetableView schedule={existingTimetable.schedule} />\r\n                            </>\r\n                        ) : (\r\n                            <div style={{ textAlign: 'center', padding: '60px' }}>\r\n                                <div style={{ fontSize: '64px', marginBottom: '20px' }}>≡ƒô¡</div>\r\n                                <h3>No Timetable Found</h3>\r\n                                <p style={{ color: '#999', marginBottom: '20px' }}>\r\n                                    No timetable has been created for Class {selectedClass} - {selectedSection} yet.\r\n                                </p>\r\n                                {(userData?.role === 'institution' || userData?.role === 'teacher') && (\r\n                                    <button onClick={() => setMode('generate')} className=\"btn\">\r\n                                        ΓÜí Generate Timetable\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* GENERATE MODE */}\r\n                {mode === 'generate' && (\r\n                    <div className=\"card\">\r\n                        <h3>Generate Smart Timetable</h3>\r\n                        <p style={{ color: '#636e72', marginBottom: '20px' }}>\r\n                            AI will automatically distribute subjects evenly and avoid conflicts\r\n                        </p>\r\n\r\n                        {!selectedClass || !selectedSection ? (\r\n                            <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>\r\n                                Please select class and section first\r\n                            </div>\r\n                        ) : (\r\n                            <>\r\n                                <div style={{ marginBottom: '20px' }}>\r\n                                    <label style={{ fontSize: '13px', color: '#636e72', display: 'block', marginBottom: '5px' }}>\r\n                                        Periods per day:\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        className=\"input-field\"\r\n                                        value={periodsPerDay}\r\n                                        onChange={(e) => setPeriodsPerDay(parseInt(e.target.value))}\r\n                                        min=\"5\"\r\n                                        max=\"8\"\r\n                                        style={{ maxWidth: '150px' }}\r\n                                    />\r\n                                </div>\r\n\r\n                                <button onClick={generateSmartTimetable} className=\"btn\" style={{ marginBottom: '20px' }}>\r\n                                    ΓÜí Generate Timetable\r\n                                </button>\r\n\r\n                                {generatedTimetable && (\r\n                                    <>\r\n                                        <div style={{ marginBottom: '15px', padding: '10px', background: '#d4edda', borderRadius: '4px', color: '#155724' }}>\r\n                                            Γ£à Timetable generated successfully! Review and save.\r\n                                        </div>\r\n\r\n                                        <TimetableView schedule={generatedTimetable} />\r\n\r\n                                        <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>\r\n                                            <button onClick={saveTimetable} className=\"btn\" style={{ background: '#27ae60' }}>\r\n                                                ≡ƒÆ╛ Save Timetable\r\n                                            </button>\r\n                                            <button onClick={downloadPDF} className=\"btn\" style={{ background: '#e74c3c' }}>\r\n                                                ≡ƒôä Download PDF\r\n                                            </button>\r\n                                            <button onClick={generateSmartTimetable} className=\"btn-outline\">\r\n                                                ≡ƒöä Regenerate\r\n                                            </button>\r\n                                        </div>\r\n                                    </>\r\n                                )}\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\UniversalScanner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\UpidHistory.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\VideoLibrary.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":80,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":87,"suggestions":[{"messageId":"removeVar","data":{"varName":"orderBy"},"fix":{"range":[165,174],"text":""},"desc":"Remove unused variable 'orderBy'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { db } from '../firebase';\r\nimport { collection, query, where, getDocs, addDoc, deleteDoc, updateDoc, doc, orderBy } from 'firebase/firestore'; // Added updateDoc\r\nimport AnnouncementBar from '../components/AnnouncementBar';\r\nimport AIBadge from '../components/AIBadge';\r\nimport { useUser } from '../context/UserContext';\r\nimport ReactPlayer from 'react-player'; // Using standard import for better compatibility\r\n\r\n// Helper to extract ID\r\nconst getYouTubeID = (url) => {\r\n    if (!url) return null;\r\n    const regExp = /^.*(youtu.be\\/|v\\/|u\\/\\w\\/|embed\\/|watch\\?v=|&v=|shorts\\/)([^#&?]*).*/;\r\n    const match = url.match(regExp);\r\n    return (match && match[2].length === 11) ? match[2] : null;\r\n};\r\n\r\nexport default function VideoLibrary() {\r\n    const { userData } = useUser();\r\n    const role = userData?.role;\r\n\r\n    // State\r\n    const [videos, setVideos] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Editing State\r\n    const [editingId, setEditingId] = useState(null); // ID of video being edited\r\n    const [editTitle, setEditTitle] = useState('');\r\n\r\n    // Add Video State (Teachers/Institution)\r\n    const [showAdd, setShowAdd] = useState(false);\r\n    const [newVideo, setNewVideo] = useState({ title: '', url: '', subject: 'General', targetClass: '' });\r\n\r\n    // Filter State (Students & Teachers)\r\n    const [filterSubject, setFilterSubject] = useState('All');\r\n    const [filterClass, setFilterClass] = useState(''); // Teacher/Inst Filter\r\n\r\n    useEffect(() => {\r\n        if (userData) fetchVideos();\r\n    }, [userData, filterSubject, filterClass]);\r\n\r\n    const fetchVideos = async () => {\r\n        setLoading(true);\r\n        try {\r\n            let q;\r\n            const videoRef = collection(db, \"videos\");\r\n\r\n            // Build variants for students\r\n            let variants = [];\r\n            if (role === 'student') {\r\n                const rawClass = userData.class || userData.assignedClass || '';\r\n                const section = userData.section || userData.assignedSection || 'A';\r\n\r\n                if (!rawClass) {\r\n                    setVideos([]);\r\n                    return;\r\n                }\r\n\r\n                variants.push(`${rawClass}-${section}`);\r\n                const normalizedClass = rawClass.toString().replace(/(\\d+)(st|nd|rd|th)/i, '$1');\r\n                if (normalizedClass !== rawClass.toString()) {\r\n                    variants.push(`${normalizedClass}-${section}`);\r\n                }\r\n            }\r\n\r\n            // SECURE FETCH: explicitly specify your institutionId for the strict rule, no orderby/where combo.\r\n            const instId = role === 'institution' ? userData.uid : userData.institutionId;\r\n            q = query(videoRef, where(\"institutionId\", \"==\", instId));\r\n\r\n            const snapshot = await getDocs(q);\r\n            let list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));\r\n\r\n            // Filter locally to avoid FAILED_PRECONDITION indexing errors\r\n            if (role === 'student') {\r\n                list = list.filter(v => variants.includes(v.targetClass));\r\n                if (filterSubject !== 'All') {\r\n                    list = list.filter(v => v.subject === filterSubject);\r\n                }\r\n            } else {\r\n                if (filterClass && filterClass !== 'All') {\r\n                    list = list.filter(v => v.targetClass === filterClass);\r\n                }\r\n            }\r\n\r\n            // Client-side sort by date descending (safe array sort)\r\n            list.sort((a, b) => {\r\n                const tA = a.timestamp?.seconds || 0;\r\n                const tB = b.timestamp?.seconds || 0;\r\n                return tB - tA;\r\n            });\r\n\r\n            setVideos(list);\r\n        } catch (e) {\r\n            console.error(\"Fetch Videos Error:\", e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleAddVideo = async () => {\r\n        if (!newVideo.title || !newVideo.url || !newVideo.targetClass) {\r\n            alert(\"Please fill all fields!\");\r\n            return;\r\n        }\r\n\r\n        // ReactPlayer handles validation well, but basic check:\r\n        if (!ReactPlayer.canPlay(newVideo.url)) {\r\n            alert(\"Invalid Video URL. Please verify.\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            await addDoc(collection(db, \"videos\"), {\r\n                ...newVideo,\r\n                url: newVideo.url, // Save original URL, ReactPlayer handles the rest\r\n                createdBy: userData.uid,\r\n                authorName: userData.name,\r\n                institutionId: userData.institutionId, // Track Institution\r\n                timestamp: new Date()\r\n            });\r\n            setShowAdd(false);\r\n            setNewVideo({ title: '', url: '', subject: 'General', targetClass: '' });\r\n            fetchVideos();\r\n            alert(\"Video Added Successfully! ≡ƒÄÑ\");\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error adding video\");\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (id) => {\r\n        if (!window.confirm(\"Delete this video?\")) return;\r\n        try {\r\n            await deleteDoc(doc(db, \"videos\", id));\r\n            setVideos(prev => prev.filter(v => v.id !== id));\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error deleting: \" + e.message);\r\n        }\r\n    };\r\n\r\n    const startEditing = (video) => {\r\n        setEditingId(video.id);\r\n        setEditTitle(video.title);\r\n    };\r\n\r\n    const handleUpdate = async (id) => {\r\n        if (!editTitle.trim()) return alert(\"Title cannot be empty\");\r\n        try {\r\n            await updateDoc(doc(db, \"videos\", id), {\r\n                title: editTitle\r\n            });\r\n\r\n            // Update local state\r\n            setVideos(prev => prev.map(v => v.id === id ? { ...v, title: editTitle } : v));\r\n            setEditingId(null);\r\n            setEditTitle('');\r\n        } catch (e) {\r\n            console.error(e);\r\n            alert(\"Error updating: \" + e.message);\r\n        }\r\n    };\r\n\r\n    // Render Logic\r\n    return (\r\n        <div className=\"page-wrapper\">\r\n            <AIBadge />\r\n\r\n\r\n            <div className=\"container\" style={{ maxWidth: '1000px', margin: '20px auto' }}>\r\n\r\n                {/* Controls Area */}\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '10px' }}>\r\n                    {role === 'student' && (\r\n                        <select\r\n                            className=\"input-field\"\r\n                            style={{ maxWidth: '200px', margin: 0 }}\r\n                            value={filterSubject}\r\n                            onChange={(e) => setFilterSubject(e.target.value)}\r\n                        >\r\n                            <option value=\"All\">All Subjects</option>\r\n                            <option value=\"Mathematics\">Mathematics</option>\r\n                            <option value=\"Science\">Science (PS/NS)</option>\r\n                            <option value=\"Social Studies\">Social Studies</option>\r\n                            <option value=\"English\">English</option>\r\n                            <option value=\"Telugu\">Telugu</option>\r\n                            <option value=\"Hindi\">Hindi</option>\r\n                        </select>\r\n                    )}\r\n\r\n                    {(role === 'teacher' || role === 'institution') && (\r\n                        <>\r\n                            <select\r\n                                className=\"input-field\"\r\n                                style={{ maxWidth: '200px', margin: 0 }}\r\n                                value={filterClass}\r\n                                onChange={(e) => setFilterClass(e.target.value)}\r\n                            >\r\n                                <option value=\"All\">All Classes</option>\r\n                                {['Nursery-A', 'LKG-A', 'UKG-A', '1-A', '2-A', '3-A', '4-A', '5-A', '6-A', '7-A', '8-A', '9-A', '10-A', '10-B'].map(c => (\r\n                                    <option key={c} value={c}>{c}</option>\r\n                                ))}\r\n                            </select>\r\n                            <button className=\"btn\" onClick={() => setShowAdd(true)}>+ Add New Video</button>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Add Video Modal (Inline) */}\r\n                {showAdd && (\r\n                    <div className=\"card\" style={{ marginBottom: '20px', border: '2px solid #6c5ce7', background: '#f8f9fa' }}>\r\n                        <h3>Upload New Video</h3>\r\n                        <p className=\"text-muted\" style={{ fontSize: '13px' }}>Upload your video to YouTube (Unlisted/Public) and paste the link here.</p>\r\n\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>\r\n                            <input className=\"input-field\" placeholder=\"Video Title\" value={newVideo.title} onChange={e => setNewVideo({ ...newVideo, title: e.target.value })} />\r\n                            <input className=\"input-field\" placeholder=\"YouTube URL (e.g. https://youtu.be/...)\" value={newVideo.url} onChange={e => setNewVideo({ ...newVideo, url: e.target.value })} />\r\n\r\n                            <select className=\"input-field\" value={newVideo.targetClass} onChange={e => setNewVideo({ ...newVideo, targetClass: e.target.value })}>\r\n                                <option value=\"\">Select Target Class</option>\r\n                                {['Nursery-A', 'LKG-A', 'UKG-A', '1-A', '2-A', '3-A', '4-A', '5-A', '6-A', '7-A', '8-A', '9-A', '10-A', '10-B'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                            </select>\r\n\r\n                            <select className=\"input-field\" value={newVideo.subject} onChange={e => setNewVideo({ ...newVideo, subject: e.target.value })}>\r\n                                <option value=\"General\">General</option>\r\n                                <option value=\"Mathematics\">Mathematics</option>\r\n                                <option value=\"Science\">Science</option>\r\n                                <option value=\"Social Studies\">Social Studies</option>\r\n                                <option value=\"English\">English</option>\r\n                                <option value=\"Telugu\">Telugu</option>\r\n                                <option value=\"Hindi\">Hindi</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div style={{ marginTop: '15px', textAlign: 'right' }}>\r\n                            <button className=\"btn-outline\" onClick={() => setShowAdd(false)} style={{ marginRight: '10px' }}>Cancel</button>\r\n                            <button className=\"btn\" onClick={handleAddVideo}>Post Video</button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Video Grid */}\r\n                {loading && <p className=\"text-center\">Loading Library...</p>}\r\n\r\n                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '25px' }}>\r\n                    {!loading && videos.length === 0 && (\r\n                        <div style={{ gridColumn: '1/-1', textAlign: 'center', color: '#888', padding: '40px' }}>\r\n                            No videos found for this selection.\r\n                        </div>\r\n                    )}\r\n\r\n                    {videos.map(video => {\r\n                        // Permission Check\r\n                        // 1. Institution: Can manage ALL videos\r\n                        // 2. Teacher: Can manage ONLY their own videos\r\n                        const canManage = role === 'institution' || (role === 'teacher' && video.createdBy === userData?.uid);\r\n                        const isEditing = editingId === video.id;\r\n\r\n                        return (\r\n                            <div key={video.id} className=\"card\" style={{ padding: '0', overflow: 'hidden', display: 'flex', flexDirection: 'column', height: '100%' }}>\r\n                                {/* Native Iframe */}\r\n                                <div style={{ position: 'relative', paddingTop: '56.25%', background: '#000' }}>\r\n                                    {getYouTubeID(video.url) ? (\r\n                                        <iframe\r\n                                            src={`https://www.youtube.com/embed/${getYouTubeID(video.url)}?rel=0&modestbranding=1`}\r\n                                            title={video.title}\r\n                                            style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', border: 0 }}\r\n                                            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\"\r\n                                            allowFullScreen\r\n                                            loading=\"lazy\"\r\n                                        />\r\n                                    ) : (\r\n                                        <div style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>\r\n                                            Invalid Video URL\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n\r\n                                {/* Info */}\r\n                                <div style={{ padding: '15px', flex: 1, display: 'flex', flexDirection: 'column' }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>\r\n                                        {isEditing ? (\r\n                                            <div style={{ flex: 1, marginRight: '10px' }}>\r\n                                                <input\r\n                                                    value={editTitle}\r\n                                                    onChange={(e) => setEditTitle(e.target.value)}\r\n                                                    className=\"input-field\"\r\n                                                    style={{ marginBottom: '5px', padding: '5px' }}\r\n                                                    autoFocus\r\n                                                />\r\n                                                <div style={{ display: 'flex', gap: '5px' }}>\r\n                                                    <button className=\"btn\" style={{ padding: '2px 8px', fontSize: '11px' }} onClick={() => handleUpdate(video.id)}>Save</button>\r\n                                                    <button className=\"btn-outline\" style={{ padding: '2px 8px', fontSize: '11px' }} onClick={() => setEditingId(null)}>Cancel</button>\r\n                                                </div>\r\n                                            </div>\r\n                                        ) : (\r\n                                            <h4 style={{ margin: 0, color: '#2d3436', fontSize: '16px', lineHeight: '1.4' }}>{video.title}</h4>\r\n                                        )}\r\n\r\n                                        {/* Action Buttons */}\r\n                                        {canManage && !isEditing && (\r\n                                            <div style={{ display: 'flex', gap: '5px' }}>\r\n                                                <button\r\n                                                    onClick={() => startEditing(video)}\r\n                                                    style={{ background: 'none', border: 'none', color: '#0984e3', cursor: 'pointer', fontSize: '16px' }}\r\n                                                    title=\"Modify Title\"\r\n                                                >Γ£Å∩╕Å</button>\r\n                                                <button\r\n                                                    onClick={() => handleDelete(video.id)}\r\n                                                    style={{ background: 'none', border: 'none', color: '#ff7675', cursor: 'pointer', fontSize: '16px' }}\r\n                                                    title=\"Delete Video\"\r\n                                                >≡ƒùæ∩╕Å</button>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div style={{ marginTop: 'auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '12px', color: '#636e72' }}>\r\n                                        <span style={{\r\n                                            background: '#dfe6e9',\r\n                                            padding: '4px 8px',\r\n                                            borderRadius: '4px',\r\n                                            fontWeight: '600',\r\n                                            color: '#2d3436'\r\n                                        }}>\r\n                                            {video.subject}\r\n                                        </span>\r\n                                        <span>{video.timestamp?.seconds ? new Date(video.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}</span>\r\n                                    </div>\r\n                                    {(role === 'teacher' || role === 'institution') && (\r\n                                        <div style={{ fontSize: '11px', color: '#b2bec3', marginTop: '8px', textAlign: 'right' }}>\r\n                                            By: {video.authorName} | Target: {video.targetClass}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\ViewExamSeating.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\pages\\WaitingList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\translations\\resources.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\src\\utils\\sessionManager.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":57,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[83,91],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'device' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":16,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"device"},"fix":{"range":[626,703],"text":""},"desc":"Remove unused variable 'device'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../firebase';\r\nimport { doc, setDoc, deleteDoc, serverTimestamp, getDoc } from 'firebase/firestore';\r\nimport { UAParser } from 'ua-parser-js';\r\n\r\nconst SESSION_KEY = 'ttr_session_id';\r\n\r\nexport const getLocalSessionId = () => localStorage.getItem(SESSION_KEY);\r\n\r\nexport const registerSession = async (uid) => {\r\n    try {\r\n        const parser = new UAParser();\r\n        const result = parser.getResult();\r\n\r\n        const browser = `${result.browser.name || 'Unknown Browser'} ${result.browser.version || ''}`;\r\n        const os = `${result.os.name || 'Unknown OS'} ${result.os.version || ''}`;\r\n        const device = result.device.model || result.device.type || 'Desktop/Laptop';\r\n        const deviceName = `${os} - ${browser}`;\r\n\r\n        // Create a unique session ID\r\n        let sessionId = getLocalSessionId();\r\n        const isNewSession = !sessionId;\r\n\r\n        if (!sessionId) {\r\n            sessionId = `sess_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n            localStorage.setItem(SESSION_KEY, sessionId);\r\n        }\r\n\r\n        const sessionRef = doc(db, 'users', uid, 'sessions', sessionId);\r\n\r\n        await setDoc(sessionRef, {\r\n            deviceName,\r\n            browser: result.browser.name,\r\n            os: result.os.name,\r\n            deviceType: result.device.type || 'desktop',\r\n            createdAt: isNewSession ? serverTimestamp() : undefined, // Only set on creation\r\n            lastActive: serverTimestamp(),\r\n            sessionId\r\n        }, { merge: true });\r\n\r\n        console.log(`Session registered: ${sessionId}`);\r\n        return sessionId;\r\n\r\n    } catch (error) {\r\n        console.error(\"Error registering session:\", error);\r\n    }\r\n};\r\n\r\nexport const clearLocalSession = () => {\r\n    localStorage.removeItem(SESSION_KEY);\r\n};\r\n\r\nexport const removeSessionFromDb = async (uid, sessionId) => {\r\n    try {\r\n        await deleteDoc(doc(db, 'users', uid, 'sessions', sessionId));\r\n    } catch (error) {\r\n        console.error(\"Error removing session:\", error);\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hp\\.vscode\\TogetherToRefine\\test-algorithm-scenarios.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
